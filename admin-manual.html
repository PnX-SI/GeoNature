

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MANUEL ADMINISTRATEUR &mdash; GeoNature 2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'2.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="IMPORT NIVEAU 1" href="import-level-1.html" />
    <link rel="prev" title="MANUEL UTILISATEUR" href="user-manual.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="index.html" class="icon icon-home"> GeoNature
          

          
            
            <img src="_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation-all.html">INSTALLATION GLOBALE</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation-standalone.html">INSTALLATION AUTONOME</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation-mtes.html">SPECIFICITES DEPOBIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MANUEL ADMINISTRATEUR</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#base-de-donnees">Base de données</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gestion-des-droits">Gestion des droits</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nomenclatures">Nomenclatures</a></li>
<li class="toctree-l3"><a class="reference internal" href="#metadonnees">Métadonnées</a></li>
<li class="toctree-l3"><a class="reference internal" href="#donnees-sig">Données SIG</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fonctions">Fonctions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tables-transversales">Tables transversales</a></li>
<li class="toctree-l3"><a class="reference internal" href="#triggers-vers-la-synthese">Triggers vers la synthèse</a></li>
<li class="toctree-l3"><a class="reference internal" href="#triggers-dans-la-synthese">Triggers dans la synthèse</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#modularite">Modularité</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configuration-generale-de-l-application">Configuration générale de l’application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-d-un-gn-module">Configuration d’un gn_module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#exploitation">Exploitation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#logs">Logs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#commandes-geonature">Commandes GeoNature</a></li>
<li class="toctree-l3"><a class="reference internal" href="#verification-des-services">Vérification des services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supervision-des-services">Supervision des services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stopper-redemarrer-les-api">Stopper/Redémarrer les API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#maintenance">Maintenance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sauvegarde-et-restauration">Sauvegarde et restauration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sauvegarde">Sauvegarde</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restauration">Restauration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#customisation">Customisation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#integrer-son-logo">Intégrer son logo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#customiser-le-contenu">Customiser le contenu</a></li>
<li class="toctree-l3"><a class="reference internal" href="#customiser-l-aspect-esthetique">Customiser l’aspect esthétique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#customiser-les-exports-pdf">Customiser les exports PDF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#integrer-des-donnees">Intégrer des données</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#referentiel-geographique">Référentiel géographique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#donnees-externes">Données externes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#creation-de-compte">Création de compte</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configuration-de-la-creation-de-compte">Configuration de la création de compte</a></li>
<li class="toctree-l3"><a class="reference internal" href="#customisation-du-formulaire">Customisation du formulaire</a></li>
<li class="toctree-l3"><a class="reference internal" href="#espace-utilisateur">Espace utilisateur</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-occtax">Module OCCTAX</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installer-le-module">Installer le module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-du-module">Configuration du module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#afficher-masquer-des-champs-du-formulaire">Afficher/masquer des champs du formulaire</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modifier-le-champ-observateurs">Modifier le champ Observateurs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#personnaliser-la-liste-des-taxons-saisissables-dans-le-module">Personnaliser la liste des taxons saisissables dans le module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gerer-les-valeurs-par-defaut-des-nomenclatures">Gérer les valeurs par défaut des nomenclatures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#personnaliser-l-interface-map-list">Personnaliser l’interface Map-list</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ajouter-une-contrainte-d-echelle-de-saisie-sur-la-carte">Ajouter une contrainte d’échelle de saisie sur la carte</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#gestion-des-exports">Gestion des exports</a></li>
<li class="toctree-l3"><a class="reference internal" href="#attribuer-des-droits">Attribuer des droits</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-occhab">Module OCCHAB</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Installer le module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Base de données</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#formulaire">Formulaire</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-synthese">Module SYNTHESE</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-validation">Module VALIDATION</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="import-level-1.html">IMPORT NIVEAU 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="import-level-2.html">IMPORT NIVEAU 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">DEVELOPPEMENT</a></li>
<li class="toctree-l1"><a class="reference internal" href="versions-compatibility.html">COMPATIBILITE</a></li>
<li class="toctree-l1"><a class="reference internal" href="conf-apache.html">CONFIGURATION APACHE</a></li>
<li class="toctree-l1"><a class="reference internal" href="https.html">HTTPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">CHANGELOG</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GeoNature</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>MANUEL ADMINISTRATEUR</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/admin-manual.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="manuel-administrateur">
<h1>MANUEL ADMINISTRATEUR<a class="headerlink" href="#manuel-administrateur" title="Permalink to this headline">¶</a></h1>
<div class="section" id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>GeoNature possède une architecture modulaire et s’appuie sur plusieurs “services” indépendants pour fonctionner :</p>
<ul class="simple">
<li>UsersHub et son sous-module d’authentification Flask (<a class="reference external" href="https://github.com/PnX-SI/UsersHub-authentification-module">https://github.com/PnX-SI/UsersHub-authentification-module</a>) sont utilisés pour gérer le schéma de BDD <code class="docutils literal"><span class="pre">ref_users</span></code> (actuellement nommé <code class="docutils literal"><span class="pre">utilisateurs</span></code>) et l’authentification. UsersHub permet une gestion centralisée de ses utilisateurs (listes, organismes, droits), utilisable par les différentes applications de son système d’information.</li>
<li>TaxHub (<a class="reference external" href="https://github.com/PnX-SI/TaxHub">https://github.com/PnX-SI/TaxHub</a>) est utilisé pour la gestion du schéma de BDD <code class="docutils literal"><span class="pre">ref_taxonomy</span></code> (actuellement nommé <code class="docutils literal"><span class="pre">taxonomie</span></code>). L’API de TaxHub est utilisée pour récupérer des informations sur les espèces et la taxonomie en général.</li>
<li>Un sous-module Flask (<a class="reference external" href="https://github.com/PnX-SI/Nomenclature-api-module/">https://github.com/PnX-SI/Nomenclature-api-module/</a>) a été créé pour une gestion centralisée des nomenclatures (<a class="reference external" href="https://github.com/PnX-SI/Nomenclature-api-module/">https://github.com/PnX-SI/Nomenclature-api-module/</a>), il pilote le schéma <code class="docutils literal"><span class="pre">ref_nomenclature</span></code>.</li>
<li><code class="docutils literal"><span class="pre">ref_geo</span></code> est le schéma de base de données qui gère le référentiel géographique. Il est utilisé pour gérer les zonages, les communes, le MNT, le calcul automatique d’altitude et les intersections spatiales.</li>
</ul>
<p>GeoNature a également une séparation claire entre le backend (API: intéraction avec la base de données) et le frontend (interface utilisateur). Le backend peut être considéré comme un “service” dont se sert le frontend pour récupérer ou poster des données.
NB : Le backend et le frontend se lancent séparément dans GeoNature.</p>
<img alt="http://geonature.fr/docs/img/admin-manual/design-geonature.png" src="http://geonature.fr/docs/img/admin-manual/design-geonature.png" />
</div>
<div class="section" id="base-de-donnees">
<h2>Base de données<a class="headerlink" href="#base-de-donnees" title="Permalink to this headline">¶</a></h2>
<p>Dans la continuité de sa version 1, GeoNature V2 utilise le SGBD PostgreSQL et sa cartouche spatiale PostGIS. Cependant l’architecture du modèle de données a été complétement revue.</p>
<p>La base de données a notamment été refondue pour s’appuyer au maximum sur des standards, comme le standard d’Occurrences de taxons du SINP (Voir <a class="reference external" href="http://standards-sinp.mnhn.fr/category/standards/occurrences-de-taxons/">http://standards-sinp.mnhn.fr/category/standards/occurrences-de-taxons/</a>).</p>
<p>La base de données a également été traduite en Anglais et supporte désormais le multilangue.</p>
<p>Les préfixes des schémas de BDD sont désormais standardisés : <code class="docutils literal"><span class="pre">ref_</span></code> concerne les référentiels externes, <code class="docutils literal"><span class="pre">gn_</span></code> concerne les schémas du coeur de GeoNature et <code class="docutils literal"><span class="pre">pr_</span></code> les schémas des protocoles.</p>
<p>Autres standards :</p>
<ul class="simple">
<li>Noms de tables, commentaires et fonctions en anglais</li>
<li>Pas de nom de table dans les noms de champs</li>
<li>Nom de schema éventuellement dans nom de table</li>
</ul>
<p>Schéma simplifié de la BDD :</p>
<img alt="http://geonature.fr/docs/img/admin-manual/GN-schema-BDD.jpg" src="http://geonature.fr/docs/img/admin-manual/GN-schema-BDD.jpg" />
<ul class="simple">
<li>En jaune, les schémas des réferentiels.</li>
<li>En rose, les schémas du coeur de GeoNature</li>
<li>En bleu, les schémas des protocoles et sources de données</li>
<li>En vert, les schémas des applications pouvant interagir avec le coeur de GeoNature</li>
</ul>
<p>Depuis la version 2.0.0-rc.4, il faut noter que les droits (CRUVED) ont été retirés du schéma <code class="docutils literal"><span class="pre">utilisateurs</span></code> (<code class="docutils literal"><span class="pre">ref_users</span></code>) de UsersHub pour l’intégrer dans GeoNature dans un schéma <code class="docutils literal"><span class="pre">gn_permissions</span></code>, à ajouter en rose.</p>
<p>Modèle simplifié de la BDD (2017-12-15) :</p>
<img alt="https://raw.githubusercontent.com/PnX-SI/GeoNature/develop/docs/2017-12-15-GN2-MCD-simplifie.jpg" src="https://raw.githubusercontent.com/PnX-SI/GeoNature/develop/docs/2017-12-15-GN2-MCD-simplifie.jpg" />
<p>Dernière version complète de la base de données (GeoNature 2.1 / 2019-08) :</p>
<img alt="https://raw.githubusercontent.com/PnX-SI/GeoNature/develop/docs/2019-08-GN2-1-MCD.png" src="https://raw.githubusercontent.com/PnX-SI/GeoNature/develop/docs/2019-08-GN2-1-MCD.png" />
<p>Les relations complexes entre les schémas ont été grisées pour faciliter la lisibilité.</p>
<div class="section" id="gestion-des-droits">
<h3>Gestion des droits<a class="headerlink" href="#gestion-des-droits" title="Permalink to this headline">¶</a></h3>
<p>Les comptes des utilisateurs, leur mot de passe, email, groupes et leur accès à l’application GeoNature est géré de manière centralisée dans UsersHub. Pour qu’un rôle (utilisateur ou groupe) ait accès à GeoNature, il faut lui attribuer un profil de “Lecteur” dans l’application GeoNature, grâce à l’application UsersHub.</p>
<p>La gestion des droits (permissions) des rôles, spécifique à GeoNature, est ensuite gérée dans un schéma (<code class="docutils literal"><span class="pre">gn_permissions</span></code>) et un module de GeoNature dédié. Dans la version 1 de GeoNature, il était possible d’attribuer des droits selon 6 niveaux à des rôles (utilisateurs ou groupes). Pour la version 2 de GeoNature, des évolutions ont été réalisées pour étendre les possibilités d’attribution de droits et les rendre plus génériques.</p>
<p>La gestion des droits dans GeoNature, comme dans beaucoup d’applications, est liée à des actions (Create / Read / Update / Delete aka CRUD). Pour les besoins  métiers de l’application nous avons rajouté deux actions : “Valider” et “Exporter”, ce qui donne le CRUVED : Create / Read / Update / Validate / Export / Delete.</p>
<p>Sur ces actions, on va pouvoir appliquer des filtres de manière générique.</p>
<p>Le filtre le plus courant est celui de la “portée”. On autorise des actions à un utilisateur sur une portée : “Ses données”, “Les données de son organisme”, “Toutes les données”.</p>
<p>Exemple :</p>
<ul class="simple">
<li>Utilisateur 1 peut effectuer l’action “DELETE” sur la portée “SES DONNEES”</li>
<li>Utilisateur Admin peut effectuer l’action “UPDATE” sur la portée “TOUTES LES DONNEES”</li>
</ul>
<p>Les autres filtres possibles sont liés à la précisions des données, les groupes taxonomiques ou des entités géographiques :</p>
<p>Exemple :</p>
<ul class="simple">
<li>Utilisateur 1 peut effectuer l’action “READ” sur “LES DONNES DEGRADEES”</li>
<li>Utilisateur admin peut effectuer l’action “READ” sur “LES DONNES PRECISES”</li>
</ul>
<p>Enfin ces permissions vont pouvoir s’attribuer à l’ensemble de l’application GeoNature et/ou à un module.</p>
<p>On a donc le quatriptique : Un utilisateur / Une action / Un filtre / Un module</p>
<p>Pour l’instant les filtres de type groupe taxonomique, précisions et géographique existent dans la base de données mais ne sont pas implémentés au niveau de l’application GeoNature, donc ils n’ont aucun effet.</p>
<p>Récapitulatif :</p>
<ul class="simple">
<li>Dans GeoNature V2 on peut attribuer à un role des actions possibles, sur lesquels on peut ajouter des filtres, dans un module ou sur toute l’application GeoNature (définis dans <code class="docutils literal"><span class="pre">gn_permissions.cor_role_action_filter_module_object</span></code>).</li>
<li>6 actions sont possibles dans GeoNature : Create / Read / Update / Validate / Export / Delete (aka CRUVED).</li>
<li>Différents types de filtre existent. Le plus courant est le filtre de type “SCOPE” (portée) : 3 portées sont attribuables à des actions: Mes données / Les données de mon organisme / Toutes les données.</li>
<li>Une vue permet de retourner toutes les actions, leurs filtres et leurs modules de GeoNature pour tous les rôles (<code class="docutils literal"><span class="pre">gn_permissions.v_users_permissions</span></code>)</li>
<li>Des fonctions PostgreSQL ont aussi été intégrées pour faciliter la récupération de ces informations (<code class="docutils literal"><span class="pre">gn_permissions.cruved_for_user_in_module</span></code>, <code class="docutils literal"><span class="pre">gn_permissions.does_user_have_scope_permission</span></code>, …)</li>
<li>Les permissions attribuées à un module surchargent les permission attribuées sur l’ensemble de l’application par un mécanisme d’héritage. Par défaut et en l’absence de permissions, tous les modules héritent des permissions de GeoNature. Attention cependant aux utilisateurs appartenant à plusieurs groupes. Si un CRUVED est définit pour un module à un seul de ses groupes, c’est ce CRUVED qui sera pris en compte. En effet, le mécanisme d’héritage ne fonctionne plus lorsqu’on surcouche implicitement le CRUVED d’un module pour un groupe.</li>
<li>Si un utilisateur n’a aucune action possible sur un module, alors il ne lui sera pas affiché et il ne pourra pas y accéder</li>
<li>Il est aussi possible de ne pas utiliser UsersHub pour gérer les utilisateurs et de connecter GeoNature à un CAS (voir configuration). Actuellement ce paramétrage est fonctionnel en se connectant au CAS de l’INPN (MNHN)</li>
</ul>
<img alt="https://raw.githubusercontent.com/PnX-SI/GeoNature/develop/docs/images/schema_cruved.png" src="https://raw.githubusercontent.com/PnX-SI/GeoNature/develop/docs/images/schema_cruved.png" />
<p>A noter que toutes les actions et toutes les portées n’ont pas été implémentées dans tous les modules. Elles le sont en fonction des besoins de chaque module.</p>
<p>TODO : Lister les permissions implémentées dans chaque module.</p>
</div>
<div class="section" id="nomenclatures">
<h3>Nomenclatures<a class="headerlink" href="#nomenclatures" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Toutes les valeurs des listes déroulantes sont gérées dans une table générique <code class="docutils literal"><span class="pre">ref_nomenclatures.t_nomenclatures</span></code></li>
<li>Elles s’appuient sur les nomenclatures du SINP (<a class="reference external" href="http://standards-sinp.mnhn.fr/nomenclature/">http://standards-sinp.mnhn.fr/nomenclature/</a>) qui peuvent être désactivées ou completées</li>
<li>Chaque nomenclature est associée à un type, et une vue par type de nomenclature a été ajoutée pour simplifier leur usage</li>
<li>Ces nomenclatures sont gérées dans un sous-module pour pouvoir les réutiliser (ainsi que leur mécanisme) dans d’autres applications : <a class="reference external" href="https://github.com/PnX-SI/Nomenclature-api-module/">https://github.com/PnX-SI/Nomenclature-api-module/</a></li>
<li>Les identifiants des nomenclatures et des types de nomenclature sont des serials (entiers auto-incrémentés) et ne sont pas prédéfinis lors de l’installation, ni utilisées en dur dans le code des applications. En effet, les nomenclatures peuvent varier en fonction des structures. On utilise le <code class="docutils literal"><span class="pre">cd_nomenclature</span></code> et le <code class="docutils literal"><span class="pre">mnémonique</span></code> du type de nomenclature pour retrouver dynamiquement l’<code class="docutils literal"><span class="pre">id_nomenclature</span></code> d’une nomenclature. C’est cependant cet identifiant qu’on stocke au niveau des données pour garantir l’intégrité référentielle</li>
<li>Chaque nomenclature peut être associée à un règne ou un group2inpn (<code class="docutils literal"><span class="pre">ref_nomenclatures.cor_taxref_nomenclature</span></code>) pour proposer des nomenclatures correspondants à un taxon</li>
<li>Les valeurs par défaut sont définies dans chaque module</li>
<li>Pour OccTax c’est dans <code class="docutils literal"><span class="pre">pr_occtax.defaults_nomenclatures_value</span></code>. Elles peuvent être définies pour chaque type de nomenclature ainsi que par organisme, règne et/ou group2inpn</li>
<li>Si organisme = 0 alors la valeur par défaut s’applique à tous les organismes. Idem pour les règnes et group2inpn</li>
<li>La fonction <code class="docutils literal"><span class="pre">pr_occtax.get_default_nomenclature_value</span></code> permet de renvoyer l’id de la nomenclature par défaut</li>
<li>Ces valeurs par défaut sont aussi utilisées pour certains champs qui sont cachés (statut_observation, floutage, statut_validation…) mais ne sont donc pas modifiables par l’utilisateur</li>
<li>Il existe aussi une table pour définir des valeurs par défaut générales de nomenclature (<code class="docutils literal"><span class="pre">ref_nomenclatures.defaults_nomenclatures_value</span></code>)</li>
</ul>
</div>
<div class="section" id="metadonnees">
<h3>Métadonnées<a class="headerlink" href="#metadonnees" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Elles sont gérées dans le schéma <code class="docutils literal"><span class="pre">gn_meta</span></code> basé sur le standard Métadonnées du SINP (<a class="reference external" href="http://standards-sinp.mnhn.fr/category/standards/metadonnees/">http://standards-sinp.mnhn.fr/category/standards/metadonnees/</a>)</li>
<li>Elles permettent de gérer des jeux de données, des cadres d’acquisition, des acteurs (propriétaire, financeur, producteur…) et des protocoles</li>
</ul>
</div>
<div class="section" id="donnees-sig">
<h3>Données SIG<a class="headerlink" href="#donnees-sig" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Le schéma <code class="docutils literal"><span class="pre">ref_geo</span></code> permet de gérer les données SIG (zonages, communes, MNT…) de manière centralisée, potentiellement partagé avec d’autres BDD</li>
<li>Il contient une table des zonages, des types de zonages, des communes, des grilles (mailles) et un MNT raster ou vectorisé (<a class="reference external" href="https://github.com/PnX-SI/GeoNature/issues/235">https://github.com/PnX-SI/GeoNature/issues/235</a>)</li>
<li>La fonction <code class="docutils literal"><span class="pre">ref_geo.fct_get_area_intersection</span></code> permet de renvoyer les zonages intersectés par une observation en fournissant sa géométrie</li>
<li>La fonction <code class="docutils literal"><span class="pre">ref_geo.fct_get_altitude_intersection</span></code> permet de renvoyer l’altitude min et max d’une observation en fournissant sa géométrie</li>
<li>Les intersections d’une observation avec les zonages sont stockées au niveau de la synthèse (<code class="docutils literal"><span class="pre">gn_synthese.cor_area_synthese</span></code>) et non au niveau de la donnée source pour alléger et simplifier leur gestion</li>
</ul>
</div>
<div class="section" id="fonctions">
<h3>Fonctions<a class="headerlink" href="#fonctions" title="Permalink to this headline">¶</a></h3>
<p>La base de données contient de nombreuses fonctions.</p>
<p><strong>gn_synthese</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="24%" />
<col width="17%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Fonction</th>
<th class="head">Paramètres</th>
<th class="head">Résultat</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>get_default_nomenclature_value</td>
<td>id_type_nomenclature,
idorganism, regne, group2inpn</td>
<td>Entier</td>
<td>Function that return the default
nomenclature id with a nomenclature
type, organism id, regne, group2_inpn</td>
</tr>
<tr class="row-odd"><td>fct_trig_insert_in_cor_area_synthese</td>
<td>geom</td>
<td>Trigger</td>
<td>Trigger intersectant la géométrie
d’une observation avec tous les zonages</td>
</tr>
</tbody>
</table>
<p><strong>ref_geo</strong></p>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">ref_geo</span><span class="o">.</span><span class="n">fct_get_altitude_intersection</span><span class="p">(</span><span class="n">IN</span> <span class="n">mygeom</span> <span class="n">geometry</span><span class="p">)</span>
<span class="o">--</span> <span class="n">Fonction</span> <span class="n">qui</span> <span class="n">retourne</span> <span class="n">l</span><span class="s1">&#39;altitude min et max de la géométrie passée en paramètre</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">ref_geo</span><span class="o">.</span><span class="n">fct_get_area_intersection</span><span class="p">(</span>
  <span class="n">IN</span> <span class="n">mygeom</span> <span class="n">geometry</span><span class="p">,</span>
  <span class="n">IN</span> <span class="n">myidtype</span> <span class="n">integer</span> <span class="n">DEFAULT</span> <span class="n">NULL</span><span class="p">::</span><span class="n">integer</span><span class="p">)</span>
<span class="n">RETURNS</span> <span class="n">TABLE</span><span class="p">(</span><span class="n">id_area</span> <span class="n">integer</span><span class="p">,</span> <span class="n">id_type</span> <span class="n">integer</span><span class="p">,</span> <span class="n">area_code</span> <span class="n">character</span> <span class="n">varying</span><span class="p">,</span> <span class="n">area_name</span> <span class="n">character</span> <span class="n">varying</span><span class="p">)</span>
<span class="o">--</span> <span class="n">Fonction</span> <span class="n">qui</span> <span class="n">retourne</span> <span class="n">un</span> <span class="n">tableau</span> <span class="n">des</span> <span class="n">zonages</span> <span class="p">(</span><span class="n">id_area</span><span class="p">)</span> <span class="n">intersectant</span> <span class="n">la</span> <span class="n">géométrie</span> <span class="n">passée</span> <span class="n">en</span> <span class="n">paramètre</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">ref_geo</span><span class="o">.</span><span class="n">get_id_area_type</span><span class="p">(</span><span class="n">mytype</span> <span class="n">character</span> <span class="n">varying</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">integer</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">which</span> <span class="k">return</span> <span class="n">the</span> <span class="n">id_type_area</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">type_code</span> <span class="n">of</span> <span class="n">an</span> <span class="n">area</span> <span class="nb">type</span>
</pre></div>
</div>
<p><strong>pr_occtax</strong></p>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">pr_occtax</span><span class="o">.</span><span class="n">get_id_counting_from_id_releve</span><span class="p">(</span><span class="n">my_id_releve</span> <span class="n">integer</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">integer</span><span class="p">[]</span>
<span class="o">--</span> <span class="n">Function</span> <span class="n">which</span> <span class="k">return</span> <span class="n">the</span> <span class="n">id_countings</span> <span class="ow">in</span> <span class="n">an</span> <span class="n">array</span> <span class="p">(</span><span class="n">table</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">cor_counting_occtax</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">id_releve</span><span class="p">(</span><span class="n">integer</span><span class="p">)</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">get_default_nomenclature_value</span><span class="p">(</span><span class="n">mytype</span> <span class="n">character</span> <span class="n">varying</span><span class="p">,</span> <span class="n">myidorganism</span> <span class="n">integer</span> <span class="n">DEFAULT</span> <span class="mi">0</span><span class="p">,</span> <span class="n">myregne</span> <span class="n">character</span> <span class="n">varying</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="n">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">mygroup2inpn</span> <span class="n">character</span> <span class="n">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">DEFAULT</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">integer</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">that</span> <span class="k">return</span> <span class="n">the</span> <span class="n">default</span> <span class="n">nomenclature</span> <span class="nb">id</span> <span class="k">with</span> <span class="n">wanteds</span> <span class="n">nomenclature</span> <span class="nb">type</span><span class="p">,</span> <span class="n">organism</span> <span class="nb">id</span><span class="p">,</span> <span class="n">regne</span><span class="p">,</span> <span class="n">group2_inp</span>  <span class="o">--</span><span class="n">Return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">nothing</span> <span class="n">matche</span> <span class="k">with</span> <span class="n">given</span> <span class="n">parameters</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">pr_occtax</span><span class="o">.</span><span class="n">insert_in_synthese</span><span class="p">(</span><span class="n">my_id_counting</span> <span class="n">integer</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">integer</span><span class="p">[]</span>
</pre></div>
</div>
<p><strong>ref_nomenclatures</strong></p>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">get_id_nomenclature_type</span><span class="p">(</span><span class="n">mytype</span> <span class="n">character</span> <span class="n">varying</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">integer</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">which</span> <span class="k">return</span> <span class="n">the</span> <span class="n">id_type</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">mnemonique</span> <span class="n">of</span> <span class="n">a</span> <span class="n">nomenclature</span> <span class="nb">type</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">get_default_nomenclature_value</span><span class="p">(</span><span class="n">mytype</span> <span class="n">character</span> <span class="n">varying</span><span class="p">,</span> <span class="n">myidorganism</span> <span class="n">integer</span> <span class="n">DEFAULT</span> <span class="mi">0</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">integer</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">that</span> <span class="k">return</span> <span class="n">the</span> <span class="n">default</span> <span class="n">nomenclature</span> <span class="nb">id</span> <span class="k">with</span> <span class="n">wanteds</span> <span class="n">nomenclature</span> <span class="nb">type</span> <span class="p">(</span><span class="n">mnemonique</span><span class="p">),</span> <span class="n">organism</span> <span class="nb">id</span>
<span class="o">--</span><span class="n">Return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">nothing</span> <span class="n">matche</span> <span class="k">with</span> <span class="n">given</span> <span class="n">parameters</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">check_nomenclature_type_by_mnemonique</span><span class="p">(</span><span class="nb">id</span> <span class="n">integer</span> <span class="p">,</span> <span class="n">mytype</span> <span class="n">character</span> <span class="n">varying</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">boolean</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">that</span> <span class="n">checks</span> <span class="k">if</span> <span class="n">an</span> <span class="n">id_nomenclature</span> <span class="n">matches</span> <span class="k">with</span> <span class="n">wanted</span> <span class="n">nomenclature</span> <span class="nb">type</span> <span class="p">(</span><span class="n">use</span> <span class="n">mnemonique</span> <span class="nb">type</span><span class="p">)</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">check_nomenclature_type_by_cd_nomenclature</span><span class="p">(</span><span class="n">mycdnomenclature</span> <span class="n">character</span> <span class="n">varying</span> <span class="p">,</span> <span class="n">mytype</span> <span class="n">character</span> <span class="n">varying</span><span class="p">)</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">that</span> <span class="n">checks</span> <span class="k">if</span> <span class="n">an</span> <span class="n">id_nomenclature</span> <span class="n">matches</span> <span class="k">with</span> <span class="n">wanted</span> <span class="n">nomenclature</span> <span class="nb">type</span> <span class="p">(</span><span class="n">use</span> <span class="n">mnemonique</span> <span class="nb">type</span><span class="p">)</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">check_nomenclature_type_by_id</span><span class="p">(</span><span class="nb">id</span> <span class="n">integer</span><span class="p">,</span> <span class="n">myidtype</span> <span class="n">integer</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">boolean</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">that</span> <span class="n">checks</span> <span class="k">if</span> <span class="n">an</span> <span class="n">id_nomenclature</span> <span class="n">matches</span> <span class="k">with</span> <span class="n">wanted</span> <span class="n">nomenclature</span> <span class="nb">type</span> <span class="p">(</span><span class="n">use</span> <span class="n">id_type</span><span class="p">)</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">get_id_nomenclature</span><span class="p">(</span>
<span class="n">mytype</span> <span class="n">character</span> <span class="n">varying</span><span class="p">,</span>
<span class="n">mycdnomenclature</span> <span class="n">character</span> <span class="n">varying</span><span class="p">)</span>
<span class="n">RETURNS</span> <span class="n">integer</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">which</span> <span class="k">return</span> <span class="n">the</span> <span class="n">id_nomenclature</span> <span class="kn">from</span> <span class="nn">an</span> <span class="n">mnemonique_type</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">cd_nomenclature</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">get_nomenclature_label</span><span class="p">(</span>
<span class="n">myidnomenclature</span> <span class="n">integer</span><span class="p">,</span>
<span class="n">mylanguage</span> <span class="n">character</span> <span class="n">varying</span>
<span class="p">)</span>
<span class="n">RETURNS</span> <span class="n">character</span> <span class="n">varying</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">which</span> <span class="k">return</span> <span class="n">the</span> <span class="n">label</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">id_nomenclature</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">language</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">get_cd_nomenclature</span><span class="p">(</span><span class="n">myidnomenclature</span> <span class="n">integer</span><span class="p">)</span> <span class="n">RETURNS</span> <span class="n">character</span> <span class="n">varying</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">which</span> <span class="k">return</span> <span class="n">the</span> <span class="n">cd_nomenclature</span> <span class="kn">from</span> <span class="nn">an</span> <span class="n">id_nomenclature</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">get_filtered_nomenclature</span><span class="p">(</span><span class="n">mytype</span> <span class="n">character</span> <span class="n">varying</span><span class="p">,</span> <span class="n">myregne</span> <span class="n">character</span> <span class="n">varying</span><span class="p">,</span> <span class="n">mygroup</span> <span class="n">character</span> <span class="n">varying</span><span class="p">)</span>
<span class="n">RETURNS</span> <span class="n">SETOF</span> <span class="n">integer</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">that</span> <span class="n">returns</span> <span class="n">a</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">id_nomenclature</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">regne</span> <span class="ow">and</span><span class="o">/</span><span class="ow">or</span> <span class="n">group2_inpn</span> <span class="n">sent</span> <span class="k">with</span> <span class="n">parameters</span><span class="o">.</span>
</pre></div>
</div>
<div class="code sql highlight-default"><div class="highlight"><pre><span></span><span class="n">calculate_sensitivity</span><span class="p">(</span>
<span class="n">mycdnom</span> <span class="n">integer</span><span class="p">,</span>
<span class="n">mynomenclatureid</span> <span class="n">integer</span><span class="p">)</span>
<span class="n">RETURNS</span> <span class="n">integer</span>
<span class="o">--</span><span class="n">Function</span> <span class="n">to</span> <span class="k">return</span> <span class="n">id_nomenclature</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">observation</span> <span class="n">sensitivity</span>
<span class="o">--</span><span class="n">USAGE</span> <span class="p">:</span> <span class="n">SELECT</span> <span class="n">ref_nomenclatures</span><span class="o">.</span><span class="n">calculate_sensitivity</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span><span class="mi">21</span><span class="p">);</span>
</pre></div>
</div>
<p>TODO : A compléter…</p>
</div>
<div class="section" id="tables-transversales">
<h3>Tables transversales<a class="headerlink" href="#tables-transversales" title="Permalink to this headline">¶</a></h3>
<p>GeoNature contient aussi des tables de stockage transversales qui peuvent être utilisées par tous les modules. C’est le cas pour la validation, la sensibilité, l’historisation des modifications et les médias.</p>
<p>Cela permet de ne pas avoir à mettre en place des tables et mécanismes dans chaque module, mais de s’appuyer sur un stockage, des fonctions et développements factorisés, centralisés et partagés.</p>
<p>Ces tables utilisent notamment le mécanisme des UUID (identifiant unique) pour retrouver les enregistrements. Depuis une table source (Occtax ou un autre module) on peut retrouver les enregistrements stockées dans les tables transversales en utilisant un <code class="docutils literal"><span class="pre">WHERE</span> <span class="pre">&lt;TABLE_TRANSVERSALE&gt;.uuid_attached_row</span> <span class="pre">=</span> <span class="pre">&lt;MON_UUID_SOURCE&gt;</span></code> et ainsi retrouver l’historique de validation, les médias ou encore la sensibilité associés à une donnée.</p>
<p>Voir <a class="reference external" href="https://github.com/PnX-SI/GeoNature/issues/339">https://github.com/PnX-SI/GeoNature/issues/339</a></p>
</div>
<div class="section" id="triggers-vers-la-synthese">
<h3>Triggers vers la synthèse<a class="headerlink" href="#triggers-vers-la-synthese" title="Permalink to this headline">¶</a></h3>
<p>Voir ceux mis en place de Occtax vers Synthèse.</p>
<p>Cheminement d’une donnée Occtax :</p>
<ol class="arabic simple">
<li>Formulaire Occtax</li>
<li>Ecriture dans la table <code class="docutils literal"><span class="pre">cor_counting_occtax</span></code> et génération d’un nouvel UUID</li>
<li>Trigger d’écriture dans la table verticale <code class="docutils literal"><span class="pre">t_validations</span></code> à partir de la valeur par défaut de la nomenclature de validation (<code class="docutils literal"><span class="pre">gn_common.ref_nomenclatures.defaults_nomenclatures_value</span></code>)</li>
<li>Trigger d’écriture d’Occtax vers la synthèse (on ne maitrise pas l’ordre de ces 2 triggers qui sont lancés en même temps)</li>
<li>Trigger de rapatriement du dernier statut de validation de la table verticale vers la synthèse.</li>
</ol>
</div>
<div class="section" id="triggers-dans-la-synthese">
<h3>Triggers dans la synthèse<a class="headerlink" href="#triggers-dans-la-synthese" title="Permalink to this headline">¶</a></h3>
<p>Version 2.1.0 de GeoNature</p>
<img alt="https://geonature.fr/docs/img/2019-06-triggers-gn_synthese.jpg" src="https://geonature.fr/docs/img/2019-06-triggers-gn_synthese.jpg" />
<p><strong>Table : synthese</strong></p>
<p>Table contenant l’ensemble des données.
Respecte le standard Occurrence de taxon du SINP.</p>
<ul class="simple">
<li>tri_meta_dates_change_synthese<ul>
<li>BEFORE INSERT OR UPDATE</li>
<li>Mise à jour des champs <code class="docutils literal"><span class="pre">meta_create_date</span></code> et <code class="docutils literal"><span class="pre">meta_update_date</span></code></li>
</ul>
</li>
<li>tri_insert_cor_area_synthese<ul>
<li>AFTER INSERT OR UPDATE OF the_geom_local</li>
<li>Mise à jour de la table <code class="docutils literal"><span class="pre">cor_area_synthese</span></code></li>
<li>Actions :<ol class="arabic">
<li>Si update : suppression des enregistrements de la table <code class="docutils literal"><span class="pre">gn_synthese.cor_area_synthese</span></code> avec l’id_synthese concerné</li>
<li>Insertion des id_areas intersectant la géométrie de la synthèse dans <code class="docutils literal"><span class="pre">gn_synthese.cor_area_synthese</span></code>. <em>Prise en compte de toutes les aires qu’elles soient ou non actives. Manque enable = true</em></li>
</ol>
</li>
</ul>
</li>
<li>tri_del_area_synt_maj_corarea_tax<ul>
<li>BEFORE DELETE</li>
<li>Mise à jour des tables <code class="docutils literal"><span class="pre">cor_area_taxon</span></code> et <code class="docutils literal"><span class="pre">cor_area_synthese</span></code></li>
<li>Actions :<ol class="arabic">
<li>Récupération de l’ensemble des aires intersectant la donnée de synthèse</li>
<li>Suppression des enregistrement de <code class="docutils literal"><span class="pre">cor_area_taxon</span></code> avec le cd_nom et les aires concernés</li>
<li>Insertion dans <code class="docutils literal"><span class="pre">cor_area_taxon</span></code> recalculant les max, nb_obs et couleur pour chaque aire pour l’ensemble des données avec les aires concernées et le cd_nom concerné ne correspondant pas à la donnée supprimée</li>
<li>Suppression des enregistrements de <code class="docutils literal"><span class="pre">gn_synthese.cor_area_synthese</span></code></li>
</ol>
</li>
</ul>
</li>
<li>tri_update_cor_area_taxon_update_cd_nom<ul>
<li>AFTER UPDATE OF cd_nom</li>
<li>Mise à jour de la table cor_area_taxon</li>
<li>Actions :<ol class="arabic">
<li>Récupération de l’ensemble des aires intersectant la donnée de synthèse</li>
<li>Recalcul <code class="docutils literal"><span class="pre">cor_area_taxon</span></code> pour l’ancien cd_nom via fonction <code class="docutils literal"><span class="pre">gn_synthese.delete_and_insert_area_taxon</span></code></li>
<li>Recalcul <code class="docutils literal"><span class="pre">cor_area_taxon</span></code> pour le nouveau cd_nom via fonction <code class="docutils literal"><span class="pre">gn_synthese.delete_and_insert_area_taxon</span></code></li>
</ol>
</li>
</ul>
</li>
</ul>
<p><strong>Table : cor_area_synthese</strong></p>
<p>Table contenant l’ensemble des id_areas intersectant les enregistrements de la synthèse</p>
<ul class="simple">
<li>tri_maj_cor_area_taxon<ul>
<li>AFTER INSERT OR UPDATE</li>
<li>Mise à jour des données de cor_area_taxon</li>
<li>Actions :<ol class="arabic">
<li>Récupération du cd_nom en lien avec l’enregistrement <code class="docutils literal"><span class="pre">cor_area_synthese</span></code></li>
<li>Suppression des données de <code class="docutils literal"><span class="pre">cor_area_taxon</span></code> avec le <code class="docutils literal"><span class="pre">cd_nom</span></code> et <code class="docutils literal"><span class="pre">id_area</span></code> concernés</li>
<li>Insertion des données dans <code class="docutils literal"><span class="pre">cor_area_taxon</span></code> en lien avec le <code class="docutils literal"><span class="pre">cd_nom</span></code> et <code class="docutils literal"><span class="pre">id_area</span></code></li>
</ol>
</li>
</ul>
</li>
</ul>
<p><strong>Table : cor_observer_synthese</strong></p>
<ul class="simple">
<li>trg_maj_synthese_observers_txt<ul>
<li>AFTER INSERT OR UPDATE OR DELETE</li>
<li>Mise à jour du champ <code class="docutils literal"><span class="pre">observers</span></code> de la table <code class="docutils literal"><span class="pre">synthese</span></code></li>
<li>Actions :<ol class="arabic">
<li>Construction de la valeur textuelle des observateurs</li>
<li>Mise à jour du champ observer de l’enregistrement de la table <code class="docutils literal"><span class="pre">synthese</span></code></li>
</ol>
</li>
</ul>
</li>
</ul>
<p><strong>FONCTIONS</strong></p>
<ul class="simple">
<li>delete_and_insert_area_taxon<ul>
<li>Fonction qui met à jour la table <code class="docutils literal"><span class="pre">cor_area_taxon</span></code> en fonction d’un <code class="docutils literal"><span class="pre">cd_nom</span></code> et d’une liste d’<code class="docutils literal"><span class="pre">id</span> <span class="pre">area</span></code></li>
<li>Actions :<ol class="arabic">
<li>Suppression des enregistrement de la table <code class="docutils literal"><span class="pre">cor_area_taxon</span></code> avec le <code class="docutils literal"><span class="pre">cd_nom</span></code> et les <code class="docutils literal"><span class="pre">id_area</span></code> concernés</li>
<li>Insertion des données dans <code class="docutils literal"><span class="pre">cor_area_taxon</span></code></li>
</ol>
</li>
</ul>
</li>
<li>color_taxon<ul>
<li>Fonction qui associe une couleur à une durée</li>
<li><em>Passer les couleurs en paramètres : table  gn_commons.t_parameters ?</em></li>
<li><em>Passer la fonction en immutable</em></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="modularite">
<h2>Modularité<a class="headerlink" href="#modularite" title="Permalink to this headline">¶</a></h2>
<p>Chaque module doit avoir son propre schéma dans la BDD, avec ses propres fichiers SQL de création comme le module OccTax : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/tree/develop/contrib/occtax/data">https://github.com/PnX-SI/GeoNature/tree/develop/contrib/occtax/data</a></p>
<p>Côté Backend, chaque module a aussi son modèle et ses routes : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/tree/develop/contrib/occtax/backend">https://github.com/PnX-SI/GeoNature/tree/develop/contrib/occtax/backend</a></p>
<p>Idem côté Frontend, où chaque module a sa configuration et ses composants : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/tree/develop/contrib/occtax/frontend/app">https://github.com/PnX-SI/GeoNature/tree/develop/contrib/occtax/frontend/app</a></p>
<p>Mais en pouvant utiliser des composants du Cœur comme expliqué dans la documentation Developpeur.</p>
<p>Plus d’infos sur le développement d’un module : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/develop/docs/development.rst#d%C3%A9velopper-et-installer-un-gn_module">https://github.com/PnX-SI/GeoNature/blob/develop/docs/development.rst#d%C3%A9velopper-et-installer-un-gn_module</a></p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Pour configurer GeoNature, actuellement il y a :</p>
<ul class="simple">
<li>Une configuration pour l’installation : <code class="docutils literal"><span class="pre">config/settings.ini</span></code></li>
<li>Une configuration globale de l’application : <code class="docutils literal"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/config/geonature_config.toml</span></code> (générée lors de l’installation de GeoNature)</li>
<li>Une configuration par module : <code class="docutils literal"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/external_modules/&lt;nom_module&gt;/config/conf_gn_module.toml</span></code> (générée lors de l’installation d’un module)</li>
<li>Une table <code class="docutils literal"><span class="pre">gn_commons.t_parameters</span></code> pour des paramètres gérés dans la BDD</li>
</ul>
<img alt="http://geonature.fr/docs/img/admin-manual/administration-geonature.png" src="http://geonature.fr/docs/img/admin-manual/administration-geonature.png" />
<div class="section" id="configuration-generale-de-l-application">
<h3>Configuration générale de l’application<a class="headerlink" href="#configuration-generale-de-l-application" title="Permalink to this headline">¶</a></h3>
<p>L’installation de GeoNature génère le fichier de configuration globale <code class="docutils literal"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/config/geonature_config.toml</span></code>. Ce fichier est aussi copié dans le frontend (<code class="docutils literal"><span class="pre">frontend/conf/app.config.ts</span></code>), à ne pas modifier.</p>
<p>Par défaut, le fichier <code class="docutils literal"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/config/geonature_config.toml</span></code> est minimaliste et généré à partir des infos présentes dans le fichier <code class="docutils literal"><span class="pre">config/settings.ini</span></code>.</p>
<p>Il est possible de le compléter en surcouchant les paramètres présents dans le fichier <code class="docutils literal"><span class="pre">config/default_config.toml.example</span></code>.</p>
<p>A chaque modification du fichier global de configuration (<code class="docutils literal"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/config/geonature_config.toml</span></code>), il faut regénérer le fichier de configuration du frontend.</p>
<p>Ainsi après chaque modification des fichiers de configuration globale, placez-vous dans le backend de GeoNature (<code class="docutils literal"><span class="pre">/home/monuser/GeoNature/backend</span></code>) et lancez les commandes :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">source venv/bin/activate</span>
<span class="go">geonature update_configuration</span>
<span class="go">deactivate</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-d-un-gn-module">
<h3>Configuration d’un gn_module<a class="headerlink" href="#configuration-d-un-gn-module" title="Permalink to this headline">¶</a></h3>
<p>Lors de l’installation d’un module, un fichier de configuration est créé : <code class="docutils literal"><span class="pre">&lt;MODULE_DIRECTORY&gt;/config/conf_gn_module.toml</span></code>.</p>
<p>Comme pour la configuration globale, ce fichier est minimaliste et peut être surcouché. Le fichier <code class="docutils literal"><span class="pre">conf_gn_module.toml.example</span></code>, situé dans le répertoire <code class="docutils literal"><span class="pre">config</span></code> du module, décrit l’ensemble des variables de configuration disponibles ainsi que leurs valeurs par défaut.</p>
<p>A chaque modification de ce fichier, lancer les commandes suivantes depuis le backend de GeoNature (<code class="docutils literal"><span class="pre">/home/monuser/GeoNature/backend</span></code>). Le fichier est copié à destination du frontend <code class="docutils literal"><span class="pre">&lt;nom_module&gt;/frontend/app/module.config.ts</span></code>, qui est alors recompilé automatiquement.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">source venv/bin/activate</span>
<span class="go">geonature update_module_configuration &lt;NOM_DE_MODULE&gt;</span>
<span class="go">deactivate</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="exploitation">
<h2>Exploitation<a class="headerlink" href="#exploitation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="logs">
<h3>Logs<a class="headerlink" href="#logs" title="Permalink to this headline">¶</a></h3>
<p>Les logs de GeoNature sont dans le répertoire <code class="docutils literal"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/var/log/</span></code> :</p>
<ul class="simple">
<li>Logs d’installation de la BDD : <code class="docutils literal"><span class="pre">install_db.log</span></code></li>
<li>Logs d’installation de la BDD d’un module : <code class="docutils literal"><span class="pre">install_&lt;nom_module&gt;_schema.log</span></code></li>
<li>Logs de l’API : <code class="docutils literal"><span class="pre">gn-errors.log</span></code></li>
</ul>
<p>Les logs de TaxHub sont dans le répertoire <code class="docutils literal"><span class="pre">/var/log/taxhub</span></code>:</p>
<ul class="simple">
<li>Logs de l’API de TaxHub : <code class="docutils literal"><span class="pre">taxhub-errors.log</span></code></li>
</ul>
</div>
<div class="section" id="commandes-geonature">
<h3>Commandes GeoNature<a class="headerlink" href="#commandes-geonature" title="Permalink to this headline">¶</a></h3>
<p>GeoNature est fourni avec une série de commandes pour administrer l’application.
Pour les exécuter, il est nécessaire d’être dans le virtualenv python de GeoNature</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd &lt;GEONATURE_DIRECTORY&gt;/backend</span>
<span class="go">source venv/bin/activate</span>
</pre></div>
</div>
<p>Le préfixe (venv) se met alors au début de votre invite de commande.</p>
<p>Voici la liste des commandes disponibles (aussi disponibles en tapant la commande <code class="docutils literal"><span class="pre">geonature</span> <span class="pre">--help</span></code>) :</p>
<ul class="simple">
<li>activate_gn_module : Active un gn_module installé (Possibilité d’activer seulement le backend ou le frontend)</li>
<li>deactivate_gn_module : Désactive gn_un module activé (Possibilté de désactiver seulement le backend ou le frontend)</li>
<li>dev_back : Lance le backend en mode développement</li>
<li>dev_front : Lance le frontend en mode développement</li>
<li>generate_frontend_module_route : Génère ou regénère le fichier de routing du frontend en incluant les gn_module installés (Fait automatiquement lors de l’installation d’un module)</li>
<li>install_gn_module : Installe un gn_module</li>
<li>start_gunicorn : Lance l’API du backend avec gunicorn</li>
<li>supervisor : Exécute les commandes supervisor (<code class="docutils literal"><span class="pre">supervisor</span> <span class="pre">stop</span> <span class="pre">&lt;service&gt;</span></code>, <code class="docutils literal"><span class="pre">supervisor</span> <span class="pre">reload</span></code>)</li>
<li>update_configuration : Met à jour la configuration du cœur de l’application. A exécuter suite à une modification du fichier <code class="docutils literal"><span class="pre">geonature_config.toml</span></code></li>
<li>update_module_configuration : Met à jour la configuration d’un module. A exécuter suite à une modification du fichier <code class="docutils literal"><span class="pre">conf_gn_module.toml</span></code>.</li>
</ul>
<p>Effectuez <code class="docutils literal"><span class="pre">geonature</span> <span class="pre">&lt;nom_commande&gt;</span> <span class="pre">--help</span></code> pour accéder à la documentation et à des exemples d’utilisation de chaque commande.</p>
</div>
<div class="section" id="verification-des-services">
<h3>Vérification des services<a class="headerlink" href="#verification-des-services" title="Permalink to this headline">¶</a></h3>
<p>Les API de GeoNature et de TaxHub sont lancées par deux serveurs http python indépendants (Gunicorn), eux-mêmes controlés par le supervisor.</p>
<p>Par défaut :</p>
<ul class="simple">
<li>L’API de GeoNature tourne sur le port 8000</li>
<li>L’API de taxhub tourne sur le port 5000</li>
</ul>
<p>Pour vérifier que les API de GeoNature et de TaxHub sont lancées, exécuter la commande :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">ps -aux |grep gunicorn</span>
</pre></div>
</div>
<p>La commande doit renvoyer 4 fois la ligne suivante pour GeoNature :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">root      27074  4.6  0.1  73356 23488 ?        S    17:35   0:00       /home/theo/workspace/GN2/GeoNature/backend/venv/bin/python3 /home/theo/workspace/GN2/GeoNature/backend/venv/bin/gunicorn wsgi:app --error-log /var/log/geonature/api_errors.log --pid=geonature2.pid -w 4 -b 0.0.0.0:8000 -n geonature2</span>
</pre></div>
</div>
<p>et 4 fois la ligne suivante pour TaxHub :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">root      27103 10.0  0.3 546188 63328 ?        Sl   17:35   0:00 /home/theo/workspace/GN2/TaxHub/venv/bin/python3.5 /home/theo/workspace/GN2/TaxHub/venv/bin/gunicorn server:app --access-logfile /var/log/taxhub/taxhub-access.log --error-log /var/log/taxhub/taxhub-errors.log --pid=taxhub.pid -w 4 -b 0.0.0.0:5000 -n taxhub</span>
</pre></div>
</div>
<p>Chaque ligne correspond à un worker Gunicorn.</p>
<p>Si ces lignes n’apparaissent pas, cela signifie qu’une des deux API n’a pas été lancée ou a connu un problème à son lancement. Voir les logs des API pour plus d’informations.</p>
</div>
<div class="section" id="supervision-des-services">
<h3>Supervision des services<a class="headerlink" href="#supervision-des-services" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Vérifier que les applications GeoNature et TaxHub sont accessibles en http</li>
<li>Vérifier que leurs services (API) sont lancés et fonctionnent correctement (tester les deux routes ci-dessous).<ul>
<li>Exemple de route locale pour tester l’API GeoNature : <a class="reference external" href="http://127.0.0.1:8000/occtax/defaultNomenclatures">http://127.0.0.1:8000/occtax/defaultNomenclatures</a> qui ne doit pas renvoyer de 404. URL absolue : <a class="reference external" href="https://urlgeonature/api/occtax/defaultNomenclatures">https://urlgeonature/api/occtax/defaultNomenclatures</a></li>
<li>Exemple de route locale pour tester l’API TaxHub : <a class="reference external" href="http://127.0.0.1:5000/api/taxref/regnewithgroupe2">http://127.0.0.1:5000/api/taxref/regnewithgroupe2</a> qui ne doit pas renvoyer de 404. URL absolue : <a class="reference external" href="https://urltaxhub/api/taxref/regnewithgroupe2">https://urltaxhub/api/taxref/regnewithgroupe2</a></li>
</ul>
</li>
<li>Vérifier que les fichiers de logs de TaxHub et GeoNature ne sont pas trop volumineux pour la capacité du serveur</li>
<li>Vérifier que les services nécessaires au fonctionnement de l’application tournent bien (Apache, PostgreSQL)</li>
</ul>
</div>
<div class="section" id="stopper-redemarrer-les-api">
<h3>Stopper/Redémarrer les API<a class="headerlink" href="#stopper-redemarrer-les-api" title="Permalink to this headline">¶</a></h3>
<p>Les API de GeoNature et de TaxHub sont gérées par le supervisor pour être lancées automatiquement au démarrage du serveur.</p>
<p>Pour les stopper, exécuter les commandes suivantes :</p>
<ul class="simple">
<li>GeoNature : <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">supervisorctl</span> <span class="pre">stop</span> <span class="pre">geonature2</span></code></li>
<li>TaxHub : <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">supervisorctl</span> <span class="pre">stop</span> <span class="pre">taxhub</span></code></li>
</ul>
<p>Pour redémarer les API :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo supervisorctl reload</span>
</pre></div>
</div>
</div>
<div class="section" id="maintenance">
<h3>Maintenance<a class="headerlink" href="#maintenance" title="Permalink to this headline">¶</a></h3>
<p>Lors d’une opération de maintenance (montée en version, modification de la base de données…), vous pouvez rendre l’application momentanémment indisponible.</p>
<p>Pour cela, désactivez la configuration Apache de GeoNature, puis activez la configuration du mode de maintenance :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo a2dissite geonature</span>
<span class="go">sudo a2ensite geonature_maintenance</span>
<span class="go">sudo apachectl restart</span>
</pre></div>
</div>
<p>A la fin de l’opération de maintenance, effectuer la manipulation inverse :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo a2dissite geonature_maintenance</span>
<span class="go">sudo a2ensite geonature</span>
<span class="go">sudo apachectl restart</span>
</pre></div>
</div>
<p>Attention : ne pas stopper le backend (des opérations en BDD en cours pourraient être corrompues)</p>
<ul>
<li><p class="first">Redémarrage de PostgreSQL</p>
<p>Si vous effectuez des manipulations de PostgreSQL qui nécessitent un redémarrage du SGBD (<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">postgresql</span> <span class="pre">restart</span></code>), il faut impérativement lancer un redémarrage des API GeoNature et TaxHub pour que celles-ci continuent de fonctionner. Pour cela, lancez la commande <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">supervisorctl</span> <span class="pre">reload</span></code>.</p>
<p><strong>NB</strong>: Ne pas faire ces manipulations sans avertir les utilisateurs d’une perturbation temporaire des applications.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="sauvegarde-et-restauration">
<h2>Sauvegarde et restauration<a class="headerlink" href="#sauvegarde-et-restauration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sauvegarde">
<h3>Sauvegarde<a class="headerlink" href="#sauvegarde" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Sauvegarde de la base de données :</li>
</ul>
<p>Les sauvegardes de la BDD sont à faire avec l’utilisateur <code class="docutils literal"><span class="pre">postgres</span></code>. Commencer par créer un répertoire et lui donner des droits sur le répertoire où seront faites les sauvegardes.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span># Créer le répertoire pour stocker les sauvegardes
mkdir /home/`whoami`/backup
# Ajouter l&#39;utilisateur postgres au groupe de l&#39;utilisateur linux courant pour qu&#39;il ait les droits d&#39;écrire dans les mêmes répertoires
sudo adduser postgres `whoami`
# ajout de droit aux groupes de l&#39;utilisateur courant sur le répertoire `backup`
chmod g+rwx /home/`whoami`/backup
</pre></div>
</div>
<p>Connectez-vous avec l’utilisateur linux <code class="docutils literal"><span class="pre">postgres</span></code> pour lancer une sauvegarde de la BDD :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo su postgres</span>
<span class="go">pg_dump -Fc geonature2db  &gt; /home/`whoami`/backup/`date +%Y-%m-%d-%H:%M`-geonaturedb.backup</span>
<span class="go">exit</span>
</pre></div>
</div>
<p>Si la sauvegarde ne se fait pas, c’est qu’il faut revoir les droits du répertoire où sont faites les sauvegardes pour que l’utilisateur <code class="docutils literal"><span class="pre">postgres</span></code> puisse y écrire</p>
<p>Opération à faire régulièrement grâce à une tâche cron.</p>
<ul>
<li><p class="first">Sauvegarde des fichiers de configuration :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd /home/`whoami`/geonature/config</span>
<span class="go">tar -zcvf /home/`whoami`/backup/`date +%Y%m%d%H%M`-geonature_config.tar.gz ./</span>
</pre></div>
</div>
</li>
</ul>
<p>Opération à faire à chaque modification d’un paramètre de configuration.</p>
<ul>
<li><p class="first">Sauvegarde des fichiers de customisation :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd /home/`whoami`/geonature/frontend/src/custom</span>
<span class="go">tar -zcvf /home/`whoami`/`date +%Y%m%d%H%M`-geonature_custom.tar.gz ./</span>
</pre></div>
</div>
</li>
</ul>
<p>Opération à faire à chaque modification de la customisation de l’application.</p>
<ul>
<li><p class="first">Sauvegarde des modules externes :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd /home/`whoami`/geonature/external_modules</span>
<span class="go">tar -zcvf /home/`whoami`/backup/`date +%Y%m%d%H%M`-external_modules.tar.gz ./</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="restauration">
<h3>Restauration<a class="headerlink" href="#restauration" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Restauration de la base de données :</p>
<ul>
<li><p class="first">Créer une base de données vierge (on part du principe que la base de données <code class="docutils literal"><span class="pre">geonature2db</span></code> n’existe pas ou plus). Sinon adaptez le nom de la BDD et également la configuration de connexion de l’application à la BDD dans <code class="docutils literal"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/config/geonature_config.toml</span></code></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo -n -u postgres -s createdb -O &lt;MON_USER&gt; geonature2db</span>
<span class="go">sudo -n -u postgres -s psql -d geonature2db -c &quot;CREATE EXTENSION IF NOT EXISTS postgis;&quot;</span>
<span class="go">sudo -n -u postgres -s psql -d geonature2db -c &quot;CREATE EXTENSION IF NOT EXISTS hstore;&quot;</span>
<span class="go">sudo -n -u postgres -s psql -d geonature2db -c &quot;CREATE EXTENSION IF NOT EXISTS plpgsql WITH SCHEMA pg_catalog; COMMENT ON EXTENSION plpgsql IS &#39;PL/pgSQL procedural language&#39;;&quot;</span>
<span class="go">sudo -n -u postgres -s psql -d geonature2db -c &#39;CREATE EXTENSION IF NOT EXISTS &quot;uuid-ossp&quot;;&#39;</span>
<span class="go">sudo -n -u postgres -s psql -d geonature2db -c &quot;CREATE EXTENSION IF NOT EXISTS pg_trgm;&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Restaurer la BDD à partir du backup</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo su postgres</span>
<span class="go">pg_restore -d geonature2db &lt;MY_BACKUP_DIRECTORY_PATH&gt;/201803150917-geonaturedb.backup</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first">Restauration de la configuration et de la customisation :</p>
<ul>
<li><p class="first">Décompresser les fichiers précedemment sauvegardés pour les remettre au bon emplacement :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo rm &lt;GEONATURE_DIRECTORY&gt;/config/*</span>
<span class="go">cd &lt;GEONATURE_DIRECTORY&gt;/config</span>
<span class="go">sudo tar -zxvf &lt;MY_BACKUP_DIRECTORY&gt;/201803150953-geonature_config.tar.gz</span>

<span class="go">cd /home/&lt;MY_USER&gt;/geonature/frontend/src/custom</span>
<span class="go">rm -r &lt;MY_USER&gt;/geonature/frontend/src/custom/*</span>
<span class="go">tar -zxvf &lt;MY_BACKUP_DIRECTORY&gt;/201803150953-geonature_custom.tar.gz</span>

<span class="go">rm /home/&lt;MY_USER&gt;/geonature/external_modules/*</span>
<span class="go">cd &lt;GEONATURE_DIRECTORY&gt;/external_modules</span>
<span class="go">tar -zxvf &lt;MY_BACKUP_DIRECTORY&gt;/201803151036-external_modules.tar.gz</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first">Relancer l’application :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd /&lt;MY_USER&gt;/geonature/frontend</span>
<span class="go">npm run build</span>
<span class="go">sudo supervisorctl reload</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="customisation">
<h2>Customisation<a class="headerlink" href="#customisation" title="Permalink to this headline">¶</a></h2>
<p>La customisation de l’application nécessite de relancer la compilation du frontend à chaque modification. Cette opération étant relativement longue, une solution alternative (mais avancée) consiste à passer le frontend de manière temporaire en mode ‘developpement’.</p>
<p>Pour cela exécuter la commande suivante depuis le répertoire <code class="docutils literal"><span class="pre">frontend</span></code></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">npm run start -- --host=0.0.0.0 --disable-host-check</span>
</pre></div>
</div>
<p>L’application est désormais disponible sur une serveur de développement à la même addresse que précédemment, mais sur le port 4200 : <a class="reference external" href="http://test.geonature.fr:4200">http://test.geonature.fr:4200</a></p>
<p>Ouvrez un nouveau terminal (pour laisser tourner le serveur de développement), puis modifier la variable <code class="docutils literal"><span class="pre">URL_APPLICATION</span></code> dans le fichier <code class="docutils literal"><span class="pre">geonature_config.toml</span></code> en mettant l’adresse ci-dessus et relancer l’application (<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">supervisorctl</span> <span class="pre">restart</span> <span class="pre">geonature2</span></code>)</p>
<p>A chaque modification d’un fichier du frontend, une compilation rapide est relancée et votre navigateur se rafraichit automatiquement en intégrant les dernières modifications.</p>
<p>Une fois les modifications terminées, remodifier le fichier <code class="docutils literal"><span class="pre">geonature_config.toml</span></code> pour remettre l’URL initiale, relancez l’application (<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">supervisorctl</span> <span class="pre">restart</span> <span class="pre">geonature2</span></code>), puis relancez la compilation du frontend (<code class="docutils literal"><span class="pre">npm</span> <span class="pre">run</span> <span class="pre">build</span></code>). Faites enfin un <code class="docutils literal"><span class="pre">ctrl+c</span></code> dans le terminal ou le frontend a été lancé pour stopper le serveur de développement.</p>
<p>Si la manipulation vous parait compliquée, vous pouvez suivre la documentation qui suit, qui fait relancer la compilation du frontend à chaque modification.</p>
<div class="section" id="integrer-son-logo">
<h3>Intégrer son logo<a class="headerlink" href="#integrer-son-logo" title="Permalink to this headline">¶</a></h3>
<p>Le logo affiché dans la barre de navigation de GeoNature peut être modifié dans le répertoire <code class="docutils literal"><span class="pre">geonature/frontend/src/custom/images</span></code>. Remplacez alors le fichier <code class="docutils literal"><span class="pre">logo_structure.png</span></code> par votre propre logo, en conservant ce nom pour le nouveau fichier. Le bandeau fait 50px de hauteur, vous pouvez donc mettre une image faisant cette hauteur. Il est également possible de modifier la taille de l’image en CSS dans le fichier <code class="docutils literal"><span class="pre">frontend/src/custom/custom.scss</span></code> de la manière suivante:</p>
<div class="code css highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">la</span> <span class="n">balise</span> <span class="n">img</span> <span class="n">affichant</span> <span class="n">l</span><span class="s1">&#39;image a l&#39;</span><span class="nb">id</span> <span class="s1">&#39;logo-structure</span>
<span class="c1">#logo-structure {</span>
      <span class="n">height</span><span class="p">:</span> <span class="mi">50</span><span class="n">px</span><span class="p">;</span>
      <span class="n">width</span><span class="p">:</span> <span class="mi">80</span><span class="n">px</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>Relancez la construction de l’interface :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd /home/`whoami`/geonature/frontend</span>
<span class="go">npm run build</span>
</pre></div>
</div>
</div>
<div class="section" id="customiser-le-contenu">
<h3>Customiser le contenu<a class="headerlink" href="#customiser-le-contenu" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Customiser le contenu de la page d’introduction :</li>
</ul>
<p>Le texte d’introduction et le titre de la page d’Accueil de GeoNature peuvent être modifiés à tout moment, sans réinstallation de l’application. Il en est de même pour le bouton d’accès à la synthèse.</p>
<p>Il suffit pour cela de mettre à jour le fichier <code class="docutils literal"><span class="pre">introduction.component.html</span></code>, situé dans le répertoire <code class="docutils literal"><span class="pre">geonature/frontend/src/custom/components/introduction</span></code>.</p>
<p>Afin que ces modifications soient prises en compte dans l’interface, il est nécessaire de relancer les commandes suivantes :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd /home/`whoami`/geonature/frontend</span>
<span class="go">npm run build</span>
</pre></div>
</div>
<ul class="simple">
<li>Customiser le contenu du pied de page :</li>
</ul>
<p>Le pied de page peut être customisé de la même manière, en renseignant le fichier <code class="docutils literal"><span class="pre">footer.component.html</span></code>, situé dans le répertoire <code class="docutils literal"><span class="pre">geonature/frontend/src/custom/components/footer</span></code></p>
<p>De la même manière, il est nécessaire de relancer les commandes suivantes pour que les modifications soient prises en compte :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd /home/`whoami`/geonature/frontend</span>
<span class="go">npm run build</span>
</pre></div>
</div>
</div>
<div class="section" id="customiser-l-aspect-esthetique">
<h3>Customiser l’aspect esthétique<a class="headerlink" href="#customiser-l-aspect-esthetique" title="Permalink to this headline">¶</a></h3>
<p>Les couleurs de textes, couleurs de fonds, forme des boutons etc peuvent être adaptées en renseignant le fichier <code class="docutils literal"><span class="pre">custom.scss</span></code>, situé dans le répertoire <code class="docutils literal"><span class="pre">geonature/frontend/src/custom</span></code>.</p>
<p>Pour remplacer la couleur de fond du bandeau de navigation par une image, on peut par exemple apporter la modification suivante :</p>
<div class="highlight-css"><div class="highlight"><pre><span></span> <span class="nt">html</span> <span class="nt">body</span> <span class="nt">pnx-root</span> <span class="nt">pnx-nav-home</span> <span class="nt">mat-sidenav-container</span><span class="p">.</span><span class="nc">sidenav-container</span><span class="p">.</span><span class="nc">mat-drawer-container</span><span class="p">.</span><span class="nc">mat-sidenav-container</span> <span class="nt">mat-sidenav-content</span><span class="p">.</span><span class="nc">mat-drawer-content</span><span class="p">.</span><span class="nc">mat-sidenav-content</span> <span class="nt">mat-toolbar</span><span class="p">#</span><span class="nn">app-toolbar</span><span class="p">.</span><span class="nc">row</span><span class="p">.</span><span class="nc">mat-toolbar</span>
<span class="p">{</span>
   <span class="k">background</span> <span class="p">:</span>
   <span class="nb">url</span><span class="p">(</span><span class="sx">bandeau_test.jpg</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Dans ce cas, l’image <code class="docutils literal"><span class="pre">bandeau_test.jpg</span></code> doit se trouver dans le répertoire <code class="docutils literal"><span class="pre">&gt;geonature/frontend/src</span></code> .</p>
<p>Comme pour la modification des contenus, il est nécessaire de relancer la commande suivante pour que les modifications soient prises en compte :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd /home/`whoami`/geonature/frontend</span>
<span class="go">npm run build</span>
</pre></div>
</div>
</div>
<div class="section" id="customiser-les-exports-pdf">
<h3>Customiser les exports PDF<a class="headerlink" href="#customiser-les-exports-pdf" title="Permalink to this headline">¶</a></h3>
<p>Vous pouvez modifier le bandeau et le logo fournis par défaut dans les exports PDF en modifiant les images <code class="docutils literal"><span class="pre">Bandeau_pdf.png</span></code> et <code class="docutils literal"><span class="pre">Logo_pdf.png</span></code> dans <code class="docutils literal"><span class="pre">backend/static/images</span></code>. Les fichiers CSS des exports PDF sont dans <code class="docutils literal"><span class="pre">backend/static/css</span></code>.</p>
</div>
</div>
<div class="section" id="integrer-des-donnees">
<h2>Intégrer des données<a class="headerlink" href="#integrer-des-donnees" title="Permalink to this headline">¶</a></h2>
<div class="section" id="referentiel-geographique">
<h3>Référentiel géographique<a class="headerlink" href="#referentiel-geographique" title="Permalink to this headline">¶</a></h3>
<p>GeoNature est fourni avec des données géographiques de base sur la métropôle (MNT national à 250m et communes de métropôle).</p>
<p><strong>1.</strong> Si vous souhaitez modifier le MNT pour mettre celui de votre territoire :</p>
<ul class="simple">
<li>Videz le contenu des tables <code class="docutils literal"><span class="pre">ref_geo.dem</span></code> et éventuellement <code class="docutils literal"><span class="pre">ref_geo.dem_vector</span></code></li>
<li>Uploadez le(s) fichier(s) du MNT sur le serveur</li>
<li>Suivez la procédure de chargement du MNT en l’adaptant : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/install/install_db.sh#L295-L299">https://github.com/PnX-SI/GeoNature/blob/master/install/install_db.sh#L295-L299</a></li>
</ul>
<p><em>TODO : Procédure à améliorer et simplifier : https://github.com/PnX-SI/GeoNature/issues/235</em></p>
<p>Si vous n’avez pas choisi d’intégrer le raster MNT national à 250m fourni par défaut lors de l’installation ou que vous souhaitez le remplacer, voici les commandes qui vous permettront de le faire.</p>
<p>Suppression du MNT par défaut (adapter le nom de la base de données : MYDBNAME).</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo -n -u postgres -s psql -d MYDBNAME -c &quot;TRUNCATE TABLE ref_geo.dem;&quot;</span>
<span class="go">sudo -n -u postgres -s psql -d MYDBNAME -c &quot;TRUNCATE TABLE ref_geo.dem_vector;&quot;</span>
</pre></div>
</div>
<p>Placer votre propre fichier MNT (ou vos différents fichiers “dalles”) dans le répertoire <code class="docutils literal"><span class="pre">/tmp/geonature</span></code> (adapter le nom du fichier et son chemin ainsi que les paramètres en majuscule).</p>
<p>Pour utiliser celui proposé par défaut :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">wget --cache=off http://geonature.fr/data/ign/BDALTIV2_2-0_250M_ASC_LAMB93-IGN69_FRANCE_2017-06-21.zip -P /tmp/geonature</span>
<span class="go">unzip /tmp/geonature/BDALTIV2_2-0_250M_ASC_LAMB93-IGN69_FRANCE_2017-06-21.zip -d /tmp/geonature</span>
<span class="go">export PGPASSWORD=MYUSERPGPASS;raster2pgsql -s MYSRID -c -C -I -M -d -t 5x5 /tmp/geonature/BDALTIV2_250M_FXX_0098_7150_MNT_LAMB93_IGN69.asc ref_geo.dem|psql -h localhost -U MYPGUSER -d MYDBNAME</span>
<span class="go">sudo -n -u postgres -s psql -d MYDBNAME -c &quot;REINDEX INDEX ref_geo.dem_st_convexhull_idx;&quot;</span>
</pre></div>
</div>
<p>Si votre MNT source est constitué de plusieurs fichiers (dalles),
assurez vous que toutes vos dalles ont le même système de projection
et le même format de fichier (tiff, asc, ou img par exemple).
Après avoir chargé vos fichiers dans <code class="docutils literal"><span class="pre">tmp/geonature</span></code> (par exemple),
vous pouvez lancer la commande <code class="docutils literal"><span class="pre">export</span></code> en remplacant le nom des
fichiers par *.asc :</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">export PGPASSWORD=MYUSERPGPASS;raster2pgsql -s MYSRID -c -C -I -M -d -t 5x5 /tmp/geonature/*.asc ref_geo.dem|psql -h localhost -U MYPGUSER -d MYDBNAME</span>
</pre></div>
</div>
<p>Si vous souhaitez vectoriser le raster MNT pour de meilleures performances lors des calculs en masse de l’altitude à partir de la localisation des observations, vous pouvez le faire en lançant les commandes ci-dessous. Sachez que cela prendra du temps et beaucoup d’espace disque (2.8Go supplémentaires environ pour le fichier DEM France à 250m).</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">sudo -n -u postgres -s psql -d MYDBNAME -c &quot;INSERT INTO ref_geo.dem_vector (geom, val) SELECT (ST_DumpAsPolygons(rast)).* FROM ref_geo.dem;&quot;</span>
<span class="go">sudo -n -u postgres -s psql -d MYDBNAME -c &quot;REINDEX INDEX ref_geo.index_dem_vector_geom;&quot;</span>
</pre></div>
</div>
<p>Si <code class="docutils literal"><span class="pre">ref_geo.dem_vector</span></code> est remplie, cette table est utilisée pour le calcul de l’altitude à la place de la table <code class="docutils literal"><span class="pre">ref_geo.dem</span></code></p>
<p><strong>2.</strong> Si vous souhaitez modifier ou ajouter des zonages administratifs, réglementaires ou naturels :</p>
<ul class="simple">
<li>Vérifiez que leur type existe dans la table <code class="docutils literal"><span class="pre">ref_geo.bib_areas_types</span></code>, sinon ajoutez-les</li>
<li>Ajoutez vos zonages dans la table <code class="docutils literal"><span class="pre">ref_geo.l_areas</span></code> en faisant bien référence à un <code class="docutils literal"><span class="pre">id_type</span></code> de <code class="docutils literal"><span class="pre">ref_geo.bib_areas_types</span></code>. Vous pouvez faire cela en SQL ou en faisant des copier/coller de vos zonages directement dans QGIS</li>
<li>Pour les grilles et les communes, vous pouvez ensuite compléter leurs tables d’extension <code class="docutils literal"><span class="pre">ref_geo.li_grids</span></code> et <code class="docutils literal"><span class="pre">ref_geo.li_municipalities</span></code></li>
</ul>
</div>
<div class="section" id="donnees-externes">
<h3>Données externes<a class="headerlink" href="#donnees-externes" title="Permalink to this headline">¶</a></h3>
<p>Il peut s’agir de données partenaires, de données historiques ou de données saisies dans d’autres outils.</p>
<p>2 possibilités s’offrent à vous :</p>
<ul class="simple">
<li>Créer un schéma dédié aux données pour les intégrer de manière complète et en extraire les DEE dans la Synthèse</li>
<li>N’intégrer que les DEE dans la Synthèse</li>
</ul>
<p>Nous présenterons ici la première solution qui est privilégiée pour disposer des données brutes mais aussi les avoir dans la Synthèse.</p>
<ul class="simple">
<li>Créer un JDD dédié (<code class="docutils literal"><span class="pre">gn_meta.t_datasets</span></code>) ou utilisez-en un existant. Eventuellement un CA si elles ne s’intègrent pas dans un CA déjà existant.</li>
<li>Ajouter une Source de données dans <code class="docutils literal"><span class="pre">gn_synthese.t_sources</span></code> ou utilisez en une existante.</li>
<li>Créer le schéma dédié à accueillir les données brutes.</li>
<li>Créer les tables nécessaires à accueillir les données brutes.</li>
<li>Intégrer les données dans ces tables (avec les fonctions de <code class="docutils literal"><span class="pre">gn_imports</span></code>, avec QGIS ou pgAdmin).</li>
<li>Pour alimenter la Synthèse à partir des tables sources, vous pouvez mettre en place des triggers (en s’inspirant de ceux de OccTax) ou bien faire une requête spécifique si les données sources ne sont plus amenées à évoluer.</li>
</ul>
<p>Pour des exemples plus précis, illustrées et commentées, vous pouvez consulter les 2 exemples d’import dans cette documentation (Import niveau et Import niveau 2).</p>
<p>Vous pouvez aussi vous inspirer des exemples avancés de migration des données de GeoNature V1 vers GeoNature V2 : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/tree/master/data/migrations/v1tov2">https://github.com/PnX-SI/GeoNature/tree/master/data/migrations/v1tov2</a></p>
<ul class="simple">
<li>Import depuis SICEN (ObsOcc) : <a class="reference external" href="https://github.com/PnX-SI/Ressources-techniques/tree/master/GeoNature/migration/sicen">https://github.com/PnX-SI/Ressources-techniques/tree/master/GeoNature/migration/sicen</a></li>
<li>Import depuis SERENA : <a class="reference external" href="https://github.com/PnX-SI/Ressources-techniques/tree/master/GeoNature/migration/serena">https://github.com/PnX-SI/Ressources-techniques/tree/master/GeoNature/migration/serena</a></li>
<li>Import continu : <a class="reference external" href="https://github.com/PnX-SI/Ressources-techniques/tree/master/GeoNature/migration/generic">https://github.com/PnX-SI/Ressources-techniques/tree/master/GeoNature/migration/generic</a></li>
<li>Import d’un CSV historique (Flavia) : <a class="reference external" href="https://github.com/PnX-SI/Ressources-techniques/blob/master/GeoNature/V2/2018-12-csv-vers-synthese-FLAVIA.sql">https://github.com/PnX-SI/Ressources-techniques/blob/master/GeoNature/V2/2018-12-csv-vers-synthese-FLAVIA.sql</a></li>
</ul>
</div>
</div>
<div class="section" id="creation-de-compte">
<h2>Création de compte<a class="headerlink" href="#creation-de-compte" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configuration-de-la-creation-de-compte">
<h3>Configuration de la création de compte<a class="headerlink" href="#configuration-de-la-creation-de-compte" title="Permalink to this headline">¶</a></h3>
<p>Depuis la version 2.1.0, UsersHub propose une API de création de compte utilisateur. Une interface a été ajoutée à GeoNature pour permettre aux futurs utilisateurs de faire des demandes de création de compte depuis la page d’authentification de GeoNature. Ce mode est activable/désactivable depuis la configuration globale de GeoNature.</p>
<p>Pour des raisons de sécurité, l’API de création de compte est réservée aux utilisateurs “admin” grâce à un token secret. GeoNature a donc besoin de se connecter en tant qu’administrateur à UsersHub pour éxecuter les requêtes d’administration de compte.
Renseigner les paramètres suivants dans le fichier de configuration (<code class="docutils literal"><span class="pre">geonature_config.toml</span></code>). L’utilisateur doit avoir des droits 6 dans UsersHub</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">USERSHUB</span><span class="p">]</span>
    <span class="n">URL_USERSHUB</span> <span class="o">=</span> <span class="s1">&#39;http://mon_adresse_usershub.fr&#39;</span> <span class="c1"># sans slash final</span>
    <span class="c1"># Administrateur de mon application</span>
    <span class="n">ADMIN_APPLICATION_LOGIN</span> <span class="o">=</span> <span class="s2">&quot;login_admin_usershub&quot;</span>
    <span class="n">ADMIN_APPLICATION_PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;password_admin_usershub</span>
</pre></div>
</div>
<p>Les fonctionnalités de création de compte nécessitent l’envoi d’emails pour vérifier l’identité des demandeurs de compte. Il est donc nécessaire d’avoir un serveur SMTP capable d’envoyer des emails. Renseigner la rubrique <code class="docutils literal"><span class="pre">MAIL_CONFIG</span></code> de la configuration :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">MAIL_CONFIG</span><span class="p">]</span>
    <span class="n">MAIL_SERVER</span> <span class="o">=</span> <span class="s1">&#39;mail.espaces-naturels.fr&#39;</span>
    <span class="n">MAIL_PORT</span> <span class="o">=</span> <span class="mi">465</span>
    <span class="n">MAIL_USE_TLS</span> <span class="o">=</span> <span class="n">false</span>
    <span class="n">MAIL_USE_SSL</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">MAIL_USERNAME</span> <span class="o">=</span> <span class="s1">&#39;mon_email@email.io&#39;</span>
    <span class="n">MAIL_PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;monpassword&#39;</span>
    <span class="n">MAIL_DEFAULT_SENDER</span> <span class="o">=</span> <span class="s1">&#39;mon_email@email.io&#39;</span>
    <span class="n">MAIL_ASCII_ATTACHMENTS</span> <span class="o">=</span> <span class="n">false</span>
</pre></div>
</div>
<p>Pour activer cette fonctionnalité (qui est par défaut désactivée), modifier le fichier de configuration de la manière suivante :</p>
<p>NB : tous les paramètres décrits ci-dessous doivent être dans la rubrique&nbsp;<code class="docutils literal"><span class="pre">[ACCOUNT_MANAGEMENT]</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ACCOUNT_MANAGEMENT</span><span class="p">]</span>
    <span class="n">ENABLE_SIGN_UP</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>Deux modes sont alors disponibles. Soit l’utilisateur est automatiquement accepté et un compte lui est créé après une confirmation de son email, soit un mail est envoyé à un administrateur pour confirmer la demande. Le compte ne sera crée qu’après validation par l’administrateur. Le paramètre <code class="docutils literal"><span class="pre">AUTO_ACCOUNT_CREATION</span></code> contrôle ce comportement (par défaut le compte créé sans validation par un administrateur: true). Dans le mode “création de compte validé par administrateur”, il est indispensable de renseigner un email où seront envoyés les emails de validation (paramètre <code class="docutils literal"><span class="pre">VALIDATOR_EMAIL</span></code>)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># automatique</span>
<span class="p">[</span><span class="n">ACCOUNT_MANAGEMENT</span><span class="p">]</span>
    <span class="n">ENABLE_SIGN_UP</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">AUTO_ACCOUNT_CREATION</span> <span class="o">=</span> <span class="n">true</span>

<span class="c1"># validé par admin</span>
<span class="p">[</span><span class="n">ACCOUNT_MANAGEMENT</span><span class="p">]</span>
    <span class="n">ENABLE_SIGN_UP</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">AUTO_ACCOUNT_CREATION</span> <span class="o">=</span> <span class="n">false</span>
    <span class="n">VALIDATOR_EMAIL</span> <span class="o">=</span> <span class="s1">&#39;email@validateur.io&#39;</span>
</pre></div>
</div>
<p>L’utilisateur qui demande la création de compte est automatiquement mis dans un “groupe” UsersHub (par défaut, il s’agit du groupe “En poste”). Ce groupe est paramétrable depuis la table <code class="docutils literal"><span class="pre">utilisateurs.cor_role_app_profil</span></code>. (La ligne où <code class="docutils literal"><span class="pre">is_default_group_for_app</span> <span class="pre">=</span> <span class="pre">true</span></code> sera utilisée comme groupe par défaut pour GeoNature). Il n’est pas en paramètre de GeoNature pusqu’il serait falsifiable via l’API. ⚠️ <strong>Attention</strong>, si vous effectuez une migration depuis une version de GeoNature &lt; 2.2.0, aucun groupe par défaut n’est défini, vous devez définir à la main le groupe par défaut pour l’application GeoNature dans la table <code class="docutils literal"><span class="pre">utilisateurs.cor_role_app_profil</span></code>.</p>
<p>Il est également possible de créer automatiquement un jeu de données et un cadre d’acquisition “personnel” à l’utilisateur afin qu’il puisse saisir des données dès sa création de compte via le paramètre <code class="docutils literal"><span class="pre">AUTO_DATASET_CREATION</span></code>. Par la suite l’administrateur pourra rattacher l’utilisateur à des JDD et CA via son organisme.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ACCOUNT_MANAGEMENT</span><span class="p">]</span>
    <span class="n">AUTO_ACCOUNT_CREATION</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">ENABLE_SIGN_UP</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">AUTO_DATASET_CREATION</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
</div>
<div class="section" id="customisation-du-formulaire">
<h3>Customisation du formulaire<a class="headerlink" href="#customisation-du-formulaire" title="Permalink to this headline">¶</a></h3>
<p>Le formulaire de création de compte est par défaut assez minimaliste (nom, prénom, email, mot de passe, organisme, remarque).</p>
<p><em>NB</em> l’organisme est demandé à l’utilisateur à titre “informatif”, c’est à l’administrateur de rattacher individuellement l’utilisateur à son organisme, et éventuellement de le créer, s’il n’existe pas.</p>
<p>Il est possible d’ajouter des champs au formulaire grâce à un générateur controlé par la configuration. Plusieurs type de champs peuvent être ajoutés (text, textarea, number, select, checkbox mais aussi taxonomy, nomenclature etc…).</p>
<p>L’exemple ci-dessous permet de créer un champs de type “checkbox” obligatoire, avec un lien vers un document (une charte par exemple) et un champ de type “select”, non obligatoire. (voir le fichier <code class="docutils literal"><span class="pre">geonature_config.toml.example</span></code> pour un exemple plus exhaustif).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ACCOUNT_MANAGEMENT</span><span class="p">]</span>
<span class="p">[[</span><span class="n">ACCOUNT_MANAGEMENT</span><span class="o">.</span><span class="n">ACCOUNT_FORM</span><span class="p">]]</span>
    <span class="n">type_widget</span> <span class="o">=</span> <span class="s2">&quot;checkbox&quot;</span>
    <span class="n">attribut_label</span> <span class="o">=</span> <span class="s2">&quot;&lt;a target=&#39;_blank&#39; href=&#39;http://docs.geonature.fr&#39;&gt;J&#39;ai lu et j&#39;accepte la charte&lt;/a&gt;&quot;</span>
    <span class="n">attribut_name</span> <span class="o">=</span> <span class="s2">&quot;validate_charte&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">true</span><span class="p">]</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">true</span>

<span class="p">[[</span><span class="n">ACCOUNT_MANAGEMENT</span><span class="o">.</span><span class="n">ACCOUNT_FORM</span><span class="p">]]</span>
    <span class="n">type_widget</span> <span class="o">=</span> <span class="s2">&quot;select&quot;</span>
    <span class="n">attribut_label</span> <span class="o">=</span> <span class="s2">&quot;Exemple select&quot;</span>
    <span class="n">attribut_name</span> <span class="o">=</span> <span class="s2">&quot;select_test&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;value1&quot;</span><span class="p">,</span> <span class="s2">&quot;value2&quot;</span><span class="p">]</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">false</span>
</pre></div>
</div>
</div>
<div class="section" id="espace-utilisateur">
<h3>Espace utilisateur<a class="headerlink" href="#espace-utilisateur" title="Permalink to this headline">¶</a></h3>
<p>Enfin, un espace “utilisateur” est accessible lorsque l’on est connecté, permettant de modifier ses informations personnelles, y compris son mot de passe.</p>
<p>Cet espace est activable grâce au paramètre <code class="docutils literal"><span class="pre">ENABLE_USER_MANAGEMENT</span></code>. Par défaut, il est désactivé.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ACCOUNT_MANAGEMENT</span><span class="p">]</span>
<span class="n">AUTO_ACCOUNT_CREATION</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">ENABLE_SIGN_UP</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">ENABLE_USER_MANAGEMENT</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="module-occtax">
<h2>Module OCCTAX<a class="headerlink" href="#module-occtax" title="Permalink to this headline">¶</a></h2>
<div class="section" id="installer-le-module">
<h3>Installer le module<a class="headerlink" href="#installer-le-module" title="Permalink to this headline">¶</a></h3>
<p>Le module est fourni par défaut avec l’installation de GeoNature.</p>
<p>Si vous l’avez supprimé, lancez les commandes suivantes depuis le repertoire <code class="docutils literal"><span class="pre">backend</span></code> de GeoNature</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">source venv/bin/activate</span>
<span class="go">geonature install_gn_module /home/&lt;mon_user&gt;/geonature/contrib/occtax occtax</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-du-module">
<h3>Configuration du module<a class="headerlink" href="#configuration-du-module" title="Permalink to this headline">¶</a></h3>
<p>Le fichier de configuration du module se trouve ici : <code class="docutils literal"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/external_modules/occtax/config/conf_gn_module.toml</span></code>.</p>
<p>Pour voir l’ensemble des variables de configuration disponibles du module ainsi que leurs valeurs par défaut, ouvrir le fichier <code class="docutils literal"><span class="pre">/home/&lt;mon_user&gt;/geonature/external_modules/occtax/config/conf_gn_module.toml.example</span></code>.</p>
<p>Les surcouches de configuration doivent être faites dans le fichier <code class="docutils literal"><span class="pre">conf_gn_module.toml</span></code>, en ne modifiant jamais le fichier <code class="docutils literal"><span class="pre">conf_gn_module.toml.example</span></code>.</p>
<p>Après toute modification de la configuration d’un module, il faut regénérer le fichier de configuration du frontend comme expliqué ici : <a class="reference internal" href="#configuration-d-un-gn-module">Configuration d’un gn_module</a></p>
<div class="section" id="afficher-masquer-des-champs-du-formulaire">
<h4>Afficher/masquer des champs du formulaire<a class="headerlink" href="#afficher-masquer-des-champs-du-formulaire" title="Permalink to this headline">¶</a></h4>
<p>La quasi-totalité des champs du standard Occurrences de taxons sont présents dans la base de données, et peuvent donc être saisis à partir du formulaire.</p>
<p>Pour plus de souplesse et afin de répondre aux besoins de chacun, l’ensemble des champs sont masquables (sauf les champs essentiels : observateur, taxon …)</p>
<p>En modifiant les variables des champs ci-dessous, vous pouvez donc personnaliser le formulaire :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">form_fields</span><span class="p">]</span>
    <span class="n">date_min</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">date_max</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">hour_min</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">hour_max</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">altitude_min</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">altitude_max</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">obs_technique</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">group_type</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">comment_releve</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">obs_method</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">bio_condition</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">bio_status</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">naturalness</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">exist_proof</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">observation_status</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">diffusion_level</span> <span class="o">=</span> <span class="n">false</span>
    <span class="n">blurring</span> <span class="o">=</span> <span class="n">false</span>
    <span class="n">determiner</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">determination_method</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">sample_number_proof</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">digital_proof</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">non_digital_proof</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">source_status</span> <span class="o">=</span> <span class="n">false</span>
    <span class="n">comment_occ</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">life_stage</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">sex</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">obj_count</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">type_count</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">count_min</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">count_max</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">validation_status</span> <span class="o">=</span> <span class="n">false</span>
</pre></div>
</div>
<p>Si le champ est masqué, une valeur par défaut est inscrite en base (voir plus loin pour définir ces valeurs).</p>
</div>
<div class="section" id="modifier-le-champ-observateurs">
<h4>Modifier le champ Observateurs<a class="headerlink" href="#modifier-le-champ-observateurs" title="Permalink to this headline">¶</a></h4>
<p>Par défaut le champ <code class="docutils literal"><span class="pre">Observateurs</span></code> est une liste déroulante qui pointe vers une liste du schéma <code class="docutils literal"><span class="pre">utilisateurs</span></code>.
Il est possible de passer ce champ en texte libre en mettant à <code class="docutils literal"><span class="pre">true</span></code> la variable <code class="docutils literal"><span class="pre">observers_txt</span></code>.</p>
<p>Le paramètre <code class="docutils literal"><span class="pre">id_observers_list</span></code> permet de changer la liste d’observateurs proposée dans le formulaire. Vous pouvez modifier le numéro de liste du module ou modifier le contenu de la liste dans UsersHub (<code class="docutils literal"><span class="pre">utilisateurs.t_listes</span></code> et <code class="docutils literal"><span class="pre">utilisateurs.cor_role_liste</span></code>)</p>
<p>Par défaut, l’ensemble des observateurs de la liste 9 (observateurs faune/flore) sont affichés.</p>
</div>
<div class="section" id="personnaliser-la-liste-des-taxons-saisissables-dans-le-module">
<h4>Personnaliser la liste des taxons saisissables dans le module<a class="headerlink" href="#personnaliser-la-liste-des-taxons-saisissables-dans-le-module" title="Permalink to this headline">¶</a></h4>
<p>Le module est fourni avec une liste restreinte de taxons (8 seulement). C’est à l’administrateur de changer ou de remplir cette liste.</p>
<p>Le paramètre <code class="docutils literal"><span class="pre">id_taxon_list</span> <span class="pre">=</span> <span class="pre">100</span></code> correspond à un ID de liste de la table <code class="docutils literal"><span class="pre">taxonomie.bib_listes</span></code> (L’ID 100 correspond à la liste “Saisie Occtax”). Vous pouvez changer ce paramètre avec l’ID de liste que vous souhaitez, ou bien garder cet ID et changer le contenu de cette liste.</p>
<p>Voici les requêtes SQL pour remplir la liste 100 avec tous les taxons de Taxref à partir du rang <code class="docutils literal"><span class="pre">genre</span></code> :</p>
<p>Il faut d’abord remplir la table <code class="docutils literal"><span class="pre">taxonomie.bib_noms</span></code> (table des taxons de sa structure), puis remplir la liste 100, avec l’ensemble des taxons de <code class="docutils literal"><span class="pre">bib_noms</span></code> :</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">taxonomie</span><span class="p">.</span><span class="n">cor_nom_liste</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">taxonomie</span><span class="p">.</span><span class="n">bib_noms</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">taxonomie</span><span class="p">.</span><span class="n">bib_noms</span><span class="p">(</span><span class="n">cd_nom</span><span class="p">,</span><span class="n">cd_ref</span><span class="p">,</span><span class="n">nom_francais</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">cd_nom</span><span class="p">,</span> <span class="n">cd_ref</span><span class="p">,</span> <span class="n">nom_vern</span>
<span class="k">FROM</span> <span class="n">taxonomie</span><span class="p">.</span><span class="n">taxref</span>
<span class="k">WHERE</span> <span class="n">id_rang</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;Dumm&#39;</span><span class="p">,</span><span class="s1">&#39;SPRG&#39;</span><span class="p">,</span><span class="s1">&#39;KD&#39;</span><span class="p">,</span><span class="s1">&#39;SSRG&#39;</span><span class="p">,</span><span class="s1">&#39;IFRG&#39;</span><span class="p">,</span><span class="s1">&#39;PH&#39;</span><span class="p">,</span><span class="s1">&#39;SBPH&#39;</span><span class="p">,</span><span class="s1">&#39;IFPH&#39;</span><span class="p">,</span><span class="s1">&#39;DV&#39;</span><span class="p">,</span><span class="s1">&#39;SBDV&#39;</span><span class="p">,</span><span class="s1">&#39;SPCL&#39;</span><span class="p">,</span><span class="s1">&#39;CLAD&#39;</span><span class="p">,</span><span class="s1">&#39;CL&#39;</span><span class="p">,</span>
  <span class="s1">&#39;SBCL&#39;</span><span class="p">,</span><span class="s1">&#39;IFCL&#39;</span><span class="p">,</span><span class="s1">&#39;LEG&#39;</span><span class="p">,</span><span class="s1">&#39;SPOR&#39;</span><span class="p">,</span><span class="s1">&#39;COH&#39;</span><span class="p">,</span><span class="s1">&#39;OR&#39;</span><span class="p">,</span><span class="s1">&#39;SBOR&#39;</span><span class="p">,</span><span class="s1">&#39;IFOR&#39;</span><span class="p">,</span><span class="s1">&#39;SPFM&#39;</span><span class="p">,</span><span class="s1">&#39;FM&#39;</span><span class="p">,</span><span class="s1">&#39;SBFM&#39;</span><span class="p">,</span><span class="s1">&#39;TR&#39;</span><span class="p">,</span><span class="s1">&#39;SSTR&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">taxonomie</span><span class="p">.</span><span class="n">cor_nom_liste</span> <span class="p">(</span><span class="n">id_liste</span><span class="p">,</span><span class="n">id_nom</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="mi">100</span><span class="p">,</span><span class="n">n</span><span class="p">.</span><span class="n">id_nom</span> <span class="k">FROM</span> <span class="n">taxonomie</span><span class="p">.</span><span class="n">bib_noms</span> <span class="n">n</span><span class="p">;</span>
</pre></div>
</div>
<p>Il est également possible d’éditer des listes à partir de l’application TaxHub.</p>
</div>
<div class="section" id="gerer-les-valeurs-par-defaut-des-nomenclatures">
<h4>Gérer les valeurs par défaut des nomenclatures<a class="headerlink" href="#gerer-les-valeurs-par-defaut-des-nomenclatures" title="Permalink to this headline">¶</a></h4>
<p>Le formulaire de saisie pré-remplit des valeurs par défaut pour simplifier la saisie. Ce sont également ces valeurs qui sont prises en compte pour remplir dans la BDD les champs du formulaire qui sont masqués.</p>
<p>La table <code class="docutils literal"><span class="pre">pr_occtax.defaults_nomenclatures_value</span></code> définit les valeurs par défaut pour chaque nomenclature.</p>
<p>La table contient les deux colonnes suivantes :</p>
<ul class="simple">
<li>l’<code class="docutils literal"><span class="pre">id_type</span></code> de nomenclature (voir table <code class="docutils literal"><span class="pre">ref_nomenclature.bib_nomenclatures_types</span></code>)</li>
<li>l’<code class="docutils literal"><span class="pre">id_nomenclature</span></code> (voir table <code class="docutils literal"><span class="pre">ref_nomenclature.t_nomenclatures</span></code>)</li>
</ul>
<p>Pour chaque type de nomenclature, on associe l’ID de la nomenclature que l’on souhaite voir apparaitre par défaut.</p>
<p>Le mécanisme peut être poussé plus loin en associant une nomenclature par défaut par organisme, règne et group2_inpn.
La valeur 0 pour ses champs revient à mettre la valeur par défaut pour tous les organismes, tous les règnes et tous les group2_inpn.</p>
<p>Une interface de gestion des nomenclatures est prévue d’être développée pour simplifier cette configuration.</p>
<p>TODO : valeur par défaut de la validation</p>
</div>
<div class="section" id="personnaliser-l-interface-map-list">
<h4>Personnaliser l’interface Map-list<a class="headerlink" href="#personnaliser-l-interface-map-list" title="Permalink to this headline">¶</a></h4>
<p>La liste des champs affichés par défaut dans le tableau peut être modifiée avec le paramètre <code class="docutils literal"><span class="pre">default_maplist_columns</span></code>.</p>
<p>Par défaut :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">default_maplist_columns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span> <span class="n">prop</span> <span class="o">=</span> <span class="s2">&quot;taxons&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Taxon&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">prop</span> <span class="o">=</span> <span class="s2">&quot;date_min&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Date début&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">prop</span> <span class="o">=</span> <span class="s2">&quot;observateurs&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Observateurs&quot;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">prop</span> <span class="o">=</span> <span class="s2">&quot;dataset_name&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Jeu de données&quot;</span> <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Voir la vue <code class="docutils literal"><span class="pre">occtax.v_releve_list</span></code> pour voir les champs disponibles.</p>
</div>
<div class="section" id="ajouter-une-contrainte-d-echelle-de-saisie-sur-la-carte">
<h4>Ajouter une contrainte d’échelle de saisie sur la carte<a class="headerlink" href="#ajouter-une-contrainte-d-echelle-de-saisie-sur-la-carte" title="Permalink to this headline">¶</a></h4>
<p>Il est possible de contraindre la saisie de la géométrie d’un relevé sur la carte par un seuil d’échelle minimum avec le paramètre <code class="docutils literal"><span class="pre">releve_map_zoom_level</span></code>.</p>
<p>Par défaut :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Zoom level on the map from which you can add point/line/polygon</span>
<span class="n">releve_map_zoom_level</span> <span class="o">=</span> <span class="mi">6</span>
</pre></div>
</div>
<p>Il suffit de modifier la valeur qui correspond au niveau de zoom sur la carte.
Par exemple, pour contraindre la saisie à l’affichage de la carte IGN au 1/25000e :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">releve_map_zoom_level</span> <span class="o">=</span> <span class="mi">15</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="gestion-des-exports">
<h3>Gestion des exports<a class="headerlink" href="#gestion-des-exports" title="Permalink to this headline">¶</a></h3>
<p>Les exports du module sont basés sur une vue (par défaut <code class="docutils literal"><span class="pre">pr_occtax.export_occtax_sinp</span></code>)</p>
<p>Il est possible de définir une autre vue pour avoir des exports personnalisés.
Pour cela, créer votre vue, et modifier les paramètres suivants :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Name of the view based export</span>
<span class="n">export_view_name</span> <span class="o">=</span> <span class="s1">&#39;export_occtax_sinp&#39;</span>

<span class="c1"># Name of the geometry columns of the view</span>
<span class="n">export_geom_columns_name</span> <span class="o">=</span> <span class="s1">&#39;geom_4326&#39;</span>

<span class="c1"># Name of the primary key column of the view</span>
<span class="n">export_id_column_name</span> <span class="o">=</span> <span class="s1">&#39;permId&#39;</span>
</pre></div>
</div>
<p>La vue doit cependant contenir les champs suivants pour que les filtres de recherche fonctionnent :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">date_min</span><span class="p">,</span>
<span class="n">date_max</span><span class="p">,</span>
<span class="n">id_releve_occtax</span><span class="p">,</span>
<span class="n">id_dataset</span><span class="p">,</span>
<span class="n">id_occurrence_occtax</span><span class="p">,</span>
<span class="n">id_digitiser</span><span class="p">,</span>
<span class="n">geom_4326</span><span class="p">,</span>
<span class="n">dataset_name</span>
</pre></div>
</div>
</div>
<div class="section" id="attribuer-des-droits">
<h3>Attribuer des droits<a class="headerlink" href="#attribuer-des-droits" title="Permalink to this headline">¶</a></h3>
<p>La gestion des droits (CRUVED) se fait module par module. Cependant si on ne redéfinit pas de droit pour un module, ce sont les droits de l’application mère (GeoNature elle-même) qui seront attribués à l’utilisateur pour l’ensemble de ses sous-modules.</p>
<p>Pour ne pas afficher le module Occtax à un utilisateur où à un groupe, il faut lui mettre l’action Read (R) à 0.</p>
<p>L’administration des droits des utilisateurs pour le module Occtax se fait dans le backoffice de gestion des permissions de GeoNature.</p>
</div>
</div>
<div class="section" id="module-occhab">
<h2>Module OCCHAB<a class="headerlink" href="#module-occhab" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Installer le module<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Le module OCCHAB fait parti du coeur de GeoNature. Son installation est au choix de l’administrateur.</p>
<p>Pour l’installer, lancer les commande suivante:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">cd backend</span>
<span class="go">source venv/bin/activate</span>
<span class="go">geonature install_gn_module /home/`whoami`/geonature/contrib/gn_module_occhab occtax</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Base de données<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Le module s’appuie sur deux schémas.:
<code class="docutils literal"><span class="pre">ref_habitats</span></code>:  Le réferentiel habitat du MNHN
<code class="docutils literal"><span class="pre">pr_occhab</span></code>: le schéma qui contient les données d’occurrence d’habitat, basé sur standard du MNHN</p>
</div>
<div class="section" id="id3">
<h3>Configuration<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>Le parametrage du module OCCHAB se fait depuis le fichier <code class="docutils literal"><span class="pre">/home/`whoami`/geonature/contrib/config/conf_gn_module.toml</span></code>
Après toute modification de la configuration d’un module, il faut regénérer le fichier de configuration du frontend comme expliqué ici : <a class="reference internal" href="#configuration-d-un-gn-module">Configuration d’un gn_module</a></p>
<div class="section" id="formulaire">
<h4>Formulaire<a class="headerlink" href="#formulaire" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>La liste des habitats fournit pour la saisie est basé sur une liste définit en base de données (table <code class="docutils literal"><span class="pre">ref_habitat.cor_list_habitat</span></code> et <code class="docutils literal"><span class="pre">ref_habitat.bib_list_habitat</span></code>). Il est possible d’éditer cette liste directement den base de données, d’en créer une autre et de changer la liste utiliser par le module. Editer alors ce paramètre:</li>
</ul>
<p><code class="docutils literal"><span class="pre">ID_LIST_HABITAT</span> <span class="pre">=</span> <span class="pre">1</span></code></p>
<ul class="simple">
<li>Le formulaire permet de saisir des observateur basés sur le referentiel utilisateurs ( <code class="docutils literal"><span class="pre">false</span></code>) ou de les saisir en texte libre (<code class="docutils literal"><span class="pre">true</span></code>).</li>
</ul>
<p><code class="docutils literal"><span class="pre">OBSERVER_AS_TXT</span> <span class="pre">=</span> <span class="pre">false</span></code></p>
<ul class="simple">
<li>L’ensemble des champs du formulaire son masquables. Pour en masquer certains, passer à <code class="docutils literal"><span class="pre">false</span></code> les variables suivantes:</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">formConfig</span><span class="p">]</span>
  <span class="n">date_min</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">date_max</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">depth_min</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">depth_max</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">altitude_min</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">altitude_max</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">exposure</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">area</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">comment</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">area_surface_calculation</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">geographic_object</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">determination_type</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">determiner</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">collection_technique</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">technical_precision</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">recovery_percentage</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">abundance</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">community_interest</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>Voir le fichier <code class="docutils literal"><span class="pre">conf_gn_module.toml.example</span></code> qui liste l’ensemble des paramètres de configuration du module.</p>
</div>
</div>
</div>
<div class="section" id="module-synthese">
<h2>Module SYNTHESE<a class="headerlink" href="#module-synthese" title="Permalink to this headline">¶</a></h2>
<p>Le module Synthèse est un module du coeur de GeoNature, fourni par défaut lors de l’installation.</p>
<div class="section" id="id4">
<h3>Configuration<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>L’ensemble des paramètres de configuration du module se trouve dans le fichier général de configuration de GeoNature <code class="docutils literal"><span class="pre">config/geonature_config.toml</span></code> puisqu’il s’agit d’un module du coeur.</p>
<p><strong>1.</strong> Modifier les filtres géographiques disponibles par défaut dans l’interface de recherche.</p>
<p>Editer la variable <code class="docutils literal"><span class="pre">AREA_FILTERS</span></code> en y ajoutant le label et l’ID du type d’entité géographique que vous souhaitez rajouter. Voir table <code class="docutils literal"><span class="pre">ref_geo.bib_areas_types</span></code>. Dans l’exemple on ajoute le type ZNIEFF1 (<code class="docutils literal"><span class="pre">id_type</span> <span class="pre">=</span> <span class="pre">3</span></code>). Attention, dans ce cas les entités géographiques correspondantes au type 3, doivent également être présentes dans la table <code class="docutils literal"><span class="pre">ref_geo.l_areas</span></code>.
Attention : Si des données sont déjà présentes dans la synthèse et que l’on ajoute de nouvelles entités géographiques à <code class="docutils literal"><span class="pre">ref_geo.l_areas</span></code>, il faut également recalculer les valeurs de la table <code class="docutils literal"><span class="pre">gn_synthese.cor_area_synthese</span></code> qui assure la correspondance entre les données de la synthèse et les entités géographiques.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">SYNTHESE</span><span class="p">]</span>
    <span class="c1"># Liste des entités géographiques sur lesquels les filtres</span>
    <span class="c1"># géographiques de la synthese s&#39;appuient (id_area = id de l&#39;entité géo, table ref_geo.bib_areas_types)</span>
    <span class="n">AREA_FILTERS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Communes&quot;</span><span class="p">,</span> <span class="n">id_type</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;ZNIEFF1&quot;</span><span class="p">,</span> <span class="n">id_type</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>Il est aussi possible de passer plusieurs <code class="docutils literal"><span class="pre">id_types</span></code> regroupés dans un même filtre géographique (exemple : <code class="docutils literal"><span class="pre">{</span> <span class="pre">label</span> <span class="pre">=</span> <span class="pre">&quot;Zonages</span> <span class="pre">réglementaires&quot;,</span> <span class="pre">id_type</span> <span class="pre">=</span> <span class="pre">[22,</span> <span class="pre">23]</span> <span class="pre">}</span></code>).</p>
<p><strong>2.</strong> Configurer les champs des exports</p>
<p>Dans tous les exports, l’ordre et le nom des colonnes sont basés sur la vue servant l’export. Il est possible de les modifier en éditant le SQL des vues en respectant bien les consignes ci-dessous.</p>
<p><strong>Export des observations</strong></p>
<p>Les exports (CSV, GeoJson, Shapefile) sont basés sur la vue <code class="docutils literal"><span class="pre">gn_synthese.v_synthese_for_export</span></code>.</p>
<p>Il est possible de masquer des champs présents dans les exports. Pour cela éditez la variable <code class="docutils literal"><span class="pre">EXPORT_COLUMNS</span></code>.</p>
<p>Enlevez la ligne de la colonne que vous souhaitez désactiver. Les noms de colonne de plus de 10 caractères seront tronqués dans le fichier shapefile.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">SYNTHESE</span><span class="p">]</span>
    <span class="n">EXPORT_COLUMNS</span>   <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;idSynthese&quot;</span><span class="p">,</span>
        <span class="s2">&quot;permId&quot;</span><span class="p">,</span>
        <span class="s2">&quot;permIdGrp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dateDebut&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dateFin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;observer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;altMin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;altMax&quot;</span><span class="p">,</span>
        <span class="s2">&quot;denbrMin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;denbrMax&quot;</span><span class="p">,</span>
        <span class="s2">&quot;EchanPreuv&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PreuvNum&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PreuvNoNum&quot;</span><span class="p">,</span>
        <span class="s2">&quot;obsCtx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;obsDescr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ObjGeoTyp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;methGrp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;obsMeth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocEtatBio&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocStatBio&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocNat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;preuveOui&quot;</span><span class="p">,</span>
        <span class="s2">&quot;validStat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;difNivPrec&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocStade&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ocSex&quot;</span><span class="p">,</span>
        <span class="s2">&quot;objDenbr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;denbrTyp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sensiNiv&quot;</span><span class="p">,</span>
        <span class="s2">&quot;statObs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dEEFlou&quot;</span><span class="p">,</span>
        <span class="s2">&quot;statSource&quot;</span><span class="p">,</span>
        <span class="s2">&quot;typInfGeo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;methDeterm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;jddCode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cdNom&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cdRef&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nomCite&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vTAXREF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;wkt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lastAction&quot;</span><span class="p">,</span>
        <span class="s2">&quot;validateur&quot;</span>
    <span class="p">]</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Note:</th><td class="field-body">L’entête <code class="docutils literal"><span class="pre">[SYNTHESE]</span></code> au dessus <code class="docutils literal"><span class="pre">EXPORT_COLUMNS</span></code> indique simplement que cette variable appartient au bloc de configuration de la synthese. Ne pas rajouter l’entête à chaque paramètre de la synthese mais une seule fois au dessus de toutes les variables de configuration du module.</td>
</tr>
</tbody>
</table>
<p>Il est également possible de personnaliser ses exports en éditant le SQL de la vue <code class="docutils literal"><span class="pre">gn_synthese.v_synthese_for_export</span></code> (niveau SQL et administration GeoNature avancé).</p>
<p>Attention, certains champs sont cependant obligatoires pour assurer la réalisation des fichiers d’export (csv, geojson et shapefile) et des filtres CRUVED.</p>
<p>La vue doit OBLIGATOIREMENT contenir les champs :</p>
<ul class="simple">
<li>geojson_4326</li>
<li>geojson_local</li>
<li>idSynthese,</li>
<li>jddId (l’ID du jeu de données)</li>
<li>id_digitiser</li>
<li>observer</li>
</ul>
<p>Ces champs doivent impérativement être présents dans la vue, mais ne seront pas nécessairement dans le fichier d’export si ils ne figurent pas dans la variable <code class="docutils literal"><span class="pre">EXPORT_COLUMNS</span></code>. De manière générale, préférez rajouter des champs plutôt que d’en enlever !</p>
<p>Le nom de ces champs peuvent cependant être modifié. Dans ce cas, modifiez le fichier <code class="docutils literal"><span class="pre">geonature_config.toml</span></code>, section <code class="docutils literal"><span class="pre">SYNTHESE</span></code> parmis les variables suivantes (<code class="docutils literal"><span class="pre">EXPORT_ID_SYNTHESE_COL,</span> <span class="pre">EXPORT_ID_DATASET_COL,</span> <span class="pre">EXPORT_ID_DIGITISER_COL,</span> <span class="pre">EXPORT_OBSERVERS_COL,</span> <span class="pre">EXPORT_GEOJSON_4326_COL,</span> <span class="pre">EXPORT_GEOJSON_LOCAL_COL</span></code>).</p>
<p>NB: Lorsqu’on effectue une recherche dans la synthèse, on interroge la vue <code class="docutils literal"><span class="pre">gn_synthese.v_synthese_for_web_app</span></code>. L’interface web passe ensuite une liste d’<code class="docutils literal"><span class="pre">id_synthese</span></code> à la vue <a href="#id5"><span class="problematic" id="id6">``</span></a>gn_synthese.v_synthese_for_export``correspondant à la recherche précedemment effectuée (ce qui permet à cette seconde vue d’être totalement modifiable).</p>
<p>La vue <code class="docutils literal"><span class="pre">gn_synthese.v_synthese_for_web_app</span></code> est taillée pour l’interface web, il ne faut donc PAS la modifier.</p>
<p><strong>Export des métadonnées</strong></p>
<p>En plus des observations brutes, il est possible d’effectuer un export des métadonnées associées aux observations. L’export est au format CSV et est construit à partir de la table <code class="docutils literal"><span class="pre">gn_synthese.v_metadata_for_export</span></code>. Vous pouvez modifier le SQL de création de cette vue pour customiser votre export (niveau SQL avancé).</p>
<p>Deux champs sont cependant obligatoire dans la vue :</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">jdd_id</span></code> (qui corespond à l’id du JDD de la table <code class="docutils literal"><span class="pre">gn_meta.t_datasets</span></code>). Le nom de ce champs est modifiable. Si vous le modifiez, éditez la variable <code class="docutils literal"><span class="pre">EXPORT_METADATA_ID_DATASET_COL</span></code>.</li>
<li><code class="docutils literal"><span class="pre">acteurs</span></code>:  Le nom de ce champs est modifiable. Si vous le modifiez, éditez la variable <code class="docutils literal"><span class="pre">EXPORT_METADATA_ACTOR_COL</span></code></li>
</ul>
<p><strong>Export des statuts taxonomiques (réglementations)</strong></p>
<p>Cet export n’est pas basé sur une vue, il n’est donc pas possible de l’adapter.</p>
<p><strong>3.</strong> Configurer les seuils du nombre de données pour la recherche et les exports</p>
<p>Par défaut et pour des questions de performance (du navigateur et du serveur) on limite à 50000 le nombre de résultat affiché sur la carte et le nombre d’observations dans les exports.</p>
<p>Ces seuils sont modifiables respectivement par les variables <code class="docutils literal"><span class="pre">NB_MAX_OBS_MAP</span></code> et <code class="docutils literal"><span class="pre">NB_MAX_OBS_EXPORT</span></code> :</p>
<p>Le mode cluster activé par défaut peut être désactivé via le paramètre <code class="docutils literal"><span class="pre">ENABLE_LEAFLET_CLUSTER</span></code>. Dans ce cas, il est conseillé de repasser le paramètre <cite>NB_MAX_OBS_MAP</cite> à 10000.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">SYNTHESE</span><span class="p">]</span>
    <span class="c1"># Nombre d&#39;observation maximum à afficher sur la carte après une recherche</span>
    <span class="n">NB_MAX_OBS_MAP</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="c1"># Nombre max d&#39;observation dans les exports</span>
    <span class="n">NB_MAX_OBS_EXPORT</span> <span class="o">=</span> <span class="mi">40000</span>
</pre></div>
</div>
<p><strong>4.</strong> Désactiver des filtres génériques</p>
<p>L’interface de recherche de la synthèse permet de filtrer sur l’ensemble des nomenclatures de la table <code class="docutils literal"><span class="pre">gn_synthese</span></code>, il est cependant possible de désactiver les filtres de certains champs.</p>
<p>Modifiez la variable <code class="docutils literal"><span class="pre">EXCLUDED_COLUMNS</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">SYNTHESE</span><span class="p">]</span>
    <span class="n">EXCLUDED_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;non_digital_proof&#39;</span><span class="p">]</span> <span class="c1"># pour enlever le filtre &#39;preuve non numérique&#39;</span>
</pre></div>
</div>
<p>D’autres élements sont paramètrables dans le module synthese. La liste complète est disponible dans le fichier <code class="docutils literal"><span class="pre">config/geonature_config.toml</span></code> rubrique <code class="docutils literal"><span class="pre">SYNTHESE</span></code>.</p>
</div>
</div>
<div class="section" id="module-validation">
<h2>Module VALIDATION<a class="headerlink" href="#module-validation" title="Permalink to this headline">¶</a></h2>
<p>Le module VALIDATION, integré depuis la version 2.1.0 dans le coeur de GeoNature permet de valider des occurrences de taxon en s’appuyant sur les données présentes dans la SYNTHESE. Le module s’appuie sur le <a class="reference external" href="http://www.naturefrance.fr/la-reunion/protocole-de-validation">standard Validation</a> du SINP et sur ses <a class="reference external" href="http://standards-sinp.mnhn.fr/nomenclature/80-niveaux-de-validation-validation-manuelle-ou-combinee-2018-05-14/">nomenclatures officiels</a>.</p>
<p>Afin de valider une occurrence, celle-ci doit impérativement avoir un UUID. En effet, la validation est stockée en BDD dans la table transversale <code class="docutils literal"><span class="pre">gn_commons.t_validations</span></code>  (<a class="reference external" href="admin-manual.html#tables-transversales">voir doc</a> ) qui impose la présence de cet UUID.</p>
<p>La table <code class="docutils literal"><span class="pre">gn_commons.t_validations</span></code> contient l’ensemble de l’historique de validation des occurrences. Pour une même occurrence (identifiée par un UUID unique) on peut donc retrouver plusieurs lignes dans la table correspondant au différents statuts de validation attribués à cet occurrence dans le temps.</p>
<p>La vue <code class="docutils literal"><span class="pre">gn_commons.v_latest_validation</span></code> permet de récupérer le dernier statut de validation d’une occurrence.</p>
<p>NB : une donnée non présente dans la SYNTHESE, ne remontera pas dans l’interface du module VALIDATION. Cependant rien n’empêche un administrateur avancé d’utiliser la table de validation et son mécanisme pour des données qui ne seraient pas en SYNTHESE (du moment que les données disposent d’un UUID).</p>
<p>Au niveau de l’interface, le formulaire de recherche est commun avec le module SYNTHESE. Les paramètres de configuration du formulaire sont donc également partagés et administrables depuis le fichier <code class="docutils literal"><span class="pre">geonature_config.toml</span></code>, rubrique SYNTHESE.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="import-level-1.html" class="btn btn-neutral float-right" title="IMPORT NIVEAU 1" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="user-manual.html" class="btn btn-neutral float-left" title="MANUEL UTILISATEUR" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2019, PnE, PnC

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>