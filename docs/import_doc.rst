
Module d’import
===============
Ce module permet d’importer des données depuis un fichier CSV dans [GeoNature](https://github.com/PnX-SI/GeoNature).


Configuration du module
=======================

Vous pouvez modifier la configuration du module dans le fichier
`geonature_config.toml` dans le dossier `config` de GeoNature, en vous inspirant 
du fichier `default_config.toml.example` et en surcouchant les paramètres que vous souhaitez
(champs affichés en interface à l'étape 1, préfixe des champs ajoutés par le module,
répertoire d'upload des fichiers, SRID, encodage, séparateurs, etc).

Pour appliquer les modifications de la configuration du module, consultez 
la [rubrique dédiée de la documentation de GeoNature](https://docs.geonature.fr/installation.html#module-config).

Configuration avancée
---------------------

Une autre partie se fait directement dans la base de données, dans les
tables `dict_fields` et `dict_themes`, permettant de masquer, ajouter,
ou rendre obligatoire certains champs à renseigner pour l'import. Un
champs masqué sera traité comme un champs non rempli, et se verra
associer des valeurs par défaut ou une information vide. Il est
également possible de paramétrer l'ordonnancement des champs (ordre,
regroupements dans des blocs) dans l'interface du mapping de champs. A
l'instar des attributs gérés dans TaxHub, il est possible de définir
des "blocs" dans la table `gn_imports.dict_themes`, et d'y attribuer
des champs (`dict_fields`) en y définissant leur ordre d'affichage.

Permissions du module
=====================

La gestions des permissions dans le module d'import se fait via le réglage
du CRUVED à deux niveaux : au niveau de l'objet "import" et au
niveau de l'objet "mapping".

-   Le CRUVED sur l'objet "import" permet de gérer
    l'affichage des imports. Une personne ayant un R = 3 verra tous les
    imports de la plateforme, un R = 2 seulement les siens et ceux de son organisme
    et un R = 1 seulement les siens.
-   Les jeux de données selectionnables par un utilisateur lors de la
    création d'un import sont eux controlés par les permissions
    sur le C de l'objet "import" (combiné au R du module "Métadonnées).
-   Les mappings constituent un "objet" du module d'import disposant
    de droits paramétrables pour les différents utilisateurs,
    indépendamment des permissions sur les imports. Le réglage des
    permissions se fait dans le module "Admin" de GeoNature ("Admin" -\>
    "Permissions").
-   Certains mappings sont définis comme "public" et sont vus par tout
    le monde. Seuls les administrateurs (U=3) et les propriétaires de ces
    mappings peuvent les modifier.
-   Par exemple, avec un C = 1, R = 2, U = 1 sur les mappings, un utilisateur pourra créer
    des nouveaux mappings (des modèles d'imports), modifier ses propres
    mappings et voir les mappings de son organisme ainsi que les
    mappings "publics".
-   Si vous modifiez un mapping sur lequel vous n'avez pas les droits,
    il vous sera proposé de créer un nouveau mapping vous appartenant
    avec les modifications que vous avez faites, mais sans modifier le
    mapping initial. Lorsqu'on a les droits de modification sur un mapping,
    il est également possible de ne pas enregistrer les modifications
    faites à celui-ci pour ne pas écraser le mapping inital (le mapping
    sera sauvegardé uniquement avec l’import).

Contrôles et transformations
============================
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Name                                          | Description                                                                                                                                                                                                                                                        | Step                | Type                |
+===============================================+====================================================================================================================================================================================================================================================================+=====================+=====================+
| file_name_error                               | Le nom du fichier ne contient que des chiffres                                                                                                                                                                                                                     | upload              | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| file_name_error                               | Le nom du fichier commence par un chiffre                                                                                                                                                                                                                          | upload              | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| file_name_error                               | Le nom du fichier fait plus de 50 caractères                                                                                                                                                                                                                       | upload              | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| no_data                                       | Aucune données n'est présente dans le fichier                                                                                                                                                                                                                      | upload              | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| extension_error                               | L'extenstion du fichier n'est pas .csv ou .geojson                                                                                                                                                                                                                 | upload              | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| no_file                                       | Aucun fichier détecté                                                                                                                                                                                                                                              | upload              | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| empty                                         | Auncun fichier envyé                                                                                                                                                                                                                                               | upload              | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| max_size                                      | La taille du fichier est plus grande que la taille définit en paramètre                                                                                                                                                                                            | upload              | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| source-error(goodtables lib)                  | Erreur de lecture du fichier lié à une inconsistence de données.                                                                                                                                                                                                   | csv                 | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| format-error(goodtables lib)                  | Erreur de lecture (format des données incorrect).                                                                                                                                                                                                                  | csv                 | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| encoding-error(goodtables lib)                | Erreur de lecture (problème d'encodage).                                                                                                                                                                                                                           | csv                 | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| blank-header(goodtables lib)                  | Il existe une colonne vide dans les noms de colonnes.                                                                                                                                                                                                              | csv                 | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| duplicate-header(goodtables lib)              | Plusieurs colonnes ont le même nom                                                                                                                                                                                                                                 | csv                 | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| blank-row(goodtables lib)                     | Une ligne doit avoir au moins une colonne non vide.                                                                                                                                                                                                                | csv                 | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| duplicate-row(goodtables lib)                 | Ligne dupliquée.                                                                                                                                                                                                                                                   | csv                 | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| extra-value(goodtables lib)                   | Une ligne a plus de colonne que l'entête                                                                                                                                                                                                                           | csv                 | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| missing-value(goodtables lib)                 | Une ligne a moins de colonne que l'entête.                                                                                                                                                                                                                         | csv                 | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| wrong id_dataset                              | L'utilisateur n'as pas les droits d'importer dans ce JDD (à vérifier/implémenter ?)                                                                                                                                                                                | load raw data to db | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| psycopg2.errors.BadCopyFileFormat             | Erreur lié à un problème de séparateur                                                                                                                                                                                                                             | load row data to db | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| missing_value                                 | Valeur manquante pour un champ obligatoire                                                                                                                                                                                                                         | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| incorrect_date                                | Format de date incorrect - Format attendu est YYYY-MM-DD ou DD-MM-YYYY (les heures sont acceptées sous ce format: HH:MM:SS)                                                                                                                                        | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| incorrect_uuid                                | Format d'UUID incorrect                                                                                                                                                                                                                                            | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| incorrect_length                              | Chaine de charactère trop longue par rapport au champs de destination                                                                                                                                                                                              | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| incorrect_integer                             | Valeur incorect (ou négative) pour un champs de type entier                                                                                                                                                                                                        | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| incorrect_cd_nom                              | Le cd_nom fourni n'est pas présent dans le taxref de l'instance                                                                                                                                                                                                    | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| incorrect_cd_hab                              | Le cd_hab fourni n'est pas présent dans le habref de l'instance                                                                                                                                                                                                    | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| date_min > date_max                           | date min > date_max                                                                                                                                                                                                                                                | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| missing_uuid                                  | UUID manquant (si calculer les UUID n'est pas coché)                                                                                                                                                                                                               | data cleaning       | warning             |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| duplicated uuid                               | L'UUID fourni est déjà présent en base (dans la table synthese) - désactivable pour les instances avec beaucoup de données: paramètre `ENABLE_SYNTHESE_UUID_CHECK`                                                                                                 | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| unique_id_sinp missing column                 | Si pas de colonne UUID fournie est que "calculer les UUID" est activé, on crée une colonne et on crée des UUID dedans                                                                                                                                              | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| unique_id_sinp missing values                 | Si UUID manquant dans une colonne UUID fournie et que "calculer les UUID" est activé, on calcul un UUID pour les valeurs manquantes                                                                                                                                | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| missing count_min value                       | Si des valeurs sont manquantes pour denombrement_min, la valeur est remplacée par le paramètre DEFAULT_COUNT_VALUE                                                                                                                                                 | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| missing count_max values                      | Si des valeurs sont manquantes pour denombrement_min, on met denombrement_min = denombrement_max                                                                                                                                                                   | data cleaning       | checks and correct  |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| missing count_min column                      | Si pas de colonne dénombrement_min, on cree une colonne et on met la valeur du paramètre DEFAULT_COUNT_VALUE                                                                                                                                                       | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| missing count_max column                      | Si pas de colonne denombrement_max on cree une colonne et on met denombrement_min = denombrement_max                                                                                                                                                               | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| missing altitude_min and altitude_max columns | Creation de colonne et calcul si 'calcul des altitudes' est coché                                                                                                                                                                                                  | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| missing altitude_min or altitude_max values   | Les altitdes sont calculées pour les valeurs manquantes si l'option est activée                                                                                                                                                                                    | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| altitude_min > altitude_max                   | altitude_min > altitude_max                                                                                                                                                                                                                                        | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| profondeur_min > profondeur_max               | profondeur_min > profondeur_max                                                                                                                                                                                                                                    | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| count_min > count_max                         | count_min > count_max                                                                                                                                                                                                                                              | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| entity_source_pk column missing               | Si pas de colonne fournie, création d'une colonne remplie avec un serial "gn_pk"                                                                                                                                                                                   | data cleaning       | checks and corrects |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| entity_source_pk duplicated                   | entity_source_pk value dupliqué                                                                                                                                                                                                                                    | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| incorrect_real                                | Valeur incorect pour un réel                                                                                                                                                                                                                                       | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| geometry_out_of_box                           | Coordonnées géographiques en dehors de la bounding-box de l'instance (paramètre: `INSTANCE_BOUNDING_BOX` - desactivable via paramètre `ENABLE_BOUNDING_BOX_CHECK`                                                                                                  | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| geometry_out_of_projection                    | Coordonnées géographiques en dehors du système de projection fourni                                                                                                                                                                                                | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| multiple_code_attachment                      | Plusieurs code de rattachement fourni pour une seule colonne (Ex code_commune = 05005, 05003)                                                                                                                                                                      | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| multiple_attachment_type_code                 | Plusieurs code de rattachement fourni pour une seule ligne (code commune + code maille par ex)                                                                                                                                                                     | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| code rattachement invalid                     | Le code de rattachement (code maille/département/commune) n'est pas dans le référentiel géographiques de GeoNature                                                                                                                                                 | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Erreur de nomenclature                        | Code nomenclature erroné ; La valeur du champ n’est pas dans la liste des codes attendus pour ce champ.                                                                                                                                                            | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Erreur de géometrie                           | Géométrie invalide ; la valeur de la géométrie ne correspond pas au format WKT.                                                                                                                                                                                    | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Géoréférencement manquant                     | Géoréférencement manquant ; un géoréférencement doit être fourni, c’est à dire qu’il faut livrer : soit une géométrie, soit une ou plusieurs commune(s), ou département(s), ou maille(s)                                                                           | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Preuve numérique incorect                     | La preuve numérique fournie n'est pas une URL                                                                                                                                                                                                                      | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Erreur champs conditionnel (désactivable)     | Le champ dEEFloutage doit être remplit si le jeu de données est privé                                                                                                                                                                                              | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Erreur champs conditionnel (désactivable)     | Le champ reference_biblio doit être remplit si le statut source est 'Littérature'                                                                                                                                                                                  | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Erreur champs preuve (désactivable)           | si le champ “preuveExistante” vaut oui, alors l’un des deux champs “preuveNumérique” ou “preuveNonNumérique” doit être rempli. A l’inverse, si l’un de ces deux champs est rempli, alors “preuveExistante” ne doit pas prendre une autre valeur que “oui” (code 1) | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Erreur de rattachement(1) - désactivable      | Vérifie que si type_info_geo = 1 (Géoréférencement) alors aucun rattachement n'est fourni                                                                                                                                                                          | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+
| Erreur de rattachement(2) - désactivable      | Si une entitié de rattachement est fourni alors le type_info_geo ne doit pas être null                                                                                                                                                                             | data cleaning       | error               |
+-----------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+---------------------+



Utilisation du module d'imports
================================

Note : le processus a un petit peu évoluer en v2 avec notamment une
étape supplémentaire.

Le module permet de traiter un fichier CSV 
(GeoJSON non disponible dans la v2 pour le moment) sous toute
structure de données, d'établir les correspondances nécessaires entre
le format source et le format de la synthèse, et de traduire le
vocabulaire source vers les nomenclatures SINP. Il stocke et archive les
données sources et intègre les données transformées dans la synthèse de
GeoNature. Il semble préférable de prévoir un serveur disposant à minima
de 4 Go de RAM.

1.  Une fois connecté à GeoNature, accédez au module Imports. L'accueil
    du module affiche une liste des imports en cours ou terminés, selon
    les permissions de l'utilisateur connecté. Vous pouvez alors finir un
    import en cours, ou bien commencer un nouvel import.

    .. image:: https://geonature.fr/docs/img/import/gn_imports-01.jpg

2.  Choisissez à quel JDD les données importées vont être associées. Si
    vous souhaitez les associer à un nouveau JDD, il faut l'avoir créé
    au préalable dans le module Métadonnées.

    .. image:: https://geonature.fr/docs/img/import/gn_imports-02.jpg

3.  Chargez le fichier CSV (GeoJSON non disponible dans la v2 pour le moment) à importer.

    .. image:: https://geonature.fr/docs/img/import/gn_imports-03.jpg

4.  Mapping des champs. Il s'agit de faire correspondre les champs du
    fichier importé aux champs de la Synthèse (basé sur le standard
    "Occurrences de taxons" du SINP). Vous pouvez utiliser un mapping
    déjà existant ou en créer un nouveau. Le module contient par défaut
    un mapping correspondant à un fichier exporté au format par défaut
    de la synthèse de GeoNature. Si vous créez un nouveau mapping, il
    sera ensuite réutilisable pour les imports suivants. Il est aussi
    possible de choisir si les UUID uniques doivent être générés et si
    les altitudes doivent être calculées automatiquement si elles ne
    sont pas renseignées dans le fichier importé.

    .. image:: https://geonature.fr/docs/img/import/gn_imports-04.jpg

6.  Une fois le mapping des champs réalisé, au moins sur les champs
    obligatoires, il faut alors valider le mapping pour lancer le
    contrôle des données. Vous pouvez ensuite consulter les éventuelles
    erreurs. Il est alors possible de corriger les données en erreurs
    directement dans la base de données, dans la table temporaire des
    données en cours d'import, puis de revalider le mapping, ou de
    passer à l'étape suivante. Les données en erreur ne seront pas
    importées et seront téléchargeables dans un fichier dédié à l'issue
    du processus.

    .. image:: https://geonature.fr/docs/img/import/gn_imports-05.jpg

7.  Mapping des contenus. Il s'agit de faire correspondre les valeurs
    des champs du fichier importé avec les valeurs disponibles dans les
    champs de la Synthèse de GeoNature (basés par défaut sur les
    nomenclatures du SINP). Par défaut les correspondances avec les
    nomenclatures du SINP sous forme de code ou de libellés sont
    fournies.

    .. image:: https://geonature.fr/docs/img/import/gn_imports-06.jpg

8.  La dernière étape permet d'avoir un aperçu des données à importer
    et leur nombre, avant de valider l'import final dans la Synthèse de
    GeoNature.

    .. image:: https://geonature.fr/docs/img/import/gn_imports-07.jpg

Pour chaque fichier importé, les données brutes sont importées
intialement et stockées en binaire dans le champs `t_imports.source_file`. 
Elles sont aussi stockées
dans une table intermédiaire, enrichie au fur et à mesure des étapes de
l'import.

Liste des contrôles réalisés sur le fichier importé et ses données :
<https://github.com/PnX-SI/gn_module_import/issues/17>

Schéma (initial et théorique) des étapes de fonctionnement du module :

.. image:: https://geonature.fr/docs/img/import/gn_imports_etapes.png

Modèle de données du schéma `gn_imports` du module (à adapter à la version 2.0.0) :

.. image:: https://geonature.fr/docs/img/import/gn_imports_MCD-2020-03.png


Fonctionnement du module (serveur et BDD)
=========================================

- J'ai un R d'au moins 1 sur le module Import : J'accède au module et je vois les imports en fonction de mon R.
- J'ai un C d'au moins 1 sur le module Import, je peux créer un import, ou terminer un import auquel j'ai accès.
- J'ai au moins un JDD actif associé au module Import.
- Je créé un nouvel Import. Le C sur le module Import permet de lister mes JDD actifs et associés au module Import, ceux de mon organisme ou tous les JDD actifs associés au module Import.
- Je choisis le JDD auquel je veux associer les données à importer.
- **Etape 1** : J'uploade mon fichier CSV (GeoJSON n'est plus disponible dans la v2 pour le moment). Le contenu du CSV est stocké en binaire dans la table des imports (`gn_imports.t_imports.source_file`). Cela permet d'analyser le fichier (encodage, séparateur...) et de télécharger les données sources.
- **Etape 2** : L'encodage, le format et le séparateur du fichier sont auto-détectés. Je peux les modifier si je le souhaite. Je renseigne le SRID parmi les SRID disponibles dans la configuration du module.
- **Etape 3** : Je choisis un modèle d'Import existant et/ou je mets en correspondance les champs du fichier source avec ceux de la Synthèse de GeoNature. Les modèles d'import listés dépendent des permissions sur l'objet "MAPPING".
La première ligne du fichier binaire est lue pour lister les champs du fichier source.
- Si je choisis un modèle et que je mappe un nouveau champs, ou une valeur différente pour un champs, je peux modifier le modèle existant, en créer un nouveau ou ne sauvegarder ces modifications dans aucun modèle.
- Si j'ai mappé une valeur source différente sur un champs déjà présent dans le modèle, il est écrasé par la nouvelle valeur si je mets à jour le modèle. Actuellement un champs de destination ne peut avoir qu'un seul champs source. Par contre un champs source peut avoir plusieurs champs de destination (`date` → `date_min` et `date` → `date_max`, par exemple).
- Les correspondances des champs sont stockées dans tous les cas en json dans le champs `gn_imports.t_imports.fieldmapping`. Cela permet de pouvoir reprendre les correspondances d'un import, même si le modèle a été modifié entre temps.
- Quand on valide l'étape 3, les données sources des champs mappés sont chargées dans la table d'import temporaire (`gn_imports.t_imports_synthese`) avec une colonne pour la valeur de la source et une pour la valeur de destination. Cela permet à l'application de faire des traitements de transformation et de contrôle sur les données. Les données sources dans des champs non mappées sont importées dans un champs json de cette table (`extra_fields`)
- **Etape 4** : Les valeurs des champs à nomenclature sont déterminées à partir du contenu de la table `gn_imports.t_imports_synthese`. Une nomenclature de destination peut avoir plusieurs valeurs source. Pour chaque type de nomenclature on liste les valeurs trouvées dans le fichier source et on propose de les associer aux valeurs des nomenclatures présentes dans GeoNature. Si le fichier source comprend des lignes vides, on propose en plus de mapper le cas "Pas de valeur".
La gestion des mappings est similaire à l'étape 3 (ils sont stockées cette fois-ci dans le champs `gn_imports.t_imports.contentmapping`).
- **Etape 5** : Il est proposé à l'utilisateur de lancer les contrôles. Ceux-ci sont exécutés en asynchrone dans tous les cas, et une barre de progression est affichée à l'utilisateur. Quand les contrôles sont terminés, le nombre d'erreurs est affiché, ainsi qu'une carte de l'étendue géographique des données et un tableau d'aperçu des données telles qu'elles seront importées.
Si il y a des erreurs, l'utilisateur peut télécharger le fichier des données sources invalides. Elles sont récupérées dans la table `gn_imports.t_imports.source_file` en ne prenant que les lignes qui ont une erreur, en se basant sur les données qui ont le champs `valid=false` dans `gn_imports.t_imports_synthese`
L'utilisateur peut alors lancer l'import des données dans la Synthèse.
Il est lancée en asynchrone dans tous les cas, et un spinner de chargement est affiché tant que l'import est en cours. Si d'autres imports sont en cours, le mécanisme asynchrone gère un système de queue pour les faire les uns après les autres et ne pas saturer le serveur.
- Il est possible de reprendre et modifier un import que celui-ci soit terminé ou non. Il est notamment possible d'uploader un nouveau fichier pour un import existant. En cas de modification d’un import existant, les données sont immédiatement supprimées de la synthèse. Les nouvelles données seront insérées lors de la nouvelle finalisation de l’import.
- Une fois les données importées, les données sont supprimées de la table temporaire (`gn_imports.t_imports_synthese`)
- **Administration des modèles** : Depuis le module ADMIN de GeoNature, il est possible de lister, afficher et modifier les modèles d'import.


Financement de la version 1.0.0 : DREAL et Conseil Régional
Auvergne-Rhône-Alpes.

Financement de la version 2.0.0 : Ministère de la Transition écologique
et UMS Patrinat.

