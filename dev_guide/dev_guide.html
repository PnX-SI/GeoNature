<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aide mémoire pour l’utilisation du core de geonature &mdash; Documentation GeoNature 2.0</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="../index.html" class="icon icon-home"> GeoNature
            <img src="../_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">INSTALLATION</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-manual.html">MANUEL ADMINISTRATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../import-level-1.html">IMPORT NIVEAU 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../import-level-2.html">IMPORT NIVEAU 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development.html">DEVELOPPEMENT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versions-compatibility.html">COMPATIBILITE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">CHANGELOG</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GeoNature</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Aide mémoire pour l’utilisation du core de geonature</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/dev_guide/dev_guide.rst.txt" rel="nofollow"> Afficher la source de la page</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="aide-memoire-pour-l-utilisation-du-core-de-geonature">
<h1>Aide mémoire pour l’utilisation du core de geonature<a class="headerlink" href="#aide-memoire-pour-l-utilisation-du-core-de-geonature" title="Lien permanent vers cette rubrique"></a></h1>
<section id="demarrage-du-serveur-de-dev-backend">
<h2>Démarrage du serveur de dev backend<a class="headerlink" href="#demarrage-du-serveur-de-dev-backend" title="Lien permanent vers cette rubrique"></a></h2>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv)...$ geonature dev_back
</pre></div>
</div>
</div></blockquote>
</section>
<section id="base-de-donnees">
<h2>Base de données<a class="headerlink" href="#base-de-donnees" title="Lien permanent vers cette rubrique"></a></h2>
<section id="session-sqlalchemy">
<h3>Session sqlalchemy<a class="headerlink" href="#session-sqlalchemy" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">geonature.utils.env.DB</span></code></p></li>
</ul>
<p>Fournit l’instance de connexion SQLAlchemy</p>
<p>Python</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">DB</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="serialisation-des-modeles">
<h2>Serialisation des modèles<a class="headerlink" href="#serialisation-des-modeles" title="Lien permanent vers cette rubrique"></a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla.serializers.serializable</span></code></p></li>
</ul>
<p>Décorateur pour les modèles SQLA : Ajoute une méthode as_dict qui retourne un
dictionnaire des données de l’objet sérialisable json</p>
<p>Fichier définition modèle</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla.serializers</span> <span class="kn">import</span> <span class="n">serializable</span>

<span class="nd">@serializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>fichier utilisation modele</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.serializers.geoserializable</span></code></p></li>
</ul>
<p>Décorateur pour les modèles SQLA : Ajoute une méthode as_geofeature qui
retourne un dictionnaire serialisable sous forme de Feature geojson.</p>
<p>Fichier définition modèle</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla_geo.serializers</span> <span class="kn">import</span> <span class="n">geoserializable</span>

<span class="nd">@geoserializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>fichier utilisation modele</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">as_geofeature</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.serializers.shapeserializable</span></code></p></li>
</ul>
<p>Décorateur pour les modèles SQLA:</p>
<ul class="simple">
<li><p>Ajoute une méthode <code class="docutils literal notranslate"><span class="pre">as_list</span></code> qui retourne l’objet sous forme de tableau
(utilisé pour créer des shapefiles)</p></li>
<li><p>Ajoute une méthode de classe <code class="docutils literal notranslate"><span class="pre">to_shape</span></code> qui crée des shapefiles à partir
des données passées en paramètre</p></li>
</ul>
<p>Fichier définition modèle</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">DB</span>

<span class="kn">from</span> <span class="nn">utils_flask_sqla_geo.serializers</span> <span class="kn">import</span> <span class="n">shapeserializable</span>


<span class="nd">@shapeserializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>fichier utilisation modele</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># utilisation de as_shape()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyShapeserializableClass</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">MyShapeserializableClass</span><span class="o">.</span><span class="n">as_shape</span><span class="p">(</span>
    <span class="n">geom_col</span><span class="o">=</span><span class="s1">&#39;geom_4326&#39;</span><span class="p">,</span>
    <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">dir_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ROOT_DIR</span> <span class="o">/</span> <span class="s1">&#39;backend/static/shapefiles&#39;</span><span class="p">),</span>
    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span>
<span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.serializers.FionaShapeService</span></code></p></li>
</ul>
<p>Classe utilitaire pour crer des shapefiles.</p>
<p>La classe contient 3 méthode de classe:</p>
<ul class="simple">
<li><p>FionaShapeService.create_shapes_struct(): crée la structure de 3 shapefiles
(point, ligne, polygone) à partir des colonens et de la geom passé en
paramètre</p></li>
<li><p>FionaShapeService.create_feature(): ajoute un enregistrement aux shapefiles</p></li>
<li><p>FionaShapeService.save_and_zip_shapefiles(): sauvegarde et zip les shapefiles
qui ont au moin un enregistrement</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MySQLAModel</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">FionaShapeService</span><span class="o">.</span><span class="n">create_shapes_struct</span><span class="p">(</span>
                <span class="n">db_cols</span><span class="o">=</span><span class="n">db_cols</span><span class="p">,</span>
                <span class="n">srid</span><span class="o">=</span><span class="n">srid</span><span class="p">,</span>
                <span class="n">dir_path</span><span class="o">=</span><span class="n">dir_path</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">col_mapping</span><span class="o">=</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SYNTHESE&#39;</span><span class="p">][</span><span class="s1">&#39;EXPORT_COLUMNS&#39;</span><span class="p">]</span>
        <span class="p">)</span>
<span class="n">FionaShapeService</span><span class="o">.</span><span class="n">create_feature</span><span class="p">(</span><span class="n">row_as_dict</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
        <span class="n">FionaShapeService</span><span class="o">.</span><span class="n">save_and_zip_shapefiles</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla.response.json_resp</span></code></p></li>
</ul>
<p>Décorateur pour les routes : les données renvoyées par la route sont
automatiquement serialisées en json (ou geojson selon la structure des
données).</p>
<p>S’insère entre le décorateur de route flask et la signature de fonction</p>
<p>fichier routes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla.response</span> <span class="kn">import</span> <span class="n">json_resp</span>

<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myview&#39;</span><span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">}</span>


<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myerrview&#39;</span><span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_err_view</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Not OK&#39;</span><span class="p">},</span> <span class="mi">400</span>
</pre></div>
</div>
</section>
<section id="export-des-donnees">
<h2>Export des données<a class="headerlink" href="#export-des-donnees" title="Lien permanent vers cette rubrique"></a></h2>
<p>TODO</p>
</section>
<section id="authentification-avec-pypnusershub">
<h2>Authentification avec pypnusershub<a class="headerlink" href="#authentification-avec-pypnusershub" title="Lien permanent vers cette rubrique"></a></h2>
<section id="verification-des-droits-des-utilisateurs">
<h3>Vérification des droits des utilisateurs<a class="headerlink" href="#verification-des-droits-des-utilisateurs" title="Lien permanent vers cette rubrique"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pypnusershub.routes.check_auth</span></code></p></li>
</ul>
<p>Décorateur pour les routes : vérifie les droits de l’utilisateur et le
redirige en cas de niveau insuffisant ou d’informations de session erronés.
(deprecated) Privilegier <cite>check_auth_cruved</cite></p>
<p>params :</p>
<ul class="simple">
<li><p>level &lt;int&gt;: niveau de droits requis pour accéder à la vue</p></li>
<li><p>get_role &lt;bool:False&gt;: si True, ajoute l’id utilisateur aux kwargs de la vue</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>
<span class="kn">from</span> <span class="nn">pypnusershub.routes</span> <span class="kn">import</span> <span class="n">check_auth</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla.response</span> <span class="kn">import</span> <span class="n">json_resp</span>

<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myview&#39;</span><span class="p">)</span>
<span class="nd">@check_auth</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">id_role</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;id_role = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_role</span><span class="p">)}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pypnusershub.routes.check_auth_cruved</span></code></p></li>
</ul>
<p>Décorateur pour les routes : Vérifie les droits de l’utilisateur à effectuer
une action sur la donnée et le redirige en cas de niveau insuffisant ou
d’informations de session erronées</p>
<p>params :</p>
<ul class="simple">
<li><p>action &lt;str:[“C”,”R”,”U”,”V”,”E”,”D”]&gt; type d’action effectuée par la route
(Create, Read, Update, Validate, Export, Delete)</p></li>
<li><p>get_role &lt;bool:False&gt;: si True, ajoute l’id utilisateur aux kwargs de la vue</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>
<span class="kn">from</span> <span class="nn">pypnusershub.routes</span> <span class="kn">import</span> <span class="n">check_auth_cruved</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla.response</span> <span class="kn">import</span> <span class="n">json_resp</span>

<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/mysensibleview&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@check_auth_cruved</span><span class="p">(</span>
    <span class="s1">&#39;R&#39;</span><span class="p">,</span>
    <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_sensible_view</span><span class="p">(</span><span class="n">id_role</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;id_role = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_role</span><span class="p">)}</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pypnusershub.routes.db.tools.cruved_for_user_in_app</span></code></p></li>
</ul>
<p>Fonction qui retourne le cruved d’un utilisateur pour une application donnée.
Si aucun cruved n’est définit pour l’application, c’est celui de l’application
mère qui est retourné.
Le cruved de l’application enfant surcharge toujours celui de l’application
mère.</p>
<p>params:
* id_role &lt;integer:None&gt;
* id_application: id du module surlequel on veut avoir le cruved
* id_application_parent: id l’application parent du module</p>
<p>Valeur retourné:
&lt;dict&gt; {“C”: “1”, “R”:”2”, “U”: “1”, “V”:”2”, “E”:”3”, “D”: “3”}</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pypnusershub.db.tools</span> <span class="kn">import</span> <span class="n">cruved_for_user_in_app</span>

<span class="n">cruved</span> <span class="o">=</span> <span class="n">cruved_for_user_in_app</span><span class="p">(</span><span class="n">id_role</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">id_application</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">id_application_parent</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2019, PnE, PnC.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>