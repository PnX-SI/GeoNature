<!doctype html>
<html class="no-js" lang="fr" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Recherche" href="search.html" /><link rel="next" title="FAQ" href="FAQ.html" /><link rel="prev" title="Manuel administrateur" href="admin-manual.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>DÃ©veloppement - Documentation GeoNature 2.15.4</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Documentation GeoNature 2.15.4</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="_static/LogoGeonature.jpg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Documentation GeoNature 2.15.4</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Recherche" name="q" aria-label="Recherche">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-manual.html">Manuel utilisateur</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin-manual.html">Manuel administrateur</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">DÃ©veloppement</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Auteurs</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">CHANGELOG</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="api-references.html">API REFERENCES</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of API REFERENCES</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="autoapi/geonature/index.html">geonature</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of geonature</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="autoapi/geonature/app/index.html">geonature.app</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="autoapi/geonature/core/index.html">geonature.core</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of geonature.core</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/admin/index.html">geonature.core.admin</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of geonature.core.admin</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/admin/admin/index.html">geonature.core.admin.admin</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/admin/utils/index.html">geonature.core.admin.utils</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/command/index.html">geonature.core.command</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of geonature.core.command</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/command/__main__/index.html">geonature.core.command.__main__</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/command/create_gn_module/index.html">geonature.core.command.create_gn_module</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/command/main/index.html">geonature.core.command.main</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/core/errors/index.html">geonature.core.errors</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_commons/index.html">geonature.core.gn_commons</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of geonature.core.gn_commons</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_commons/admin/index.html">geonature.core.gn_commons.admin</a></li>
<li class="toctree-l5 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_commons/medias/index.html">geonature.core.gn_commons.medias</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of geonature.core.gn_commons.medias</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_commons/medias/routes/index.html">geonature.core.gn_commons.medias.routes</a></li>
</ul>
</li>
<li class="toctree-l5 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_commons/models/index.html">geonature.core.gn_commons.models</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of geonature.core.gn_commons.models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_commons/models/additional_fields/index.html">geonature.core.gn_commons.models.additional_fields</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_commons/models/base/index.html">geonature.core.gn_commons.models.base</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_commons/repositories/index.html">geonature.core.gn_commons.repositories</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_commons/routes/index.html">geonature.core.gn_commons.routes</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_commons/schemas/index.html">geonature.core.gn_commons.schemas</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_commons/tasks/index.html">geonature.core.gn_commons.tasks</a></li>
<li class="toctree-l5 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_commons/validation/index.html">geonature.core.gn_commons.validation</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of geonature.core.gn_commons.validation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_commons/validation/routes/index.html">geonature.core.gn_commons.validation.routes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_meta/index.html">geonature.core.gn_meta</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of geonature.core.gn_meta</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_meta/models/index.html">geonature.core.gn_meta.models</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of geonature.core.gn_meta.models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_meta/models/aframework/index.html">geonature.core.gn_meta.models.aframework</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_meta/models/commons/index.html">geonature.core.gn_meta.models.commons</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_meta/models/datasets/index.html">geonature.core.gn_meta.models.datasets</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_meta/repositories/index.html">geonature.core.gn_meta.repositories</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_meta/routes/index.html">geonature.core.gn_meta.routes</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_meta/schemas/index.html">geonature.core.gn_meta.schemas</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_monitoring/index.html">geonature.core.gn_monitoring</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of geonature.core.gn_monitoring</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_monitoring/models/index.html">geonature.core.gn_monitoring.models</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_monitoring/routes/index.html">geonature.core.gn_monitoring.routes</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_permissions/index.html">geonature.core.gn_permissions</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of geonature.core.gn_permissions</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_permissions/admin/index.html">geonature.core.gn_permissions.admin</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_permissions/commands/index.html">geonature.core.gn_permissions.commands</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_permissions/decorators/index.html">geonature.core.gn_permissions.decorators</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_permissions/models/index.html">geonature.core.gn_permissions.models</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_permissions/routes/index.html">geonature.core.gn_permissions.routes</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_permissions/schemas/index.html">geonature.core.gn_permissions.schemas</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_permissions/tools/index.html">geonature.core.gn_permissions.tools</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_profiles/index.html">geonature.core.gn_profiles</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of geonature.core.gn_profiles</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_profiles/models/index.html">geonature.core.gn_profiles.models</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_profiles/routes/index.html">geonature.core.gn_profiles.routes</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_profiles/tasks/index.html">geonature.core.gn_profiles.tasks</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/index.html">geonature.core.gn_synthese</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of geonature.core.gn_synthese</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/imports/index.html">geonature.core.gn_synthese.imports</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of geonature.core.gn_synthese.imports</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/imports/actions/index.html">geonature.core.gn_synthese.imports.actions</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/imports/geo/index.html">geonature.core.gn_synthese.imports.geo</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/imports/plot/index.html">geonature.core.gn_synthese.imports.plot</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/models/index.html">geonature.core.gn_synthese.models</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/module/index.html">geonature.core.gn_synthese.module</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/routes/index.html">geonature.core.gn_synthese.routes</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/schemas/index.html">geonature.core.gn_synthese.schemas</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/synthese_config/index.html">geonature.core.gn_synthese.synthese_config</a></li>
<li class="toctree-l5 has-children"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/utils/index.html">geonature.core.gn_synthese.utils</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of geonature.core.gn_synthese.utils</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/utils/blurring/index.html">geonature.core.gn_synthese.utils.blurring</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/utils/orm/index.html">geonature.core.gn_synthese.utils.orm</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/utils/process/index.html">geonature.core.gn_synthese.utils.process</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/gn_synthese/utils/query_select_sqla/index.html">geonature.core.gn_synthese.utils.query_select_sqla</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/imports/index.html">geonature.core.imports</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of geonature.core.imports</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/actions/index.html">geonature.core.imports.actions</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/admin/index.html">geonature.core.imports.admin</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/blueprint/index.html">geonature.core.imports.blueprint</a></li>
<li class="toctree-l5 has-children"><a class="reference internal" href="autoapi/geonature/core/imports/checks/index.html">geonature.core.imports.checks</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of geonature.core.imports.checks</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6 has-children"><a class="reference internal" href="autoapi/geonature/core/imports/checks/dataframe/index.html">geonature.core.imports.checks.dataframe</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of geonature.core.imports.checks.dataframe</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/dataframe/cast/index.html">geonature.core.imports.checks.dataframe.cast</a></li>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/dataframe/core/index.html">geonature.core.imports.checks.dataframe.core</a></li>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/dataframe/dates/index.html">geonature.core.imports.checks.dataframe.dates</a></li>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/dataframe/geometry/index.html">geonature.core.imports.checks.dataframe.geometry</a></li>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/dataframe/utils/index.html">geonature.core.imports.checks.dataframe.utils</a></li>
</ul>
</li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/imports/checks/errors/index.html">geonature.core.imports.checks.errors</a></li>
<li class="toctree-l6 has-children"><a class="reference internal" href="autoapi/geonature/core/imports/checks/sql/index.html">geonature.core.imports.checks.sql</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle navigation of geonature.core.imports.checks.sql</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/sql/core/index.html">geonature.core.imports.checks.sql.core</a></li>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/sql/extra/index.html">geonature.core.imports.checks.sql.extra</a></li>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/sql/geo/index.html">geonature.core.imports.checks.sql.geo</a></li>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/sql/nomenclature/index.html">geonature.core.imports.checks.sql.nomenclature</a></li>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/sql/parent/index.html">geonature.core.imports.checks.sql.parent</a></li>
<li class="toctree-l7"><a class="reference internal" href="autoapi/geonature/core/imports/checks/sql/utils/index.html">geonature.core.imports.checks.sql.utils</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/commands/index.html">geonature.core.imports.commands</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/config_schema/index.html">geonature.core.imports.config_schema</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/logs/index.html">geonature.core.imports.logs</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/models/index.html">geonature.core.imports.models</a></li>
<li class="toctree-l5 has-children"><a class="reference internal" href="autoapi/geonature/core/imports/routes/index.html">geonature.core.imports.routes</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle navigation of geonature.core.imports.routes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/imports/routes/fields/index.html">geonature.core.imports.routes.fields</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/imports/routes/imports/index.html">geonature.core.imports.routes.imports</a></li>
<li class="toctree-l6"><a class="reference internal" href="autoapi/geonature/core/imports/routes/mappings/index.html">geonature.core.imports.routes.mappings</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/schemas/index.html">geonature.core.imports.schemas</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/tasks/index.html">geonature.core.imports.tasks</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/templates/index.html">geonature.core.imports.templates</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/imports/utils/index.html">geonature.core.imports.utils</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/notifications/index.html">geonature.core.notifications</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle navigation of geonature.core.notifications</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/notifications/admin/index.html">geonature.core.notifications.admin</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/notifications/models/index.html">geonature.core.notifications.models</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/notifications/routes/index.html">geonature.core.notifications.routes</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/notifications/tasks/index.html">geonature.core.notifications.tasks</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/notifications/utils/index.html">geonature.core.notifications.utils</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/sensitivity/index.html">geonature.core.sensitivity</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><div class="visually-hidden">Toggle navigation of geonature.core.sensitivity</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/sensitivity/models/index.html">geonature.core.sensitivity.models</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/sensitivity/routes/index.html">geonature.core.sensitivity.routes</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/sensitivity/utils/index.html">geonature.core.sensitivity.utils</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/taxonomie/index.html">geonature.core.taxonomie</a><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><div class="visually-hidden">Toggle navigation of geonature.core.taxonomie</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/taxonomie/admin/index.html">geonature.core.taxonomie.admin</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/taxonomie/schemas/index.html">geonature.core.taxonomie.schemas</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="autoapi/geonature/core/users/index.html">geonature.core.users</a><input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><div class="visually-hidden">Toggle navigation of geonature.core.users</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/users/models/index.html">geonature.core.users.models</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/users/register_post_actions/index.html">geonature.core.users.register_post_actions</a></li>
<li class="toctree-l5"><a class="reference internal" href="autoapi/geonature/core/users/routes/index.html">geonature.core.users.routes</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="autoapi/geonature/middlewares/index.html">geonature.middlewares</a></li>
<li class="toctree-l3"><a class="reference internal" href="autoapi/geonature/tasks/index.html">geonature.tasks</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="autoapi/geonature/utils/index.html">geonature.utils</a><input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><div class="visually-hidden">Toggle navigation of geonature.utils</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/celery/index.html">geonature.utils.celery</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/command/index.html">geonature.utils.command</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/config/index.html">geonature.utils.config</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/config_schema/index.html">geonature.utils.config_schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/env/index.html">geonature.utils.env</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/errors/index.html">geonature.utils.errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/filemanager/index.html">geonature.utils.filemanager</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/logs/index.html">geonature.utils.logs</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/metaclass_utils/index.html">geonature.utils.metaclass_utils</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/module/index.html">geonature.utils.module</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/schema/index.html">geonature.utils.schema</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/sentry/index.html">geonature.utils.sentry</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/utilsgeometrytools/index.html">geonature.utils.utilsgeometrytools</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/utilsmails/index.html">geonature.utils.utilsmails</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/utilsrequests/index.html">geonature.utils.utilsrequests</a></li>
<li class="toctree-l4"><a class="reference internal" href="autoapi/geonature/utils/utilstoml/index.html">geonature.utils.utilstoml</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/development.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="developpement">
<h1>DÃ©veloppement<a class="headerlink" href="#developpement" title="Lien vers cette rubrique">Â¶</a></h1>
<section id="general">
<h2>GÃ©nÃ©ral<a class="headerlink" href="#general" title="Lien vers cette rubrique">Â¶</a></h2>
<p>GeoNature 1, crÃ©Ã© en 2010, a Ã©tÃ© dÃ©veloppÃ© par Gil Deluermoz avec PHP/Symfony/ExtJS.</p>
<p>GeoNature 2 est une refonte initiÃ©e en 2017 par les parcs nationaux franÃ§ais en Python/Flask/Angular.</p>
<p>Mainteneurs actuels :</p>
<ul class="simple">
<li><p>Jacques FIZE (PnEcrins)</p></li>
<li><p>Pierre NARCISI (Patrinat)</p></li>
<li><p>Vincent CAUCHOIS (Patrinat)</p></li>
<li><p>Ãlie BOUTTIER (PnEcrins)</p></li>
<li><p>ThÃ©o LECHEMIA (PnEcrins)</p></li>
<li><p>Amandine SAHL (PnCevennes)</p></li>
<li><p>Camille MONCHICOURT (PnEcrins)</p></li>
</ul>
<img alt="_images/geonature-techno.png" src="_images/geonature-techno.png" />
</section>
<section id="api">
<span id="id1"></span><h2>API<a class="headerlink" href="#api" title="Lien vers cette rubrique">Â¶</a></h2>
<p>GeoNature utilise :</p>
<ul class="simple">
<li><p>lâAPI de TaxHub (recherche taxon, rÃ¨gne et groupe dâun taxonâ¦), intÃ©grÃ©e Ã  GeoNature depuis sa version 2.15</p></li>
<li><p>lâAPI du sous-module Nomenclatures (typologies et listes dÃ©roulantes)</p></li>
<li><p>lâAPI du sous-module dâauthentification de UsersHub (login/logout, rÃ©cupÃ©ration du CRUVED dâun utilisateur)</p></li>
<li><p>lâAPI de GeoNature (get, post, update des donnÃ©es des diffÃ©rents modules, mÃ©tadonnÃ©es, intersections gÃ©ographiques, exportsâ¦)</p></li>
</ul>
<img alt="_images/api_services.png" src="_images/api_services.png" />
<section id="liste-des-routes">
<h3>Liste des routes<a class="headerlink" href="#liste-des-routes" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Vous pouvez obtenir la liste des routes de GeoNature avec la commande suivante :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>geonature<span class="w"> </span>routes
</pre></div>
</div>
</section>
<section id="documentation-des-routes">
<h3>Documentation des routes<a class="headerlink" href="#documentation-des-routes" title="Lien vers cette rubrique">Â¶</a></h3>
<p>GÃ©nÃ©ration automatique actuellement hors-service :-(</p>
</section>
</section>
<section id="pratiques-et-regles-de-developpement">
<h2>Pratiques et rÃ¨gles de developpement<a class="headerlink" href="#pratiques-et-regles-de-developpement" title="Lien vers cette rubrique">Â¶</a></h2>
<p>Afin de partager des rÃ¨gles communes de dÃ©veloppement et faciliter lâintÃ©gration de
nouveau code, veuillez lire les recommandations et bonnes pratiques recommandÃ©es pour contribuer
au projet GeoNature.</p>
<section id="git">
<h3>Git<a class="headerlink" href="#git" title="Lien vers cette rubrique">Â¶</a></h3>
<ul class="simple">
<li><p>Assurez-vous dâavoir rÃ©cupÃ©rÃ© les dÃ©pendances dans les sous-modules git : <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">init</span> <span class="pre">&amp;&amp;</span> <span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">update</span></code></p></li>
<li><p>AprÃ¨s un <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code>, il faut mettre Ã  jour les sous-modules : <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">submodule</span> <span class="pre">update</span></code></p></li>
<li><p>Ne jamais faire de commit dans la branche <code class="docutils literal notranslate"><span class="pre">master</span></code> mais dans la branche <code class="docutils literal notranslate"><span class="pre">develop</span></code> ou idÃ©alement dans une branche dÃ©diÃ©e Ã  la fonctionnalitÃ© (feature branch)</p></li>
<li><p>Faire des pull requests vers la branche <code class="docutils literal notranslate"><span class="pre">develop</span></code></p></li>
<li><p>Faire des <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code> avant chaque dÃ©veloppement et avant chaque commit</p></li>
<li><p>Les messages des commits font rÃ©fÃ©rence Ã  un ticket ou le ferment (<code class="docutils literal notranslate"><span class="pre">ref</span> <span class="pre">#12</span></code> ou <code class="docutils literal notranslate"><span class="pre">fixes</span> <span class="pre">#23</span></code>)</p></li>
<li><p>Les messages des commits sont en anglais (dans la mesure du possible)</p></li>
<li><p>PrivilÃ©gier les rebases afin de conserver un historique linÃ©aire</p></li>
<li><p>PrivilÃ©gier lâamendement (<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--amend</span></code> ou <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--fixup</span></code>) des commits existants lorsque vous portez des corrections Ã  votre PR, en particulier pour lâapplication du style.</p></li>
</ul>
</section>
<section id="backend">
<h3>Backend<a class="headerlink" href="#backend" title="Lien vers cette rubrique">Â¶</a></h3>
<ul class="simple">
<li><p>Une fonction ou classe doit contenir une docstring en franÃ§ais. Les doctrings doivent suivre le modÃ¨le NumPy/SciPy (voir <a class="reference external" href="https://numpydoc.readthedocs.io/en/latest/format.html">https://numpydoc.readthedocs.io/en/latest/format.html</a> et <a class="reference external" href="https://realpython.com/documenting-python-code/#numpyscipy-docstrings-example">https://realpython.com/documenting-python-code/#numpyscipy-docstrings-example</a>)</p></li>
<li><p>Les commentaires dans le codes doivent Ãªtre en anglais (ne pas sâempÃªcher de mettre un commentaire en franÃ§ais sur une partie du code complexe !)</p></li>
<li><p>Utiliser <em>blake</em> comme formateur de texte et activer lâauto-formatage dans son Ã©diteur de texte (Tuto pour VsCode : <a class="reference external" href="https://medium.com/&#64;marcobelo/setting-up-python-black-on-visual-studio-code-5318eba4cd00">https://medium.com/&#64;marcobelo/setting-up-python-black-on-visual-studio-code-5318eba4cd00</a>)</p></li>
<li><p>La longueur maximale pour une ligne de code est 100 caractÃ¨res. Pour VSCODE copier ces lignes le fichier <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> :</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;python.formatting.blackArgs&quot;</span><span class="p">:</span> <span class="p">[</span>
  <span class="s2">&quot;--line-length&quot;</span><span class="p">,</span>
  <span class="s2">&quot;100&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>PrivilÃ©gier la snake_case pour les variables, CamelCase pour les classes.</p></li>
</ul>
</section>
<section id="bdd">
<h3>BDD<a class="headerlink" href="#bdd" title="Lien vers cette rubrique">Â¶</a></h3>
<ul class="simple">
<li><p>Le noms des tables est prÃ©fixÃ© par Â«Â t_Â Â» pour une table de contenu, de Â«Â bib_Â Â» pour les tables de Â«Â dictionnairesÂ Â» et de Â«Â cor_Â Â» pour les tables de correspondance (relations N-N)</p></li>
<li><p>Les schÃ©mas du coeur de GeoNature sont prÃ©fixÃ©s de Â«Â gn_Â Â»</p></li>
<li><p>Les schÃ©mas des protocoles ou modules GeoNature sont prÃ©fixÃ©s de Â«Â pr_Â Â»</p></li>
<li><p>Ne rien Ã©crire dans le schÃ©ma <code class="docutils literal notranslate"><span class="pre">public</span></code></p></li>
</ul>
<section id="modele-python">
<h4>ModÃ¨le Python<a class="headerlink" href="#modele-python" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Les conventions prÃ©cÃ©dentes concernent uniquement la BDD. Pour les modÃ¨les Python, on fera attention Ã  :</p>
<ul class="simple">
<li><p>Nommer les modÃ¨les sans le prÃ©fixe Â«Â t_Â Â», et Ã  les Ã©crire au singulier. Exemple : <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">Observation:</span></code>.</p></li>
<li><p>Ne pas rÃ©peter le nom des tables dans les noms des colonnes.</p></li>
</ul>
</section>
</section>
<section id="typescript">
<span id="id2"></span><h3>Typescript<a class="headerlink" href="#typescript" title="Lien vers cette rubrique">Â¶</a></h3>
<ul class="simple">
<li><p>Documenter les fonctions et classes grÃ¢ce au JSDoc en franÃ§ais (<a class="reference external" href="https://jsdoc.app/">https://jsdoc.app/</a>)</p></li>
<li><p>Les commentaires dans le codes doivent Ãªtre en anglais (ne pas sâempÃªcher de mettre un commentaire en franÃ§ais sur une partie du code complexe !)</p></li>
<li><p>Les messages renvoyÃ©s aux utilisateurs sont en franÃ§ais</p></li>
<li><p>Installer les outils de devÃ©loppement : <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span> <span class="pre">--only=dev</span></code></p></li>
<li><p>Utiliser <em>prettier</em> comme formateur de texte et activer lâautoformatage dans son Ã©diteur de texte (VsCode dispose dâune extension Prettier : <a class="reference external" href="https://github.com/prettier/prettier-vscode">https://github.com/prettier/prettier-vscode</a>)
Pour lancer manuellement prettier depuis le dossier <code class="docutils literal notranslate"><span class="pre">frontend</span></code> :</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nvm<span class="w"> </span>use
npm<span class="w"> </span>run<span class="w"> </span>format
</pre></div>
</div>
<ul class="simple">
<li><p>La longueur maximale pour une ligne de code est 100 caractÃ¨res.</p></li>
</ul>
</section>
<section id="angular">
<h3>Angular<a class="headerlink" href="#angular" title="Lien vers cette rubrique">Â¶</a></h3>
<ul class="simple">
<li><p>Suivre les recommandations dÃ©finies par le styleguide Angular: <a class="reference external" href="https://angular.io/guide/styleguide">https://angular.io/guide/styleguide</a>. Câest une ressources trÃ¨s fournie en cas de question sur les pratiques de dÃ©veloppement (principe de sÃ©paration des principes, organisation des services et des composants)</p></li>
<li><p>On privilÃ©giera lâutilisation des reactive forms pour la construction des formulaires (<a class="reference external" href="https://angular.io/guide/reactive-forms">https://angular.io/guide/reactive-forms</a>). Ce sont des formulaires pilotÃ©s par le code, ce qui facilite la lisibilitÃ© et le contrÃ´le de ceux-ci.</p></li>
<li><p>Pour lâensemble des composants cartographiques et des formulaires (taxonomie, nomenclaturesâ¦), il est conseillÃ© dâutiliser les composants prÃ©sents dans le module âGN2CommonModuleâ.</p></li>
</ul>
</section>
<section id="html">
<h3>HTML<a class="headerlink" href="#html" title="Lien vers cette rubrique">Â¶</a></h3>
<ul class="simple">
<li><p>La longueur maximale pour une ligne de code est 100 caractÃ¨res.</p></li>
<li><p>Revenir Ã  la ligne avant et aprÃ¨s le contenue dâune balise.</p></li>
<li><p>Lorsquâil y a plus dâun attribut sur une balise, revenir Ã  la ligne, aligner les attributs et aller a la ligne pour fermer la balise :</p></li>
</ul>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">button</span>
  <span class="na">mat-raised-button</span>
  <span class="na">color</span><span class="o">=</span><span class="s">&quot;primary&quot;</span>
  <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn-action hard-shadow uppercase ml-3&quot;</span>
  <span class="na">data-toggle</span><span class="o">=</span><span class="s">&quot;collapse&quot;</span>
  <span class="na">data-target</span><span class="o">=</span><span class="s">&quot;#collapseAvance&quot;</span>
<span class="p">&gt;</span>
  Filtrer
<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>VSCODE fournit un formatteur de HTML par dÃ©faut (Dans les options de VsCode, tapez Â«Â wrap attributesÂ Â» et sÃ©lectionner Â«Â force-expand-multilineÂ Â»)</p></li>
<li><p>En plus du TypeScript/Javascript, Prettier permet de formater le HTML et le SCSS (Se rÃ©fÃ©rer Ã  la configuration Nâoubliez pas les <a class="reference internal" href="#typescript"><span class="std std-ref">Typescript</span></a>.)</p></li>
</ul>
</section>
<section id="style-et-ergonomie">
<h3>Style et ergonomie<a class="headerlink" href="#style-et-ergonomie" title="Lien vers cette rubrique">Â¶</a></h3>
<ul class="simple">
<li><p>Boutons :
On utilise les boutons dâAngular Material (<a class="reference external" href="https://material.angular.io/components/button/overview">https://material.angular.io/components/button/overview</a>).</p>
<ul>
<li><p>mat-raised-button pour les boutons contenant du texte</p></li>
<li><p>mat-fab ou mat-mini-fab pour les boutons dâactions avec seulement une icone</p></li>
</ul>
</li>
<li><p>Couleur des boutons :</p>
<ul>
<li><p>Action : primary</p></li>
<li><p>Validation: vert (nâexistant pas dans Material : utiliser la classe <cite>button-success</cite>)</p></li>
<li><p>Suppression: warn</p></li>
<li><p>Navigation: basic</p></li>
</ul>
</li>
<li><p>Librairie dâicones :</p>
<ul>
<li><p>Utiliser la librairie Material icons fournie avec le projet : <a class="reference external" href="https://material.io/resources/icons/?style=baseline">https://material.io/resources/icons/?style=baseline</a> (<code class="docutils literal notranslate"><span class="pre">&lt;mat-icon&gt;</span> <span class="pre">add</span> <span class="pre">&lt;/mat-icon&gt;</span></code>)</p></li>
</ul>
</li>
<li><p>Formulaire :</p>
<ul>
<li><p>Nous utilisons pour lâinstant le style des formulaires Bootstrap (<a class="reference external" href="https://getbootstrap.com/docs/4.0/components/forms/">https://getbootstrap.com/docs/4.0/components/forms/</a>). Une reflexion de migration vers les formulaires materials est en cours.</p></li>
</ul>
</li>
<li><p>SystÃ¨me de grille et responsive :</p>
<ul>
<li><p>Utiliser le systÃ¨me de grille de Bootstrap pour assurer le responsive design sur lâapplication. On ne vise pas lâutilisation sur mobile, mais Ã  minima sur ordinateur portable de petite taille.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="passer-en-mode-developpement">
<span id="mode-dev"></span><h2>Passer en mode dÃ©veloppement<a class="headerlink" href="#passer-en-mode-developpement" title="Lien vers cette rubrique">Â¶</a></h2>
<p>Cette section documente comment passer en mode dÃ©veloppement une installation de GeoNature initialement faite en mode production.</p>
<section id="recuperation-des-sources">
<h3>RÃ©cupÃ©ration des sources<a class="headerlink" href="#recuperation-des-sources" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Si vous avez tÃ©lÃ©chargÃ© GeoNature zippÃ© (via la procÃ©dure dâinstallation globale <code class="docutils literal notranslate"><span class="pre">install_all.sh</span></code> ou en suivant la documentation dâinstallation standalone), il est nÃ©cessaire de rattacher votre rÃ©pertoire au dÃ©pÃ´t GitHub afin de pouvoir tÃ©lÃ©charger les derniÃ¨res avancÃ©es du coeur en <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code>. Pour cela, suivez les commandes suivantes en vous placant Ã  la racine du rÃ©pertoire de GeoNature.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Se crÃ©er un rÃ©pertoire .git</span>
mkdir<span class="w"> </span>.git
<span class="c1"># RÃ©cupÃ©rer l&#39;historique du dÃ©pÃ´t</span>
git<span class="w"> </span>clone<span class="w"> </span>--depth<span class="o">=</span><span class="m">2</span><span class="w"> </span>--bare<span class="w"> </span>https://github.com/PnX-SI/GeoNature.git<span class="w"> </span>.git
<span class="c1"># Initialiser un dÃ©pÃ´t git Ã  partir de l&#39;historique tÃ©lÃ©chargÃ©</span>
git<span class="w"> </span>init
<span class="c1"># VÃ©rifier que le dÃ©pÃ´t distant et le contenu local sont synchronisÃ©s</span>
git<span class="w"> </span>pull
<span class="c1"># Reset sur HEAD pour mettre Ã  jour les status</span>
git<span class="w"> </span>reset<span class="w"> </span>HEAD
<span class="c1"># -&gt; vous Ãªtes Ã  jour sur la branche master</span>
<span class="c1"># Cloner les sous-modules pour rÃ©cupÃ©rer les dÃ©pendances</span>
git<span class="w"> </span>submodule<span class="w"> </span>init
git<span class="w"> </span>submodule<span class="w"> </span>update
</pre></div>
</div>
</section>
<section id="installation-du-venv-en-dev">
<h3>Installation du venv en dev<a class="headerlink" href="#installation-du-venv-en-dev" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Il est nÃ©cessaire dâinstaller les dÃ©pendances (sous-modules Git prÃ©sent dans <code class="docutils literal notranslate"><span class="pre">backend/dependencies</span></code>) en mode Ã©ditable afin de travailler avec la derniÃ¨re version de celles-ci.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cd backend</span>
<span class="go">source venv/bin/activate</span>
<span class="go">pip install -e .. -r requirements-dev.txt</span>
</pre></div>
</div>
</section>
<section id="configuration-des-urls-de-developpement">
<h3>Configuration des URLs de dÃ©veloppement<a class="headerlink" href="#configuration-des-urls-de-developpement" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Il est nÃ©cessaire de changer la configuration du fichier <code class="docutils literal notranslate"><span class="pre">config/geonature_config.toml</span></code> pour utiliser les adresses suivantes :</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="n">URL_APPLICATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://127.0.0.1:4200&#39;</span>
<span class="n">API_ENDPOINT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://127.0.0.1:8000&#39;</span>
</pre></div>
</div>
<p>Nâoubliez pas les <a class="reference internal" href="admin-manual.html#post-config-change"><span class="std std-ref">actions Ã  effectuer aprÃ¨s modification de la configuration</span></a>.</p>
</section>
<section id="autres-extensions-en-developpement">
<h3>Autres extensions en dÃ©veloppement<a class="headerlink" href="#autres-extensions-en-developpement" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Il nâest pas forcÃ©mment utile de passer toutes les extensions en mode dÃ©velomment.
Pour plus dâinformations, rÃ©fÃ©rez-vous aux documentations dÃ©diÃ©es :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://taxhub.readthedocs.io/fr/latest/developpement.html">https://taxhub.readthedocs.io/fr/latest/developpement.html</a></p></li>
<li><p><a class="reference external" href="https://usershub.readthedocs.io/fr/latest/">https://usershub.readthedocs.io/fr/latest/</a></p></li>
</ul>
</section>
<section id="debugger-avec-un-navigateur">
<h3>Debugger avec un navigateur<a class="headerlink" href="#debugger-avec-un-navigateur" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Lâextension <a class="reference external" href="https://angular.io/guide/devtools">Angular DevTools</a> permettra de debugger lâapplication dans la console du navigateur.
Pour utiliser lâextension vous devez lâinstaller et passer obligatoirement en mode <code class="docutils literal notranslate"><span class="pre">development</span></code>.</p>
</section>
</section>
<section id="developpement-backend">
<span id="dev-backend"></span><h2>DÃ©veloppement Backend<a class="headerlink" href="#developpement-backend" title="Lien vers cette rubrique">Â¶</a></h2>
<section id="demarrage-du-serveur-de-dev-backend">
<h3>DÃ©marrage du serveur de dev backend<a class="headerlink" href="#demarrage-du-serveur-de-dev-backend" title="Lien vers cette rubrique">Â¶</a></h3>
<p>La commande <code class="docutils literal notranslate"><span class="pre">geonature</span></code> fournit la sous-commande <code class="docutils literal notranslate"><span class="pre">dev-back</span></code> pour lancer un serveur de test :</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">source &lt;GEONATURE_DIR&gt;backend/venv/bin/activate</span>
<span class="go">geonature dev-back</span>
</pre></div>
</div>
<p>LâAPI est alors accessible Ã  lâadresse <a class="reference external" href="http://127.0.0.1:8000">http://127.0.0.1:8000</a>.</p>
</section>
<section id="base-de-donnees-avec-flask-sqlalchemy">
<h3>Base de donnÃ©es avec Flask-SQLAlchemy<a class="headerlink" href="#base-de-donnees-avec-flask-sqlalchemy" title="Lien vers cette rubrique">Â¶</a></h3>
<p>LâintÃ©gration de la base de donnÃ©es Ã  GeoNature repose sur la bibliothÃ¨que <a class="reference external" href="https://flask-sqlalchemy.palletsprojects.com">Flask-SQLAlchemy</a>.</p>
<p>Celle-ci fournit un objet <code class="docutils literal notranslate"><span class="pre">db</span></code> Ã  importer comme ceci : <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">geonature.utils.env</span> <span class="pre">import</span> <span class="pre">db</span></code></p>
<p>Cet objet permet dâaccÃ©der Ã  la session SQLAlchemy ainsi :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">db</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Mais il fournit une base dÃ©clarative <code class="docutils literal notranslate"><span class="pre">db.Model</span></code> permettant dâinterroger encore plus simplement les modÃ¨les via leur attribut <code class="docutils literal notranslate"><span class="pre">query</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">db</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="err">â¦</span>

<span class="n">obj</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Lâattribut <code class="docutils literal notranslate"><span class="pre">query</span></code> fournit <a class="reference external" href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/api/#flask_sqlalchemy.BaseQuery">plusieurs fonctions</a> trÃ¨s utiles dont la fonction <code class="docutils literal notranslate"><span class="pre">get_or_404</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Ceci est typiquement la premiÃ¨re ligne de toutes les routes travaillant sur une instance (route de type get/update/delete).</p>
<section id="fonctions-de-filtrages">
<h4>Fonctions de filtrages<a class="headerlink" href="#fonctions-de-filtrages" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Lâattribut <code class="docutils literal notranslate"><span class="pre">query</span></code> est une instance de la classe <code class="docutils literal notranslate"><span class="pre">flask_sqlalchemy.BaseQuery</span></code> qui peut Ãªtre surchargÃ©e afin de dÃ©finir de nouvelles fonctions de filtrage.</p>
<p>On pourra ainsi implÃ©menter une fonction pour filtrer les objets auxquels lâutilisateur a accÃ¨s, ou encore pour implÃ©menter des filtres de recherche.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">g</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">sa</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">BaseQuery</span>
<span class="kn">from</span> <span class="nn">geonature.core.gn_permissions</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="k">class</span> <span class="nc">MyModelQuery</span><span class="p">(</span><span class="n">BaseQuery</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">filter_by_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">false</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">scope</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span>Â <span class="n">MyModel</span><span class="o">.</span><span class="n">owner</span><span class="o">==</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span> <span class="p">]</span>
            <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">id_organism</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">id_organism</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">id_organism</span><span class="p">)</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">query_class</span> <span class="o">=</span> <span class="n">MyModelQuery</span>


<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">list_my_model</span><span class="p">():</span>
    <span class="n">obj_list</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by_scope</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="serialisation-des-modeles-avec-marshmallow">
<h3>Serialisation des modÃ¨les avec Marshmallow<a class="headerlink" href="#serialisation-des-modeles-avec-marshmallow" title="Lien vers cette rubrique">Â¶</a></h3>
<p>La bibliothÃ¨que <a class="reference external" href="https://marshmallow.readthedocs.io/en/stable/">Marshmallow</a> fournit des outils de sÃ©rialisation et desÃ©rialisation.</p>
<p>Elle est intÃ©grÃ©e Ã  GeoNature par la bibliothÃ¨que <a class="reference external" href="https://flask-marshmallow.readthedocs.io/en/latest/">Flask-Marshmallow</a> qui fournit lâobjet <code class="docutils literal notranslate"><span class="pre">ma</span></code> Ã  importer comme ceci : <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">geonature.utils.env</span> <span class="pre">import</span> <span class="pre">ma</span></code>.</p>
<p>Cette bibliothÃ¨que ajoute notablement une mÃ©thode <code class="docutils literal notranslate"><span class="pre">jsonify</span></code> aux schÃ©mas.</p>
<p>Les schÃ©mas Marshmallow peuvent Ãªtre facilement crÃ©Ã©s Ã  partir des modÃ¨les SQLAlchemy grÃ¢ce Ã  la bibliothÃ¨que <a class="reference external" href="https://marshmallow-sqlalchemy.readthedocs.io/en/latest/">Marshmallow-SQLAlchemy</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">ma</span>

<span class="k">class</span> <span class="nc">MyModelSchema</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<section id="gestion-des-relationships">
<h4>Gestion des relationships<a class="headerlink" href="#gestion-des-relationships" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Lâoption <code class="docutils literal notranslate"><span class="pre">include_fk=True</span></code> concerne les champs de type <code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code>, mais pas les <code class="docutils literal notranslate"><span class="pre">relationships</span></code> en elles-mÃªmes. Pour ces derniÃ¨res, il est nÃ©cessaire dâajouter manuellement des champs <code class="docutils literal notranslate"><span class="pre">Nested</span></code> Ã  notre schÃ©ma :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ParentModelSchema</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ParentModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">childs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="s2">&quot;ChildModelSchema&quot;</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ChildModelSchema</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ChildModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="n">ParentModelSchema</span><span class="p">)</span>
</pre></div>
</div>
<p>Attention, la sÃ©rialisation dâun objet avec un tel schÃ©ma va provoquer une rÃ©cursion infinie, le schÃ©ma parent incluant le schÃ©ma enfant, et le schÃ©ma enfant incluant le schÃ©ma parent.
Il est donc nÃ©cessaire de restreindre les champs Ã  inclure dans la sÃ©rialisation lors de la crÃ©ation du schÃ©ma :</p>
<ul>
<li><dl>
<dt>avec lâargument <code class="docutils literal notranslate"><span class="pre">only</span></code> :</dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parent_schema</span> <span class="o">=</span> <span class="n">ParentModelSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pk&#39;</span><span class="p">,</span> <span class="s1">&#39;childs.pk&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Lâutilisation de <code class="docutils literal notranslate"><span class="pre">only</span></code> a lâinconvÃ©nient dâÃªtre lourde puisquâil faut spÃ©cifier lâensemble les champs Ã  sÃ©rialiser.
De plus, lâajout dâune nouvelle colonne au modÃ¨le nÃ©cessite de la rajouter partout oÃ¹ le schÃ©ma est utilisÃ©.</p>
</dd>
</dl>
</li>
<li><dl>
<dt>avec lâargument <code class="docutils literal notranslate"><span class="pre">exclude</span></code> :</dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">parent_schema</span> <span class="o">=</span> <span class="n">ParentModelSchema</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;childs.parent&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Cependant, lâutilisation de <code class="docutils literal notranslate"><span class="pre">exclude</span></code> est hautement problÃ©matique !
En effet, lâajout dâun nouveau champs <code class="docutils literal notranslate"><span class="pre">Nested</span></code> au schÃ©ma nÃ©cessiterait de le rajouter dans la liste des exclusions partout oÃ¹ le schÃ©ma est utilisÃ© (que Ã§a soit pour Ã©viter une rÃ©cursion infinie, dâalourdir une rÃ©ponse JSON avec des donnÃ©es inutiles ou pour Ã©viter un problÃ¨me n+1 - voir section dÃ©diÃ©e).</p>
</dd>
</dl>
</li>
</ul>
<p>La bibliothÃ¨que Utils-Flask-SQLAlchemy fournit une classe utilitaire <code class="docutils literal notranslate"><span class="pre">SmartRelationshipsMixin</span></code> permettant dâexclure par dÃ©faut les champs <code class="docutils literal notranslate"><span class="pre">Nested</span></code>.
Pour demander la sÃ©rialisation dâun sous-schÃ©ma, il faut le spÃ©cifier avec <code class="docutils literal notranslate"><span class="pre">only</span></code>, mais sans nÃ©cessitÃ© de spÃ©cifier tous les champs basiques (non <code class="docutils literal notranslate"><span class="pre">Nested</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils_flask_sqla.schema</span> <span class="kn">import</span> <span class="n">SmartRelationshipsMixin</span>

<span class="k">class</span> <span class="nc">ParentModelSchema</span><span class="p">(</span><span class="n">SmartRelationshipsMixin</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ParentModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">childs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="s2">&quot;ChildModelSchema&quot;</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ChildModelSchema</span><span class="p">(</span><span class="n">SmartRelationshipsMixin</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ChildModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="n">ParentModelSchema</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="modeles-avec-nomenclatures">
<h4>ModÃ¨les avec nomenclatures<a class="headerlink" href="#modeles-avec-nomenclatures" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Le convertisseur de modÃ¨le <code class="docutils literal notranslate"><span class="pre">NomenclaturesConverter</span></code> permet dâautomatiquement ajouter un champs <code class="docutils literal notranslate"><span class="pre">Nested(NomenclatureSchema)</span></code> pour les relationships vers une nomenclature.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pypnnomenclature.models</span> <span class="kn">import</span> <span class="n">TNomenclatures</span> <span class="k">as</span> <span class="n">Nomenclature</span>
<span class="kn">from</span> <span class="nn">pypnnomenclature.utils</span> <span class="kn">import</span> <span class="n">NomenclaturesConverter</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">id_nomenclature_foo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">Nomenclature</span><span class="o">.</span><span class="n">id_nomenclature</span><span class="p">))</span>
    <span class="n">nomenclature_foo</span> <span class="o">=</span> <span class="n">relationships</span><span class="p">(</span><span class="n">Nomenclature</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="n">id_nomenclature_foo</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">MyModelSchema</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">model_converter</span> <span class="o">=</span> <span class="n">NomenclaturesConverter</span>

    <span class="c1"># automatically added: nomenclature_foo = ma.Nested(NomenclatureSchema)</span>
</pre></div>
</div>
<p>Le mixin <code class="docutils literal notranslate"><span class="pre">NomenclaturesMixin</span></code> permet de dÃ©finir une propriÃ©tÃ© <code class="docutils literal notranslate"><span class="pre">__nomenclatures__</span></code> sur un modÃ¨le contenant
la liste des champs Ã  nomenclature.
Cette propriÃ©tÃ© peut Ãªtre utilisÃ© pour facilement joindre et inclure lors de la sÃ©rialisation les champs Ã  nomenclatures.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pypnnomenclature.models</span> <span class="kn">import</span> <span class="n">TNomenclatures</span> <span class="k">as</span> <span class="n">Nomenclature</span>
<span class="kn">from</span> <span class="nn">pypnnomenclature.utils</span> <span class="kn">import</span> <span class="n">NomenclaturesMixin</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">NomenclaturesMixin</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">id_nomenclature_foo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">Nomenclature</span><span class="o">.</span><span class="n">id_nomenclature</span><span class="p">))</span>
    <span class="n">nomenclature_foo</span> <span class="o">=</span> <span class="n">relationships</span><span class="p">(</span><span class="n">Nomenclature</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="n">id_nomenclature_foo</span><span class="p">])</span>

<span class="c1"># joinedload all nomenclatures</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">joinedload</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">__nomenclatures__</span><span class="p">])</span>
<span class="c1"># include all nomenclatures to serialization</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">MyModelSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="n">MyModel</span><span class="o">.</span><span class="n">__nomenclatures__</span><span class="p">)</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="modeles-geographiques">
<h4>ModÃ¨les gÃ©ographiques<a class="headerlink" href="#modeles-geographiques" title="Lien vers cette rubrique">Â¶</a></h4>
<p>En utilisant <code class="docutils literal notranslate"><span class="pre">GeoAlchemyAutoSchema</span></code> Ã  la place de <code class="docutils literal notranslate"><span class="pre">SQLAlchemyAutoSchema</span></code>, il est facile de crÃ©er des schÃ©mas pour des modÃ¨les possÃ©dant des colonnes gÃ©omÃ©triques :</p>
<ul class="simple">
<li><p>Utilisation automatique de <code class="docutils literal notranslate"><span class="pre">model_converter</span> <span class="pre">=</span> <span class="pre">GeoModelConverter</span></code> afin de convertir les colonnes gÃ©omÃ©triques</p></li>
<li><p>Exclusion par dÃ©faut des colonnes gÃ©omÃ©triques de la sÃ©rialisation</p></li>
<li><p>PossibilitÃ© de gÃ©nÃ©rer du <cite>geojson</cite> en initialisant le schÃ©ma avec <code class="docutils literal notranslate"><span class="pre">as_geojson=True</span></code></p></li>
</ul>
<p>Les options suivantes sont disponible (Ã  rajouter comme propriÃ©tÃ© de la classe MÃ©ta, ou comme paramÃ¨tre Ã  la crÃ©ation du schÃ©ma) :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">feature_id</span></code> : Colonne Ã  utiliser pour remplire lâ<code class="docutils literal notranslate"><span class="pre">id</span></code> des features geojson.
Typiquement la clÃ© primaire du modÃ¨le. Exclue si non spÃ©cifiÃ©.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">feature_geometry</span></code> : Colonne Ã  utiliser pour dÃ©finir la <code class="docutils literal notranslate"><span class="pre">geometry</span></code> des features geojson.
DÃ©terminÃ©e automatiquement lorsque le modÃ¨le possÃ¨de une unique colonne gÃ©omÃ©trique.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">pk</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">Geometry</span><span class="p">(</span><span class="s2">&quot;GEOMETRY&quot;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">MyModelSchema</span><span class="p">(</span><span class="n">GeoAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">feature_id</span> <span class="o">=</span> <span class="s2">&quot;pk&quot;</span>  <span class="c1"># optionnel</span>
        <span class="n">feature_geometry</span> <span class="o">=</span> <span class="s2">&quot;geom&quot;</span>  <span class="c1"># automatiquement dÃ©terminÃ©</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">o</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="n">from_shape</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">)))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">MyModelSchema</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="go">{&quot;pk&quot;: 1}  # la colonne gÃ©omÃ©trique est automatiquement exclue</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">MyModelSchema</span><span class="p">(</span><span class="n">as_geojson</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="go">{</span>
<span class="go">    &quot;type&quot;: &quot;Feature&quot;,</span>
<span class="go">    &quot;id&quot;: 1,</span>
<span class="go">    &quot;geometry&quot;: {&quot;type&quot;: &quot;Point&quot;, &quot;coordinates&quot;: [6, 10]},</span>
<span class="go">    &quot;properties&quot;: {&quot;pk&quot;: 1}</span>
<span class="go">}</span>
</pre></div>
</div>
<p>La sortie sera une <cite>FeatureCollection</cite> lorsque le schÃ©ma est utilisÃ© avec <code class="docutils literal notranslate"><span class="pre">many=True</span></code>.</p>
<p>Les schÃ©mas gÃ©ographiques peuvent Ã©galement Ãªtre utilisÃ© pour parser du geojson (<cite>Feature</cite> ou <cite>FeatureCollection</cite>).</p>
</section>
<section id="modeles-geographiques-avec-nomenclatures">
<h4>ModÃ¨les gÃ©ographiques avec nomenclatures<a class="headerlink" href="#modeles-geographiques-avec-nomenclatures" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Si vous avez un modÃ¨le possÃ©dant Ã  la fois des relations vers des nomenclatures et des colonnes gÃ©omÃ©triques,
vous pouvez devoir crÃ©er votre propre convertisseur de modÃ¨le hÃ©ritant Ã  la fois de <code class="docutils literal notranslate"><span class="pre">NomenclaturesConverter</span></code> et de <code class="docutils literal notranslate"><span class="pre">GeoModelConverter</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NomenclaturesGeoModelConverter</span><span class="p">(</span><span class="n">NomenclaturesConverter</span><span class="p">,</span> <span class="n">GeoModelConverter</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">MyModelSchema</span><span class="p">(</span><span class="n">GeoAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">model_converter</span> <span class="o">=</span> <span class="n">NomenclaturesGeoModelConverter</span>
</pre></div>
</div>
</section>
<section id="modeles-de-permission">
<h4>ModÃ¨les de permission<a class="headerlink" href="#modeles-de-permission" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Le mixin <code class="docutils literal notranslate"><span class="pre">CruvedSchemaMixin</span></code> permet dâajouter un champs <code class="docutils literal notranslate"><span class="pre">cruved</span></code> Ã  la sÃ©rialisation qui contiendra un dictionnaire avec en clÃ© les actions du cruved et en valeur des boolÃ©ens indiquant si lâaction est disponible.</p>
<p>Pour lâutiliser, il faut :</p>
<ul class="simple">
<li><p>DÃ©finir une propriÃ©tÃ© <code class="docutils literal notranslate"><span class="pre">__module_code__</span></code> (et optionnellement une propriÃ©tÃ© <code class="docutils literal notranslate"><span class="pre">__object_code__</span></code>) au niveau du <strong>schÃ©ma</strong> Marshmallow.
Ces propriÃ©tÃ©s sont passÃ©es en argument Ã  la fonction <code class="docutils literal notranslate"><span class="pre">get_scopes_by_action</span></code>.</p></li>
<li><p>Le <strong>modÃ¨le</strong> doit dÃ©finir une fonction <code class="docutils literal notranslate"><span class="pre">has_instance_permission(scope)</span></code> prenant en argument une portÃ©e (0, 1, 2 ou 3) et renvoyant un boolÃ©en.</p></li>
</ul>
<p>Par dÃ©faut, le CRUVED est exclu de la sÃ©rialisation pour des raisons de performance.
Il faut donc demander sa sÃ©rialisation lors de la crÃ©ation du schÃ©ma avec <code class="docutils literal notranslate"><span class="pre">only=[&quot;+cruved&quot;]</span></code>.
Le prÃ©fixe <code class="docutils literal notranslate"><span class="pre">+</span></code> permet de spÃ©cifier que lâon souhaite rajouter le cruved aux champs Ã  sÃ©rialiser (et non que lâon souhaite sÃ©rialiser uniquement le cruved).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.schema</span> <span class="kn">import</span> <span class="n">CruvedSchemaMixin</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># â¦</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_instance_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">scope</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="p">(</span><span class="n">scope</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyModelSchema</span><span class="p">(</span><span class="n">CruvedSchemaMixin</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">__module_code__</span> <span class="o">=</span> <span class="s2">&quot;MODULE_CODE&quot;</span>

    <span class="c1"># automatically added: cruved = fields.Method(&quot;get_cruved&quot;, metadata={&quot;exclude&quot;: True})</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">o</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">MyModelSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;+cruved&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="go">{&quot;pk&quot;: 42, &quot;cruved&quot;: {&quot;C&quot;: False, &quot;R&quot;: True, &quot;U&quot;: True, &quot;V&quot;: False, &quot;E&quot;: False}}</span>
</pre></div>
</div>
</section>
<section id="creation-dun-objet">
<h4>CrÃ©ation dâun objet<a class="headerlink" href="#creation-dun-objet" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Lâutilisation de <code class="docutils literal notranslate"><span class="pre">load_instance=True</span></code> permet, lors de lâappelle de la fonction <code class="docutils literal notranslate"><span class="pre">load</span></code>, de directement rÃ©cupÃ©rer un objet pouvant Ãªtre ajoutÃ© Ã  la session SQLAlchemy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModelSchema</span><span class="p">(</span><span class="n">SmartRelationshipsMixin</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">load_instance</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">o</span> <span class="o">=</span> <span class="n">MyModelSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<section id="id3">
<h5>Gestion des relationships<a class="headerlink" href="#id3" title="Lien vers cette rubrique">Â¶</a></h5>
<section id="many-to-one">
<h6>Many-to-One<a class="headerlink" href="#many-to-one" title="Lien vers cette rubrique">Â¶</a></h6>
<p>Exemple dâune relation vers une nomenclature :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">id_nomenclature_foo</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">Nomenclature</span><span class="o">.</span><span class="n">id_nomenclature</span><span class="p">))</span>
    <span class="n">nomenclature_foo</span> <span class="o">=</span> <span class="n">relationships</span><span class="p">(</span><span class="n">Nomenclature</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="n">id_nomenclature_foo</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">MyModelSchema</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">model_converter</span> <span class="o">=</span> <span class="n">NomenclaturesConverter</span>

<span class="c1"># Le front spÃ©cifie directement la ForeignKey et non la relationship :</span>
<span class="n">o</span> <span class="o">=</span> <span class="n">MyModelSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s2">&quot;id_nomenclature_foo&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="many-to-many">
<h6>Many-to-Many<a class="headerlink" href="#many-to-many" title="Lien vers cette rubrique">Â¶</a></h6>
<p>Exemple dâune relation vers plusieurs utilisateurs :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cor_mymodel_user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">owners</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">cor_mymodel_user</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyModelSchema</span><span class="p">(</span><span class="n">SmartRelationshipsMixin</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># Le front spÃ©cifie la ForeignKey, la relationship est ignorÃ© :</span>
<span class="n">o</span> <span class="o">=</span> <span class="n">MyModelSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;owners.id_role&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">load</span><span class="p">({</span>
    <span class="s2">&quot;owners&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;id_role&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;id_role&quot;</span><span class="p">:</span> <span class="mi">43</span><span class="p">}]</span>
<span class="p">})</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Prendre garde Ã  bien spÃ©cifier <code class="docutils literal notranslate"><span class="pre">owners.id_role</span></code> et non simplement <code class="docutils literal notranslate"><span class="pre">owners</span></code>, sans quoi il devient possible dâutiliser votre route pour crÃ©er des utilisateurs !</p>
</div>
</section>
<section id="one-to-many">
<h6>One-to-Many<a class="headerlink" href="#one-to-many" title="Lien vers cette rubrique">Â¶</a></h6>
<p>Exemple dâune relation vers des modÃ¨les enfants, qui sont rattachÃ© Ã  un unique parent :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">id_parent</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">Parent</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Parent</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;childs&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Parent</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">childs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Child</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ChildSchema</span><span class="p">(</span><span class="n">SmartRelationshipsMixin</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">load_instance</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="n">Nested</span><span class="p">(</span><span class="n">ParentSchema</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ParentSchema</span><span class="p">(</span><span class="n">SmartRelationshipsMixin</span><span class="p">,</span> <span class="n">ma</span><span class="o">.</span><span class="n">SQLAlchemyAutoSchema</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ParentModel</span>
        <span class="n">include_fk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">load_instance</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">childs</span> <span class="o">=</span> <span class="n">Nested</span><span class="p">(</span><span class="n">ChildSchema</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@validates_schema</span>
    <span class="k">def</span> <span class="nf">validate_childs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure this schema is not leveraged to retrieve childs from other parent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;childs&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">id_parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">child</span><span class="o">.</span><span class="n">id_parent</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;Child does not belong to this parent.&quot;</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;childs&quot;</span>
                <span class="p">)</span>

<span class="n">o</span> <span class="o">=</span> <span class="n">ParentSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;childs&quot;</span><span class="p">],</span> <span class="n">dump_only</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;childs.id_parent&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">load</span><span class="p">({</span>
    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;childs&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>  <span class="c1"># validate_childs checks child 1 belongs to parent 1</span>
    <span class="p">]</span>
<span class="p">})</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Prendre garde Ã  ajouter <code class="docutils literal notranslate"><span class="pre">dump_only=[&quot;childs.id_parent&quot;]</span></code>, sans quoi il devient possible de crÃ©er des objets Child appartenant Ã  un autre Parent !</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Prendre garde Ã  ajouter une validation sur le modÃ¨le parent de lâappartenance des objets Child, sans quoi il devient possible de rattacher Ã  un parent des objets Child appartenant Ã  un autre parent !</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Le frontend doit systÃ©matiquement listÃ© lâensemble des childs, sans quoi ceux-ci seront supprimÃ©.</p>
</div>
</section>
</section>
</section>
</section>
<section id="serialisation-des-modeles-avec-le-decorateur-serializable">
<h3>Serialisation des modÃ¨les avec le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;serializable</span></code><a class="headerlink" href="#serialisation-des-modeles-avec-le-decorateur-serializable" title="Lien vers cette rubrique">Â¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Lâutilisation des schÃ©mas Marshmallow est probablement plus performante.</p>
</div>
<p>La bibliothÃ¨que maison <a class="reference external" href="https://github.com/PnX-SI/Utils-Flask-SQLAlchemy">Utils-Flask-SQLAlchemy</a> fournit le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;serializable</span></code> qui ajoute une mÃ©thode <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> sur les modÃ¨les dÃ©corÃ©s :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils_flask_sqla.serializers</span> <span class="kn">import</span> <span class="n">serializable</span>

<span class="nd">@serializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="err">â¦</span>


<span class="n">obj</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">(</span><span class="err">â¦</span><span class="p">)</span>
<span class="n">obj</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
</pre></div>
</div>
<p>La mÃ©thode <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> fournit les arguments <code class="docutils literal notranslate"><span class="pre">fields</span></code> et <code class="docutils literal notranslate"><span class="pre">exclude</span></code> permettant de spÃ©cifier les champs que lâon souhaite sÃ©rialiser.</p>
<p>Par dÃ©faut, seules les champs qui ne sont pas des relationshisp sont sÃ©rialisÃ©es (fonctionnalitÃ© similaire Ã  celle fournit par <code class="docutils literal notranslate"><span class="pre">SmartRelationshipsMixin</span></code> pour Marshmallow).</p>
<p>Les relations que lâon souhaite voir sÃ©rialisÃ©es doivent Ãªtre explicitement dÃ©clarÃ©es via lâargument <code class="docutils literal notranslate"><span class="pre">fields</span></code>.</p>
<p>Lâargument <code class="docutils literal notranslate"><span class="pre">fields</span></code> supporte la Â« notation Ã  point Â» permettant de prÃ©ciser les champs dâun modÃ¨le en relation :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">child</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parent.pk&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>Les <a class="reference external" href="https://github.com/PnX-SI/Utils-Flask-SQLAlchemy/blob/master/src/utils_flask_sqla/tests/test_serializers.py">tests unitaires</a> fournissent un ensemble dâexemples dâusage du dÃ©corateur.</p>
<p>La fonction <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> prenait autrefois en argument les paramÃ¨tres <code class="docutils literal notranslate"><span class="pre">recursif</span></code> et <code class="docutils literal notranslate"><span class="pre">depth</span></code> qui sont tous les deux obsolÃ¨tes. Ces derniers ont diffÃ©rents problÃ¨mes :</p>
<ul class="simple">
<li><p>rÃ©cursion infinie (contournÃ©e par un hack qui ne rÃ©soud pas tous les problÃ¨mes et quâil serait souhaitable de voir disparaitre)</p></li>
<li><p>augmentation non prÃ©vue des donnÃ©es sÃ©rialisÃ©es lors de lâajout dâune nouvelle relationship</p></li>
<li><p>problÃ¨me n+1 (voir section dÃ©diÃ©e)</p></li>
</ul>
<section id="id4">
<h4>ModÃ¨les gÃ©ographiques<a class="headerlink" href="#id4" title="Lien vers cette rubrique">Â¶</a></h4>
<p>La bibliothÃ¨que maison <a class="reference external" href="https://github.com/PnX-SI/Utils-Flask-SQLAlchemy-Geo">Utils-Flask-SQLAlchemy-Geo</a> fournit des dÃ©corateurs supplÃ©mentaires pour la sÃ©rialisation des modÃ¨les contenant des champs gÃ©ographiques.</p>
<ul>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.serializers.geoserializable</span></code></dt><dd><p>DÃ©corateur pour les modÃ¨les SQLA : Ajoute une mÃ©thode as_geofeature qui
retourne un dictionnaire serialisable sous forme de Feature geojson.</p>
<p>Fichier dÃ©finition modÃ¨le</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla_geo.serializers</span> <span class="kn">import</span> <span class="n">geoserializable</span>


<span class="nd">@geoserializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Fichier utilisation modÃ¨le</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">instance</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">as_geofeature</span><span class="p">()</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.serializers.shapeserializable</span></code></dt><dd><p>DÃ©corateur pour les modÃ¨les SQLA :</p>
<ul class="simple">
<li><p>Ajoute une mÃ©thode <code class="docutils literal notranslate"><span class="pre">as_list</span></code> qui retourne lâobjet sous forme de tableau (utilisÃ© pour crÃ©er des shapefiles)</p></li>
<li><p>Ajoute une mÃ©thode de classe <code class="docutils literal notranslate"><span class="pre">to_shape</span></code> qui crÃ©e des shapefiles Ã  partir des donnÃ©es passÃ©es en paramÃ¨tre</p></li>
</ul>
<p>Fichier dÃ©finition modÃ¨le</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.env</span> <span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla_geo.serializers</span> <span class="kn">import</span> <span class="n">shapeserializable</span>


<span class="nd">@shapeserializable</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DB</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;bla&#39;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Fichier utilisation modÃ¨le</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># utilisation de as_shape()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyShapeserializableClass</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">MyShapeserializableClass</span><span class="o">.</span><span class="n">as_shape</span><span class="p">(</span>
    <span class="n">geom_col</span><span class="o">=</span><span class="s1">&#39;geom_4326&#39;</span><span class="p">,</span>
    <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">dir_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">ROOT_DIR</span> <span class="o">/</span> <span class="s1">&#39;backend/static/shapefiles&#39;</span><span class="p">),</span>
    <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.utilsgeometry.FionaShapeService</span></code></dt><dd><p>Classe utilitaire pour crÃ©er des shapefiles.</p>
<p>La classe contient 3 mÃ©thodes de classe :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FionaShapeService.create_shapes_struct()</span></code> : crÃ©e la structure de 3 shapefiles</p></li>
</ul>
<p>(point, ligne, polygone) Ã  partir des colonens et de la geomÃ©trie passÃ©e
en paramÃ¨tre</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FionaShapeService.create_feature()</span></code> : ajoute un enregistrement</p></li>
</ul>
<p>aux shapefiles</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FionaShapeService.save_and_zip_shapefiles()</span></code> : sauvegarde et zip les</p></li>
</ul>
<p>shapefiles qui ont au moins un enregistrement</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MySQLAModel</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">FionaShapeService</span><span class="o">.</span><span class="n">create_shapes_struct</span><span class="p">(</span>
                <span class="n">db_cols</span><span class="o">=</span><span class="n">db_cols</span><span class="p">,</span>
                <span class="n">srid</span><span class="o">=</span><span class="n">srid</span><span class="p">,</span>
                <span class="n">dir_path</span><span class="o">=</span><span class="n">dir_path</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
                <span class="n">col_mapping</span><span class="o">=</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SYNTHESE&#39;</span><span class="p">][</span><span class="s1">&#39;EXPORT_COLUMNS&#39;</span><span class="p">]</span>
        <span class="p">)</span>
<span class="n">FionaShapeService</span><span class="o">.</span><span class="n">create_feature</span><span class="p">(</span><span class="n">row_as_dict</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
        <span class="n">FionaShapeService</span><span class="o">.</span><span class="n">save_and_zip_shapefiles</span><span class="p">()</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</section>
</section>
<section id="reponses">
<h3>RÃ©ponses<a class="headerlink" href="#reponses" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Voici quelques conseils sur lâenvoi de rÃ©ponse dans vos routes.</p>
<ul>
<li><dl>
<dt>PrivilÃ©gier lâenvoi du modÃ¨le sÃ©rialisÃ© (vues de type create/update), ou dâune liste de modÃ¨les sÃ©rialisÃ©s (vues de type list), plutÃ´t que des structures de donnÃ©es non conventionnelles.</dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_foo</span><span class="p">(</span><span class="n">pk</span><span class="p">):</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="n">fields</span><span class="o">=...</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_foo</span><span class="p">(</span><span class="n">pk</span><span class="p">):</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FooSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=...</span><span class="p">)</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">list_foo</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">([</span><span class="n">foo</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="n">fields</span><span class="o">=...</span><span class="p">)</span> <span class="k">for</span> <span class="n">foo</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span>

<span class="k">def</span> <span class="nf">list_foo</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FooSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=...</span><span class="p">)</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>Pour les listes vides, ne pas renvoyer le code dâerreur 404 mais une liste vide !</dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">jsonify</span><span class="p">([])</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>Renvoyer une liste et sa longueur dans une structure de donnÃ©es non conventionnelle est strictement inutile, il est trÃ¨s simple dâaccÃ©der Ã  la longueur de la liste en javascript via lâattribut <code class="docutils literal notranslate"><span class="pre">length</span></code>.</p></li>
<li><dl>
<dt>Traitement des erreurs<span class="classifier">utiliser <a class="reference external" href="https://werkzeug.palletsprojects.com/en/2.0.x/exceptions/">les exceptions prÃ©vues Ã  cet effet</a> :</span></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="kn">import</span> <span class="n">Fobridden</span><span class="p">,</span> <span class="n">Badrequest</span><span class="p">,</span> <span class="n">NotFound</span>

<span class="k">def</span> <span class="nf">restricted_action</span><span class="p">(</span><span class="n">pk</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_allowed</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">Forbidden</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>Penser Ã  utiliser <code class="docutils literal notranslate"><span class="pre">get_or_404</span></code> plutÃ´t que de lancer une exception <code class="docutils literal notranslate"><span class="pre">NotFound</span></code></p></li>
<li><p>Si lâutilisateur nâa pas le droit dâeffectuer une action, utiliser lâexception <code class="docutils literal notranslate"><span class="pre">Forbidden</span></code> (code HTTP 403), et non lâexception <code class="docutils literal notranslate"><span class="pre">Unauthorized</span></code> (code HTTP 401), cette derniÃ¨re Ã©tant rÃ©servÃ©e aux utilisateurs non authentifiÃ©s.</p></li>
<li><dl>
<dt>VÃ©rifier la validitÃ© des donnÃ©es fournies par lâutilisateur (<code class="docutils literal notranslate"><span class="pre">request.json</span></code> ou <code class="docutils literal notranslate"><span class="pre">request.args</span></code>) et lever une exception <code class="docutils literal notranslate"><span class="pre">BadRequest</span></code> si celles-ci ne sont pas valides (lâutilisateur ne doit pas Ãªtre en mesure de dÃ©clencher une erreur 500 en fournissant une string plutÃ´t quâun int par exemple !).</dt><dd><ul>
<li><dl>
<dt>Marshmallow peut servir Ã  cela</dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="k">def</span> <span class="nf">my_route</span><span class="p">():</span>
    <span class="k">class</span> <span class="nc">RequestSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">RequestSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>Cela peut Ãªtre fait avec <em>jsonschema</em> :</dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">from</span> <span class="n">jsonschema</span> <span class="kn">import</span> <span class="nn">validate</span> <span class="k">as</span> <span class="nn">validate_json</span><span class="o">,</span> <span class="nn">ValidationError</span>

<span class="k">def</span> <span class="nf">my_route</span><span class="p">():</span>
    <span class="n">request_schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;minProperties&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">validate_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">request_schema</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt>Pour les rÃ©ponses vides (exemple<span class="classifier">route de type delete), on pourra utiliser le code de retour 204 :</span></dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">204</span>
</pre></div>
</div>
</dd>
</dl>
<p>Lorsque par exemple une action est traitÃ©e mais aucun rÃ©sultat nâest Ã  renvoyer, inutile dâenvoyer une rÃ©ponse Â« OK Â». Câest lâenvoi dâune rÃ©ponse HTTP avec un code Ã©gale Ã  400 ou supÃ©rieur qui entrainera le traitement dâune erreur cÃ´tÃ© frontend, plutÃ´t que de se fonder sur le contenu dâune rÃ©ponse non normalisÃ©e.</p>
</li>
</ul>
<section id="le-decorateur-json-resp">
<h4>Le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;json_resp</span></code><a class="headerlink" href="#le-decorateur-json-resp" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Historiquement, beaucoup de vues sont dÃ©corÃ©es avec le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;json_resp</span></code>.</p>
<p>Celui-ci apparait aujourdâhui superflu par rapport Ã  lâusage directement de la fonction <code class="docutils literal notranslate"><span class="pre">jsonify</span></code> fournie par Flask.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">utils_flask_sqla_geo.serializers.json_resp</span></code></p>
<p>DÃ©corateur pour les routes : les donnÃ©es renvoyÃ©es par la route sont
automatiquement serialisÃ©es en json (ou geojson selon la structure des
donnÃ©es).</p>
<p>SâinsÃ¨re entre le dÃ©corateur de route flask et la signature de fonction</p>
<p>Fichier routes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>
<span class="kn">from</span> <span class="nn">utils_flask_sqla.response</span> <span class="kn">import</span> <span class="n">json_resp</span>

<span class="n">blueprint</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myview&#39;</span><span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_view</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span><span class="p">}</span>


<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myerrview&#39;</span><span class="p">)</span>
<span class="nd">@json_resp</span>
<span class="k">def</span> <span class="nf">my_err_view</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;Not OK&#39;</span><span class="p">},</span> <span class="mi">400</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="probleme-n-1">
<h3>ProblÃ¨me Â« n+1 Â»<a class="headerlink" href="#probleme-n-1" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Le problÃ¨me Â« n+1 Â» est un anti-pattern courant des routes de type Â« liste Â» (par exemple, rÃ©cupÃ©ration de la liste des cadres dâacquisition).</p>
<p>En effet, on souhaite par exemple afficher la liste des cadres dâacquisitions, et pour chacun dâentre eux, la liste des jeux de donnÃ©es :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af_list</span> <span class="o">=</span> <span class="n">AcquisitionFramwork</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># with Marshmallow (and SmartRelationshipsMixin)</span>
<span class="k">return</span> <span class="n">AcquisitionFrameworkSchema</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">af_list</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># with @serializable</span>
<span class="k">return</span> <span class="n">jsonify</span><span class="p">([</span> <span class="n">af</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">af</span> <span class="ow">in</span> <span class="n">af_list</span><span class="p">])</span>
</pre></div>
</div>
<p>Ainsi, lors de la sÃ©rialisation de chaque AF, on demande Ã  sÃ©rialiser lâattribut <code class="docutils literal notranslate"><span class="pre">datasets</span></code>, qui est une relationships vers la liste des DS associÃ©s :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AcquisitionFramework</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationships</span><span class="p">(</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Sans prÃ©cision, la <a class="reference external" href="https://docs.sqlalchemy.org/en/14/orm/loading_relationships.html">stratÃ©gie de chargement</a> de la relation <code class="docutils literal notranslate"><span class="pre">datasets</span></code> est <code class="docutils literal notranslate"><span class="pre">select</span></code>, câest-Ã -dire que lâaccÃ¨s Ã  lâattribut <code class="docutils literal notranslate"><span class="pre">datasets</span></code> dâun AF provoque une nouvelle requÃªte select afin de rÃ©cupÃ©rer la liste des DS concernÃ©s.</p>
<p>Ceci est gÃ©nÃ©ralement peu grave lorsque lâon manipule un unique objet, mais dans le cas dâune liste dâobjet, cela gÃ©nÃ¨re 1+n requÃªtes SQL : une pour rÃ©cupÃ©rer la liste des AF, puis une lors de la sÃ©rialisation de chaque AF pour rÃ©cupÃ©rer les DS de ce dernier.</p>
<p>Cela devient alors un problÃ¨me de performance notable !</p>
<p>Afin de rÃ©soudre ce problÃ¨me, il nous faut joindre les DS Ã  la requÃªte de rÃ©cupÃ©ration des AF.</p>
<p>Pour cela, plusieurs solutions :</p>
<ul>
<li><p>Le spÃ©cifier dans la relationship :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AcquisitionFramework</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationships</span><span class="p">(</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Cependant, cette stratÃ©gie sâappliquera (sauf contre-ordre) dans tous les cas, mÃªme lorsque les DS ne sont pas nÃ©cessaires, alourdissant potentiellement certaines requÃªtes qui nâen ont pas usage.</p>
</li>
<li><dl>
<dt>Le spÃ©cifier au moment oÃ¹ la requÃªte est effectuÃ©e :</dt><dd><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">joinedload</span>

<span class="n">af_list</span> <span class="o">=</span> <span class="n">AcquisitionFramework</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
<p>Il est Ã©galement possible de joindre les relations dâune relation, par exemple le crÃ©ateur des jeux de donnÃ©es :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">af_list</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">AcquisitionFramework</span><span class="o">.</span><span class="n">query</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span>
        <span class="n">joinedload</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">joinedload</span><span class="p">(</span><span class="s1">&#39;creator&#39;</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Afin dâÃªtre sÃ»r dâavoir joint toutes les relations nÃ©cessaires, il est possible dâutiliser la stratÃ©gie <code class="docutils literal notranslate"><span class="pre">raise</span></code> par dÃ©faut, ce qui va provoquer le lancement dâune exception lors de lâaccÃ¨s Ã  un attribut non prÃ©-chargÃ©, nous incitant Ã  le joindre Ã©galement :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">raiseload</span><span class="p">,</span> <span class="n">joinedload</span>

<span class="n">af_list</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">AcquisitionFramework</span><span class="o">.</span><span class="n">query</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span>
        <span class="n">raiseload</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">),</span>
        <span class="n">joinedload</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Pour toutes les requÃªtes rÃ©cupÃ©rant une liste dâobjet, lâutilisation de la stratÃ©gie <code class="docutils literal notranslate"><span class="pre">raise</span></code> par dÃ©faut est grandement encouragÃ©e afin de ne pas tomber dans cet anti-pattern.</p>
<p>La mÃ©thode <code class="docutils literal notranslate"><span class="pre">as_dict</span></code> du dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;serializable</span></code> accepte lâargument <code class="docutils literal notranslate"><span class="pre">unloaded='raise'</span></code> ou <code class="docutils literal notranslate"><span class="pre">unloaded='warn'</span></code> pour un rÃ©sultat similaire (ou un simple warning).</p>
<p>Lâutilisation de <code class="docutils literal notranslate"><span class="pre">raiseload</span></code>, appartenant au cÅur de SQLAlchemy, reste Ã  privilÃ©gier.</p>
</section>
<section id="export-des-donnees">
<h3>Export des donnÃ©es<a class="headerlink" href="#export-des-donnees" title="Lien vers cette rubrique">Â¶</a></h3>
<p>TODO</p>
</section>
<section id="utilisation-de-la-configuration">
<h3>Utilisation de la configuration<a class="headerlink" href="#utilisation-de-la-configuration" title="Lien vers cette rubrique">Â¶</a></h3>
<p>La configuration globale de lâapplication est controlÃ©e par le fichier
<code class="docutils literal notranslate"><span class="pre">config/geonature_config.toml</span></code> qui contient un nombre limitÃ© de paramÃ¨tres.
Il est possible dâutiliser un autre fichier de configuration en spÃ©cifiant
un autre chemin dâaccÃ¨s dans la variable dâenvironnement
<code class="docutils literal notranslate"><span class="pre">GEONATURE_CONFIG_FILE</span></code>.</p>
<p>Il est Ã©galement possible de dÃ©finir des paramÃ¨tres de configuration par variable
dâenvironnement en prÃ©fixant le nom du paramÃ¨tre par <code class="docutils literal notranslate"><span class="pre">GEONATURE_</span></code> (<em>e.g.</em> <code class="docutils literal notranslate"><span class="pre">GEONATURE_SQLALCHEMY_DATABASE_URI</span></code>). Cette mÃ©thode permet cependant de passer uniquement des valeurs textuelles.</p>
<p>Les paramÃ¨tres de configuration sont validÃ©s par un schÃ©ma Marshmallow (voir <code class="docutils literal notranslate"><span class="pre">backend/geonature/utils/config_schema.py</span></code>).</p>
<p>Dans lâapplication flask, lâensemble des paramÃ¨tres de configuration sont
utilisables via le dictionnaire <code class="docutils literal notranslate"><span class="pre">config</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.utils.config</span> <span class="kn">import</span> <span class="n">config</span>

<span class="n">MY_PARAMETER</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;MY_PARAMETER&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Le dictionnaire <code class="docutils literal notranslate"><span class="pre">config</span></code> est Ã©galement accessible via <code class="docutils literal notranslate"><span class="pre">current_app.config</span></code>.</p>
<p>La <a class="reference internal" href="installation.html#module-config"><span class="std std-ref">configuration des modules</span></a> est accessible Ã  la clÃ© <code class="docutils literal notranslate"><span class="pre">MODULE_CODE</span></code> du dictionnaire de configuration. Elle est Ã©galement accessible directement via la propriÃ©tÃ© <code class="docutils literal notranslate"><span class="pre">config</span></code> du blueprint du module :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>

<span class="n">MY_MODULE_PARAMETER</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MODULE_CODE&#39;</span><span class="p">][</span><span class="s1">&#39;MY_MODULE_PARAMETER&#39;</span><span class="p">]</span>
<span class="n">MY_MODULE_PARAMETER</span> <span class="o">=</span> <span class="n">blueprint</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MY_MODULE_PARAMETER&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="authentification-et-autorisations">
<h3>Authentification et autorisations<a class="headerlink" href="#authentification-et-autorisations" title="Lien vers cette rubrique">Â¶</a></h3>
<section id="acceder-a-lutilisateur-courant">
<h4>AccÃ©der Ã  lâutilisateur courant<a class="headerlink" href="#acceder-a-lutilisateur-courant" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Lâutilisateur courant est stockÃ© dans lâespace de nom <code class="docutils literal notranslate"><span class="pre">g</span></code> :</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">g</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">current_user</span><span class="p">)</span>
<span class="go">&lt;User &#39;&#39;admin&#39;&#39; id=&#39;3&#39;&gt;</span>
</pre></div>
</div>
<p>Il sâagit dâune instance de <code class="docutils literal notranslate"><span class="pre">pypnusershub.db.models.User</span></code>.
Si lâutilisateur nâest pas connectÃ©, <code class="docutils literal notranslate"><span class="pre">g.current_user</span></code> vaudra <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
</section>
<section id="restreindre-une-route-aux-utilisateurs-connectes">
<h4>Restreindre une route aux utilisateurs connectÃ©s<a class="headerlink" href="#restreindre-une-route-aux-utilisateurs-connectes" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Utiliser le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;login_required</span></code> :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.core.gn_permissions.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">my_protected_route</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Si lâutilisateur nâest pas authentifiÃ©, celui-ci est redirigÃ© vers une page dâauthentification, Ã  moins que la requÃªte contienne un header <code class="docutils literal notranslate"><span class="pre">Accept:</span> <span class="pre">application/json</span></code> (requÃªte effectuÃ©e par le frontend) auquel cas une erreur 401 (Unauthorized) est levÃ©.</p>
</section>
<section id="restreindre-une-route-aux-utilisateurs-avec-un-certain-scope">
<h4>Restreindre une route aux utilisateurs avec un certain scope<a class="headerlink" href="#restreindre-une-route-aux-utilisateurs-avec-un-certain-scope" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Utiliser le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;check_cruved_scope</span></code> :</p>
<dl class="py function">
<dt class="sig sig-object py" id="check_cruved_scope">
<span class="sig-prename descclassname"><span class="pre">&#64;</span></span><span class="sig-name descname"><span class="pre">check_cruved_scope</span></span><a class="headerlink" href="#check_cruved_scope" title="Lien vers cette dÃ©finition">Â¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">ParamÃ¨tres<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>action</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>[</em><em>&quot;C&quot;</em><em>, </em><em>&quot;R&quot;</em><em>, </em><em>&quot;U&quot;</em><em>, </em><em>&quot;V&quot;</em><em>, </em><em>&quot;E&quot;</em><em>, </em><em>&quot;D&quot;</em><em>]</em>) â Type dâaction effectuÃ©e par la route
(Create, Read, Update, Validate, Export, Delete)</p></li>
<li><p><strong>module_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a>) â Code du module sur lequel on veut vÃ©rifier les permissions.</p></li>
<li><p><strong>object_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>, </em><em>optional</em>) â Code de lâobjet sur lequel on veut vÃ©rifier les permissions.
Si non fourni, on vÃ©rifie la portÃ©e sur lâobjet <code class="docutils literal notranslate"><span class="pre">ALL</span></code>.</p></li>
<li><p><strong>get_scope</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(disponible dans Python v3.13)"><em>bool</em></a><em>, </em><em>optional</em>) â si <code class="docutils literal notranslate"><span class="pre">True</span></code>, ajoute le scope aux kwargs de la vue</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p>Lorsque lâutilisateur nâest pas connectÃ©, le comportement est le mÃªme que le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;login_required</span></code>. Lorsque celui-ci est connectÃ©, le dÃ©corateur va rÃ©cupÃ©rer le scope de lâutilisateur pour lâaction donnÃ©e dans le module donnÃ©e (et Ã©ventuellement lâobjet donnÃ©e). Si ce scope est Ã©gal Ã  0, alors une erreur 403 (Forbidden) est levÃ©e.</p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Le dÃ©corateur ne vÃ©rifie pas si un scope de 1 ou 2 est suffisant pour accÃ©der
aux ressources demandÃ©es. Câest Ã  votre route dâimplÃ©menter cette vÃ©rification,
en utilisant lâargument <code class="docutils literal notranslate"><span class="pre">get_scope=True</span></code> afin de rÃ©cupÃ©rer la valeur exacte du
scope.</p>
</div>
<p>Exemple dâutilisation :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.core.gn_permissions.decorators</span> <span class="kn">import</span> <span class="n">check_cruved_scope</span>

<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/mysensibleview&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@check_cruved_scope</span><span class="p">(</span>
        <span class="s1">&#39;R&#39;</span><span class="p">,</span>
        <span class="n">module_code</span><span class="o">=</span><span class="s2">&quot;OCCTAX&quot;</span>
        <span class="n">get_scope</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">my_sensible_view</span><span class="p">(</span><span class="n">scope</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scope</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Forbidden</span>
</pre></div>
</div>
</section>
<section id="recuperation-manuelle-du-scope">
<h4>RÃ©cupÃ©ration manuelle du scope<a class="headerlink" href="#recuperation-manuelle-du-scope" title="Lien vers cette rubrique">Â¶</a></h4>
<p>La fonction suivante permet de rÃ©cupÃ©rer manuellement le scope pour un rÃ´le, une action et un module donnÃ©s :</p>
<dl class="py function">
<dt class="sig sig-object py" id="get_scope">
<span class="sig-name descname"><span class="pre">get_scope</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">action_code</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">id_role</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">module_code</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">object_code</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#get_scope" title="Lien vers cette dÃ©finition">Â¶</a></dt>
<dd><p>Retourne le scope de lâutilisateur donnÃ©e une action dans le module demandÃ©.</p>
<dl class="field-list simple">
<dt class="field-odd">ParamÃ¨tres<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>action_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>[</em><em>&quot;C&quot;</em><em>, </em><em>&quot;R&quot;</em><em>, </em><em>&quot;U&quot;</em><em>, </em><em>&quot;V&quot;</em><em>, </em><em>&quot;E&quot;</em><em>, </em><em>&quot;D&quot;</em><em>]</em>) â Code de lâaction.</p></li>
<li><p><strong>id_role</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(disponible dans Python v3.13)"><em>int</em></a><em>, </em><em>optional</em>) â Identifiant du role. Utilisation de <code class="docutils literal notranslate"><span class="pre">g.current_user</span></code> si non spÃ©cifiÃ©
(nÃ©cessite de se trouver dans une route authentifiÃ©e).</p></li>
<li><p><strong>module_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>, </em><em>optional</em>) â Code du module. Si non spÃ©cifiÃ©, utilisation de <code class="docutils literal notranslate"><span class="pre">g.current_module</span></code></p></li>
<li><p><strong>object_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>, </em><em>optional</em>) â Code de lâobjet. Si non spÃ©cifiÃ©, utilisation de <code class="docutils literal notranslate"><span class="pre">g.current_object</span></code>,
<code class="docutils literal notranslate"><span class="pre">ALL</span></code> Ã  dÃ©faut.</p></li>
</ul>
</dd>
<dt class="field-even">Renvoie<span class="colon">:</span></dt>
<dd class="field-even"><p>Valeur du scope</p>
</dd>
<dt class="field-odd">Type renvoyÃ©<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(disponible dans Python v3.13)">int</a>[0, 1, 2, 3]</p>
</dd>
</dl>
</dd></dl>

<p>Il est Ã©galement possible de rÃ©cupÃ©rer les scopes pour lâensemble des actions possibles grÃ¢ce Ã  la fonction suivante :</p>
<dl class="py function">
<dt class="sig sig-object py" id="get_scopes_by_action">
<span class="sig-name descname"><span class="pre">get_scopes_by_action</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">id_role</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">module_code</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">object_code</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#get_scopes_by_action" title="Lien vers cette dÃ©finition">Â¶</a></dt>
<dd><p>Retourne un dictionnaire avec pour clÃ© les actions du CRUVED et pour valeur le scope associÃ©
pour un utilisateur et un module donnÃ© (et Ã©ventuellement un objet prÃ©cis).</p>
<dl class="field-list simple">
<dt class="field-odd">ParamÃ¨tres<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id_role</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(disponible dans Python v3.13)"><em>int</em></a>) â Identifiant du role. Utilisation de <code class="docutils literal notranslate"><span class="pre">g.current_user</span></code> si non spÃ©cifiÃ©
(nÃ©cessite de se trouver dans une route authentifiÃ©e).</p></li>
<li><p><strong>module_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a>) â Code du module. Si non spÃ©cifiÃ©, utilisation de <code class="docutils literal notranslate"><span class="pre">g.current_module</span></code>
si dÃ©finie, <code class="docutils literal notranslate"><span class="pre">GEONATURE</span></code> sinon.</p></li>
<li><p><strong>object_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a>) â Code de lâobjet. <code class="docutils literal notranslate"><span class="pre">ALL</span></code> si non prÃ©cisÃ©.</p></li>
</ul>
</dd>
<dt class="field-even">Renvoie<span class="colon">:</span></dt>
<dd class="field-even"><p>Dictionnaire de scope pour chaque action du CRUVED.</p>
</dd>
<dt class="field-odd">Type renvoyÃ©<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(disponible dans Python v3.13)">dict</a>[<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)">str</a>, <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(disponible dans Python v3.13)">int</a>]</p>
</dd>
</dl>
</dd></dl>

<p>Exemple dâusage :</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">geonature.core.gn_permissions.tools</span> <span class="kn">import</span> <span class="n">get_scopes_by_action</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_scopes_by_action</span><span class="p">(</span><span class="n">id_role</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">module_code</span><span class="o">=</span><span class="s2">&quot;METADATA&quot;</span><span class="p">)</span>
<span class="go">{&#39;C&#39;: 3, &#39;R&#39;: 3, &#39;U&#39;: 3, &#39;V&#39;: 3, &#39;E&#39;: 3, &#39;D&#39;: 3}</span>
</pre></div>
</div>
</section>
<section id="restreindre-une-route-aux-utilisateurs-avec-des-permissions-avancees">
<h4>Restreindre une route aux utilisateurs avec des permissions avancÃ©es<a class="headerlink" href="#restreindre-une-route-aux-utilisateurs-avec-des-permissions-avancees" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Utiliser le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;permissions_required</span></code> :</p>
<dl class="py function">
<dt class="sig sig-object py" id="permissions_required">
<span class="sig-prename descclassname"><span class="pre">&#64;</span></span><span class="sig-name descname"><span class="pre">permissions_required</span></span><a class="headerlink" href="#permissions_required" title="Lien vers cette dÃ©finition">Â¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">ParamÃ¨tres<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>action</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>[</em><em>&quot;C&quot;</em><em>, </em><em>&quot;R&quot;</em><em>, </em><em>&quot;U&quot;</em><em>, </em><em>&quot;V&quot;</em><em>, </em><em>&quot;E&quot;</em><em>, </em><em>&quot;D&quot;</em><em>]</em>) â Type dâaction effectuÃ©e par la route
(Create, Read, Update, Validate, Export, Delete)</p></li>
<li><p><strong>module_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a>) â Code du module sur lequel on veut vÃ©rifier les permissions.</p></li>
<li><p><strong>object_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>, </em><em>optional</em>) â Code de lâobjet sur lequel on veut vÃ©rifier les permissions.
Si non fourni, on vÃ©rifie la portÃ©e sur lâobjet <code class="docutils literal notranslate"><span class="pre">ALL</span></code>.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p>Lorsque lâutilisateur nâest pas connectÃ©, le comportement est le mÃªme que le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;login_required</span></code>.
Lorsque celui-ci est connectÃ©, le dÃ©corateur va rÃ©cupÃ©rer lâensemble des permissions pour lâaction donnÃ©e dans le module donnÃ©e (et Ã©ventuellement lâobjet donnÃ©e).
Si aucune permission nâest trouvÃ©e, alors une erreur 403 (Forbidden) est levÃ©e.</p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Le dÃ©corateur ne vÃ©rifie pas si le jeu de permissions est suffisant pour accÃ©der
aux ressources demandÃ©es. Câest Ã  votre route dâimplÃ©menter cette vÃ©rification,
celle-ci recevant le jeu de permissions en argument.</p>
</div>
<p>Exemple dâutilisation :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geonature.core.gn_permissions.decorators</span> <span class="kn">import</span> <span class="n">permissions_required</span>

<span class="nd">@blueprint</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/mysensibleview&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@permissions_required</span><span class="p">(</span>
        <span class="s1">&#39;R&#39;</span><span class="p">,</span>
        <span class="n">module_code</span><span class="o">=</span><span class="s2">&quot;SYNTHESE&quot;</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">my_sensible_view</span><span class="p">(</span><span class="n">permissions</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">permissions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">has_other_filters_than</span><span class="p">(</span><span class="s2">&quot;SCOPE&quot;</span><span class="p">,</span> <span class="s2">&quot;SENSITIVITY&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">scope_value</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">perm</span><span class="o">.</span><span class="n">sensitivity_filter</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Forbidden</span>
</pre></div>
</div>
</section>
<section id="recuperation-manuelle-des-permissions-avancees">
<h4>RÃ©cupÃ©ration manuelle des permissions avancÃ©es<a class="headerlink" href="#recuperation-manuelle-des-permissions-avancees" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Utiliser la fonction <code class="docutils literal notranslate"><span class="pre">get_permissions</span></code> :</p>
<dl class="py function">
<dt class="sig sig-object py" id="get_permissions">
<span class="sig-name descname"><span class="pre">get_permissions</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">action_code</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">id_role</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">module_code</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">object_code</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#get_permissions" title="Lien vers cette dÃ©finition">Â¶</a></dt>
<dd><p>Retourne lâensemble des permissions de lâutilisateur donnÃ©e pour lâaction, le module et lâobjet prÃ©cisÃ©.</p>
<dl class="field-list simple">
<dt class="field-odd">ParamÃ¨tres<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>action_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>[</em><em>&quot;C&quot;</em><em>, </em><em>&quot;R&quot;</em><em>, </em><em>&quot;U&quot;</em><em>, </em><em>&quot;V&quot;</em><em>, </em><em>&quot;E&quot;</em><em>, </em><em>&quot;D&quot;</em><em>]</em>) â Code de lâaction.</p></li>
<li><p><strong>id_role</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(disponible dans Python v3.13)"><em>int</em></a><em>, </em><em>optional</em>) â Identifiant du role. Utilisation de <code class="docutils literal notranslate"><span class="pre">g.current_user</span></code> si non spÃ©cifiÃ©
(nÃ©cessite de se trouver dans une route authentifiÃ©e).</p></li>
<li><p><strong>module_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>, </em><em>optional</em>) â Code du module. Si non spÃ©cifiÃ©, utilisation de <code class="docutils literal notranslate"><span class="pre">g.current_module</span></code></p></li>
<li><p><strong>object_code</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(disponible dans Python v3.13)"><em>str</em></a><em>, </em><em>optional</em>) â Code de lâobjet. Si non spÃ©cifiÃ©, utilisation de <code class="docutils literal notranslate"><span class="pre">g.current_object</span></code>,
<code class="docutils literal notranslate"><span class="pre">ALL</span></code> Ã  dÃ©faut.</p></li>
</ul>
</dd>
<dt class="field-even">Renvoie<span class="colon">:</span></dt>
<dd class="field-even"><p>Liste de permissions</p>
</dd>
<dt class="field-odd">Type renvoyÃ©<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(disponible dans Python v3.13)">list</a>[<a class="reference internal" href="autoapi/geonature/core/gn_permissions/models/index.html#geonature.core.gn_permissions.models.Permission" title="geonature.core.gn_permissions.models.Permission">Permission</a>]</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="a-propos-de-lapi-scope">
<h4>Ã propos de lâAPI Â« scope Â»<a class="headerlink" href="#a-propos-de-lapi-scope" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Certains modules supportent des permissions avec plusieurs types de filtres (par exemple, filtre dâappartenance et filtre de sensibilitÃ©), ce qui amÃ¨ne Ã  devoir dÃ©finir plusieurs permissions pour une mÃªme action dans un module donnÃ©e (par exemple, droit de lecteur des donnÃ©es de mon organisme sans restriction de sensibilitÃ© + droit de lecteur des donnÃ©es non sensible sans restriction dâappartenance).</p>
<p>Cependant, cet usage est trÃ¨s peu rÃ©pandu, la plupart des modules acceptant uniquement un filtre dâappartenance, voir aucun filtre.
Ainsi, lâAPI Â« scope Â» (dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;check_cruved_scope</span></code>, fonctions <code class="docutils literal notranslate"><span class="pre">get_scope</span></code> et <code class="docutils literal notranslate"><span class="pre">get_scopes_by_action</span></code>) visent Ã  simplifier lâusage des permissions dans ces modules en rÃ©sumant les droits de lâutilisateur par un entier de 0 Ã  4 :</p>
<ul class="simple">
<li><p>0 : aucune donnÃ©e (pas de permission)</p></li>
<li><p>1 : donnÃ©es mâappartenant</p></li>
<li><p>2 : donnÃ©es appartenant Ã  mon organisme</p></li>
<li><p>3 : toutes les donnÃ©es (permission sans filtre dâappartenance)</p></li>
</ul>
<p>Lâutilisateur hÃ©ritant des permissions des diffÃ©rents groupes auquel il appartient en plus de ses permissions personnelles, lâAPI Â« scope Â» sâoccupe de calculer le scope maximal de lâutilisateur.</p>
</section>
<section id="rajouter-un-nouveau-type-de-filtre">
<h4>Rajouter un nouveau type de filtre<a class="headerlink" href="#rajouter-un-nouveau-type-de-filtre" title="Lien vers cette rubrique">Â¶</a></h4>
<p>On suppose souhaiter lâajout dâun nouveau type de filtre Â« foo Â».</p>
<ol class="arabic simple">
<li><p>Rajouter une colonne dans la table <code class="docutils literal notranslate"><span class="pre">t_permissions</span></code> nommÃ© <code class="docutils literal notranslate"><span class="pre">foo_filter</span></code> du type dÃ©sirÃ© (boolÃ©en, entier, â¦) avec Ã©ventuellement une contrainte de clÃ© Ã©trangÃ¨re.
Dans le cas oÃ¹ le filtre peut contenir une liste de valeur contrÃ´lÃ©es par une Foreign Key, on prÃ©fÃ¨rera lâajout dâune nouvelle table contenant une Foreign Key vers <code class="docutils literal notranslate"><span class="pre">t_permissions.id_permission</span></code> (par exemple, filtre gÃ©ographique avec liste dâ<code class="docutils literal notranslate"><span class="pre">id_area</span></code> ou filtre taxonomique avec liste de <code class="docutils literal notranslate"><span class="pre">cd_nom</span></code>).</p></li>
<li><p>Rajouter une colonne boolÃ©enne dans la table <code class="docutils literal notranslate"><span class="pre">t_permissions_available</span></code> nommÃ© <code class="docutils literal notranslate"><span class="pre">foo_filter</span></code>.</p></li>
<li><p>Faire Ã©voluer les modÃ¨les Python <code class="docutils literal notranslate"><span class="pre">Permission</span></code> et <code class="docutils literal notranslate"><span class="pre">PermissionAvailable</span></code> pour reflÃ©ter les changements du schÃ©ma de base de donnÃ©es.</p></li>
<li><p>ComplÃ©ter <code class="docutils literal notranslate"><span class="pre">Permission.filters_fields</span></code> et <code class="docutils literal notranslate"><span class="pre">PermissionAvailable.filters_fields</span></code> (<em>e.g.</em> <code class="docutils literal notranslate"><span class="pre">&quot;FOO&quot;:</span> <span class="pre">foo_filter</span></code>).</p></li>
<li><p>VÃ©rifier que la propriÃ©tÃ© <code class="docutils literal notranslate"><span class="pre">Permission.filters</span></code> fonctionne correctement avec le nouveau filtre : celui-ci doit Ãªtre renvoyÃ© uniquement sâil est dÃ©fini.
Le cas dâune relationship nâa encore jamais Ã©tÃ© traitÃ©.</p></li>
<li><p>Optionel : Rajouter une mÃ©thode statique <code class="docutils literal notranslate"><span class="pre">Permission.__FOO_le__(a,</span> <span class="pre">b)</span></code>.
Celle-ci reÃ§oit en argument 2 filtres FOO et doit renvoyer <code class="docutils literal notranslate"><span class="pre">True</span></code> lorsque le filtre <code class="docutils literal notranslate"><span class="pre">a</span></code> est plus restrictif (au autant) que le filtre <code class="docutils literal notranslate"><span class="pre">b</span></code>.
Par exemple, dans le cas dâun filtre gÃ©ographique, on renvera <code class="docutils literal notranslate"><span class="pre">True</span></code> si <code class="docutils literal notranslate"><span class="pre">b</span></code> vaut <code class="docutils literal notranslate"><span class="pre">None</span></code> (pas de restriction gÃ©ographique) ou si la liste des zonages <code class="docutils literal notranslate"><span class="pre">a</span></code> est un sous-ensemble de la liste des zonages <code class="docutils literal notranslate"><span class="pre">b</span></code>.
Cette mÃ©thode permet dâoptimiser le jeu de permission en supprimant les permissions redondantes.</p></li>
<li><p>ComplÃ©ter la classe <code class="docutils literal notranslate"><span class="pre">PermFilter</span></code> qui permet lâaffichage des permissions dans Flask-Admin (permissions des utilisateurs et des groupes).
Attention, Flask-Admin utilise FontAwesome version <strong>4</strong>.</p></li>
<li><p>Faire Ã©voluer Flask-Admin (classes <code class="docutils literal notranslate"><span class="pre">PermissionAdmin</span></code> et <code class="docutils literal notranslate"><span class="pre">PermissionAvailableAdmin</span></code>) pour prendre en charge le nouveau type de filtre.</p></li>
<li><p>ImplÃ©menter le support de son nouveau filtre Ã  lâendroit voulu (typiquement la synthÃ¨se).</p></li>
<li><p>ComplÃ©ter ou faire Ã©voluer la table <code class="docutils literal notranslate"><span class="pre">t_permissions_available</span></code> pour dÃ©clarer le nouveau filtre comme disponible pour son module.</p></li>
</ol>
</section>
</section>
</section>
<section id="developpement-frontend">
<h2>DÃ©veloppement Frontend<a class="headerlink" href="#developpement-frontend" title="Lien vers cette rubrique">Â¶</a></h2>
<section id="serveur-frontend-en-developpement">
<h3>Serveur frontend en dÃ©veloppement<a class="headerlink" href="#serveur-frontend-en-developpement" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Lancer le serveur frontent en dÃ©veloppement :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/geonature/frontend/
nvm<span class="w"> </span>use
npm<span class="w"> </span>run<span class="w"> </span>start
</pre></div>
</div>
<p>Le frontend est alors accessible Ã  lâadresse <a class="reference external" href="http://127.0.0.1:4200">http://127.0.0.1:4200</a>.</p>
</section>
<section id="bonnes-pratiques">
<h3>Bonnes pratiques<a class="headerlink" href="#bonnes-pratiques" title="Lien vers cette rubrique">Â¶</a></h3>
<ul class="simple">
<li><p>Chaque gn_module de GeoNature doit Ãªtre un module Angular indÃ©pendant <a class="reference external" href="https://angular.io/guide/ngmodule">https://angular.io/guide/ngmodule</a>.</p></li>
<li><p>Ce gn_module peut sâappuyer sur une sÃ©rie de composants gÃ©nÃ©riques intÃ©grÃ©s dans le module GN2CommonModule et dÃ©crit ci-dessous</p></li>
</ul>
</section>
<section id="les-composants-generiques">
<h3>Les composants gÃ©nÃ©riques<a class="headerlink" href="#les-composants-generiques" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Un ensemble de composants dÃ©crits ci-dessous sont intÃ©grÃ©s dans le coeur de GeoNature et permettent aux dÃ©veloppeurs de simplifier la mise en place de formulaires ou de bloc cartographiques.</p>
<p>Voir la <a class="reference external" href="http://pnx-si.github.io/GeoNature/frontend/modules/GN2CommonModule.html">DOCUMENTATION COMPLETE</a> sur les composants gÃ©nÃ©riques.</p>
<p>NB : les composants de type Â«Â formulaireÂ Â» (balise <cite>input</cite> ou <cite>select</cite>) partagent une logique commune et ont des <code class="docutils literal notranslate"><span class="pre">Inputs</span></code> et des <code class="docutils literal notranslate"><span class="pre">Outputs</span></code> communs, dÃ©crits ci-dessous. (voir <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/frontend/src/app/GN2CommonModule/form/genericForm.component.ts">https://github.com/PnX-SI/GeoNature/blob/master/frontend/src/app/GN2CommonModule/form/genericForm.component.ts</a>).</p>
<p>Une documentation complÃ¨te des composants gÃ©nÃ©riques est
<a class="reference external" href="http://pnx-si.github.io/GeoNature/frontend/modules/GN2CommonModule.html">disponible ici</a></p>
<p>NB : les composants de type Â«Â formulaireÂ Â» (balise <cite>input</cite> ou <cite>select</cite>) partagent
une logique commune et ont des <code class="docutils literal notranslate"><span class="pre">Inputs</span></code> et des <code class="docutils literal notranslate"><span class="pre">Outputs</span></code> communs, dÃ©crits
ci-dessous.
(voir <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/frontend/src/app/GN2CommonModule/form/genericForm.component.ts">https://github.com/PnX-SI/GeoNature/blob/master/frontend/src/app/GN2CommonModule/form/genericForm.component.ts</a>).</p>
<ul>
<li><p>Inputs</p>
<ul class="simple">
<li><p>Lâinput <code class="docutils literal notranslate"><span class="pre">parentFormControl</span></code> de type <code class="docutils literal notranslate"><span class="pre">FormControl</span></code> (<a class="reference external" href="https://angular.io/api/forms/FormControl">https://angular.io/api/forms/FormControl</a>) permet de contrÃ´ler la logique et les valeurs du formulaire depuis lâextÃ©rieur du composant. Cet input est <strong>obligatoire</strong> pour le fonctionnement du composant.</p></li>
<li><p>Lâinput <code class="docutils literal notranslate"><span class="pre">label</span></code> (string) permet dâafficher un label au dessus de lâinput.</p></li>
<li><p>Lâinput <code class="docutils literal notranslate"><span class="pre">displayAll</span></code> (boolean, dÃ©faut = false) permet dâajouter un item âtousâ sur les inputs de type select (Exemple : pour sÃ©lectionner tous les jeux de donnÃ©es de la liste)</p></li>
<li><p>Lâinput <code class="docutils literal notranslate"><span class="pre">multiSelect</span></code> (boolean, dÃ©faut = false) permet de passer les composants de type select en Â«Â multiselectÂ Â» (sÃ©lection multiple sur une liste dÃ©roulante). Le parentFormControl devient par consÃ©quent un tableau</p></li>
<li><p>Lâinput <code class="docutils literal notranslate"><span class="pre">searchBar</span></code> (boolean, dÃ©faut = false) permet de rajouter une barre de recherche sur les composants multiselect</p></li>
<li><p>Lâinput <code class="docutils literal notranslate"><span class="pre">disabled</span></code> (boolean) permet de rendre le composant non-saisissable</p></li>
<li><p>Lâinput <code class="docutils literal notranslate"><span class="pre">debounceTime</span></code> dÃ©finit une durÃ©e en ms aprÃ¨s laquelle les Ã©venements <code class="docutils literal notranslate"><span class="pre">onChange</span></code> et <code class="docutils literal notranslate"><span class="pre">onDelete</span></code> sont dÃ©clenchÃ©s suite Ã  un changement dâun formulaire. (Par dÃ©fault Ã  0)</p></li>
</ul>
</li>
<li><p>Outputs</p>
<p>Plusieurs <code class="docutils literal notranslate"><span class="pre">Output</span></code> communs Ã  ses composants permettent dâÃ©mettre des Ã©vÃ©nements liÃ©s aux formulaires.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">onChange</span></code> : Ã©vÃ©nement Ã©mit Ã  chaque fois quâun changement est effectuÃ© sur le composant. Renvoie la valeur fraiche de lâinput.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">onDelete</span></code> : Ã©vÃ©nement Ã©mit chaque fois que le champ du formulaire est supprimÃ©. Renvoie un Ã©venement vide.</p></li>
</ul>
</li>
</ul>
<p>Ces composants peuvent Ãªtre considÃ©rÃ©s comme des Â«Â dump componentsÂ Â» ou
Â«Â presentation componentsÂ Â», puisque que la logique de contrÃ´le est dÃ©portÃ©e
au composant parent qui lâaccueille
(<a class="reference external" href="https://blog.angular-university.io/angular-2-smart-components-vs-presentation-components-whats-the-difference-when-to-use-each-and-why/">https://blog.angular-university.io/angular-2-smart-components-vs-presentation-components-whats-the-difference-when-to-use-each-and-why/</a>)</p>
<p>Un ensemble de composants permettant de simplifier lâaffichage des cartographies
Leaflet sont disponibles. Notamment un composant Â«Â map-listÂ Â» permettant de
connecter une carte avec une liste dâobjets dÃ©crits en dÃ©tail ci-dessous.</p>
<section id="maplistcomponent">
<h4>MapListComponent<a class="headerlink" href="#maplistcomponent" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Le composant MapList fournit une carte pouvant Ãªtre synchronisÃ©e
avec une liste. La liste, pouvant Ãªtre spÃ©cifique Ã  chaque module,
elle nâest pas intÃ©grÃ©e dans le composant et est laissÃ©e Ã  la
responsabilitÃ© du dÃ©veloppeur. Le service <code class="docutils literal notranslate"><span class="pre">MapListService</span></code> offre
cependant des fonctions permettant facilement de synchroniser
les deux Ã©lÃ©ments.</p>
<p>FonctionnalitÃ© et comportement offerts par le composant et le
service :</p>
<ul>
<li><p>Charger les donnÃ©es</p>
<p>Le service expose la fonction <code class="docutils literal notranslate"><span class="pre">getData(apiEndPoint,</span> <span class="pre">params?)</span></code>
permettant de charger les donnÃ©es pour la carte et la liste.
Cette fonction doit Ãªtre utilisÃ©e dans le composant qui utilise
le composant <code class="docutils literal notranslate"><span class="pre">MapListComponent</span></code>. Elle se charge de faire
appel Ã  lâAPI passÃ©e en paramÃ¨tre et de rendre les donnÃ©es
disponibles au service.</p>
<p>Le deuxiÃ¨me paramÃ¨tre <code class="docutils literal notranslate"><span class="pre">params</span></code> est un tableau de paramÃ¨tre(s)
(facultatif). Il permet de filtrer les donnÃ©es sur nâimporte
quelle propriÃ©tÃ© du GeoJson, et Ã©galement de gÃ©rer
la pagination.</p>
<p>Exemple : afficher les 10 premiers relevÃ©s du cd_nom 212 :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">mapListService</span><span class="p">.</span><span class="nx">getData</span><span class="p">(</span><span class="s1">&#39;occtax/releve&#39;</span><span class="p">,</span>
<span class="p">[{</span><span class="s1">&#39;param&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;limit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;value&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="s1">&#39;},</span>
<span class="s1">{&#39;</span><span class="nx">param</span><span class="s1">&#39;: &#39;</span><span class="nx">cd_nom</span><span class="s1">&#39;, &#39;</span><span class="nx">value</span><span class="s1">&#39;: 212&#39;</span><span class="p">}])</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/contrib/occtax/frontend/app/occtax-map-list/occtax-map-list.component.ts#L99/">Exemple dans le module OccTax</a></p>
<p>LâAPI doit nÃ©cessairement renvoyer un objet comportant un
GeoJson. La structure du lâobjet doit Ãªtre la suivante :</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;total&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nombre d&#39;Ã©lÃ©ment total&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;total_filtered&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nombre d&#39;Ã©lÃ©ment filtrÃ©&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;page&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;numÃ©ro de page de la liste&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;limit&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;limite d&#39;Ã©lÃ©ment renvoyÃ©&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;items&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;le GeoJson&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Pour une liste simple sans pagination, seule la propriÃ©tÃ© âitemsâ
est obligatoire.</p>
</li>
<li><p>RafraÃ®chir les donnÃ©es</p>
<p>La fonction <code class="docutils literal notranslate"><span class="pre">refreshData(apiEndPoint,</span> <span class="pre">method,</span> <span class="pre">params?)</span></code> permet de raffrachir les donnÃ©es en fonction de filtres personnalisÃ©s.
Les paramÃ¨tres <code class="docutils literal notranslate"><span class="pre">apiEndPoint</span></code>Â et <code class="docutils literal notranslate"><span class="pre">params</span></code> sont les mÃªmes que pour la fonction <code class="docutils literal notranslate"><span class="pre">getData</span></code>. Le paramÃ¨tre <code class="docutils literal notranslate"><span class="pre">method</span></code> permet lui de chosir si on ajoute - <code class="docutils literal notranslate"><span class="pre">append</span></code>- , ou si on initialise (ou remplace) -<code class="docutils literal notranslate"><span class="pre">set</span></code>- un filtre.</p>
<p>Exemple 1 : Pour filtrer sur lâobservateur 1, puis ajouter un filtre sur lâobservateur 2 :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">mapListService</span><span class="p">.</span><span class="nx">refreshData</span><span class="p">(</span><span class="s1">&#39;occtax/relevÃ©&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;append, [{&#39;</span><span class="nx">param</span><span class="s1">&#39;: &#39;</span><span class="nx">observers</span><span class="s1">&#39;, &#39;</span><span class="nx">value</span><span class="s1">&#39;: 1&#39;</span><span class="p">}])</span>
</pre></div>
</div>
<p>puis :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">refreshData</span><span class="p">(</span><span class="s1">&#39;occtax/relevÃ©&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;append, [{&#39;</span><span class="nx">param</span><span class="s1">&#39;: &#39;</span><span class="nx">observers</span><span class="s1">&#39;, &#39;</span><span class="nx">value</span><span class="s1">&#39;: 2&#39;</span><span class="p">}])</span>
</pre></div>
</div>
<p>Exemple 2: pour filtrer sur le cd_nom 212, supprimer ce filtre et filtrer sur  le cd_nom 214</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">mapListService</span><span class="p">.</span><span class="nx">refreshData</span><span class="p">(</span><span class="s1">&#39;occtax/relevÃ©&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;set, [{&#39;</span><span class="nx">param</span><span class="s1">&#39;: &#39;</span><span class="nx">cd_nom</span><span class="s1">&#39;, &#39;</span><span class="nx">value</span><span class="s1">&#39;: 1&#39;</span><span class="p">}])</span>
</pre></div>
</div>
<p>puis :</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">mapListService</span><span class="p">.</span><span class="nx">refreshData</span><span class="p">(</span><span class="s1">&#39;occtax/relevÃ©&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;set, [{&#39;</span><span class="nx">param</span><span class="s1">&#39;: &#39;</span><span class="nx">cd_nom</span><span class="s1">&#39;, &#39;</span><span class="nx">value</span><span class="s1">&#39;: 2&#39;</span><span class="p">}])</span>
</pre></div>
</div>
</li>
<li><p>Gestion des Ã©venements :</p>
<ul class="simple">
<li><p>Au clic sur un marker de la carte, le service <code class="docutils literal notranslate"><span class="pre">MapListService</span></code> expose la propriÃ©tÃ© <code class="docutils literal notranslate"><span class="pre">selectedRow</span></code> qui est un tableau contenant lâid du marker sÃ©lectionnÃ©. Il est ainsi possible de surligner lâÃ©lÃ©ment sÃ©lÃ©ctionnÃ© dans le liste.</p></li>
<li><p>Au clic sur une ligne du tableau, utiliser la fonction <code class="docutils literal notranslate"><span class="pre">MapListService.onRowSelected(id)</span></code> (id Ã©tant lâid utilisÃ© dans le GeoJson) qui permet de zoomer sur le point sÃ©lÃ©ctionner et de changer la couleur de celui-ci.</p></li>
</ul>
</li>
</ul>
<p>Le service contient Ã©galement deux propriÃ©tÃ©s publiques <code class="docutils literal notranslate"><span class="pre">geoJsonData</span></code> (le geojson renvoyÃ© par lâAPI) et <code class="docutils literal notranslate"><span class="pre">tableData</span></code> (le tableau de features du Geojson) qui sont respectivement passÃ©es Ã  la carte et Ã  la liste. Ces deux propriÃ©tÃ©s sont utilisables pour interagir (ajouter, supprimer) avec les donnÃ©es de la carte et de la liste.</p>
<ul>
<li><p>Selector : <code class="docutils literal notranslate"><span class="pre">pnx-map-list</span></code></p></li>
<li><p>Inputs :</p>
<dl class="field-list">
<dt class="field-odd"><code class="docutils literal notranslate"><span class="pre">idName</span></code><span class="colon">:</span></dt>
<dd class="field-odd"><p>LibellÃ© de lâid du geojson (id_releve, id)</p>
<p>Type: <code class="docutils literal notranslate"><span class="pre">string</span></code></p>
</dd>
<dt class="field-even"><code class="docutils literal notranslate"><span class="pre">height</span></code><span class="colon">:</span></dt>
<dd class="field-even"><p>Taille de lâaffichage de la carte Leaflet</p>
<p>Type: <code class="docutils literal notranslate"><span class="pre">string</span></code></p>
</dd>
</dl>
</li>
</ul>
<p>Exemple dâutilisation avec une liste simple :</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">pnx-map-list</span>
        <span class="na">idName</span><span class="o">=</span><span class="s">&quot;id_releve_occtax&quot;</span>
        <span class="na">height</span><span class="o">=</span><span class="s">&quot;80vh&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">pnx-map-list</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span> <span class="na">ngFor</span><span class="o">=</span><span class="s">&quot;let row of mapListService.tableData&quot;</span> <span class="err">[</span><span class="na">ngClass</span><span class="err">]=&quot;</span> <span class="err">{&#39;</span><span class="na">selected</span><span class="err">&#39;</span><span class="na">:</span> <span class="na">mapListService</span><span class="err">.</span><span class="na">selectedRow</span><span class="err">[</span><span class="na">0</span><span class="err">]}</span> <span class="err">==</span> <span class="na">row</span><span class="err">.</span><span class="na">id</span> <span class="err">&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span> <span class="err">(</span><span class="na">click</span><span class="err">)=&quot;</span><span class="na">mapListService</span><span class="err">.</span><span class="na">onRowSelect</span><span class="err">(</span><span class="na">row</span><span class="err">.</span><span class="na">id</span><span class="err">)&quot;</span><span class="p">&gt;</span> Zoom on map <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span> <span class="p">&gt;</span> {{row.observers}} <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">td</span> <span class="p">&gt;</span> {{row.date}} <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="gestion-des-erreurs">
<h3>Gestion des erreurs<a class="headerlink" href="#gestion-des-erreurs" title="Lien vers cette rubrique">Â¶</a></h3>
<p>GeoNature utilise un intercepteur gÃ©nÃ©rique afin dâafficher un toaster en cas dâerreur lors dâune requÃªte HTTP.
Si vous souhaitez traiter lâerreur vous-mÃªme, et empÃªcher le toaster par dÃ©faut de sâafficher, vous pouvez dÃ©finir un header <code class="docutils literal notranslate"><span class="pre">not-to-handle</span></code> Ã  votre requÃªte :</p>
<div class="highlight-typescript notranslate"><div class="highlight"><pre><span></span><span class="k">this</span><span class="p">.</span><span class="nx">_http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/url&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;not-to-handle&quot;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">})</span>
</pre></div>
</div>
</section>
<section id="tests">
<h3>Tests<a class="headerlink" href="#tests" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Pour toute PR ou nouvelle fonctionnalitÃ© il est demandÃ© dâÃ©crire des tests. Voir la section dÃ©diÃ©e sur lâ<a class="reference internal" href="#tests-frontend"><span class="std std-ref">Ã©criture des tests frontend</span></a>.</p>
</section>
</section>
<section id="tests-backend">
<span id="id5"></span><h2>Tests backend<a class="headerlink" href="#tests-backend" title="Lien vers cette rubrique">Â¶</a></h2>
<p>Cette documentation a pour objectif dâexpliquer comment Ã©crire des tests pour
le backend de GeoNature.</p>
<p>Un test se dÃ©compose en gÃ©nÃ©ral en 3 Ã©tapes :</p>
<ul class="simple">
<li><p><strong>Arrange</strong> : prÃ©pare tous les Ã©lÃ©ments avant lâexÃ©cution de la portion de
code Ã  tester (en gÃ©nÃ©ral une fonction)</p></li>
<li><p><strong>Act</strong> : exÃ©cute cette portion de code</p></li>
<li><p><strong>Assert</strong> : vÃ©rifie que lâexÃ©cution sâest bien dÃ©roulÃ©e</p></li>
</ul>
<p>Il est toujours utile de distinguer dans le code ces 3 Ã©tapes en ajoutant un
commentaire ou une sÃ©paration entre elles.</p>
<p>Enfin un test doit Ãªtre concis, il vaut mieux Ã©crire plusieurs tests pour
tester diffÃ©rentes configurations plutÃ´t quâun seul les testant toutes dâun
coup. Cela permet dâidentifier plus prÃ©cisÃ©ment le test qui nâa pas fonctionnÃ©.</p>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Comme spÃ©cifiÃ© dans la partie DÃ©veloppement, la librairie Python PyTest est
utilisÃ©e pour rÃ©diger des tests. Elle permet de :</p>
<ul class="simple">
<li><p>disposer dâun framework de redaction de tests en se basant notamment sur
lâinstruction <code class="docutils literal notranslate"><span class="pre">assert</span></code></p></li>
<li><p>Ã©crire des objets ou des portions de code rÃ©utilisables : les <code class="docutils literal notranslate"><span class="pre">fixtures</span></code></p></li>
<li><p>lancer un mÃªme test avec des configurations diffÃ©rentes</p></li>
<li><p>faire de nombreuses autres choses dÃ©crites dans la
<a class="reference external" href="https://docs.pytest.org/">documentation PyTest</a></p></li>
</ul>
</section>
<section id="utilisation">
<h3>Utilisation<a class="headerlink" href="#utilisation" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Les tests sont des fonctions pouvant Ãªtre regroupÃ©es dans des classes. La
nomenclature est la suivante :</p>
<ul class="simple">
<li><p>Les tests doivent Ãªtre situÃ©es dans un dossier nommÃ© tests (dans
GeoNature, ils sont situÃ©s dans <code class="docutils literal notranslate"><span class="pre">backend/geonature/tests</span></code>)</p></li>
<li><p>Le nom de chaque fichier Python contenant des tests doit commencer par
<code class="docutils literal notranslate"><span class="pre">test_</span></code></p></li>
<li><p>Chaque classe comprenant des tests doit commencer par <code class="docutils literal notranslate"><span class="pre">Test</span></code> (pas de
underscore car la norme PEP8 impose un nom de classe en CamelCase)</p></li>
<li><p>Chaque nom de test (donc de fonction) doit commencer par <code class="docutils literal notranslate"><span class="pre">test_</span></code> pour
pouvoir Ãªtre dÃ©tectÃ© automatiquement par PyTest</p></li>
</ul>
</section>
<section id="fixtures">
<h3>Fixtures<a class="headerlink" href="#fixtures" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Les fixtures de PyTest peuvent permettre de nombreuses choses comme expliquÃ©
dans la documentation PyTest sur <a class="reference external" href="https://docs.pytest.org/explanation/fixtures.html#about-fixtures">les fixtures</a>.</p>
<p>Dans GeoNature elles sont, en gÃ©nÃ©ral, utilisÃ©es pour dÃ©finir des objets
rÃ©utilisables comme des utilisateurs en base de donnÃ©es pour tester les droits, des observations fictives de taxon pour tester des routes de la synthÃ¨se ou
encore des Ã©lÃ©ments non prÃ©sents en base pour tester que le code voulant les
rÃ©cupÃ©rer ne plante pas etc.</p>
<p>Elles sont aussi utilisÃ©es pour fournir un contexte Ã  un test. Par exemple, la
fixture <code class="docutils literal notranslate"><span class="pre">temporary_transaction</span></code> permet de ne pas sauvegarder ce qui sera
insÃ©rÃ©/supprimÃ©/modifiÃ© dans la base de donnÃ©es pendant le test.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>La plupart des fixtures sont rassemblÃ©es dans
<code class="docutils literal notranslate"><span class="pre">backend/geonature/tests/fixtures.py</span></code>, il est important de regarder
lesquelles y sont dÃ©finies avant dâen Ã©crire dâautres !</p>
</div>
<p>Enfin, les fixtures peuvent aussi Ãªtre dÃ©finies directement dans le fichier
Python du test. Elles sont dÃ©finies comme suit :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Obligatoire pour accÃ©der au dÃ©corateur</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="c1"># DÃ©finit une fixture qui renverra 2</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">my_fixture</span><span class="p">():</span>
  <span class="k">return</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Et sâutilisent comme suit :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># On passe directement la fixture en argument du test. Il est</span>
<span class="c1"># nÃ©cessaire de l&#39;importer si elle n&#39;est pas dÃ©finie dans le mÃªme fichier</span>
<span class="c1"># Ce test n&#39;est pas dans une classe (donc pas de self)</span>
<span class="k">def</span> <span class="nf">test_ma_fonction_a_tester</span><span class="p">(</span><span class="n">my_fixture</span><span class="p">):</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">my_fixture</span>

  <span class="c1"># On vÃ©rifie que la fixture retourne la bonne valeur</span>
  <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Il est aussi possible de dÃ©finir un <code class="docutils literal notranslate"><span class="pre">scope</span></code> dâune fixture comme ceci :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># DÃ©finit une fixture qui renverra 2 mais qui sera exÃ©cutÃ©e qu&#39;une</span>
<span class="c1"># seule fois par classe (une classe regroupe plusieurs tests) au</span>
<span class="c1"># lieu d&#39;une fois par test. Il est possible aussi de dÃ©finir ce</span>
<span class="c1"># scope au module ou Ã  la function</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_fixture</span><span class="p">():</span>
  <span class="k">return</span> <span class="mi">2</span>
</pre></div>
</div>
</section>
<section id="exemple">
<h3>Exemple<a class="headerlink" href="#exemple" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Voici un exemple de test qui a Ã©tÃ© fait dans GeoNature</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_get_consistancy_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">synthese_record</span> <span class="o">=</span> <span class="n">Synthese</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;gn_profiles.get_consistancy_data&quot;</span><span class="p">,</span>
                <span class="n">id_synthese</span><span class="o">=</span><span class="n">synthese_record</span><span class="o">.</span><span class="n">id_synthese</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</pre></div>
</div>
<p>Ce test est situÃ© dans une classe (le <code class="docutils literal notranslate"><span class="pre">self</span></code> est donc obligatoire). Ce test
vÃ©rifie que la route <code class="docutils literal notranslate"><span class="pre">gn_profiles.get_consistancy_data</span></code> fonctionne bien avec
un <code class="docutils literal notranslate"><span class="pre">id_synthese</span></code> pris dans la base de donnÃ©es. Le <code class="docutils literal notranslate"><span class="pre">assert</span></code> est directement
interprÃ©tÃ© par PyTest et le test sera en erreur si la condition nâest pas
respectÃ©e. Il est possible dâÃ©crire plusieurs <code class="docutils literal notranslate"><span class="pre">assert</span></code> pour un mÃªme test !</p>
<p>Enfin, une fixture a Ã©tÃ© utilisÃ©e au niveau de la classe pour rendre accessible
lâattribut <code class="docutils literal notranslate"><span class="pre">client</span></code> de la classe, utile pour faire des requÃªtes http
notamment.</p>
</section>
<section id="dans-github">
<h3>Dans GitHub<a class="headerlink" href="#dans-github" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Dans le dÃ©pÃ´t de GeoNature sur GitHub, tous ces tests sont exÃ©cutÃ©s
automatiquement pour chaque commit dâune pull request grÃ¢ce Ã  PyTest et Ã 
GitHub Actions. Ils permettent donc de vÃ©rifier que les modifications apportÃ©es
par les dÃ©veloppeurs ne changent pas le statut des tests et permettent donc aux
mainteneurs du projet de disposer dâune meilleure confiance dans la pull
request. Un coverage est aussi exÃ©cutÃ© pour sâassurer que les nouveaux
dÃ©veloppements sont bien testÃ©s.</p>
</section>
<section id="coverage">
<h3>Coverage<a class="headerlink" href="#coverage" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Le coverage est un systÃ¨me permettant de quantifier les lignes de code
exÃ©cutÃ©es par le test. Exemple rapide :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># DÃ©finition d&#39;une fonction quelconque</span>
<span class="k">def</span> <span class="nf">ma_fonction_a_tester</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;blablabla&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;blabla&quot;</span>

<span class="c1"># DÃ©finition d&#39;un possible test associÃ©</span>
<span class="k">def</span> <span class="nf">test_ma_fonction_a_tester</span><span class="p">():</span>
    <span class="c1"># Arrange</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Act</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">ma_fonction_a_tester</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;blablabla&quot;</span>
</pre></div>
</div>
<p>Dans cet exemple, un seul test a Ã©tÃ© Ã©crit oÃ¹ <code class="docutils literal notranslate"><span class="pre">verbose</span> <span class="pre">=</span> <span class="pre">True</span></code> donc la
ligne <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">&quot;blabla&quot;</span></code> ne sera jamais exÃ©cutÃ©e par un test. Donc sur les 3
lignes de la fonction, seules 67% des lignes ont Ã©tÃ© exÃ©cutÃ©es donc le
coverage serait dâenviron (le calcul est plus complexe) 67%. Il faudrait
donc Ã©crire un nouveau test avec <code class="docutils literal notranslate"><span class="pre">verbose</span> <span class="pre">=</span> <span class="pre">False</span></code> dans <code class="docutils literal notranslate"><span class="pre">Arrange</span></code> pour
obtenir 100% de coverage sur la fonction <code class="docutils literal notranslate"><span class="pre">ma_fonction_a_tester()</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Un coverage de 100% ne garantit pas un code sans bug ! Il permet plutÃ´t
dâÃªtre plus confiant dans la modification/refactorisation de lignes de code et dans le dÃ©veloppement de nouvelles fonctionnalitÃ©s.</p>
</div>
</section>
<section id="dans-vscode">
<h3>Dans VSCode<a class="headerlink" href="#dans-vscode" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Il est possible dâinstaller <a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=ms-python.python">lâextension Python</a> pour facilement lancer et
debugger un ou plusieurs tests directement depuis VSCode. Il suffit juste de
changer le fichier <code class="docutils literal notranslate"><span class="pre">settings.json</span></code> dans le dossier <code class="docutils literal notranslate"><span class="pre">.vscode</span></code> de votre
projet avec le code suivant pour quâil soit compatible avec GeoNature :</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;python.testing.pytestArgs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;/chemin/vers/geonature/backend/geonature/tests&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;python.testing.unittestEnabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;python.testing.pytestEnabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Pour exÃ©cuter les tests de GeoNature placez vous Ã  la racine du dossier oÃ¹ est
installÃ© GeoNature et exÃ©cutez la commande suivante :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pytest
</pre></div>
</div>
<p>Assurez vous dâavoir bien installÃ© les librairies de dÃ©veloppement avant
(en Ã©tant toujours placÃ© Ã  la racine de lâinstallation de GeoNature) :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.<span class="o">[</span>tests<span class="o">]</span>
</pre></div>
</div>
<p>Pour exÃ©cuter un seul test lâoption <code class="docutils literal notranslate"><span class="pre">-k</span></code> est trÃ¨s utile :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>-k<span class="w"> </span><span class="s1">&#39;test_uuid_report_with_dataset_id&#39;</span>
</pre></div>
</div>
<p>Ici, elle exÃ©cutera uniquement le test <code class="docutils literal notranslate"><span class="pre">test_uuid_report_with_dataset_id</span></code> (du
ficher <code class="docutils literal notranslate"><span class="pre">test_gn_meta.py</span></code>).</p>
<p>Enfin, pour gÃ©nÃ©rer le coverage en mÃªme temps que les tests :</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>--cov<span class="w"> </span>--cov-report<span class="w"> </span>xml
</pre></div>
</div>
<p>Le format <code class="docutils literal notranslate"><span class="pre">xml</span></code> est interprÃ©tÃ© par lâextension VSCode <a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=ryanluker.vscode-coverage-gutters">Coverage Gutters</a> qui fournie directement dans le code les lignes couvertes et celles non parcourues par le test.</p>
<p>Si vous souhaitez voir le coverage directement depuis le navigateur, il est
possible de gÃ©nÃ©rer le coverage au format html en remplaÃ§ant <code class="docutils literal notranslate"><span class="pre">xml</span></code> par
<code class="docutils literal notranslate"><span class="pre">html</span></code>.</p>
</section>
<section id="evaluer-les-performances-du-backend">
<h3>Evaluer les performances du backend<a class="headerlink" href="#evaluer-les-performances-du-backend" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Les versions de GeoNature &gt;2.14.1 intÃ¨grent la possibilitÃ© dâÃ©valuer les performances de routes connues pour leur temps de traitement important. Par exemple, lâappel de la route <code class="docutils literal notranslate"><span class="pre">gn_synthese.get_observations_for_web</span></code> avec une gÃ©ographie non-prÃ©sente dans le rÃ©fÃ©rentiel gÃ©ographique.</p>
<p>Cette fonctionnalitÃ© sâappuie sur <code class="docutils literal notranslate"><span class="pre">pytest</span></code> et son extension <a href="#id6"><span class="problematic" id="id7">``</span></a>pytest-benchmark``(<a class="reference external" href="https://pytest-benchmark.readthedocs.io/en/latest/">https://pytest-benchmark.readthedocs.io/en/latest/</a>).</p>
<p>Pour lancer les tests de performances, utiliser la commande suivante : <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">--benchmark-only</span></code></p>
<p>La crÃ©ation de tests de performance sâeffectue Ã  lâaide de la classe <code class="docutils literal notranslate"><span class="pre">geonature.tests.benchmarks.benchmark_generator.BenchmarkTest</span></code>.</p>
<p>Lâobjet <code class="docutils literal notranslate"><span class="pre">BenchmarkTest</span></code> prend en argument :</p>
<ul class="simple">
<li><p>La fonction dont on souhaite mesurer la performance</p></li>
<li><p>Le nom du test</p></li>
<li><p>Les <code class="docutils literal notranslate"><span class="pre">args</span></code> de la fonction</p></li>
<li><p>les <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> de la fonction</p></li>
</ul>
<p>Cette classe permet de gÃ©nÃ©rer une fonction de test utilisable dans le _framework_ existant de <code class="docutils literal notranslate"><span class="pre">pytest</span></code>. Pour cela, rien de plus simple ! CrÃ©er un fichier de test (de prÃ©fÃ©rence dans le sous-dossier <code class="docutils literal notranslate"><span class="pre">backend/geonature/tests/benchmarks</span></code>).</p>
<p>Import la classe BenchmarkTest dans le fichier de test.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">geonature.tests.benchmarks</span> <span class="kn">import</span> <span class="n">BenchmarkTest</span>
</pre></div>
</div>
<p>Ajouter un test de performance, ici le test <code class="docutils literal notranslate"><span class="pre">test_print</span></code> qui teste la fonction <code class="docutils literal notranslate"><span class="pre">print</span></code> de Python.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bench</span> <span class="o">=</span> <span class="n">BenchmarkTest</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span><span class="s2">&quot;test_print&quot;</span><span class="p">,[</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span><span class="s2">&quot;World&quot;</span><span class="p">],{})</span>
</pre></div>
</div>
<p>Ajouter la fonction gÃ©nÃ©rÃ©e dans <code class="docutils literal notranslate"><span class="pre">bench</span></code> dans une classe de test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">benchmark</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s2">&quot;occhab&quot;</span><span class="p">)</span> <span class="c1"># Pas obligatoire mais permet de compartimenter les tests de performances</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">&quot;client_class&quot;</span><span class="p">,</span> <span class="s2">&quot;temporary_transaction&quot;</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">TestBenchie</span><span class="p">:</span>
        <span class="n">test_print</span> <span class="o">=</span> <span class="n">bench</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.benchmark</span></code> permet de configurer lâÃ©xecution des tests de performances par <code class="docutils literal notranslate"><span class="pre">pytest-benchmark</span></code>. Dans lâexemple ci-dessus, on lâutilise pour regrouper les tests de performances
dÃ©clarÃ©s dans la classe <code class="docutils literal notranslate"><span class="pre">TestBenchie</span></code> dans un groupe nommÃ©e <code class="docutils literal notranslate"><span class="pre">occhab</span></code>.</p>
</div>
<a class="reference internal image-reference" href="_images/benchmark_result.png"><img alt="Affichage des tests de performances" class="align-center" src="_images/benchmark_result.png" style="width: 60%;" />
</a>
<p>Si le test de performances doit accÃ©der Ã  des fonctions ou des variables uniquement accessibles dans le contexte
de lâapplication flask, il faudra utiliser lâobjet <code class="docutils literal notranslate"><span class="pre">geonature.tests.benchmarks.CLater</span></code>. Ce dernier permet
de dÃ©clarer un expression python retournant un objet (fonction ou variable) dans une chaÃ®ne de caractÃ¨re qui
sera _Ã©valuÃ©_ (voir la fonction <code class="docutils literal notranslate"><span class="pre">eval()</span></code> de Python) uniquement lors de lâexÃ©cution du benchmark.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_get_default_nomenclatures</span> <span class="o">=</span> <span class="n">BenchmarkTest</span><span class="p">(</span>
      <span class="n">CLater</span><span class="p">(</span><span class="s2">&quot;self.client.get&quot;</span><span class="p">),</span>
      <span class="p">[</span><span class="n">CLater</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;url_for(&quot;gn_synthese.getDefaultsNomenclatures&quot;)&quot;&quot;&quot;</span><span class="p">)],</span>
      <span class="nb">dict</span><span class="p">(</span><span class="n">user_profile</span><span class="o">=</span><span class="s2">&quot;self_user&quot;</span><span class="p">),</span>
  <span class="p">)()</span>
</pre></div>
</div>
<p>LâexÃ©cution de certaines benchmark de routes doivent inclure lâengistrement dâutilisateur de tests. Pour cela,
il suffit dâutiliser la clÃ© <code class="docutils literal notranslate"><span class="pre">user_profile</span></code> dans lâargument <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> (Voir code ci-dessus).</p>
<p>Si lâutilisation de _fixtures_ est nÃ©cessaire Ã  votre test de performance, utilisÃ© la clÃ© <code class="docutils literal notranslate"><span class="pre">fixture</span></code>
dans lâargument <code class="docutils literal notranslate"><span class="pre">kwargs</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_get_station</span> <span class="o">=</span> <span class="n">BenchmarkTest</span><span class="p">(</span>
      <span class="n">CLater</span><span class="p">(</span><span class="s2">&quot;self.client.get&quot;</span><span class="p">),</span>
      <span class="p">[</span><span class="n">CLater</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;url_for(&quot;occhab.get_station&quot;, id_station=8)&quot;&quot;&quot;</span><span class="p">)],</span>
      <span class="nb">dict</span><span class="p">(</span><span class="n">user_profile</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">fixtures</span><span class="o">=</span><span class="p">[</span><span class="n">stations</span><span class="p">]),</span>
  <span class="p">)()</span>
</pre></div>
</div>
</section>
</section>
<section id="tests-frontend">
<span id="id8"></span><h2>Tests frontend<a class="headerlink" href="#tests-frontend" title="Lien vers cette rubrique">Â¶</a></h2>
<p>Cette documentation a pour objectif dâexpliquer comment Ã©crire des tests pour
le frontend de GeoNature.</p>
<p>LâÃ©criture de tests frontend dans GeoNature se base sur lâoutil <a class="reference external" href="https://www.cypress.io/">Cypress</a> dont il est necessaire de maitriser et comprendre le fonctionnement.</p>
<p>Le lancement des tests cypress nÃ©cessite la prÃ©sence de donnÃ©es en base. Les branches alembic suivantes doivent Ãªtre montÃ©es : <cite>occtax-samples-test</cite>, <cite>occhab-samples</cite>. Le contenu du fichier <cite>config/test_config.toml</cite> doit Ã©galement Ãªtre utilisÃ©.</p>
<p>Principe de base ; Un test doit Ãªtre concis.
Il vaut mieux Ã©crire plusieurs tests pour tester diffÃ©rentes configurations plutÃ´t quâun seul les testant toutes dâun coup.
Cela permet dâidentifier plus prÃ©cisÃ©ment le test qui nâa pas fonctionnÃ©.</p>
<section id="redaction">
<h3>RÃ©daction<a class="headerlink" href="#redaction" title="Lien vers cette rubrique">Â¶</a></h3>
<p>La rÃ©daction des fichiers de tests se fait dans le dossier frontend/cypress/e2e.</p>
<section id="structure">
<h4>Structure<a class="headerlink" href="#structure" title="Lien vers cette rubrique">Â¶</a></h4>
<p>La nomenclature des fichiers de test est XXXXXXX-spec.js (XXXX correspondant au nom du module testÃ©).</p>
<p>Afin dâamÃ©liorer la lisibilitÃ© des fichiers de test si un module contient beaucoup de tests il est nÃ©cessaire de sÃ©parer les tests end to end en plusieurs fichiers et les placer dans un dossier portant le nom du module.</p>
</section>
<section id="id9">
<h4>Exemple<a class="headerlink" href="#id9" title="Lien vers cette rubrique">Â¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>e2e
âââ<span class="w"> </span>import
â<span class="w">   </span>âââ<span class="w"> </span>all-steps-spec.js
â<span class="w">   </span>âââ<span class="w"> </span>list-search-spec.js
</pre></div>
</div>
<p>Dans chaque fichier la structure des tests est de la forme</p>
<ul class="simple">
<li><dl class="simple">
<dt>une description</dt><dd><ul>
<li><p>test</p></li>
<li><p>test</p></li>
<li><p>â¦</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="id10">
<h4>Exemple<a class="headerlink" href="#id10" title="Lien vers cette rubrique">Â¶</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">describe</span><span class="p">(</span><span class="s2">&quot;description gÃ©nÃ©ral de la partie testÃ©e&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;description du test 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//contenu du test 1</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;description du test 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//contenu du test 2</span>
<span class="w">    </span><span class="p">})</span>

<span class="p">})</span>
</pre></div>
</div>
<p>Afin dâhomogÃ©nÃ©iser les descriptions des tests il est Ã©tabli que lâon nomme un test en anglais en commenÃ§ant par should.</p>
</section>
<section id="id11">
<h4>Exemple<a class="headerlink" href="#id11" title="Lien vers cette rubrique">Â¶</a></h4>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should change the state&#39;</span><span class="p">,()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">...</span>
</pre></div>
</div>
</section>
<section id="implementation">
<h4>ImplÃ©mentation<a class="headerlink" href="#implementation" title="Lien vers cette rubrique">Â¶</a></h4>
<p>La rÃ©alisation des tests frontend passe par la sÃ©lection des objets HTML du DOM.
A fin de rendre ces sÃ©lections plus propres, on peut ajouter des tags HTML dans le dom.
Angular et Cypress suggÃ¨rent lâajout de tags de ce type:</p>
<ul class="simple">
<li><p>data-qa</p></li>
<li><p>test-qa</p></li>
<li><p>data-test</p></li>
</ul>
<p>Il est recommandÃ© dâutiliser un nom explicite pour Ã©viter toutes confusions.</p>
</section>
<section id="id12">
<h4>Exemple<a class="headerlink" href="#id12" title="Lien vers cette rubrique">Â¶</a></h4>
<div class="highlight-HTML notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">button</span> <span class="na">data-qa</span><span class="o">=</span><span class="s">&quot;import-list-new&quot;</span><span class="p">&gt;</span>New<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Voir <a class="reference external" href="https://docs.cypress.io/guides/references/best-practices#Selecting-Elements">https://docs.cypress.io/guides/references/best-practices#Selecting-Elements</a> pour les bonnes pratique de sÃ©lection dâÃ©lÃ©ments.</p>
</section>
</section>
<section id="lancement">
<h3>Lancement<a class="headerlink" href="#lancement" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Pour lancer Cypress et executer les tests Ã  la main il faut exÃ©cuter la commande (nÃ©cessite quâune instance GeoNature fonctionne (backend+frontend)):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>npm<span class="w"> </span>run<span class="w"> </span>cypress:open
</pre></div>
</div>
<p>Pour lancer les test en mode automatique, il faut exÃ©cuter la commande (utilisÃ©e dans lâintÃ©gration continue (GitHub Action)):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>npm<span class="w"> </span>run<span class="w"> </span>e2e:ci<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>e2e:coverage
</pre></div>
</div>
</section>
</section>
<section id="developper-un-module-externe">
<h2>DÃ©velopper un module externe<a class="headerlink" href="#developper-un-module-externe" title="Lien vers cette rubrique">Â¶</a></h2>
<p>GeoNature a Ã©tÃ© conÃ§u pour fonctionner en briques modulaires.</p>
<p>Chaque protocole, rÃ©pondant Ã  une question scientifique, est amenÃ© Ã  avoir
son propre module GeoNature comportant son modÃ¨le de base de donnÃ©es (dans un
schÃ©ma sÃ©parÃ©), son API et son interface utilisateur.</p>
<p>Les modules dÃ©veloppÃ©s sâappuieront sur le coeur de GeoNature qui est
constituÃ© dâun ensemble de briques rÃ©utilisables.</p>
<p>En base de donnÃ©es, le coeur de GeoNature est constituÃ© de lâensemble des
rÃ©fÃ©rentiels (utilisateurs, taxonomique, nomenclatures gÃ©ographique)
et du schÃ©ma <code class="docutils literal notranslate"><span class="pre">gn_synthese</span></code> regroupant lâensemble donnÃ©es saisies dans les
diffÃ©rents protocoles (voir doc administrateur pour plus de dÃ©tail sur le
modÃ¨le de donnÃ©es).</p>
<p>LâAPI du coeur permet dâinterroger les schÃ©mas de la base de donnÃ©es Â«Â coeurÂ Â»
de GeoNature. Une documentation complÃ¨te de lâAPI est disponible dans la
rubrique <a class="reference internal" href="#api"><span class="std std-ref">API</span></a>.</p>
<p>Du cÃ´tÃ© interface utilisateur, GeoNature met Ã  disposition un ensemble de
composants Angular rÃ©utilisables pour lâaffichage des cartes, des formulaires etcâ¦</p>
<p>Avant de dÃ©velopper un gn_module, assurez-vous dâavoir GeoNature bien
installÃ© sur votre machine (voir <a class="reference internal" href="installation.html#installation-standalone"><span class="std std-ref">Installation de GeoNature uniquement</span></a>).</p>
<p>Afin de pouvoir connecter ce module au Â«Â coeurÂ Â», il est impÃ©ratif de suivre
une arborescence prÃ©dÃ©finie par lâÃ©quipe GeoNature.
Un template GitHub a Ã©tÃ© prÃ©vu Ã  cet effet
(<a class="reference external" href="https://github.com/PnX-SI/gn_module_template">https://github.com/PnX-SI/gn_module_template</a>).
Il est possible de crÃ©er un nouveau dÃ©pÃ´t GitHub Ã  partir de ce template,
ou alors de copier/coller le contenu du dÃ©pÃ´t dans un nouveau.</p>
<p>Cette arborescence implique de dÃ©velopper le module dans les technologies du
coeur de GeoNature Ã  savoir :</p>
<ul class="simple">
<li><p>Le backend est dÃ©veloppÃ© en Python grÃ¢ce au framework Flask.</p></li>
<li><p>Le frontend est dÃ©veloppÃ© grÃ¢ce au framework Angular (voir la version actuelle du coeur)</p></li>
</ul>
<p>GeoNature prÃ©voit cependant lâintÃ©gration de module Â«Â externeÂ Â» dont le
frontend serait dÃ©veloppÃ© dans dâautres technologies. La gestion de
lâintÃ©gration du module est Ã  la charge du dÃ©veloppeur.</p>
<ul class="simple">
<li><p>Le module se placera dans un dossier Ã  part du dossier Â«Â GeoNatureÂ Â» et portera le suffixe Â«Â gn_moduleÂ Â». Exemple : <em>gn_module_validation</em></p></li>
<li><p>Le backend doit Ãªtre un paquet Python. Ce paquet peut dÃ©finir diffÃ©rent <em>entry points</em> permettant de renseigner diffÃ©rentes informations sur votre module :</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">code</span></code> : le MODULE_CODE de votre module (obligatoire)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">picto</span></code> : le pictogramme par dÃ©faut pour lâentrÃ©e dans le menu Geonature (facultatif)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">blueprint</span></code> : le blueprint qui sera servit par GeoNature (obligatoire)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">config_schema</span></code> : un schÃ©ma Marshmallow permettant de valider la configuration du module (obligatoire)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">migrations</span></code> : lâemplacement de vos migrations Alembic pour le schÃ©ma de base de donnÃ©es de votre module (facultatif)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alembic_branch</span></code> : le nom de la branche Alembic (par dÃ©faut, la branche Alembic devra porter le nom du module code en minuscule)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tasks</span></code>: votre fichier de tÃ¢ches asynchrones Celery (facultatif)</p></li>
</ul>
</li>
<li><p>Le frontend doit Ãªtre placÃ© dans un sous-dossier <code class="docutils literal notranslate"><span class="pre">frontend</span></code>. Il comprendra les Ã©lÃ©ments suivants :</p>
<ul>
<li><p>Les fichiers <code class="docutils literal notranslate"><span class="pre">package.json</span></code> et <code class="docutils literal notranslate"><span class="pre">package-lock.json</span></code> avec vos dÃ©pendances (facultatif si pas de dÃ©pendances)</p></li>
<li><p>Un dossier <code class="docutils literal notranslate"><span class="pre">assets</span></code> avec un sous-dossier du nom du module avec lâensemble des mÃ©dias (images, son)</p></li>
<li><p>Un dossier <code class="docutils literal notranslate"><span class="pre">app</span></code> qui comprendra le code de votre module, avec notamment le Â«Â module Angular racineÂ Â» qui doit impÃ©rativement sâappeler <code class="docutils literal notranslate"><span class="pre">gnModule.module.ts</span></code></p></li>
</ul>
</li>
</ul>
<p>Pour lâinstallation du module, voir <a class="reference internal" href="installation.html#install-gn-module"><span class="std std-ref">Installation dâun module GeoNature</span></a>.</p>
<section id="bonnes-pratiques-frontend">
<h3>Bonnes pratiques Frontend<a class="headerlink" href="#bonnes-pratiques-frontend" title="Lien vers cette rubrique">Â¶</a></h3>
<ul>
<li><p>Pour lâensemble des composants cartographiques et des formulaires (taxonomie, nomenclaturesâ¦), il est conseillÃ© dâutiliser les composants prÃ©sents dans le module âGN2CommonModuleâ.</p>
<p>Importez ce module dans le module racine de la maniÃ¨re suivante</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">{</span> <span class="n">GN2CommonModule</span> <span class="p">}</span> <span class="kn">from</span> <span class="s1">&#39;@geonature_common/GN2Common.module&#39;</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Les librairies JS seront installÃ©es dans le dossier <code class="docutils literal notranslate"><span class="pre">node_modules</span></code> de GeoNature. (Il nâest pas nÃ©cessaire de rÃ©installer toutes les librairies dÃ©jÃ  prÃ©sentes dans GeoNature (Angular, Leaflet, ChartJS â¦). Le <code class="docutils literal notranslate"><span class="pre">package.json</span></code> de GeoNature liste lâensemble des librairies dÃ©jÃ  installÃ©es et rÃ©utilisable dans le module.</p></li>
<li><p>Les fichiers dâassets sont Ã  ranger dans le dossier <code class="docutils literal notranslate"><span class="pre">assets</span></code> du frontend. Angular-cli impose cependant que tous les assets soient dans le rÃ©pertoire mÃ¨re de lâapplication (celui de GeoNature). Un lien symbolique est crÃ©Ã© Ã  lâinstallation du module pour faire entre le dossier dâassets du module et celui de Geonature.</p></li>
<li><p>Utiliser node_modules prÃ©sent dans GeoNature</p>
<p>Pour utiliser des librairies dÃ©jÃ  installÃ©es dans GeoNature,
utilisez la syntaxe suivante</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="p">{</span> <span class="n">TreeModule</span> <span class="p">}</span> <span class="kn">from</span> <span class="s2">&quot;@librairies/angular-tree-component&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Lâalias <code class="docutils literal notranslate"><span class="pre">&#64;librairies</span></code> pointe en effet vers le repertoire des node_modules
de GeoNature</p>
<p>Pour les utiliser Ã  lâinterieur du module, utiliser la syntaxe suivante</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;assets/&lt;MY_MODULE_CODE&gt;/afb.png&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Exemple pour le module de validation</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;assets/&lt;gn_module_validation&gt;/afb.png&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="integrer-limport-de-donnees-dans-votre-module">
<h2>IntÃ©grer lâimport de donnÃ©es dans votre module<a class="headerlink" href="#integrer-limport-de-donnees-dans-votre-module" title="Lien vers cette rubrique">Â¶</a></h2>
<p>A partir de la version 2.15, le module dâImport permet lâajout de nouvelles destinations en plus de la SynthÃ¨se. Cela a Ã©tÃ© lâoccasion dâajouter la possibilitÃ© dâimporter des donnÃ©es dâhabitat dans le module Occhab.
Cette section prÃ©sente le processus dâajout de lâimport dans votre module GeoNature.</p>
<section id="modification-a-apporter-sur-la-base-de-donnees">
<h3>Modification Ã  apporter sur la base de donnÃ©es<a class="headerlink" href="#modification-a-apporter-sur-la-base-de-donnees" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Plusieurs points sont essentiels au bon fonctionnement de lâimport dans votre moduleÂ :</p>
<ol class="arabic simple">
<li><p>Avoir une permission C sur votre module de destination</p></li>
<li><p>CrÃ©er un objet destination (<cite>bib_destinations</cite>) et autant dâentitÃ©s (<cite>bib_entities</cite>) que vous avez dâobjets dans votre module (e.g. habitat, station pour Occhab)</p></li>
<li><p>CrÃ©er une table transitoire permettant dâeffectuer la complÃ©tion et le contrÃ´le des donnÃ©es avant lâimport des donnÃ©es vers la table de destination finale.</p></li>
<li><p>Pour chaque entitÃ©, dÃ©clarer les attributs rendus accessibles Ã  lâimport dans <cite>bib_fields</cite></p></li>
<li><p>Si de nouvelles erreurs de contrÃ´le de donnÃ©es doivent Ãªtre dÃ©clarÃ©es, ajouter ces derniÃ¨res dans <cite>bib_errors_type</cite></p></li>
</ol>
<p>N.B. Comme dans le reste de GeoNature, il est conseillÃ© dâeffectuer les modifications de base de donnÃ©es Ã  lâaide de migrations Alembic.</p>
<section id="permissions-requises">
<h4>Permissions requises<a class="headerlink" href="#permissions-requises" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Si ce nâest pas le dÃ©jÃ  cas, ajouter la permission de crÃ©ation de donnÃ©es dans votre module. Le code ci-dessous donne un exemple fonctionnant dans une rÃ©vision alembic.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    INSERT INTO</span>
<span class="sd">        gn_permissions.t_permissions_available (id_module,id_object,id_action,label,scope_filter)</span>
<span class="sd">    SELECT</span>
<span class="sd">        m.id_module,o.id_object,a.id_action,v.label,v.scope_filter</span>
<span class="sd">    FROM</span>
<span class="sd">        (</span>
<span class="sd">            VALUES</span>
<span class="sd">                (&#39;[votreModuleCode&#39;, &#39;ALL&#39;, &#39;C&#39;, True, &#39;CrÃ©er [nomEntitÃ©]&#39;)</span>
<span class="sd">        ) AS v (module_code, object_code, action_code, scope_filter, label)</span>
<span class="sd">    JOIN</span>
<span class="sd">        gn_commons.t_modules m ON m.module_code = v.module_code</span>
<span class="sd">    JOIN</span>
<span class="sd">        gn_permissions.t_objects o ON o.code_object = v.object_code</span>
<span class="sd">    JOIN</span>
<span class="sd">        gn_permissions.bib_actions a ON a.code_action = v.action_code</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="creer-votre-destination-et-vos-entites">
<h4>CrÃ©er votre destination et vos entitÃ©s<a class="headerlink" href="#creer-votre-destination-et-vos-entites" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Dans un premier temps, il faut crÃ©er une Â«Â destinationÂ Â». Pour cela, il faut enregistrer votre module dans <cite>bib_destinations</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># RÃ©cupÃ©rer l&#39;identifiant de votre module</span>
<span class="n">id_de_votre_module</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">op</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
    <span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id_module FROM gn_commons.t_modules WHERE module_code = &#39;CODE_DE_VOTRE_MODULE&#39;&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Ajouter la destination</span>
<span class="c1"># N.B. table_name correspond au nom de la future table transitoire</span>
<span class="n">destination</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;bib_destinations&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;gn_imports&quot;</span><span class="p">)</span>
<span class="n">op</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
<span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>
    <span class="o">.</span><span class="n">values</span><span class="p">(</span>
        <span class="n">id_module</span><span class="o">=</span><span class="n">id_de_votre_module</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="s2">&quot;votre_module_code&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;VotreModule&quot;</span><span class="p">,</span>
        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;t_imports_votre_module&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Dans votre module, plusieurs objets sont manipulÃ©s et stockÃ©s chacun dans une table. Pour prendre lâexemple du module Occhab, on a deux entitÃ©s les stations et les habitats.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">id_dest_module</span><span class="o">=</span> <span class="p">(</span>
<span class="n">op</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
<span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id_destination FROM gn_imports.bib_destinations WHERE code = &#39;votre_module_code&#39;&quot;</span><span class="p">)</span>
<span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">entity</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;bib_entities&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;gn_imports&quot;</span><span class="p">)</span>
<span class="n">op</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
<span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
    <span class="o">.</span><span class="n">values</span><span class="p">(</span>
        <span class="n">id_destination</span><span class="o">=</span><span class="n">id_dest_module</span><span class="p">,</span>
        <span class="n">code</span><span class="o">=</span><span class="s2">&quot;code_entite1&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Entite1&quot;</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">validity_column</span><span class="o">=</span><span class="s2">&quot;entite1_valid&quot;</span><span class="p">,</span>
        <span class="n">destination_table_schema</span><span class="o">=</span><span class="s2">&quot;votre_module_schema&quot;</span><span class="p">,</span>
        <span class="n">destination_table_name</span><span class="o">=</span><span class="s2">&quot;entite1_table_name&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="creer-votre-table-transitoire">
<h4>CrÃ©er votre table transitoire<a class="headerlink" href="#creer-votre-table-transitoire" title="Lien vers cette rubrique">Â¶</a></h4>
<p>NÃ©cessaire pour le contrÃ´le de donnÃ©es, il est important de crÃ©er une table transitoire permettant dâeffectuer la complÃ©tion et le contrÃ´le des donnÃ©es avant lâimport des donnÃ©es vers la table de destination finale. La table transitoire doit contenir les colonnes suivantes :</p>
<ul class="simple">
<li><p>id_import : identifiant de lâimport</p></li>
<li><p>line_no : entier, numÃ©ro de la ligne dans le fichier source</p></li>
<li><p>entityname_valid : booleen, indique si une entitÃ© est valide</p></li>
<li><p>pour chaque champ de lâentitÃ©, il faudra une colonne VARCHAR contenant la donnÃ©e du fichier et une colonne du type du champ qui contiendra la donnÃ©es finales. La convention de nommage est la suivante: Â«Â src_nomchampÂ Â» pour colonne contenant la donnÃ©es du fichier source et Â«Â nomchampÂ Â» pour la colonne contenant les donnÃ©es finales. Il est conseillÃ© que le nom de la colonne contenant les donnÃ©es finales soit identiques Ã  celle du champs dans la table de destination.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
    <span class="s2">&quot;t_imports_votremodule&quot;</span><span class="p">,</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s2">&quot;id_import&quot;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;gn_imports.t_imports.id_import&quot;</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="s2">&quot;CASCADE&quot;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;CASCADE&quot;</span><span class="p">),</span>
        <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;line_no&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;entite1_valid&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">sa</span><span class="o">.</span><span class="n">false</span><span class="p">()),</span>
    <span class="c1"># Station fields</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;src_id_entite&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">),</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id_entite&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">),</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;src_unique_dataset_id&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">),</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;unique_dataset_id&quot;</span><span class="p">,</span> <span class="n">UUID</span><span class="p">(</span><span class="n">as_uuid</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="declarer-les-attributs-rendus-accessibles-a-limport-dans-bib-fields">
<h4>DÃ©clarer les attributs rendus accessibles Ã  lâimport dans <strong>bib_fields</strong><a class="headerlink" href="#declarer-les-attributs-rendus-accessibles-a-limport-dans-bib-fields" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Pour chaque entitÃ© (e.g. une station dans Occhab), il faut dÃ©clarer les champs du modÃ¨les accessibles Ã  lâimport dans <cite>bib_fields</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">theme</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;bib_themes&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;gn_imports&quot;</span><span class="p">)</span>

<span class="n">id_theme_general</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">op</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
    <span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sa</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">theme</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id_theme</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">theme</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name_theme</span> <span class="o">==</span> <span class="s2">&quot;general_info&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
<span class="p">)</span>


<span class="n">fields_entities</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;name_field&quot;</span><span class="p">:</span> <span class="s2">&quot;id_entite1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fr_label&quot;</span><span class="p">:</span> <span class="s2">&quot;Identifiant entitÃ©1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mandatory&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># Obligatoire ou non</span>
            <span class="s2">&quot;autogenerated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># gÃ©nÃ©rÃ© automatique (ex. UUID)</span>
            <span class="s2">&quot;display&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># Afficher dans l&#39;UI</span>
            <span class="s2">&quot;mnemonique&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;source_field&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;dest_field&quot;</span><span class="p">:</span> <span class="s2">&quot;id_entite1&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="n">id_entity1</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># rÃ©cupÃ©rer l&#39;id de l&#39;entitÃ© entitÃ©1 prÃ©cÃ©dement insÃ©rÃ©</span>
                <span class="s2">&quot;id_theme&quot;</span><span class="p">:</span> <span class="n">id_theme_general</span><span class="p">,</span>
                <span class="s2">&quot;order_field&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="c1"># UtilisÃ© comme tooltip</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">),</span>
    <span class="o">...</span>
<span class="p">]</span>

<span class="n">field</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;bib_fields&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;gn_imports&quot;</span><span class="p">)</span>
<span class="n">id_fields</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">id_field</span>
    <span class="k">for</span> <span class="n">id_field</span><span class="p">,</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">get_bind</span><span class="p">()</span>
    <span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">([{</span><span class="s2">&quot;id_destination&quot;</span><span class="p">:</span> <span class="n">id_votre_dest</span><span class="p">,</span> <span class="o">**</span><span class="n">field</span><span class="p">}</span> <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">fields_entities</span><span class="p">])</span>
        <span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id_field</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="p">]</span>
<span class="n">cor_entity_field</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;cor_entity_field&quot;</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;gn_imports&quot;</span><span class="p">)</span>
<span class="n">op</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cor_entity_field</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;id_entity&quot;</span><span class="p">:</span> <span class="n">id_entity</span><span class="p">,</span> <span class="s2">&quot;id_field&quot;</span><span class="p">:</span> <span class="n">id_field</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">id_field</span><span class="p">,</span> <span class="n">field_entities</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">id_fields</span><span class="p">,</span> <span class="n">fields_entities</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">id_entity</span><span class="p">,</span> <span class="n">props</span> <span class="ow">in</span> <span class="n">field_entities</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="ajout-de-nouvelles-erreurs-de-controle-de-donnees">
<h4>Ajout de nouvelles erreurs de contrÃ´le de donnÃ©es<a class="headerlink" href="#ajout-de-nouvelles-erreurs-de-controle-de-donnees" title="Lien vers cette rubrique">Â¶</a></h4>
<p>Il est possible que votre module nÃ©cessite de dÃ©clarer de nouveaux contrÃ´les de donnÃ©es. Ces contrÃ´les
peuvent provoquer de nouvelles erreurs que celle dÃ©clarÃ© dans <cite>bib_errors_type</cite>. Il est possible dâen ajouter
comme dans lâexemple suivant :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">error_type</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s2">&quot;bib_errors_types&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;gn_imports&quot;</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">get_bind</span><span class="p">())</span>
<span class="n">op</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">(</span>
    <span class="n">error_type</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Erreur de format boolÃ©en&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;INVALID_BOOL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Le champ doit Ãªtre renseignÃ© avec une valeur binaire (0 ou 1, true ou false).&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error_level&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="s2">&quot;DonnÃ©es incohÃ©rentes d&#39;une ou plusieurs entitÃ©s&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;INCOHERENT_DATA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Les donnÃ©es indiquÃ©es pour une ou plusieurs entitÃ©s sont incohÃ©rentes sur diffÃ©rentes lignes.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error_level&quot;</span><span class="p">:</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="o">...</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Lien vers cette rubrique">Â¶</a></h3>
<p>Il faut dâabord crÃ©er une classe hÃ©ritant de la classe <cite>ImportActions</cite></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VotreModuleImportActions</span><span class="p">(</span><span class="n">ImportActions</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">statistics_labels</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">ImportStatisticsLabels</span><span class="p">]:</span>
    <span class="c1"># Retourne un objet contenant les labels pour les statistiques</span>

    <span class="k">def</span> <span class="nf">preprocess_transient_data</span><span class="p">(</span><span class="n">imprt</span><span class="p">:</span> <span class="n">TImports</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
    <span class="c1"># Effectue un prÃ©-traitement des donnÃ©es dans un dataframe</span>

    <span class="k">def</span> <span class="nf">check_transient_data</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">imprt</span><span class="p">:</span> <span class="n">TImports</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Effectue la validation des donnÃ©es</span>

    <span class="k">def</span> <span class="nf">import_data_to_destination</span><span class="p">(</span><span class="n">imprt</span><span class="p">:</span> <span class="n">TImports</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Importe les donnÃ©es dans la table de destination</span>

    <span class="k">def</span> <span class="nf">remove_data_from_destination</span><span class="p">(</span><span class="n">imprt</span><span class="p">:</span> <span class="n">TImports</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Supprime les donnÃ©es de la table de destination</span>

    <span class="k">def</span> <span class="nf">report_plot</span><span class="p">(</span><span class="n">imprt</span><span class="p">:</span> <span class="n">TImports</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StandaloneEmbedJson</span><span class="p">:</span>
    <span class="c1"># Retourne des graphiques sur l&#39;import</span>

    <span class="k">def</span> <span class="nf">compute_bounding_box</span><span class="p">(</span><span class="n">imprt</span><span class="p">:</span> <span class="n">TImports</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Calcule la bounding box</span>
</pre></div>
</div>
<p>Dans cette classe on retrouve toutes les fonctions obligatoires, Ã  implementer pour pouvoir implementer lâimport dans un module.</p>
<section id="methodes-a-implementer">
<h4>MÃ©thodes Ã  implÃ©menter<a class="headerlink" href="#methodes-a-implementer" title="Lien vers cette rubrique">Â¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">statistics_labels()</span></code></p>
<p>Fonction qui renvoie un objet de la forme suivante :</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;station_count&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Nombre de stations importÃ©es&quot;</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;habitat_count&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Nombre dâhabitats importÃ©s&quot;</span><span class="p">},</span>
</pre></div>
</div>
<p>Les statistiques sont calculÃ©es en amont, et ajoutÃ©s Ã  lâobjet import dans la section statistique.
Les valeurs des clÃ©s permettent de dÃ©finir les labels Ã  afficher pour les statistique affichÃ©es dans la liste dâimports.</p>
<p><code class="docutils literal notranslate"><span class="pre">preprocess_transient_data(imprt:</span> <span class="pre">TImports,</span> <span class="pre">df)</span></code></p>
<p>Fonction qui permet de faire un prÃ©-traitement sur les donnÃ©es de lâimport, elle retourne un dataframe panda.</p>
<p><code class="docutils literal notranslate"><span class="pre">check_transient_data(task,</span> <span class="pre">logger,</span> <span class="pre">imprt:</span> <span class="pre">TImports)</span></code></p>
<p>Dans cette fonction est effectuÃ©e la validation et le traitement des donnÃ©es de lâimport.</p>
<p>La fonction <code class="docutils literal notranslate"><span class="pre">check_dates</span></code>, par exemple, utilisÃ©e dans lâimport Occhab permet de valider tous les champs de type date prÃ©sents dans lâimport.
Elle vÃ©rifie que le format est respectÃ©.</p>
<p>La fonction <code class="docutils literal notranslate"><span class="pre">check_transient_data</span></code> permet de gÃ©nerer les uuid manquants dans lâimport, elle permet notamment de gÃ©nÃ©rer un UUID commun Ã  diffÃ©rentes lignes de lâimport quand id_origin est le mÃªme.</p>
<p><code class="docutils literal notranslate"><span class="pre">import_data_to_destination(imprt:</span> <span class="pre">TImports)</span></code></p>
<p>Cette fonction permet dâimplÃ©menter lâimport des donnÃ©es valides dans la table de destination une fois que toutes les vÃ©rifications ont Ã©tÃ© effectuÃ©es.</p>
<p><code class="docutils literal notranslate"><span class="pre">remove_data_from_destination(imprt:</span> <span class="pre">TImports)</span></code></p>
<p>Cette fonction permet de supprimer les donnÃ©es dâun import, lors de la suppression dâun import.
Câest notamment pour pouvoir implÃ©menter cette fonction que la colonne <code class="docutils literal notranslate"><span class="pre">id_import</span></code> est prÃ©conisÃ©e dans les tables de destination.</p>
<p><code class="docutils literal notranslate"><span class="pre">report_plot(imprt:</span> <span class="pre">TImports)</span></code></p>
<p>Cette fonction permet de crÃ©er les graphiques affichÃ©s dans le raport dâimport.
Pour crÃ©er ces graphiques on utilise la librairie bokeh (documentation : <a class="reference external" href="https://docs.bokeh.org/en/latest/">https://docs.bokeh.org/en/latest/</a>). Il y a des exemples de crÃ©ation de graphiques dans lâimport Occhab.</p>
<p><code class="docutils literal notranslate"><span class="pre">compute_bounding_box(imprt:</span> <span class="pre">TImports)</span></code></p>
<p>Cette fonction sert Ã  calculer la bounding box des donnÃ©es importÃ©es, câest-Ã -dire le plus petit polygone dans lequel sont contenues toutes les donnÃ©es gÃ©ographique importÃ©es.
Cette bounding box est affichÃ©e dans le rapport dâimport une fois toutes les donnÃ©es validÃ©es.</p>
</section>
</section>
</section>
<section id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Lien vers cette rubrique">Â¶</a></h2>
<p>La documentation se trouve dans le dossier <code class="docutils literal notranslate"><span class="pre">docs</span></code>.
Elle est Ã©crites en ReStructuredText et gÃ©nÃ©rÃ© avec Sphinx.</p>
<p>Pour gÃ©nÃ©rer la documentation HTML :</p>
<ul class="simple">
<li><p>Se placer dans le dossier <code class="docutils literal notranslate"><span class="pre">docs</span></code> : <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">docs</span></code></p></li>
<li><p>CrÃ©er un virtualenv : <code class="docutils literal notranslate"><span class="pre">python3</span> <span class="pre">-m</span> <span class="pre">venv</span> <span class="pre">venv</span></code></p></li>
<li><p>Activer le virtualenv : <code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">venv/bin/activate</span></code></p></li>
<li><p>Installer les dÃ©pendances nÃ©cessaires Ã  la gÃ©nÃ©ration de la documentation : <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements.txt</span></code></p></li>
<li><p>Lancer la gÃ©nÃ©ration de la documentation : <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">html</span></code></p></li>
</ul>
<p>La documentation gÃ©nÃ©rÃ©e se trouve dans le dossier <code class="docutils literal notranslate"><span class="pre">build/html/</span></code>.</p>
</section>
<section id="release">
<h2>Release<a class="headerlink" href="#release" title="Lien vers cette rubrique">Â¶</a></h2>
<p>Pour sortir une nouvelle version de GeoNature :</p>
<ul>
<li><p>Faites les Ã©ventuelles Releases des dÃ©pendances (UsersHub, TaxHub, UsersHub-authentification-module, Nomenclature-api-module, RefGeo, Utils-Flask-SQLAlchemy, Utils-Flask-SQLAlchemy-Geo)</p></li>
<li><p>Assurez-vous que les sous-modules git de GeoNature pointent sur les bonnes versions des dÃ©pendances et que le <code class="docutils literal notranslate"><span class="pre">requirements-dependencies.in</span></code> a bien Ã©tÃ© mis Ã  jour.</p></li>
<li><p>RegÃ©nÃ©rer les fichiers <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> et <code class="docutils literal notranslate"><span class="pre">requirements-dev.txt</span></code> avec les commandes suivantes dans la plus petite version de python supportÃ©e par GeoNature</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span><span class="o">-</span><span class="nb">compile</span> <span class="n">requirements</span><span class="o">.</span><span class="ow">in</span> <span class="o">&gt;</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
<span class="n">pip</span><span class="o">-</span><span class="nb">compile</span> <span class="n">requirements</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="ow">in</span> <span class="o">&gt;</span> <span class="n">requirements</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
</li>
<li><p>Mettez Ã  jour la version de GeoNature et Ã©ventuellement des dÃ©pendances dans <code class="docutils literal notranslate"><span class="pre">install/install_all/install_all.ini</span></code></p></li>
<li><p>ComplÃ©tez le fichier <code class="docutils literal notranslate"><span class="pre">docs/CHANGELOG.md</span></code> (en comparant les branches <a class="reference external" href="https://github.com/PnX-SI/GeoNature/compare/develop">https://github.com/PnX-SI/GeoNature/compare/develop</a>) et dater la version Ã  sortir</p></li>
<li><p>Mettez Ã  jour le fichier <code class="docutils literal notranslate"><span class="pre">VERSION</span></code></p></li>
<li><p>Mergez la branche <code class="docutils literal notranslate"><span class="pre">develop</span></code> dans la branche <code class="docutils literal notranslate"><span class="pre">master</span></code></p></li>
<li><p>Faites la release (<a class="reference external" href="https://github.com/PnX-SI/GeoNature/releases">https://github.com/PnX-SI/GeoNature/releases</a>) en la taguant <code class="docutils literal notranslate"><span class="pre">X.Y.Z</span></code> (sans <code class="docutils literal notranslate"><span class="pre">v</span></code> devant) et en copiant le contenu du Changelog</p></li>
<li><p>Dans la branche <code class="docutils literal notranslate"><span class="pre">develop</span></code>, modifiez le fichier <code class="docutils literal notranslate"><span class="pre">VERSION</span></code> en <code class="docutils literal notranslate"><span class="pre">X.Y.Z.dev0</span></code> et pareil dans le fichier <code class="docutils literal notranslate"><span class="pre">docs/CHANGELOG.md</span></code></p></li>
<li><p>Faites la release de <a class="reference external" href="https://github.com/PnX-SI/GeoNature-Docker-services">GeoNature-Docker-services</a> avec la nouvelle version de GeoNature, et Ã©ventuellement des modules (Voir un <a class="reference external" href="https://github.com/PnX-SI/GeoNature-Docker-services/pull/19/files">exemple</a>)</p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="FAQ.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">FAQ</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="admin-manual.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Manuel administrateur</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018-2024, Parc National des Ãcrins, Parc National des CÃ©vennes
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">DÃ©veloppement</a><ul>
<li><a class="reference internal" href="#general">GÃ©nÃ©ral</a></li>
<li><a class="reference internal" href="#api">API</a><ul>
<li><a class="reference internal" href="#liste-des-routes">Liste des routes</a></li>
<li><a class="reference internal" href="#documentation-des-routes">Documentation des routes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pratiques-et-regles-de-developpement">Pratiques et rÃ¨gles de developpement</a><ul>
<li><a class="reference internal" href="#git">Git</a></li>
<li><a class="reference internal" href="#backend">Backend</a></li>
<li><a class="reference internal" href="#bdd">BDD</a><ul>
<li><a class="reference internal" href="#modele-python">ModÃ¨le Python</a></li>
</ul>
</li>
<li><a class="reference internal" href="#typescript">Typescript</a></li>
<li><a class="reference internal" href="#angular">Angular</a></li>
<li><a class="reference internal" href="#html">HTML</a></li>
<li><a class="reference internal" href="#style-et-ergonomie">Style et ergonomie</a></li>
</ul>
</li>
<li><a class="reference internal" href="#passer-en-mode-developpement">Passer en mode dÃ©veloppement</a><ul>
<li><a class="reference internal" href="#recuperation-des-sources">RÃ©cupÃ©ration des sources</a></li>
<li><a class="reference internal" href="#installation-du-venv-en-dev">Installation du venv en dev</a></li>
<li><a class="reference internal" href="#configuration-des-urls-de-developpement">Configuration des URLs de dÃ©veloppement</a></li>
<li><a class="reference internal" href="#autres-extensions-en-developpement">Autres extensions en dÃ©veloppement</a></li>
<li><a class="reference internal" href="#debugger-avec-un-navigateur">Debugger avec un navigateur</a></li>
</ul>
</li>
<li><a class="reference internal" href="#developpement-backend">DÃ©veloppement Backend</a><ul>
<li><a class="reference internal" href="#demarrage-du-serveur-de-dev-backend">DÃ©marrage du serveur de dev backend</a></li>
<li><a class="reference internal" href="#base-de-donnees-avec-flask-sqlalchemy">Base de donnÃ©es avec Flask-SQLAlchemy</a><ul>
<li><a class="reference internal" href="#fonctions-de-filtrages">Fonctions de filtrages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#serialisation-des-modeles-avec-marshmallow">Serialisation des modÃ¨les avec Marshmallow</a><ul>
<li><a class="reference internal" href="#gestion-des-relationships">Gestion des relationships</a></li>
<li><a class="reference internal" href="#modeles-avec-nomenclatures">ModÃ¨les avec nomenclatures</a></li>
<li><a class="reference internal" href="#modeles-geographiques">ModÃ¨les gÃ©ographiques</a></li>
<li><a class="reference internal" href="#modeles-geographiques-avec-nomenclatures">ModÃ¨les gÃ©ographiques avec nomenclatures</a></li>
<li><a class="reference internal" href="#modeles-de-permission">ModÃ¨les de permission</a></li>
<li><a class="reference internal" href="#creation-dun-objet">CrÃ©ation dâun objet</a><ul>
<li><a class="reference internal" href="#id3">Gestion des relationships</a><ul>
<li><a class="reference internal" href="#many-to-one">Many-to-One</a></li>
<li><a class="reference internal" href="#many-to-many">Many-to-Many</a></li>
<li><a class="reference internal" href="#one-to-many">One-to-Many</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#serialisation-des-modeles-avec-le-decorateur-serializable">Serialisation des modÃ¨les avec le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;serializable</span></code></a><ul>
<li><a class="reference internal" href="#id4">ModÃ¨les gÃ©ographiques</a></li>
</ul>
</li>
<li><a class="reference internal" href="#reponses">RÃ©ponses</a><ul>
<li><a class="reference internal" href="#le-decorateur-json-resp">Le dÃ©corateur <code class="docutils literal notranslate"><span class="pre">&#64;json_resp</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#probleme-n-1">ProblÃ¨me Â« n+1 Â»</a></li>
<li><a class="reference internal" href="#export-des-donnees">Export des donnÃ©es</a></li>
<li><a class="reference internal" href="#utilisation-de-la-configuration">Utilisation de la configuration</a></li>
<li><a class="reference internal" href="#authentification-et-autorisations">Authentification et autorisations</a><ul>
<li><a class="reference internal" href="#acceder-a-lutilisateur-courant">AccÃ©der Ã  lâutilisateur courant</a></li>
<li><a class="reference internal" href="#restreindre-une-route-aux-utilisateurs-connectes">Restreindre une route aux utilisateurs connectÃ©s</a></li>
<li><a class="reference internal" href="#restreindre-une-route-aux-utilisateurs-avec-un-certain-scope">Restreindre une route aux utilisateurs avec un certain scope</a><ul>
<li><a class="reference internal" href="#check_cruved_scope"><code class="docutils literal notranslate"><span class="pre">check_cruved_scope()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#recuperation-manuelle-du-scope">RÃ©cupÃ©ration manuelle du scope</a><ul>
<li><a class="reference internal" href="#get_scope"><code class="docutils literal notranslate"><span class="pre">get_scope()</span></code></a></li>
<li><a class="reference internal" href="#get_scopes_by_action"><code class="docutils literal notranslate"><span class="pre">get_scopes_by_action()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#restreindre-une-route-aux-utilisateurs-avec-des-permissions-avancees">Restreindre une route aux utilisateurs avec des permissions avancÃ©es</a><ul>
<li><a class="reference internal" href="#permissions_required"><code class="docutils literal notranslate"><span class="pre">permissions_required()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#recuperation-manuelle-des-permissions-avancees">RÃ©cupÃ©ration manuelle des permissions avancÃ©es</a><ul>
<li><a class="reference internal" href="#get_permissions"><code class="docutils literal notranslate"><span class="pre">get_permissions()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-propos-de-lapi-scope">Ã propos de lâAPI Â« scope Â»</a></li>
<li><a class="reference internal" href="#rajouter-un-nouveau-type-de-filtre">Rajouter un nouveau type de filtre</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#developpement-frontend">DÃ©veloppement Frontend</a><ul>
<li><a class="reference internal" href="#serveur-frontend-en-developpement">Serveur frontend en dÃ©veloppement</a></li>
<li><a class="reference internal" href="#bonnes-pratiques">Bonnes pratiques</a></li>
<li><a class="reference internal" href="#les-composants-generiques">Les composants gÃ©nÃ©riques</a><ul>
<li><a class="reference internal" href="#maplistcomponent">MapListComponent</a></li>
</ul>
</li>
<li><a class="reference internal" href="#gestion-des-erreurs">Gestion des erreurs</a></li>
<li><a class="reference internal" href="#tests">Tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tests-backend">Tests backend</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#utilisation">Utilisation</a></li>
<li><a class="reference internal" href="#fixtures">Fixtures</a></li>
<li><a class="reference internal" href="#exemple">Exemple</a></li>
<li><a class="reference internal" href="#dans-github">Dans GitHub</a></li>
<li><a class="reference internal" href="#coverage">Coverage</a></li>
<li><a class="reference internal" href="#dans-vscode">Dans VSCode</a></li>
<li><a class="reference internal" href="#evaluer-les-performances-du-backend">Evaluer les performances du backend</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tests-frontend">Tests frontend</a><ul>
<li><a class="reference internal" href="#redaction">RÃ©daction</a><ul>
<li><a class="reference internal" href="#structure">Structure</a></li>
<li><a class="reference internal" href="#id9">Exemple</a></li>
<li><a class="reference internal" href="#id10">Exemple</a></li>
<li><a class="reference internal" href="#id11">Exemple</a></li>
<li><a class="reference internal" href="#implementation">ImplÃ©mentation</a></li>
<li><a class="reference internal" href="#id12">Exemple</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lancement">Lancement</a></li>
</ul>
</li>
<li><a class="reference internal" href="#developper-un-module-externe">DÃ©velopper un module externe</a><ul>
<li><a class="reference internal" href="#bonnes-pratiques-frontend">Bonnes pratiques Frontend</a></li>
</ul>
</li>
<li><a class="reference internal" href="#integrer-limport-de-donnees-dans-votre-module">IntÃ©grer lâimport de donnÃ©es dans votre module</a><ul>
<li><a class="reference internal" href="#modification-a-apporter-sur-la-base-de-donnees">Modification Ã  apporter sur la base de donnÃ©es</a><ul>
<li><a class="reference internal" href="#permissions-requises">Permissions requises</a></li>
<li><a class="reference internal" href="#creer-votre-destination-et-vos-entites">CrÃ©er votre destination et vos entitÃ©s</a></li>
<li><a class="reference internal" href="#creer-votre-table-transitoire">CrÃ©er votre table transitoire</a></li>
<li><a class="reference internal" href="#declarer-les-attributs-rendus-accessibles-a-limport-dans-bib-fields">DÃ©clarer les attributs rendus accessibles Ã  lâimport dans <strong>bib_fields</strong></a></li>
<li><a class="reference internal" href="#ajout-de-nouvelles-erreurs-de-controle-de-donnees">Ajout de nouvelles erreurs de contrÃ´le de donnÃ©es</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration">Configuration</a><ul>
<li><a class="reference internal" href="#methodes-a-implementer">MÃ©thodes Ã  implÃ©menter</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#documentation">Documentation</a></li>
<li><a class="reference internal" href="#release">Release</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=7e9e99ef"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/translations.js?v=041d0952"></script>
    </body>
</html>