<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spécificités DEPOBIO &mdash; GeoNature 2.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="index.html" class="icon icon-home"> GeoNature
            <img src="_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">INSTALLATION</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin-manual.html">MANUEL ADMINISTRATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="import-level-1.html">IMPORT NIVEAU 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="import-level-2.html">IMPORT NIVEAU 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">DEVELOPPEMENT</a></li>
<li class="toctree-l1"><a class="reference internal" href="versions-compatibility.html">COMPATIBILITE</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">CHANGELOG</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GeoNature</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Spécificités DEPOBIO</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/installation-mtes.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="specificites-depobio">
<h1>Spécificités DEPOBIO<a class="headerlink" href="#specificites-depobio" title="Permalink to this headline"></a></h1>
<p>Cette documentation mentionne les spécificités et la configuration de l’installation de l’instance nationale du Ministère de la Transition Ecologique et Solidaire (MTES), dans le cadre du projet de Depôt Légal des données de biodiversité (<a class="reference external" href="https://depot-legal-biodiversite.naturefrance.fr/">https://depot-legal-biodiversite.naturefrance.fr/</a>).</p>
<p>Pour l’installation de GeoNature, voir la procédure d’installation de GeoNature et ses dépendances (<a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/docs/installation-all.rst">https://github.com/PnX-SI/GeoNature/blob/master/docs/installation-all.rst</a>).</p>
<section id="configuration-apache">
<h2>Configuration Apache<a class="headerlink" href="#configuration-apache" title="Permalink to this headline"></a></h2>
<p>Editez la configuration Apache de GeoNature et de TaxHub pour l’adapter au
contexte de production.</p>
<p>Fichier <code class="docutils literal notranslate"><span class="pre">/etc/apache/site-enabled/geonature.conf</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Configuration GeoNature</span>

<span class="n">Alias</span> <span class="o">/</span><span class="n">saisie</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ecrins</span><span class="o">/</span><span class="n">geonature</span><span class="o">/</span><span class="n">frontend</span><span class="o">/</span><span class="n">dist</span>
<span class="o">&lt;</span><span class="n">Directory</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ecrins</span><span class="o">/</span><span class="n">geonature</span><span class="o">/</span><span class="n">frontend</span><span class="o">/</span><span class="n">dist</span><span class="o">&gt;</span>
    <span class="n">Require</span> <span class="nb">all</span> <span class="n">granted</span>
<span class="o">&lt;/</span><span class="n">Directory</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">Location</span> <span class="o">/</span><span class="n">saisie</span><span class="o">/</span><span class="n">api</span><span class="o">&gt;</span>
    <span class="n">ProxyPass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span>
    <span class="n">ProxyPassReverse</span>  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span>
<span class="o">&lt;/</span><span class="n">Location</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Fichier <code class="docutils literal notranslate"><span class="pre">/etc/apache/site-enabled/taxhub.conf</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configuration TaxHub</span>
<span class="n">RewriteEngine</span>  <span class="n">on</span>
<span class="n">RewriteRule</span>    <span class="s2">&quot;taxhub$&quot;</span>  <span class="s2">&quot;taxhub/&quot;</span>  <span class="p">[</span><span class="n">R</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">Location</span> <span class="o">/</span><span class="n">saisie</span><span class="o">/</span><span class="n">taxhub</span><span class="o">&gt;</span>
    <span class="n">ProxyPass</span>  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">5000</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ProxyPassReverse</span>  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">5000</span>
<span class="o">&lt;/</span><span class="n">Location</span><span class="o">&gt;</span>
<span class="c1">#FIN Configuration TaxHub</span>
</pre></div>
</div>
<p>Le fichier <code class="docutils literal notranslate"><span class="pre">/etc/apache/site-enabled/000-default.conf</span></code> doit également être
édité pour faire fonctionner le load balancing (Voir la configuration de la
pre-prod pour l’adapter au serveur de production).</p>
</section>
<section id="configuration-de-l-application">
<h2>Configuration de l’application<a class="headerlink" href="#configuration-de-l-application" title="Permalink to this headline"></a></h2>
<p>Une fois l’installation terminée, il est nécessaire d’adapter les fichiers de
configuration de l’application pour les besoins spécifiques de
l’instance nationale.</p>
<p>Lancer le script pour effectuer automatiquement la configuration
de l’application :</p>
<p><code class="docutils literal notranslate"><span class="pre">/home/&lt;my_user&gt;/geonature/install/install_all/configuration_mtes.sh</span></code></p>
<p>Il est cependant possible de modifier ces configurations.
Le fichier <code class="docutils literal notranslate"><span class="pre">/home/&lt;my_user&gt;/geonature/config/default_config.toml.example</span></code>
liste l’ensemble des variables de configuration disponibles ainsi que leurs
valeurs par défaut.</p>
<p>Editer le fichier de configuration de GeoNature pour surcoucher ces variables :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo nano /home/&lt;MON_USER&gt;/geonature/config/geonature_config.toml`
</pre></div>
</div>
<p>Ci-dessous, les paramètres de configuration pour l’instance de production.</p>
<section id="configuration-globale-de-l-application">
<h3>Configuration globale de l’application<a class="headerlink" href="#configuration-globale-de-l-application" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># code EPSG de la projection de la base</span>
<span class="n">LOCAL_SRID</span> <span class="o">=</span> <span class="s1">&#39;2154&#39;</span>

<span class="n">DEFAULT_LANGUAGE</span><span class="o">=</span><span class="s1">&#39;fr&#39;</span>

<span class="c1"># url de l&#39;application métadonnée</span>
<span class="n">MTD_API_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;http://inpn.mnhn.fr/mtd&#39;</span>

<span class="c1"># Nom de l&#39;application sur la page d&#39;acceuil</span>
<span class="n">appName</span> <span class="o">=</span> <span class="s1">&#39;Depôt légal de biodiviersité - saisie&#39;</span>

<span class="n">ID_APPLICATION_GEONATURE</span> <span class="o">=</span> <span class="mi">14</span>
</pre></div>
</div>
</section>
<section id="configuration-des-urls-pour-le-cas">
<h3>Configuration des URLS pour le CAS<a class="headerlink" href="#configuration-des-urls-pour-le-cas" title="Permalink to this headline"></a></h3>
<p>Les URLS doivent correspondre aux informations renseignées dans la
configuration Apache et au Load Balancer. Elle ne doivent pas contenir
de <code class="docutils literal notranslate"><span class="pre">/</span></code> final.</p>
<p>Pour la pré-prod, ajouter le préfixe “pp-” avant <code class="docutils literal notranslate"><span class="pre">saisie</span></code> et <code class="docutils literal notranslate"><span class="pre">taxhub</span></code>
(naturefrance.fr/pp-saisie, naturefrance.fr/pp-taxhub/api) et adapter la
configuration Apache en conséquence.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># URL d&#39;accès à l&#39;application</span>
<span class="n">URL_APPLICATION</span> <span class="o">=</span> <span class="s1">&#39;https://depot-legal-biodiversite.naturefrance.fr/saisie&#39;</span>
<span class="c1"># URL de l&#39;API de GeoNature</span>
<span class="n">API_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;https://depot-legal-biodiversite.naturefrance.fr/saisie/api&#39;</span>
<span class="c1"># URL de l&#39;API de Taxhub</span>
<span class="n">API_TAXHUB</span> <span class="o">=</span> <span class="s1">&#39;https://depot-legal-biodiversite.naturefrance.fr/taxhub/api&#39;</span>
</pre></div>
</div>
</section>
<section id="cle-secrete">
<h3>Clé secrète<a class="headerlink" href="#cle-secrete" title="Permalink to this headline"></a></h3>
<p>Mettre un clé secrète personnalisée</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s1">&#39;&lt;MA_CLE_CRYPTEE&gt;&#39;</span>
</pre></div>
</div>
</section>
<section id="configuration-bdd-liee-a-la-connexion-au-cas">
<h3>Configuration BDD liée à la connexion au CAS<a class="headerlink" href="#configuration-bdd-liee-a-la-connexion-au-cas" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">BDD</span><span class="p">]</span>
<span class="c1"># id du groupe dans lequel tous les utilisateurs connectés sont ajoutés</span>
<span class="c1"># (seul le socle 1 - droit minimum - est utilisé pour l&#39;instance de production)</span>
<span class="n">ID_USER_SOCLE_1</span> <span class="o">=</span> <span class="mi">20003</span>
<span class="n">ID_USER_SOCLE_2</span> <span class="o">=</span> <span class="mi">20001</span>
</pre></div>
</div>
</section>
<section id="connexion-au-cas-inpn-gestion-centralisee-des-utilisateurs">
<h3>Connexion au CAS INPN - gestion centralisée des utilisateurs<a class="headerlink" href="#connexion-au-cas-inpn-gestion-centralisee-des-utilisateurs" title="Permalink to this headline"></a></h3>
<p>Bien changer les variables ID et PASSWORD avec les bonnes valeurs.</p>
<p>NB : pour la pré-prod, utiliser <code class="docutils literal notranslate"><span class="pre">https://preprod-inpn.mnhn.fr</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">CAS_PUBLIC</span><span class="p">]</span>
<span class="n">CAS_AUTHENTIFICATION</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">CAS_URL_LOGIN</span> <span class="o">=</span> <span class="s1">&#39;https://inpn.mnhn.fr/auth/login&#39;</span>
<span class="n">CAS_URL_LOGOUT</span> <span class="o">=</span> <span class="s1">&#39;https://inpn.mnhn.fr/auth/logout&#39;</span>

<span class="p">[</span><span class="n">CAS</span><span class="p">]</span>
<span class="n">CAS_URL_VALIDATION</span> <span class="o">=</span> <span class="s1">&#39;https://inpn.mnhn.fr/auth/serviceValidate&#39;</span>
<span class="c1"># est ce que les utilisateurs connecté peuvent voir les donées de leur organisme</span>
<span class="n">USERS_CAN_SEE_ORGANISM_DATA</span> <span class="o">=</span> <span class="n">false</span>

<span class="p">[</span><span class="n">CAS</span><span class="o">.</span><span class="n">CAS_USER_WS</span><span class="p">]</span>
<span class="n">URL</span> <span class="o">=</span> <span class="s1">&#39;https://inpn.mnhn.fr/authentication/information&#39;</span>
<span class="n">ID</span> <span class="o">=</span> <span class="s1">&#39;&lt;THE_INPN_LOGIN&gt;&#39;</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;&lt;THE_INPN_PASSWORD&gt;&#39;</span>
</pre></div>
</div>
</section>
<section id="configuration-du-frontend">
<h3>Configuration du frontend<a class="headerlink" href="#configuration-du-frontend" title="Permalink to this headline"></a></h3>
<p>Pour l’instance de pré-prod, rajouter “instance de démo” à la variable
<code class="docutils literal notranslate"><span class="pre">appName</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">FRONTEND</span><span class="p">]</span>
    <span class="c1"># Compilation du fronend en mode production</span>
    <span class="n">PROD_MOD</span> <span class="o">=</span> <span class="n">true</span>
    <span class="c1"># Affichage du footer sur la page d&#39;acceuil</span>
    <span class="n">DISPLAY_FOOTER</span> <span class="o">=</span> <span class="n">true</span>
    <span class="c1"># affiche la carte des dernières observations basées sur la synthese</span>
    <span class="n">DISPLAY_MAP_LAST_OBS</span> <span class="o">=</span> <span class="n">false</span>
    <span class="c1"># afficheafficher un bloc de stat basé sur la synthese</span>
    <span class="n">DISPLAY_STAT_BLOC</span> <span class="o">=</span> <span class="n">false</span>
</pre></div>
</div>
</section>
<section id="configuration-de-la-cartographie">
<h3>Configuration de la cartographie<a class="headerlink" href="#configuration-de-la-cartographie" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">MAPCONFIG</span><span class="p">]</span>
<span class="n">BASEMAP</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="s2">&quot;IGN-topo&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://wxs.ign.fr/i53afxeajwaokg3gxzzhn8un/geoportail/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=GEOGRAP$</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=</span> <span class="s2">&quot;IGN-Scan Express&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://wxs.ign.fr/i53afxeajwaokg3gxzzhn8un/geoportail/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=$</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="s2">&quot;IGN-Ortho&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://wxs.ign.fr/i53afxeajwaokg3gxzzhn8un/geoportail/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=ORTHOI$</span>
<span class="p">]</span>
<span class="c1"># Attention: les coordonnées sont au format [Y, X] - cf leaflet configuration (https://leafletjs.com/reference-1.4.0.html#latlng-l-latlng)</span>
<span class="n">CENTER</span> <span class="o">=</span> <span class="p">[</span><span class="mf">46.52863469527167</span><span class="p">,</span> <span class="mf">2.43896484375</span><span class="p">]</span>
<span class="c1"># Zoom par défaut</span>
<span class="n">ZOOM_LEVEL</span> <span class="o">=</span> <span class="mi">6</span>
<span class="c1"># Zoom à partir duquel on peut pointer un releve</span>
<span class="n">ZOOM_LEVEL_RELEVE</span> <span class="o">=</span> <span class="mi">15</span>
</pre></div>
</div>
<p>Après chaque modification du fichier de configuration, lancez les commandes
suivantes pour mettre à jour l’application (l’opération peut être longue car
il s’agit de la recompilation du frontend).</p>
<p>Depuis le répertoire <code class="docutils literal notranslate"><span class="pre">backend</span></code> de GeoNature</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">geonature</span> <span class="n">update_configuration</span>
<span class="n">deactivate</span>
</pre></div>
</div>
</section>
<section id="configuration-du-module-occurrence-de-taxon-occtax">
<h3>Configuration du module Occurrence de taxon: OCCTAX<a class="headerlink" href="#configuration-du-module-occurrence-de-taxon-occtax" title="Permalink to this headline"></a></h3>
<p>Le fichier de configuration du module Occtax se trouve dans le fichier
<code class="docutils literal notranslate"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/external_modules/occtax/config/conf_gn_module.toml</span></code>.</p>
<p>Le script de configuration spécifique de l’instance nationale remplit ce
fichier avec les bonnes configuration.</p>
<p>Voici la configuration fournie pour l’instance de production:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api_url</span> <span class="o">=</span> <span class="s1">&#39;/occtax&#39;</span>

<span class="c1"># message sur la modale des export pour préciser les consignes pour GINCO</span>
<span class="n">export_message</span> <span class="o">=</span> <span class="s2">&quot;&lt;p&gt; &lt;b&gt; Attention: &lt;/b&gt; &lt;/br&gt; Vous vous apprêtez à télécharger les données de la &lt;b&gt;recherche courante.&lt;/b&gt; &lt;/br&gt; Pour n&#39;exporter qu&#39;un &lt;b&gt;$</span>

<span class="c1"># format disponible pour l&#39;export</span>
<span class="n">export_available_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;geojson&#39;</span><span class="p">]</span>

<span class="c1"># passage du champ observateur du formulaire de saisi en mode &#39;saisie libre&#39;</span>
<span class="n">observers_txt</span> <span class="o">=</span> <span class="n">true</span>

<span class="c1"># identifiant de la liste des taxon proposé dans le formulaire (voir table taxonomie.bib_listes et taxonomie.cor_nom_liste)</span>
<span class="n">id_taxon_list</span> <span class="o">=</span> <span class="mi">500</span>

<span class="c1"># niveau de zoom à partir duquel on peut saisir un relevé sur la carte</span>
<span class="n">releve_map_zoom_level</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c1"># colonnes de la vue pr_occtax.export_occtax_sinp à exporter pour GINCO dépot légal</span>
<span class="n">export_columns</span> <span class="o">=</span>  <span class="p">[</span>
    <span class="s2">&quot;permId&quot;</span><span class="p">,</span>
    <span class="s2">&quot;statObs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nomCite&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dateDebut&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dateFin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;heureDebut&quot;</span><span class="p">,</span>
    <span class="s2">&quot;heureFin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;altMax&quot;</span><span class="p">,</span>
    <span class="s2">&quot;altMin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cdNom&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cdRef&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dateDet&quot;</span><span class="p">,</span>
    <span class="s2">&quot;comment&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dSPublique&quot;</span><span class="p">,</span>
    <span class="s2">&quot;statSource&quot;</span><span class="p">,</span>
    <span class="s2">&quot;idOrigine&quot;</span><span class="p">,</span>
    <span class="s2">&quot;refBiblio&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obsMeth&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocEtatBio&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocNat&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocSex&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocStade&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocBiogeo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocStatBio&quot;</span><span class="p">,</span>
    <span class="s2">&quot;preuveOui&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocMethDet&quot;</span><span class="p">,</span>
    <span class="s2">&quot;preuvNum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;preuvNoNum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obsCtx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;permIdGrp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;methGrp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;typGrp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;denbrMax&quot;</span><span class="p">,</span>
    <span class="s2">&quot;denbrMin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;objDenbr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;typDenbr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obsId&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obsNomOrg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detId&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detNomOrg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;orgGestDat&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WKT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;natObjGeo&quot;</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>Le fichier
<code class="docutils literal notranslate"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/external_modules/occtax/config/conf_gn_module.toml.example</span></code>
liste l’ensemble des variables de configuration du module Occtax ainsi que
leurs valeurs par défault.</p>
<p>Après chaque modification du fichier de configuration, lancez les commandes
suivantes pour mettre à jour l’application (l’opération peut être longue car
il s’agit de la recompilation du frontend).</p>
<p>Depuis le répertoire <code class="docutils literal notranslate"><span class="pre">backend</span></code> de GeoNature</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">geonature</span> <span class="n">update_module_configuration</span> <span class="n">occtax</span>
<span class="n">deactivate</span>
</pre></div>
</div>
<p>Pour plus d’information sur la configuration du module Occtax, voir la documentation concernant le module (<a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/docs/admin-manual.rst#module-occtax">https://github.com/PnX-SI/GeoNature/blob/master/docs/admin-manual.rst#module-occtax</a>).</p>
</section>
</section>
<section id="referentiel-geographique">
<h2>Référentiel géographique<a class="headerlink" href="#referentiel-geographique" title="Permalink to this headline"></a></h2>
<p>Sur l’instance nationale on charge dans le référentiel géographique
l’ensemble des communes du territoire français, ainsi qu’un MNT (modèle
numérique de terrain) national de résolution 250m (pour le calcul automatique
des altitudes pour chaque observation).</p>
<img alt="http://geonature.fr/docs/img/admin-manual/design-geonature-mtes.png" src="http://geonature.fr/docs/img/admin-manual/design-geonature-mtes.png" />
</section>
<section id="authentification-cas-inpn">
<h2>Authentification CAS INPN<a class="headerlink" href="#authentification-cas-inpn" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Code source : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/backend/geonature/core/auth/routes.py">https://github.com/PnX-SI/GeoNature/blob/master/backend/geonature/core/auth/routes.py</a></p></li>
<li><p>Config : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/config/default_config.toml.example#L124-L135">https://github.com/PnX-SI/GeoNature/blob/master/config/default_config.toml.example#L124-L135</a></p></li>
</ul>
</section>
<section id="connexion-et-droits-dans-geonature">
<h2>Connexion et droits dans GeoNature<a class="headerlink" href="#connexion-et-droits-dans-geonature" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>A chaque connexion via le CAS INPN on récupère l’ID_Utilisateur.
On ajoute cet utilisateur dans la base de données de GeoNature
(<code class="docutils literal notranslate"><span class="pre">utilisateurs.t_roles</span></code> et <code class="docutils literal notranslate"><span class="pre">utilisateurs.bib_organisme</span></code>) et on
lui affecte des droits CRUVED par défaut.</p></li>
<li><p>On assigne à l’utilisateur le « socle 1 » (C1-R1-V0-E1-D1). Il pourra voir
seulement les données qu’il a saisi lui-même et les JDD qu’il a
créé dans MTD.</p></li>
</ul>
<p>NB sur la gestion des droits dans GeoNature :</p>
<ul class="simple">
<li><p>6 actions sont possibles dans GeoNature :
Create / Read / Update / Validate / Export / Delete (aka CRUVED).</p></li>
<li><p>3 portées de ces actions sont possibles :
Mes données / Les données de mon organisme / Toutes les données.</p></li>
</ul>
</section>
<section id="recuperation-des-jdd">
<h2>Récupération des JDD<a class="headerlink" href="#recuperation-des-jdd" title="Permalink to this headline"></a></h2>
<p>Grâce à l’API de MTD, il est désormais possible d’ajouter les jeux de données
(et des cadres d’acquisition) créés dans MTD dans la BDD GeoNature.</p>
<ul class="simple">
<li><p>On récupère la liste des JDD créés par l’utilisateur grâce à l’API MTD au
chargement de la liste déroulante des JDD :
<a class="reference external" href="https://xxxxx/cadre/jdd/export/xml/GetRecordsByUserId">https://xxxxx/cadre/jdd/export/xml/GetRecordsByUserId</a>?id=&lt;ID_USER&gt;</p></li>
<li><p>On récupère l’UUID du cadre CA associé au JDD dans le XML renvoyé et on fait
appel au l’API MTD pour récupérer le fichier XML du CA :
<a class="reference external" href="https://xxxxx/cadre/export/xml/GetRecordById">https://xxxxx/cadre/export/xml/GetRecordById</a>?id=&lt;UUID&gt;</p></li>
<li><p>On ajoute le CA dans la table <code class="docutils literal notranslate"><span class="pre">gn_meta.t_acquisition_framwork</span></code> et les JDD
dans la table <code class="docutils literal notranslate"><span class="pre">gn_meta.t_datasets</span></code>. Si le CA ou les JDD sont modifiés dans
MTD, ils seront également modifiés dans le BDD GeoNature.</p></li>
<li><p>Dans la table <code class="docutils literal notranslate"><span class="pre">gn_meta.cor_dataset_actor</span></code> on fait le lien entre les
acteurs et le JDD. On ajoute l’utilisateur qui a créé le JDD comme
“Point de contact principal” du JDD. Si on dispose de l’ID_Organisme de
l’utilisateur, on ajoute également l’organisme comme
“Point de contact principal” du JDD.</p></li>
<li><p>Pour remplir cette table on ne prend pas les infos renvoyés par le
XML JDD sous l’intitulé « Acteur » puisque l’ID_Organisme ou l’ID_Acteur
n’est pas renseigné. (Dans la table <code class="docutils literal notranslate"><span class="pre">gn_meta.cor_dataset_actor</span></code>, il faut
obligatoirement un ID).</p></li>
<li><p>La question de la suppresion de JDD et des CA n’est pas résolue. Si un JDD
est supprimé dans MTD, qu’est-ce qu’on fait des données associées a celui-ci
dans GeoNature ?</p></li>
</ul>
</section>
<section id="module-synthese">
<h2>Module Synthese<a class="headerlink" href="#module-synthese" title="Permalink to this headline"></a></h2>
<p>Sur l’instance DEPOPBIO le module synthese a été désactivé en mettant un
CRUVED à 0 au groupe socle 1 et socle 2 pour le module.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">gn_permissions</span><span class="o">.</span><span class="n">cor_role_action_filter_module_object</span>
  <span class="p">(</span>
  <span class="n">id_role</span><span class="p">,</span>
  <span class="n">id_action</span><span class="p">,</span>
  <span class="n">id_filter</span><span class="p">,</span>
  <span class="n">id_module</span><span class="p">,</span>
  <span class="n">id_object</span>
  <span class="p">)</span>
  <span class="n">VALUES</span>
  <span class="o">--</span> <span class="n">synthese</span> <span class="n">pour</span> <span class="n">socle</span> <span class="mi">1</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="o">--</span> <span class="n">synthese</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="o">--</span> <span class="n">admin</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="o">--</span> <span class="n">admin</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="o">--</span> <span class="n">meta</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="o">--</span> <span class="n">meta</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">;</span>
</pre></div>
</div>
<p>Les triggers d’insertion du module Occtax vers le module Synthese ont
également été désactivés.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">t_releves_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_update_synthese_t_releve_occtax</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">t_releves_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_delete_synthese_t_releve_occtax</span><span class="p">;</span>

<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">t_occurrences_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_update_synthese_t_occurrence_occtax</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">t_occurrences_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_delete_synthese_t_occurrence_occtax</span><span class="p">;</span>

<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">cor_counting_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_insert_synthese_cor_counting_occtax</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">cor_counting_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_update_synthese_cor_counting_occtax</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">cor_counting_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_delete_synthese_cor_counting_occtax</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2019, PnE, PnC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>