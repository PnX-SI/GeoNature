<div class="container-fluid">
  <div class="card card-page">
    <div class="card-header">
      <h3 class="main-color"> Catalogue des jeux de données </h3>
    </div>

    <div class="card-body">
      <div class="row ml-4 mb-4">
        <button
          *ngIf="_cruvedStore.cruved?.METADATA?.cruved.C !== '0'"
          routerLink="/metadata/af"
          class="uppercase mr-1"
          mat-raised-button
          color="primary"
        >
          Ajouter un cadre d'acquisition
          &nbsp;
        </button>
        <button
          *ngIf="_cruvedStore.cruved?.METADATA?.cruved.C !== '0'"
          routerLink="/metadata/dataset"
          class="uppercase"
          mat-raised-button
          color="primary"
        >
          Ajouter un jeu de données
        </button>
      </div>

      <div class="row">
        <div class="form-group col-sm-7">
          <input
            class="form-control form-control-sm"
            type="text"
            placeholder="Rechercher"
            [formControl]="metadataService.rapidSearchControl"
          >
        </div>
        <div class="col-sm-3">
          <button
            mat-raised-button
            color="primary"
            (click)="openSearchModal(searchModal)"
          > Recherche avancée </button>
          <button
            mat-raised-button
            color="accent"
            class="ml-2"
            matTooltip="Réinitialiser la recherche"
            (click)="refreshFilters()"
          >
            <mat-icon style="vertical-align: middle;">refresh</mat-icon>
          </button>
        </div>
      </div>

      <div>Liste des cadres d'acquisition et des jeux de données associés</div>
      <br>

      <ng-container *ngIf="(acquisitionFrameworks | async)?.length || isLoading; else noAcquisitionFrameworks">

        

        <mat-accordion 
          [multi]="true"
          >
          <div class="tab-title" *ngIf="!isLoading">
            <div class="col-md-1">ID </div>
            <div class="col-md-2"> Nom</div>
            <div class="col-md-2"> Date de création</div>
            <div class="col-md-5"> Acteurs</div>
            <div class="col-md-1"> Actions</div>
          </div>
          <mat-spinner
            *ngIf="isLoading"
            diameter="50"
            strokeWidth="2"
            style="margin: 0 auto;"
          >
          </mat-spinner>

          <ng-container *ngFor="let af of (acquisitionFrameworks | async); let idx = index">
            <mat-expansion-panel
              [expanded]="expandAccordions"
            >
              <mat-expansion-panel-header
                collapsedHeight="*"
                expandedHeight="*"
              >
                <mat-panel-title
                  class="af-title"
                  style="margin-top:2.5%;margin-bottom: 1.2%;"
                >

                  <div class="col-md-1">{{ af.id_acquisition_framework }}</div>
                  <div class="col-md-2">
                    <a [routerLink]="['/metadata/af_detail', af.id_acquisition_framework]">
                      {{ af.acquisition_framework_name }}
                      <br> <small style="color: gray"> {{ af.unique_acquisition_framework_id  }}
                      </small>
                    </a>
                  </div>
                  <div class="col-md-2 ">{{af.meta_create_date |date:'d/MM/yyyy'}}
                  </div>
                  <section class="col-md-5">
                    <span *ngIf="af.creator"> <b> {{af.creator?.nom_complet}} : </b> créateur </span>

                    <div *ngFor="let ac of af.cor_af_actor">
                      <span *ngIf="ac.organism">
                        <b> {{ac.organism?.nom_organisme }} : </b>
                        {{ac.nomenclature_actor_role.label_fr }} <br>
                      </span>
                      <span *ngIf="ac.role">
                        <b> {{ac.role?.nom_complet }} : </b>
                        {{ac.nomenclature_actor_role.label_fr }} <br>
                      </span>

                    </div>
                  </section>

                  <div class="col-md-2">
                    <a 
                      mat-icon-button
                      [routerLink]="['/metadata/af_detail', af.id_acquisition_framework]"
                      matTooltip="Voir la fiche du cadre d'acquisition"
                      style="color: black;"
                    >
                      <mat-icon> info</mat-icon>
                    </a>
                    <a
                      mat-icon-button
                      [disabled]="!af.cruved.U"
                      matTooltip="Editer ce cadre d'acquisition"
                      [routerLink]="['/metadata/af', af.id_acquisition_framework]"
                    >
                      <mat-icon> create</mat-icon>
                    </a>
                    <button
                      *ngIf="APP_CONFIG.METADATA?.ENABLE_CLOSE_AF"
                      type="button"
                      mat-icon-button
                      [disabled]="!af.cruved.V || !af.opened || af['t_datasets'].length == 0"
                      (click)="openPublishModalAf($event, af.id_acquisition_framework, publishModal)"
                    >
                      <mat-icon
                        *ngIf="af.opened==false; else elifEmpty"
                        matTooltip="Le cadre d'acquisition a déjà été déposé"
                      > gavel </mat-icon>
                      <ng-template #elifEmpty>
                        <mat-icon
                          *ngIf="af['t_datasets'].length == 0; else elsePublish"
                          matTooltip="Le cadre d'acquisition est vide"
                        > gavel </mat-icon>
                      </ng-template>
                      <ng-template #elsePublish>
                        <mat-icon
                          matTooltip="Déposer le cadre d'acquisition"
                        > gavel </mat-icon>
                      </ng-template>
                    </button>

                  </div>

                </mat-panel-title>

              </mat-expansion-panel-header>
              <table class="table table-bordered">
                <thead class="bold">
                  <tr>
                    <td style="width:1%">
                      Id
                    </td>
                    <td>Nom du JDD</td>
                    <td>Date de création</td>
                    <td>Acteurs</td>
                    <td>Nombre de données</td>
                    <td>Actions</td>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let ds of af.datasetsTemp; let last = last;">
                    <td>
                      {{ds.id_dataset}}
                    </td>
                    <td>
                      <span class="float-left">
                        <mat-icon
                          *ngIf="ds.active"
                          matTooltip="Le jeu de données est actif"
                          class="success"
                        > toggle_on </mat-icon>
                        <mat-icon
                          *ngIf="!ds.active"
                          matTooltip="Le jeu de données est inactif"
                          color="warn"
                        > toggle_off </mat-icon>
                      </span>
                      <a [routerLink]="['/metadata/dataset_detail', ds.id_dataset]">
                        {{ds.dataset_name}}

                        <br />
                        <small style="color: gray"> {{ds.unique_dataset_id}} </small>

                      </a>
                    </td>
                    <td> {{ds.meta_create_date |date:'dd/MM/yyyy' }}</td>
                    <td style="text-align: left;">
                      <span *ngIf="ds.creator"> <b> {{ds.creator?.nom_complet}} : </b> créateur
                      </span>
                      <div *ngFor="let ac of ds.cor_dataset_actor">
                        <span *ngIf="ac.organism">
                          <b> {{ac.organism?.nom_organisme }} : </b>
                          {{ac.nomenclature_actor_role.label_fr }} <br>
                        </span>
                        <span *ngIf="ac.role">
                          <b> {{ac.role?.nom_complet }} : </b>
                          {{ac.nomenclature_actor_role.label_fr }} <br>
                        </span>

                      </div>
                    </td>
                    <td> {{ds?.observation_count}} </td>
                    <td>
                      <a
                        mat-icon-button
                        [routerLink]="['/metadata/dataset_detail', ds.id_dataset]"
                        matTooltip="Voir la fiche du jeu de données"
                      >
                        <mat-icon> info </mat-icon>
                      </a>
                      <a
                        *ngIf="moduleImportIsAuthorized"
                        mat-icon-button
                        type="button"
                        [disabled]="!ds.active"
                        [routerLink]="['/import/process/step/1']" 
                        [queryParams]="{datasetId: ds.id_dataset, resetStepper: true}"
                      >
                        <mat-icon
                          *ngIf="!ds.active; else elseImport"
                          matTooltip="Le jeu de donnée est inactif"
                        > upload </mat-icon>
                        <ng-template #elseImport>
                          <mat-icon matTooltip="Importer dans ce jeu de donnée"> upload </mat-icon>
                        </ng-template>
                      </a>

                      <a
                        mat-icon-button
                        [disabled]="ds?.observation_count == 0"
                        [routerLink]="['/synthese']" 
                        [queryParams]="{id_dataset: ds.id_dataset}"
                      >
                        <mat-icon
                          *ngIf="ds?.observation_count == 0; else elseSynthese;"
                          matTooltip="Ce jeu de données ne comporte aucune donnée"
                        > room </mat-icon>
                        <ng-template #elseSynthese>
                          <mat-icon matTooltip="Afficher les données dans la Synthèse"> room
                          </mat-icon>
                        </ng-template>
                      </a>
                      <a
                        mat-icon-button
                        [disabled]="!ds.cruved.U"
                        [routerLink]="['/metadata/dataset', ds.id_dataset]"
                        matTooltip="Editer le jeu de données"
                      >
                        <mat-icon> create</mat-icon>
                      </a>
                      <ng-container *ngIf="!ds.cruved.D || (ds?.observation_count || 0) > 0; else elseblock">
                        <button
                          mat-icon-button
                          [disabled]="true"
                        >
                          <mat-icon
                            [matTooltip]="
                              (ds?.observation_count || 0) > 0 ? 
                                'Ce jeu de données contient des données et ne peut pas être supprimé' :
                                'Vous n\'avez pas les droits nécessaires pour supprimer ce jeu de données'
                            "
                          > delete </mat-icon>
                        </button>
                      </ng-container>
                      <ng-template #elseblock>
                        <button
                          mat-icon-button
                          (click)="deleteDs(ds)"
                        >
                          <mat-icon matTooltip="Supprimer le jeu de données"> delete </mat-icon>
                        </button>
                      </ng-template>
                    </td>
                  </tr>
                </tbody>
              </table>
            </mat-expansion-panel>
          </ng-container>

        </mat-accordion>
        <mat-paginator
          #paginator
          [length]="(metadataService.filteredAcquisitionFrameworks | async)?.length || 0"
          [pageSize]="(metadataService.pageSize | async)"
          [pageSizeOptions]="metadataService.pageSizeOptions"
          [pageIndex]="(metadataService.pageIndex | async)"
          (page)="changePaginator($event)"
        >
        </mat-paginator>
      </ng-container>
      <ng-template #noAcquisitionFrameworks>
        <div class="text-center">Oups ! Il n'y a aucune métadonnée à afficher.</div>
      </ng-template>


    </div>
  </div>
</div>


<ng-template
  #searchModal
  let-c="close"
  let-d="dismiss"
>
  <div class="modal-header">
    <h5
      class="modal-title"
      id="exampleModalLabel"
    > Rechercher </h5>
  </div>
  <div
    class="modal-body"
    style="align-items: flex-end;"
  >
    <label> Rechercher sur:</label>
    <select
      [formControl]="metadataService.form.get('selector')"
      name="selecteur"
      id="selector"
      class="form-control"
    >
      <option value="ds">Jeu de données</option>
      <option value="af">Cadre d'acquisition</option>
    </select>
    <label>UUID</label>
    <input
      [formControl]="metadataService.form.get('uuid')"
      class="form-control form-control-sm"
      type="text"
    >
    <label>Titre / Identifiant</label>

    <input
      [formControl]="metadataService.form.get('name')"
      class="form-control form-control-sm"
    >

    <pnx-date
      [parentFormControl]="metadataService.form.get('date')"
      label="Date de création"
    ></pnx-date>
    <label>Acteur (organisme)</label>

    <select
      [formControl]="metadataService.form.get('organism')"
      class="form-control form-control"
    >
      <option
        value=""
        selected
      >--</option>
      <option
        *ngFor="let org of organisms"
        value="{{org.id_organisme}}"
      >
        {{org.nom_organisme}} </option>
    </select>
    <label> Acteur (personne)</label>

    <select
      class="form-control form-control"
      [formControl]="metadataService.form.get('person')"
    >
      <option
        value=""
        selected
      > --</option>
      <option
        *ngFor="let role of roles"
        value="{{role.id_role}}"
      >
        {{role?.nom_complet}}</option>
    </select>

    <div class="mt-2">
      <button
        mat-raised-button
        class="button-success uppercase mr-2"
        (click)="advancedSearch(); c()"
      > Rechercher </button>
      <button
        mat-raised-button
        color="warn"
        class="uppercase"
        (click)="c()"
      >
        Fermer
      </button>
    </div>

  </div>
</ng-template>


<ng-template
  #publishModal
  let-c="close"
  let-d="dismiss"
>
  <div class="modal-header">
    <h5
      class="modal-title"
      id="publishModalLabel"
    >{{ afPublishModalLabel }}</h5>
  </div>

  <div
    class="modal-body"
    style="align-items: flex-end;"
  >
    <div class="col">
      <span>
        <p style="text-align: justify;">{{ afPublishModalContent }}</p>
      </span>
    </div>
  </div>

  <div class="modal-footer">
    <div class="col">
    </div>
    <div mat-dialog-actions align="end">
      <button
        mat-raised-button
        cdkFocusInitial
        class="mr-1"
        (click)="c()"
      > Annuler </button>
      <button
        mat-raised-button
        color="primary"
        (click)="publishAf()"
      > Confirmer </button>
    </div>
    <br>
  </div>

</ng-template>
