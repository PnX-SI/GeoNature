<div
  class="container-fluid"
  data-qa="pnx-home-content"
>
  <div class="row">
    <div [className]="showLastObsMap ? 'col-xs-12 col-sm-12 col-md-6 col-lg-6' : 'col-12'">
      <pnx-introduction></pnx-introduction>
    </div>
    <div
      class="col-xs-12 col-sm-12 col-md-6 col-lg-6"
      *ngIf="showLastObsMap"
    >
      <div class="panel panel-default">
        <!-- mr-0 and ml-0 since row puts margin-left and right at -15px... -->
        <div class="panel-heading row mr-0 ml-0">
          <div class="col-12 col-lg-5 col-xl-7">
            <span>Les 100 dernières observations</span>
          </div>
          <div class="col-12 col-lg-7 col-xl-5">
            <button
              routerLink="/synthese"
              mat-stroked-button
              color="primary"
              class="uppercase ml-1 mt-1 float-right"
              data-qa="pnx-home-content-explore-data-button"
            >
              Explorer les données
            </button>
          </div>
        </div>

        <div id="map-title"></div>

        <pnx-map
          class="map-card"
          height="50vh"
        ></pnx-map>
      </div>
    </div>
  </div>
  <mat-tab-group>
    <mat-tab label="Dernières Discussions">
      <ngx-datatable
        #table
        class="material striped margin-top-xs table-size expandable"
        [rows]="discussions"
        [columns]="columns"
        [headerHeight]="50"
        [footerHeight]="50"
        [rowHeight]="'auto'"
        [limit]="perPage"
        [count]="totalPages"
        [offset]="currentPage - 1"
        (page)='changePage($event.offset + 1)'
        (select)="onRowClick($event)"
        (sort)="onColumnSort($event)"
      >
 <!-- Row Detail Template -->
 <ngx-datatable-row-detail [rowHeight]="150">
  <ng-template ngx-datatable-row-detail-template let-row="row">
    <div class="row-detail">
      <ng-container *ngIf="row.content">
        <div>
          <strong>Commentaire :</strong> {{ row.content }}
        </div>
      </ng-container>
      <div>
        <strong>Date du commentaire :</strong> {{ row.creation_date | date:'dd-MM-yyyy' }}
      </div>
      <div>
        <strong>Utilisateur :</strong> {{ row.user.nom_complet }}
      </div>
    </div>
  </ng-template>
</ngx-datatable-row-detail>

<ngx-datatable-column [width]="10" [resizeable]="false" [sortable]="false" [draggable]="false" [canAutoResize]="false">
  <ng-template ngx-datatable-cell-template let-row="row" let-expanded="expanded">
    <a
      href="javascript:void(0)"
      matTooltip="Ouvrir/fermer le détail"
      [class.datatable-icon-right]="!expanded"
      [class.datatable-icon-down]="expanded"
      (click)="toggleExpandRow(row)"
    ></a>
  </ng-template>
</ngx-datatable-column>
<ng-container *ngFor="let col of columns">
  <ngx-datatable-column
    [width]="col.maxWidth || 150"
    [prop]="col.prop"
    [name]="col.name"
    [sortable]="col.sortable !== false"
    [resizeable]="true"
    [canAutoResize]="true"
  >
    <ng-template ngx-datatable-cell-template let-row="row">
      <span [ngSwitch]="col.prop">
        <span *ngSwitchCase="'creation_date'">{{ row[col.prop] | date:'dd-MM-yyyy' }}</span>
        <span *ngSwitchCase="'user.nom_complet'">{{ row.user.nom_complet || 'N/A' }}</span>
        <span *ngSwitchCase="'observation'" [innerHTML]="row.observation"></span>
        <span *ngSwitchDefault>{{ row[col.prop] || 'N/A' }}</span>
      </span>
    </ng-template>
  </ngx-datatable-column>
</ng-container>
    </ngx-datatable>
      
      <!-- Toggle for "Mes discussions" -->
      <div class="toggle-container">
        <label>
          <input type="checkbox" [(ngModel)]="myReportsOnly" (change)="toggleMyReports()">
          Mes discussions
        </label>
      </div>
    </mat-tab>
    <!-- TODO: Autres onglets à ajouter (Dernière validations etc) -->
  </mat-tab-group>
  <div
    *ngIf="showGeneralStat"
    class="panel panel-container panel-top"
  >
    <div class="row row-0">
      <div class="col-xs-6 col-md-3 col-lg-3 no-padding">
        <div class="panel panel-teal panel-widget border-right no-margin-bottom">
          <div class="no-padding">
            <em class="fa fa-xl fa-search color-blue"></em>
            <div class="large">
              <mat-spinner
                *ngIf="!generalStat"
                diameter="20"
              ></mat-spinner>
              {{ generalStat?.nb_data | number: '1.0-0' : locale }}
            </div>
            <div class="text-muted">Observations</div>
          </div>
        </div>
      </div>
      <div class="col-xs-6 col-md-3 col-lg-3 no-padding">
        <div class="panel panel-blue panel-widget border-right no-margin-bottom">
          <div class="no-padding">
            <em class="fa fa-xl fa fa-leaf color-orange"></em>
            <div class="large">
              <mat-spinner
                *ngIf="!generalStat"
                diameter="20"
              ></mat-spinner>
              {{ generalStat?.nb_species | number: '1.0-0' : locale }}
            </div>
            <div class="text-muted">Taxons</div>
          </div>
        </div>
      </div>
      <div class="col-xs-6 col-md-3 col-lg-3 no-padding">
        <div class="panel panel-orange panel-widget border-right no-margin-bottom">
          <div class="no-padding">
            <em class="fa fa-xl fa-users color-teal"></em>
            <div class="large">
              <mat-spinner
                *ngIf="!generalStat; else hasStat"
                diameter="20"
              ></mat-spinner>
              <ng-template #hasStat>
                ~{{ generalStat?.nb_observers | number: '1.0-0' : locale }}
              </ng-template>
            </div>
            <div class="text-muted">Observateurs</div>
          </div>
        </div>
      </div>
      <div class="col-xs-6 col-md-3 col-lg-3 no-padding">
        <div class="panel panel-red panel-widget no-margin-bottom">
          <div class="no-padding">
            <em class="fa fa-xl fa fa-book color-red"></em>
            <div class="large">
              <mat-spinner
                *ngIf="!generalStat"
                diameter="20"
              ></mat-spinner>
              {{ generalStat?.nb_dataset | number: '1.0-0' : locale }}
            </div>
            <div class="text-muted">Jeux de données</div>
          </div>
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-center">
      <div class="col-xs-12 pr-2 text-muted">
        <small>
          Dernière mise à jour
          {{ generalStat?.createdDate | date: 'full' : undefined : locale }}
        </small>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<pnx-footer *ngIf="config.FRONTEND.DISPLAY_FOOTER"></pnx-footer>
