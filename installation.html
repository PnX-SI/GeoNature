<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>INSTALLATION &mdash; Documentation GeoNature 2.0</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Recherche" href="search.html" />
    <link rel="next" title="MANUEL UTILISATEUR" href="user-manual.html" />
    <link rel="prev" title="Bienvenue dans la documentation de GeoNature" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="index.html" class="icon icon-home"> GeoNature
            <img src="_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">INSTALLATION</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequis">Prérequis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparation-du-serveur">Préparation du serveur</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation-globale">Installation globale</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installation-de-l-application">Installation de l’application</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installation-de-geonature-uniquement">Installation de GeoNature uniquement</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installation-des-dependances">Installation des dépendances</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Installation de l’application</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">Installation de l’application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-apache">Configuration Apache</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dependances">Dépendances</a></li>
<li class="toctree-l3"><a class="reference internal" href="#passer-en-mode-developpement">Passer en mode développement</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#https">HTTPS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installer-certbot">Installer certbot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lancer-la-commande-cerbot">Lancer la commande cerbot</a></li>
<li class="toctree-l3"><a class="reference internal" href="#les-certificats-obtenus">Les certificats obtenus</a></li>
<li class="toctree-l3"><a class="reference internal" href="#automatiser-le-renouvellement-du-certificat">Automatiser le renouvellement du certificat</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prise-en-compte-des-nouvelles-configurations-apache">Prise en compte des nouvelles configurations Apache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-de-l-application-geonature">Configuration de l’application GeoNature</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#taches-planifiees">Taches planifiées</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation-d-un-module-geonature">Installation d’un module GeoNature</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mise-a-jour-de-l-application">Mise à jour de l’application</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin-manual.html">MANUEL ADMINISTRATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="import-level-1.html">IMPORT NIVEAU 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="import-level-2.html">IMPORT NIVEAU 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">DEVELOPPEMENT</a></li>
<li class="toctree-l1"><a class="reference internal" href="versions-compatibility.html">COMPATIBILITE</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">CHANGELOG</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GeoNature</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>INSTALLATION</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/installation.rst.txt" rel="nofollow"> Afficher la source de la page</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installation">
<h1>INSTALLATION<a class="headerlink" href="#installation" title="Lien permanent vers cette rubrique"></a></h1>
<p>GeoNature repose sur les composants suivants :</p>
<ul class="simple">
<li><p>PostgreSQL / PostGIS</p></li>
<li><p>Python 3 et dépendances Python nécessaires à l’application</p></li>
<li><p>Flask (framework web Python)</p></li>
<li><p>Apache</p></li>
<li><p>Angular 7, Angular CLI, NodeJS</p></li>
<li><p>Librairies javascript (Leaflet, ChartJS)</p></li>
<li><p>Librairies CSS (Bootstrap, Material Design)</p></li>
</ul>
<p>Deux méthodes d’installation existent :</p>
<ul class="simple">
<li><p><a class="reference internal" href="#installation-all"><span class="std std-ref">Installation globale</span></a> : Installation automatisée de GeoNature, TaxHub et UsersHub.</p></li>
<li><p><a class="reference internal" href="#installation-standalone"><span class="std std-ref">Installation de GeoNature uniquement</span></a> : TaxHub et UsersHub ne sont pas installés (mais leur schémas sont tous de même créés dans la base de données).</p></li>
</ul>
<section id="prerequis">
<h2>Prérequis<a class="headerlink" href="#prerequis" title="Lien permanent vers cette rubrique"></a></h2>
<ul class="simple">
<li><p>Ressources minimum serveur :</p>
<ul>
<li><p>Un serveur Debian 10 ou Debian 11 architecture 64-bits</p></li>
<li><p>4 Go RAM</p></li>
<li><p>20 Go d’espace disque</p></li>
</ul>
</li>
<li><p>GeoNature nécessite d’accéder à des ressources externes durant son installation et son fonctionnement. Si vous utilisez un serveur mandataire, celui-ci doit permettre l’accès aux domaines suivants :</p>
<ul>
<li><p><a class="reference external" href="https://pypi.python.org">https://pypi.python.org</a></p></li>
<li><p><a class="reference external" href="https://geonature.fr/">https://geonature.fr/</a></p></li>
<li><p><a class="reference external" href="https://codeload.github.com/">https://codeload.github.com/</a></p></li>
<li><p><a class="reference external" href="https://nodejs.org/dist">https://nodejs.org/dist</a></p></li>
<li><p><a class="reference external" href="https://registry.npmjs.org">https://registry.npmjs.org</a></p></li>
<li><p><a class="reference external" href="https://www.npmjs.com">https://www.npmjs.com</a></p></li>
<li><p><a class="reference external" href="https://raw.githubusercontent.com/">https://raw.githubusercontent.com/</a></p></li>
<li><p><a class="reference external" href="https://inpn.mnhn.fr/mtd">https://inpn.mnhn.fr/mtd</a></p></li>
<li><p><a class="reference external" href="https://preprod-inpn.mnhn.fr/mtd">https://preprod-inpn.mnhn.fr/mtd</a></p></li>
<li><p><a class="reference external" href="https://wxs.ign.fr/">https://wxs.ign.fr/</a></p></li>
</ul>
</li>
</ul>
</section>
<section id="preparation-du-serveur">
<span id="preparation-server"></span><h2>Préparation du serveur<a class="headerlink" href="#preparation-du-serveur" title="Lien permanent vers cette rubrique"></a></h2>
<p>Commencer la procédure en se connectant au serveur en SSH avec l’utilisateur linux <code class="docutils literal notranslate"><span class="pre">root</span></code>.</p>
<ul>
<li><p>Mettre à jour de la liste des dépôts Linux :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt update</span>
<span class="c1"># apt upgrade</span>
</pre></div>
</div>
</li>
<li><p>Configuration de la locale du serveur</p>
<p>Certains serveurs sont livrés sans « locale » (langue par défaut). Pour l’installation de GeoNature, il est nécessaire de bien configurer la locale. Si la commande <code class="docutils literal notranslate"><span class="pre">locale</span></code> renvoie ceci :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LANG</span><span class="o">=</span><span class="n">fr_FR</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">LANGUAGE</span><span class="o">=</span><span class="n">fr_FR</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">LC_CTYPE</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_NUMERIC</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_TIME</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_COLLATE</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_MONETARY</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_MESSAGES</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_PAPER</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_NAME</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_ADDRESS</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_TELEPHONE</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_MEASUREMENT</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_IDENTIFICATION</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_ALL</span><span class="o">=</span><span class="n">fr_FR</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
</pre></div>
</div>
<p>Vous pouvez alors passer cette étape de configuration des locales.</p>
<p>Sinon exécuter la commande <code class="docutils literal notranslate"><span class="pre">dpkg-reconfigure</span> <span class="pre">locales</span></code>. Une fenêtre s’affiche dans votre console. Dans la liste déroulante, sélectionnez <code class="docutils literal notranslate"><span class="pre">fr_FR.UTF-8</span> <span class="pre">UTF-8</span></code> avec <code class="docutils literal notranslate"><span class="pre">Espace</span></code>, puis cliquez sur OK. Une 2ème fenêtre s’affiche avec une liste de locale activées (<code class="docutils literal notranslate"><span class="pre">fr_FR.UTF-8</span></code> doit être présent dans la liste), confirmez votre choix, en cliquant sur OK, puis attendez que la locale s’installe.</p>
</li>
<li><p>Installer l’utilitaire <code class="docutils literal notranslate"><span class="pre">sudo</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install sudo</span>
</pre></div>
</div>
</li>
<li><p>Créer un utilisateur Linux dédié (nommé <code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code> dans notre cas) pour ne pas travailler en <code class="docutils literal notranslate"><span class="pre">root</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># adduser geonatureadmin</span>
</pre></div>
</div>
</li>
<li><p>Lui donner ensuite les droits administrateur en l’ajoutant au groupe <code class="docutils literal notranslate"><span class="pre">sudo</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># adduser geonatureadmin sudo</span>
</pre></div>
</div>
</li>
<li><p>Pour la suite du processus d’installation, on utilisera l’utilisateur non privilégié nouvellement créé. Si besoin d’éxecuter des commandes avec les droits d’administrateur, on les précèdera de <code class="docutils literal notranslate"><span class="pre">sudo</span></code>.</p>
<p>Il est d’ailleurs possible renforcer la sécurité du serveur en bloquant la connexion SSH au serveur avec <code class="docutils literal notranslate"><span class="pre">root</span></code>. Voir <a class="reference external" href="https://docs.ovh.com/fr/vps/conseils-securisation-vps/">https://docs.ovh.com/fr/vps/conseils-securisation-vps/</a> pour plus d’informations sur le sécurisation du serveur.</p>
<p>Pour passer de l’utilisateur <code class="docutils literal notranslate"><span class="pre">root</span></code> à <code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code>, vous pouvez aussi utiliser la commande :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># su - geonatureadmin</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="installation-globale">
<span id="installation-all"></span><h2>Installation globale<a class="headerlink" href="#installation-globale" title="Lien permanent vers cette rubrique"></a></h2>
<p>Ce document décrit une procédure d’installation packagée de GeoNature.</p>
<p>En lançant le script d’installation ci-dessous, l’application GeoNature ainsi que ses dépendances seront installées sur un seul et même serveur au sein d’une seule base de données.</p>
<p>Les applications suivantes seront installées :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/PnX-SI/GeoNature">GeoNature</a></p></li>
<li><p><a class="reference external" href="https://github.com/PnX-SI/TaxHub">TaxHub</a> qui pilote le schéma <code class="docutils literal notranslate"><span class="pre">taxonomie</span></code></p></li>
<li><p><a class="reference external" href="https://github.com/PnX-SI/UsersHub">UsersHub</a> qui pilote le schéma <code class="docutils literal notranslate"><span class="pre">utilisateurs</span></code> (le paramètre <code class="docutils literal notranslate"><span class="pre">install_usershub_app</span></code> du fichier de configuration <code class="docutils literal notranslate"><span class="pre">install_all.ini</span></code> permet de désactiver l’installation de l’application. Il est cependant recommandé d’installer l’application pour disposer d’une interface pour gérer les utilisateurs dans GeoNature)</p></li>
</ul>
<p>Si vous disposez déjà de Taxhub ou de UsersHub sur un autre serveur ou une autre base de données et que vous souhaitez installer simplement GeoNature, veuillez suivre la documentation <a class="reference internal" href="#installation-standalone"><span class="std std-ref">Installation de GeoNature uniquement</span></a>.</p>
<section id="installation-de-l-application">
<h3>Installation de l’application<a class="headerlink" href="#installation-de-l-application" title="Lien permanent vers cette rubrique"></a></h3>
<p>Commencer la procédure en se connectant au serveur en SSH avec l’utilisateur dédié précédemment créé lors de l’étape de <a class="reference internal" href="#preparation-server"><span class="std std-ref">Préparation du serveur</span></a> (usuellement <code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code>).</p>
<ul class="simple">
<li><p>Se placer à la racine du <code class="docutils literal notranslate"><span class="pre">home</span></code> de l’utilisateur puis récupérer les scripts d’installation (X.Y.Z à remplacer par le numéro de la <a class="reference external" href="https://github.com/PnEcrins/GeoNature/releases">dernière version stable de GeoNature</a>). Ces scripts installent les applications GeoNature, TaxHub et UsersHub (en option) ainsi que leurs bases de données (uniquement les schémas du coeur) :</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget https://raw.githubusercontent.com/PnX-SI/GeoNature/X.Y.Z/install/install_all/install_all.ini
$ wget https://raw.githubusercontent.com/PnX-SI/GeoNature/X.Y.Z/install/install_all/install_all.sh
</pre></div>
</div>
<p><em>Attention</em> : l’installation globale fonctionne uniquement si les scripts sont placés à la racine du <code class="docutils literal notranslate"><span class="pre">home</span></code> de l’utilisateur courant.</p>
<ul class="simple">
<li><p>Configurez votre installation en adaptant le fichier <code class="docutils literal notranslate"><span class="pre">install_all.ini</span></code> :</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nano</span> <span class="n">install_all</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>Renseignez à minima votre utilisateur linux, l’URL (ou IP) de votre serveur (avec un <code class="docutils literal notranslate"><span class="pre">/</span></code> à la fin) ainsi que l’utilisateur PostgreSQL que vous souhaitez et son mot de passe. Le script se chargera d’installer PostgreSQL et de créer l’utilisateur de base de données que vous avez renseigné.</p>
<p>Pour la définition des numéros de version des dépendances, voir le <a class="reference external" href="versions-compatibility.rst">tableau de compatibilité</a> des versions de GeoNature avec ses dépendances. Il est déconseillé de modifier ces versions, chaque nouvelle version de GeoNature étant fournie avec les versions adaptées de ses dépendances.</p>
<ul class="simple">
<li><p>Lancer l’installation :</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">install_all</span><span class="o">.</span><span class="n">log</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">install_all</span><span class="o">.</span><span class="n">sh</span>
<span class="o">./</span><span class="n">install_all</span><span class="o">.</span><span class="n">sh</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">install_all</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Une fois l’installation terminée, lancez la commande suivante:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exec</span> <span class="n">bash</span>
</pre></div>
</div>
<p>Les applications sont disponibles aux adresses suivantes :</p>
<ul class="simple">
<li><p><a class="reference external" href="http://monip.com/geonature/">http://monip.com/geonature/</a></p></li>
<li><p><a class="reference external" href="http://monip.com/taxhub/">http://monip.com/taxhub/</a></p></li>
<li><p><a class="reference external" href="http://monip.com/usershub/">http://monip.com/usershub/</a> (en option)</p></li>
</ul>
<p>Vous pouvez vous connecter avec l’utilisateur intégré par défaut (admin/admin).</p>
<dl class="field-list simple">
<dt class="field-odd">Note</dt>
<dd class="field-odd"><p>Pour en savoir plus TaxHub, sa configuration et son utilisation, reportez-vous à sa documentation : <a class="reference external" href="https://taxhub.readthedocs.io">https://taxhub.readthedocs.io</a>. Idem pour UsersHub et sa documentation : <a class="reference external" href="https://usershub.readthedocs.io">https://usershub.readthedocs.io</a></p>
</dd>
<dt class="field-even">Note</dt>
<dd class="field-even"><ul class="simple">
<li><p>GeoNature-atlas compatible avec GeoNature V2 est disponible sur <a class="reference external" href="https://github.com/PnX-SI/GeoNature-atlas">https://github.com/PnX-SI/GeoNature-atlas</a></p></li>
<li><p>Vous pouvez utiliser le schéma <code class="docutils literal notranslate"><span class="pre">ref_geo</span></code> de GeoNature pour votre territoire, les communes et les mailles, si vous les avez intégré dans <code class="docutils literal notranslate"><span class="pre">ref_geo.l_areas</span></code> au préalable.</p></li>
</ul>
</dd>
<dt class="field-odd">Note</dt>
<dd class="field-odd"><p>Une version expérimentale du calcul automatique de la sensibilité est disponible : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/issues/284">https://github.com/PnX-SI/GeoNature/issues/284</a></p>
</dd>
</dl>
<p>Si vous rencontrez une erreur, se reporter aux fichiers de logs :</p>
<ul class="simple">
<li><p>Logs de l’installation de la base de données : <code class="docutils literal notranslate"><span class="pre">/home/`whoami`/geonature/var/log/install_db.log</span></code></p></li>
<li><p>Log général de l’installation de l’application : <code class="docutils literal notranslate"><span class="pre">/home/`whoami`/install_all.log</span></code></p></li>
</ul>
<p>Si vous souhaitez que GeoNature soit à la racine du serveur, ou à une autre adresse, editez le fichier de configuration Apache (<code class="docutils literal notranslate"><span class="pre">/etc/apache2/sites-available/geonature.conf</span></code>) en modifiant l’alias :</p>
<ul class="simple">
<li><p>Pour <code class="docutils literal notranslate"><span class="pre">/</span></code>: <code class="docutils literal notranslate"><span class="pre">Alias</span> <span class="pre">/</span> <span class="pre">/home/test/geonature/frontend/dist</span></code></p></li>
<li><p>Pour <code class="docutils literal notranslate"><span class="pre">/saisie</span></code> : <code class="docutils literal notranslate"><span class="pre">Alias</span> <span class="pre">/saisie</span> <span class="pre">/home/test/geonature/frontend/dist</span></code></p></li>
</ul>
<dl class="field-list simple">
<dt class="field-odd">Note</dt>
<dd class="field-odd"><p>Par défaut et par mesure de sécurité, la base de données est accessible uniquement localement par la machine où elle est installée. Pour accéder à la BDD depuis une autre machine (pour s’y connecter avec QGIS, pgAdmin ou autre), vous pouvez consulter cette documentation <a class="reference external" href="https://github.com/PnX-SI/Ressources-techniques/blob/master/PostgreSQL/acces-bdd.rst">https://github.com/PnX-SI/Ressources-techniques/blob/master/PostgreSQL/acces-bdd.rst</a>. Attention si vous redémarrez PostgreSQL (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">postgresql</span> <span class="pre">restart</span></code>), il faut ensuite redémarrer les API de GeoNature, UsersHub et TaxHub (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">geonature.service</span></code>, <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">usershub.service</span></code> et <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">taxhub.service</span></code>). Attention, exposer la base de données sur internet n’est pas recommandé. Il est préférable de se connecter via un tunnel SSH. QGIS et la plupart des outils d’administration de base de données permettent d’établir une connexion à la base de cette manière.</p>
</dd>
<dt class="field-even">Note</dt>
<dd class="field-even"><p>Il est aussi important de configurer l’accès au serveur en HTTPS plutôt qu’en HTTP pour chiffrer le contenu des échanges entre le navigateur et le serveur (<a class="reference external" href="https://docs.ovh.com/fr/hosting/les-certificats-ssl-sur-les-hebergements-web/">https://docs.ovh.com/fr/hosting/les-certificats-ssl-sur-les-hebergements-web/</a>).</p>
</dd>
</dl>
</section>
</section>
<section id="installation-de-geonature-uniquement">
<span id="installation-standalone"></span><h2>Installation de GeoNature uniquement<a class="headerlink" href="#installation-de-geonature-uniquement" title="Lien permanent vers cette rubrique"></a></h2>
<p>Cette procédure détail l’installation de GeoNature seul, sans TaxHub et UsersHub.
Si vous souhaitez installer GeoNature avec TaxHub et UsersHub, reportez-vous à la section <a class="reference internal" href="#installation-all"><span class="std std-ref">Installation globale</span></a>.</p>
<section id="installation-des-dependances">
<h3>Installation des dépendances<a class="headerlink" href="#installation-des-dependances" title="Lien permanent vers cette rubrique"></a></h3>
<p>Installer les paquets suivants :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt install unzip git postgresql postgis python3-pip python3-venv python3-dev libpq-dev libgdal-dev libffi-dev libpangocairo-1.0-0 apache2 redis
</pre></div>
</div>
<p>Note : le paquet <code class="docutils literal notranslate"><span class="pre">redis</span></code> n’est pas nécessaire si vous ne souhaitez pas installer le worker celery.</p>
</section>
<section id="id1">
<h3>Installation de l’application<a class="headerlink" href="#id1" title="Lien permanent vers cette rubrique"></a></h3>
<ul>
<li><p>Se placer dans le répertoire de l’utilisateur (<code class="docutils literal notranslate"><span class="pre">/home/geonatureadmin/</span></code> dans notre cas)</p></li>
<li><p>Récupérer l’application (<code class="docutils literal notranslate"><span class="pre">X.Y.Z</span></code> à remplacer par le numéro de la <a class="reference external" href="https://github.com/PnEcrins/GeoNature/releases">dernière version stable de GeoNature</a>). Voir le <a class="reference external" href="versions-compatibility.rst">tableau de compatibilité</a> des versions de GeoNature avec ses dépendances.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget https://github.com/PnX-SI/GeoNature/archive/X.Y.Z.zip
</pre></div>
</div>
</li>
<li><p>Dézipper l’archive de l’application</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ unzip X.Y.Z.zip
$ rm X.Y.Z.zip
</pre></div>
</div>
</li>
<li><p>Renommer le répertoire de l’application puis placez-vous dedans :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mv GeoNature-X.Y.Z /home/`whoami`/geonature/
$ cd geonature
</pre></div>
</div>
</li>
<li><p>Copier puis mettre à jour le fichier de configuration (<code class="docutils literal notranslate"><span class="pre">config/settings.ini</span></code>) comportant les informations relatives à votre environnement serveur :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cp config/settings.ini.sample config/settings.ini
$ nano config/settings.ini
</pre></div>
</div>
</li>
</ul>
<section id="id4">
<h4>Installation de l’application<a class="headerlink" href="#id4" title="Lien permanent vers cette rubrique"></a></h4>
<p>Rendez vous dans le dossier <code class="docutils literal notranslate"><span class="pre">install</span></code> et lancez successivement dans l’ordre les scripts suivant :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">01_install_backend.sh</span></code> : Création du virtualenv python, installation des dépendances et du backend GeoNature dans celui-ci.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">02_configure_systemd.sh</span></code> : Création des services systemd <code class="docutils literal notranslate"><span class="pre">geonature</span></code> et <code class="docutils literal notranslate"><span class="pre">geonature-worker</span></code>, configuration de <code class="docutils literal notranslate"><span class="pre">logrotate</span></code>, création des dossiers <code class="docutils literal notranslate"><span class="pre">/run/geonature</span></code> et <code class="docutils literal notranslate"><span class="pre">/var/log/geonature</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">03_create_db.sh</span></code> : Création du role postgresql, de la base de données, ajout des extensions nécessaires (postgis, …), création des schémas nécessaires à GeoNature et ajout des données métiers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">04_install_gn_modules.sh</span></code> : Installation des modules OccTax, OccHab et validation (si activé dans le fichier <cite>settings.ini</cite>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">05_install_frontend.sh</span></code> : Création des dossiers et liens symboliques nécessaires, création des fichier custom à partir des fichiers d’exemple, génération des fichiers de configuration grâce à la commande <cite>geonature</cite>, installation de nvm, npm et node ainsi que toutes les dépendances javascript nécessaires puis build du front.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">06_configure_apache.sh</span></code> : Installation du fichier de configuration Apache <code class="docutils literal notranslate"><span class="pre">/etc/apache2/conf-available/geonature.conf</span></code> et activation des modules Apache nécessaires.</p></li>
</ul>
<p>Vous pouvez alors démarrer le backend GeoNature : <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">geonature2</span></code></p>
</section>
<section id="configuration-apache">
<h4>Configuration Apache<a class="headerlink" href="#configuration-apache" title="Lien permanent vers cette rubrique"></a></h4>
<ul>
<li><p>Copiez et adaptez le fichier de configuration d’exemple d’Apache de GeoNature :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo cp install/assets/geonature_apache.conf /etc/apache2/sites-available/geonature.conf
$ sudo nano /etc/apache2/sites-available/geonature.conf
</pre></div>
</div>
</li>
<li><p>Activez les modules suivants :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo a2enmod rewrite
$ sudo a2enmod proxy
$ sudo a2enmod proxy_http
</pre></div>
</div>
</li>
<li><p>Activez la nouvelle configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo a2ensite geonature.conf
</pre></div>
</div>
</li>
<li><p>et redémarrez Apache:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo systemctl restart apache2
</pre></div>
</div>
</li>
<li><p>L’application est disponible à l’adresse suivante : <a class="reference external" href="http://monip.com/geonature">http://monip.com/geonature</a></p></li>
</ul>
</section>
</section>
<section id="dependances">
<h3>Dépendances<a class="headerlink" href="#dependances" title="Lien permanent vers cette rubrique"></a></h3>
<p>Lors de l’installation de la BDD (<code class="docutils literal notranslate"><span class="pre">02_create_db.sh</span></code>) le schéma <code class="docutils literal notranslate"><span class="pre">utilisateurs</span></code> de UsersHub et le schéma <code class="docutils literal notranslate"><span class="pre">taxonomie</span></code> de TaxHub sont intégrés automatiquement dans la BDD de GeoNature.</p>
<p>UsersHub n’est pas nécessaire au fonctionnement de GeoNature mais il sera utile pour avoir une interface de gestion des utilisateurs, des groupes et de leurs droits.</p>
<p>Par contre il est nécessaire d’installer TaxHub (<a class="reference external" href="https://github.com/PnX-SI/TaxHub">https://github.com/PnX-SI/TaxHub</a>) pour que GeoNature fonctionne. En effet, GeoNature utilise l’API de TaxHub. Une fois GeoNature installé, il vous faut donc installer TaxHub en le connectant à la BDD de GeoNature, vu que son schéma <code class="docutils literal notranslate"><span class="pre">taxonomie</span></code> a déjà été installé par le script <code class="docutils literal notranslate"><span class="pre">02_create_db.sh</span></code> de GeoNature. Lors de l’installation de TaxHub, n’installez donc que l’application et pas la BDD.</p>
<p>Télécharger TaxHub depuis son dépôt Github depuis la racine de votre utilisateur :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~</span>
<span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PnX</span><span class="o">-</span><span class="n">SI</span><span class="o">/</span><span class="n">TaxHub</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">unzip</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">rm</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
<p>en mode développeur:</p>
<p><code class="docutils literal notranslate"><span class="pre">https://github.com/PnX-SI/TaxHub.git</span></code></p>
<p>Rendez vous dans le répertoire téléchargé et dézippé, puis « désamplez » le fichier <code class="docutils literal notranslate"><span class="pre">settings.ini</span></code> et remplissez la configuration avec les paramètres de connexion à la BDD GeoNature précedemment installée :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">settings</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">sample</span> <span class="n">settings</span><span class="o">.</span><span class="n">ini</span>
<span class="n">nano</span> <span class="n">settings</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>Lancer le script d’installation de l’application :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">var</span>
<span class="n">mkdir</span> <span class="n">var</span><span class="o">/</span><span class="n">log</span>
<span class="n">touch</span> <span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">install_app</span><span class="o">.</span><span class="n">log</span>
<span class="o">./</span><span class="n">install_app</span><span class="o">.</span><span class="n">sh</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">install_app</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Suite à l’execution de ce script, l’application Taxhub a été lancé automatiquement par le superviseur et est disponible à l’adresse <code class="docutils literal notranslate"><span class="pre">127.0.0.1:5000</span></code> (et l’API, à <code class="docutils literal notranslate"><span class="pre">127.0.0.1:5000/api</span></code>)</p>
<p>Voir la doc d’installation de TaxHub : <a class="reference external" href="http://taxhub.readthedocs.io/">http://taxhub.readthedocs.io/</a></p>
<p>Voir la doc d’installation de UsersHub : <a class="reference external" href="http://usershub.readthedocs.io/">http://usershub.readthedocs.io/</a></p>
</section>
<section id="passer-en-mode-developpement">
<h3>Passer en mode développement<a class="headerlink" href="#passer-en-mode-developpement" title="Lien permanent vers cette rubrique"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Consultez le guide <a class="reference internal" href="development.html#mode-dev"><span class="std std-ref">Passer en mode développement</span></a> de GeoNature.</p>
</div>
</section>
</section>
<section id="https">
<h2>HTTPS<a class="headerlink" href="#https" title="Lien permanent vers cette rubrique"></a></h2>
<p>La procédure décrit une méthode de certification HTTPS de votre domaine, grâce au service <a class="reference external" href="https://letsencrypt.org/">Let’s Encrypt</a>. Les manipulations ont été effectuées sur un serveur Debian 9 avec Apache2 installé, et un utilisateur bénéficiant des droits sudo.</p>
<p>Ressources :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.memoinfo.fr/tutoriels-linux/configurer-lets-encrypt-apache/">https://www.memoinfo.fr/tutoriels-linux/configurer-lets-encrypt-apache/</a></p></li>
<li><p><a class="reference external" href="https://korben.info/securiser-facilement-gratuitement-site-https.html">https://korben.info/securiser-facilement-gratuitement-site-https.html</a></p></li>
</ul>
<section id="installer-certbot">
<h3>Installer certbot<a class="headerlink" href="#installer-certbot" title="Lien permanent vers cette rubrique"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">certbot</span><span class="o">-</span><span class="n">apache</span>
</pre></div>
</div>
</section>
<section id="lancer-la-commande-cerbot">
<h3>Lancer la commande cerbot<a class="headerlink" href="#lancer-la-commande-cerbot" title="Lien permanent vers cette rubrique"></a></h3>
<p>Lancer la commande suivant pour générer des certificats et des clés pour le nom de domaine que vous souhaitez mettre en HTTPS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">certbot</span> <span class="n">certonly</span> <span class="o">--</span><span class="n">webroot</span> <span class="o">--</span><span class="n">webroot</span><span class="o">-</span><span class="n">path</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span> <span class="o">--</span><span class="n">domain</span> <span class="n">mondomaine</span><span class="o">.</span><span class="n">fr</span> <span class="o">--</span><span class="n">email</span> <span class="n">monemail</span><span class="nd">@mondomaine</span><span class="o">.</span><span class="n">fr</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">certonly</span></code> : demander la création du certificat uniquement.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--webroot</span></code> : utiliser le plugin webroot qui se contente d’ajouter des fichiers dans le dossier défini via <code class="docutils literal notranslate"><span class="pre">--webroot-path</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--webroot-path</span></code> : le chemin de votre « DocumentRoot » Apache. Certbot placera ses fichiers dans <code class="docutils literal notranslate"><span class="pre">$DocumentRoot/.well-known/</span></code> pour les tests et vérifications</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--domain</span></code> : le nom de domaine à certifier. Mettre tous les sous-domaines à certifier</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--email</span></code> : l’adresse qui recevra les notifications de Let’s Encrypt. Principalement pour rappeler de renouveler le certificat le moment venu.</p></li>
</ul>
</section>
<section id="les-certificats-obtenus">
<h3>Les certificats obtenus<a class="headerlink" href="#les-certificats-obtenus" title="Lien permanent vers cette rubrique"></a></h3>
<p>Le certificat se trouve dans le répertoire <code class="docutils literal notranslate"><span class="pre">/etc/letsencrypt/live/mondomaine.fr/</span></code>.</p>
<p>Il est constitué de 4 fichiers :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">privkey.pem</span></code> : La clé privée de votre certificat. A garder confidentielle en toutes circonstances et à ne communiquer à personne quel que soit le prétexte. Vous êtes prévenus !</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cert.pem</span></code> : Le certificat serveur est à préciser pour les versions d’Apache &lt; 2.4.8. Ce qui est notre cas ici.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chain.pem</span></code> : Les autres certificats, SAUF le certificat serveur. Par exemple les certificats intermédiaires. Là encore pour les versions d’Apache &lt; 2.4.8.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fullchain.pem</span></code> : Logiquement, l’ensemble des certificats. La concaténation du <code class="docutils literal notranslate"><span class="pre">cert.pem</span></code> et du <code class="docutils literal notranslate"><span class="pre">chain.pem</span></code>. A utiliser cette fois-ci pour les versions d’Apache &gt;= 2.4.8.</p></li>
</ul>
</section>
<section id="automatiser-le-renouvellement-du-certificat">
<h3>Automatiser le renouvellement du certificat<a class="headerlink" href="#automatiser-le-renouvellement-du-certificat" title="Lien permanent vers cette rubrique"></a></h3>
<p>Le certificat fourni par Let’s Encrypt n’est valable que 3 mois. Il faut donc mettre en place un renouvellement automatique.
Ajouter une tache automatique (Cron) pour renouveler une fois par semaine le certificat :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">crontab</span> <span class="o">-</span><span class="n">e</span>
<span class="mi">1</span> <span class="mi">8</span> <span class="o">*</span> <span class="o">*</span> <span class="n">Sat</span> <span class="n">certbot</span> <span class="n">renew</span> <span class="o">--</span><span class="n">renew</span><span class="o">-</span><span class="n">hook</span> <span class="s2">&quot;service apache2 reload&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">certbot</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
</section>
<section id="prise-en-compte-des-nouvelles-configurations-apache">
<h3>Prise en compte des nouvelles configurations Apache<a class="headerlink" href="#prise-en-compte-des-nouvelles-configurations-apache" title="Lien permanent vers cette rubrique"></a></h3>
<p>Activer les modules <code class="docutils literal notranslate"><span class="pre">ssl</span></code>, <code class="docutils literal notranslate"><span class="pre">headers</span></code> et <code class="docutils literal notranslate"><span class="pre">rewrite</span></code> puis redémarrer Apache :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">a2enmod</span> <span class="n">ssl</span>
<span class="n">sudo</span> <span class="n">a2enmod</span> <span class="n">rewrite</span>
<span class="n">sudo</span> <span class="n">a2enmod</span> <span class="n">headers</span>
<span class="n">sudo</span> <span class="n">apachectl</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Les fichiers de configuration des sites TaxHub et UsersHub ne sont pas à modifier, ils seront automatiquement associés à la configuration HTTPS. En revanche, la configuration de GeoNature doit être mise à jour.</p>
</section>
<section id="configuration-de-l-application-geonature">
<h3>Configuration de l’application GeoNature<a class="headerlink" href="#configuration-de-l-application-geonature" title="Lien permanent vers cette rubrique"></a></h3>
<p>Il est nécessaire de mettre à jour le fichier de configuration <code class="docutils literal notranslate"><span class="pre">geonature_config.toml</span></code> situé dans le répertoire <code class="docutils literal notranslate"><span class="pre">geonature/config</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">geonature</span><span class="o">/</span><span class="n">config</span>
<span class="n">nano</span> <span class="n">geonature_config</span><span class="o">.</span><span class="n">toml</span>
</pre></div>
</div>
<p>Modifier les éléments suivants :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">URL_APPLICATION</span> <span class="o">=</span> <span class="s1">&#39;https://mondomaine.fr/geonature&#39;</span>
<span class="n">API_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;https://mondomaine.fr/geonature/api&#39;</span>
<span class="n">API_TAXHUB</span> <span class="o">=</span> <span class="s1">&#39;https://mondomaine.fr/taxhub/api&#39;</span>
</pre></div>
</div>
<p>Pour que ces modifications soient prises en compte, exécuter les <a class="reference internal" href="admin-manual.html#post-config-change"><span class="std std-ref">actions à effecture après modification de la configuration</span></a>.</p>
<p>Les applications sont désormais accessibles sur votre domaine sécurisé en HTTPS !</p>
</section>
</section>
<section id="taches-planifiees">
<span id="cron"></span><h2>Taches planifiées<a class="headerlink" href="#taches-planifiees" title="Lien permanent vers cette rubrique"></a></h2>
<p>Depuis sa version 2.9.0, GeoNature permet de générer des profils pour chaque taxon à partir des observations existantes et validées.</p>
<p>Pour automatiser la mise à jour des profils en fonction des nouvelles observations, il est nécessaire de relancer automatiquement la fonction de calcul des profils de taxon en créant une taches planifiée (cron)</p>
<p>Créer une tache planifiée, exécutée tous les jours à minuit dans cet exemple :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">cron</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">geonature</span>
</pre></div>
</div>
<p>Ajouter la ligne suivante en remplaçant « &lt;CHEMIN_ABSOLU_VERS_VENV&gt; » par le chemin absolu vers le virtualenv de GeoNature et « &lt;GEONATURE_USER&gt; » par l’utilisateur Linux de GeoNature :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">&lt;</span><span class="n">GEONATURE_USER</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">CHEMIN_ABSOLU_VERS_VENV</span><span class="o">&gt;/</span><span class="nb">bin</span><span class="o">/</span><span class="n">geonature</span> <span class="n">profiles</span> <span class="n">update</span>
</pre></div>
</div>
<p>Exemple :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">geonatadmin</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">geonature</span><span class="o">/</span><span class="n">backend</span><span class="o">/</span><span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">geonature</span> <span class="n">profiles</span> <span class="n">update</span>
</pre></div>
</div>
</section>
<section id="installation-d-un-module-geonature">
<h2>Installation d’un module GeoNature<a class="headerlink" href="#installation-d-un-module-geonature" title="Lien permanent vers cette rubrique"></a></h2>
<p>L’installation de GeoNature n’est livrée qu’avec les schémas de base de données et les modules du coeur (NB : les modules Occtax, Occhab et Validation sont fournis par défaut). Pour ajouter un gn_module externe, il est nécessaire de l’installer :</p>
<p><strong>1.</strong> Téléchargez le module depuis son dépôt Github puis dézippez-le dans le repertoire utilisateur, au même niveau que le dossier <code class="docutils literal notranslate"><span class="pre">geonature</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd /home/`whoami`
</pre></div>
</div>
<p><strong>2.</strong> Renseignez l’éventuel fichier <code class="docutils literal notranslate"><span class="pre">config/settings.ini</span></code> du module.</p>
<p><strong>3.</strong> Installez le module. Rendez-vous dans le répertoire <code class="docutils literal notranslate"><span class="pre">backend</span></code> de GeoNature et activez le virtualenv pour rendre disponible les commandes GeoNature :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
</pre></div>
</div>
<p>Lancez ensuite la commande <code class="docutils literal notranslate"><span class="pre">geonature</span> <span class="pre">install_gn_module</span> <span class="pre">&lt;mon_chemin_absolu_vers_le_module&gt;</span> <span class="pre">&lt;url_relative_du_module&gt;</span></code></p>
<p>Le premier paramètre est l’emplacement absolu du module sur votre serveur et le deuxième est le chemin derrière lequel on accédera au module dans le navigateur.</p>
<p>Exemple pour un module Import :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>geonature install_gn_module /home/`whoami`/gn_module_import import
</pre></div>
</div>
<p>Le module sera disponible à l’adresse <code class="docutils literal notranslate"><span class="pre">http://mon-geonature.fr/geonature/#/import</span></code></p>
<p>L’API du module sera disponible à l’adresse <code class="docutils literal notranslate"><span class="pre">http://mon-geonature.fr/api/import</span></code></p>
<p>Cette commande exécute les actions suivantes :</p>
<ul class="simple">
<li><p>Vérification de la conformité de la structure du module (présence des fichiers et dossiers obligatoires)</p></li>
<li><p>Intégration du blueprint du module dans l’API de GeoNature</p></li>
<li><p>Vérification de la conformité des paramètres utilisateurs</p></li>
<li><p>Génération du routing Angular pour le frontend</p></li>
</ul>
<p><strong>4.</strong> Complétez l’éventuelle configuration du module (<code class="docutils literal notranslate"><span class="pre">config/conf_gn_module.toml</span></code>) à partir des paramètres présents dans <code class="docutils literal notranslate"><span class="pre">config/conf_gn_module.toml.example</span></code> dont vous pouvez surcoucher les valeurs par défaut. Puis relancez la mise à jour de la configuration (depuis le répertoire <code class="docutils literal notranslate"><span class="pre">geonature/backend</span></code> et une fois dans le venv (<code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">venv/bin/activate</span></code>) : <code class="docutils literal notranslate"><span class="pre">geonature</span> <span class="pre">update_module_configuration</span> <span class="pre">nom_du_module</span></code>)</p>
<p><strong>5.</strong> Re-build du frontend :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">frontend</span>
<span class="n">nvm</span> <span class="n">use</span>
<span class="n">npm</span> <span class="n">run</span> <span class="n">build</span>
</pre></div>
</div>
</section>
<section id="mise-a-jour-de-l-application">
<h2>Mise à jour de l’application<a class="headerlink" href="#mise-a-jour-de-l-application" title="Lien permanent vers cette rubrique"></a></h2>
<p>Attention, avant chaque mise à jour de GeoNature, il est important de sauvegarder l’application et sa base de données, ou de faire un snapshot du serveur pour pouvoir revenir à son état antérieure avant mise à jour en cas de problème.</p>
<p>La mise à jour de GeoNature consiste à télécharger sa nouvelle version dans un nouveau répertoire, récupérer les fichiers de configuration et de surcouche depuis la version actuelle et de relancer l’installation dans le répertoire de la nouvelle version.</p>
<p>La mise à jour doit être réalisée avec votre utilisateur linux courant (<code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code> par exemple) et non pas le super-utilisateur <code class="docutils literal notranslate"><span class="pre">root</span></code>.</p>
<ul>
<li><p>Télécharger la dernière version de GeoNature :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PnX</span><span class="o">-</span><span class="n">SI</span><span class="o">/</span><span class="n">GeoNature</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">unzip</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">rm</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
</li>
<li><p>Renommer l’ancien repertoire de l’application, ainsi que le nouveau :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mv /home/`whoami`/geonature/ /home/`whoami`/geonature_old/
mv GeoNature-X.Y.Z /home/`whoami`/geonature/
cd geonature
</pre></div>
</div>
</li>
<li><p>Suivez les éventuelles notes de version spécifiques décrites au niveau de chaque version : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/releases">https://github.com/PnX-SI/GeoNature/releases</a>.</p></li>
</ul>
<p>⚠️ Si la release inclut des scripts de migration SQL : <em>lancer ces scripts avec l’utilisateur de BDD courant</em> (généralement <code class="docutils literal notranslate"><span class="pre">geonatadmin</span></code>) et non le super-utilisateur <code class="docutils literal notranslate"><span class="pre">postgres</span></code>.</p>
<p>Sauf mentions contraires dans les notes de version, vous pouvez sauter des versions mais en suivant bien les différentes notes de versions intermédiaires et notamment les scripts de mise à jour de la base de données à exécuter successivement.</p>
<ul>
<li><p>Si vous devez aussi mettre à jour TaxHub et/ou UsersHub, suivez leurs notes de versions mais aussi leur documentation (<a class="reference external" href="https://usershub.readthedocs.io">https://usershub.readthedocs.io</a> et <a class="reference external" href="https://taxhub.readthedocs.io">https://taxhub.readthedocs.io</a>).</p></li>
<li><p>Lancez le script de <code class="docutils literal notranslate"><span class="pre">migration.sh</span></code> à la racine du dossier <code class="docutils literal notranslate"><span class="pre">geonature</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">install</span><span class="o">/</span><span class="n">migration</span><span class="o">/</span><span class="n">migration</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pied de page">
        <a href="index.html" class="btn btn-neutral float-left" title="Bienvenue dans la documentation de GeoNature" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Précédent</a>
        <a href="user-manual.html" class="btn btn-neutral float-right" title="MANUEL UTILISATEUR" accesskey="n" rel="next">Suivant <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2019, PnE, PnC.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>